1,"Patch TRT  AX3M - AppCore","ITA/FRA","1","","X3","1",
2,"TRT","IMPSMRS",""
#<AdxTL>@(#)0.0.0.0 $Revision$
###########################################################################
# IMPSMRS : Import spécifique des entrées diverses stock   MBT 03/03/2004 #
# ----------------------------------------------------------------------- #
# L'import des entrées diverses de stock est un import spécifique, il     #
# permet d'importer pour chaque ligne du bordereau d'entrée le détail     #
# des entrées de stock                                                    #
# Cet import fonctionne :                                                 #
#   - en création détaillée d'un bordereau d'entrée                       #
#   - en suppression totale d'un bordereau d'entrée                       #
# Les modifications d'un bordereau d'entrée ne sont pas possibles par     #
# l'import !                                                              #
###########################################################################


$ACTION
If dim(GSTK_TRACE)>0 & GSTK_TRACE=2 & [L]ACTION<>"IMP_ZONE" & [L]ACTION<>"EXP_ZONE"
  GSTK_ACT=[L]ACTION : GSTK_PGM="IMPSMRS" : Gosub TRACE_DETAILLEE From STKIMP
Endif
Case [L]ACTION
  When "IMP_COMPILE"   : Gosub IMP_COMPILE
  When "IMP_TRTSUP"    : Gosub IMP_TRTSUP
  When "IMP_ZONE"      : Gosub IMP_ZONE
  When "AP_IMPORT"     : Gosub AP_IMPORT
  When "IMP_FERME"     : Gosub IMP_FERME
  #-----
  When "EXP_OUVRE"     : Gosub EXP_OUVRE   From IMPSMR
  When "EXPORT"        : Gosub EXPORT      From IMPSMR
  When "EXP_ZONE"      : Gosub EXP_ZONE    From IMPSMR
  When "AP_EXPORT"     : Gosub AP_EXPORT   From IMPSMR
Endcase
Return


###########################################################################
#                                 IMPORT                                  #
###########################################################################


#-------------------------------------------------------------------------#
# Début de la génération du traitement WWIxxxxxx, appelé par le SUBIMPOBJ #
#-------------------------------------------------------------------------#
$IMP_COMPILE
Return


#-----------------------------------------------------------------------#
# Fin de la génération du traitement WWIxxxxxx, appelé par le SUBIMPOBJ #
#-----------------------------------------------------------------------#
$IMP_TRTSUP
Return


#-------------------------------------------------------------#
# Après chargement de la classe [F] effectué par le WWIxxxxxx #
# IMPFIC : Abréviation du fichier en cours SMH, SMD, STJ      #
#-------------------------------------------------------------#
$AP_IMPORT

  If(GWEBSERV & type([F:SMH]CREUSR)>0 & vireblc([F:SMH]CREUSR,2)<> AVOID.ACHAR)
   #Call ECR_TRACE("IMPSMRS_AP_IMPORT : creusr = " - [F:SMH]CREUSR,0) From GESECRAN
   GUSER = [F:SMH]CREUSR
  Endif
Return

#-----------------------------------------------------------------#
# Début import, étiquette appelée directement depuis le SUBIMPOBJ #
#-----------------------------------------------------------------#
$OUVRE

If !clalev([M:SMR0])  Local Mask SMR0     [SMR0]  : Endif
If !clalev([M:SMR1])  Local Mask SMR1     [SMR1]  : Endif

If !clalev([F:SRT])  Local File STKTRS    [SRT]   : Endif
If !clalev([M:SDP])  Local Mask SAIDECPRI [SDP]   : Endif
If !clalev([F:SMV])  Local File SMVTDVAL  [SMV]   : Endif

#--- Issue x3-220344 By TS
Global Integer GPRNCOD
#---

GABREV="SMR" : GFLAG=""
#----- Sélection de la transaction d'un bordereau d'entrée -----#
Read [SRT] SRT0=1;GFLAG
If fstat
  Filter [SRT] Where SRTTYP=1 & ENAFLG=2
  Read [SRT] First
  Filter [SRT]
  If fstat
    If GTRACE<>""
      Call ECR_TRACE(mess(114,192,1),1) From GESECRAN
    Endif
    OK=0 : Return
  Endif
  GFLAG    = [F:SRT]SRTNUM
  GSMRNUM  = [F:SRT]SRTNUM       # hcb 89329

Endif
[F:SRT]SRGWAIFLG=2 : # On force l'autorisation d'une réception à quai
[F:SRT]PRNCOD1  =1 : # On force l'impression d'étiquettes à "Non"
[F:SRT]PRNNBFLG1=1 : # On force le nbre d'impression à "Non"
#-----
[L]ACTION="OUVRE"   : Gosub ACTION From GOBJSUB : Gosub DEFAUT From WOSMR
If !clalev([M:STA])  Local Mask STOANA [STA] : Endif
Gosub FLD_MODELE From TRTX3IMP
#----- Principaux contrôles sur le modèle -----#
If !find("[F:SMH]STOFCY(0)",[M:AOE2]ZONMSK1)
  #----- Le site de stockage est obligatoire -----#
  OK=0 : GERR=1 : GMESSAGE=mess(323,199,1)-"([F:SMH]STOFCY)" : Return
Elsif !find("[F:SMD]ITMREF(0)",[M:AOE2]ZONMSK1)
  #----- La référence article est obligatoire -----#
  OK=0 : GERR=1 : GMESSAGE=mess(323,199,1)-"([F:SMD]ITMREF)" : Return
Elsif !find("[F:SMD]QTYPCU(0)",[M:AOE2]ZONMSK1)
  #----- La quantité est obligatoire -----#
  OK=0 : GERR=1 : GMESSAGE=mess(323,199,1)-"([F:SMD]QTYPCU)" : Return
Elsif !find("[F:SMD]PCU(0)",[M:AOE2]ZONMSK1)
  #----- L'unité est obligatoire -----#
  OK=0 : GERR=1 : GMESSAGE=mess(323,199,1)-"([F:SMD]PCU)"    : Return
Endif
#----- Variables locales -----#
Local  Integer  WNOL, J, K, L
Local  Char     SYMBOL2(30)
Local  Libelle  WTEST_CCE
#----- Test si besoin d'importer les axes analytiques avec l'écran STOANA [STA] -----#
Raz [L]WTEST_CCE
For J=1 To GNBDIE
#  If evalue("find('[F:SMH]CCE"+num$(J)+"(0)',[M:AOE2]ZONMSK1)") # hcb 69190
    If evalue("find('[F:SMH]CCE("+num$(J)+")',[M:AOE2]ZONMSK1)")  # hcb 69190
    [L]WTEST_CCE=1 : Break
  Endif
Next J

# hcb 54712 deb
Global Integer  GCCE_STJ
#----- Test si besoin d'importer les axes analytiques avec l'écran STOANA [STA] -----#
Raz GCCE_STJ
For J=1 To GNBDIE
#  If evalue("find('[F:STJ]CCE"+num$(J)+"(0)',[M:AOE2]ZONMSK1)")          # hcb 69190
   If evalue("find('[F:STJ]CCE("+num$(J)+")',[M:AOE2]ZONMSK1)")           # hcb 69190
     GCCE_STJ=1 : Break
  Endif
Next J
# hcb 54712

#----- Gestion des textes (pas de texte pour l'instant !) -----#
Gosub DECLARE_TEXTE From TRTX3IMP
G_IMPORT=1 : Gosub OUVRE_TEXTE From IMPSMR
#----- Globales à definir pour import stock -----#
Global Char     GSTK_ACTION(20)                               : # Nom de l'action
Global Char     GSTK_BASTAB(20) : GSTK_BASTAB="[M:SMR1]NBLIG" : # Nom variable bas tableau
Global Libelle  GSTK_TRSTYP     : GSTK_TRSTYP=1               : # Type mouvement (M.704)
Global Libelle  GSTK_VCRTYP     : GSTK_VCRTYP=19              : # Type pièce (M.701)
Global Libelle  GSTK_TRACE      : GSTK_TRACE =1               : # Trace détaillée si =2
#-----
If GSTOTRACE>2  GSTK_TRACE=2 : Endif
#-----
If GSTK_TRACE=2
  Call ECR_TRACE(mess(27,115,1)-"OUVRE"+space$(17)+"From IMPSMRS",0) From GESECRAN
Endif
#-----
GSTK_ACTION="OUVRE" : Gosub ACTION From STKIMP
[L]WSTK_ABRTTR="SRT" : # Abréviation table transaction de saisie

Return


#--------------------------------------------------------------------------------------#
# Nouveau document à importer, appelé directement depuis le traitement généré WWIxxxxx #
#--------------------------------------------------------------------------------------#
$RAZCRE
If GSTK_TRACE=2
  GSTK_ACT="RAZCRE" : GSTK_PGM="IMPSMRS" : Gosub TRACE_DETAILLEE From STKIMP
Endif
GREP="C"
Raz [M:SMR0], [M:SMR1], [M:STA]
If GSTK_TRACE=2
  GSTK_ACT="RAZCRE" : GSTK_PGM="GOBJSUB" : Gosub TRACE_DETAILLEE From STKIMP
Endif
[L]ACTION="RAZCRE"   : Gosub ACTION From GOBJSUB : Gosub DEFAUT From WOSMR
GSTK_ACTION="RAZCRE" : Gosub ACTION From STKIMP
Return


#------------------------------------------------------------------------------------#
# Chargement masques écrans, appelé directement depuis le traitement généré WWIxxxxx #
#------------------------------------------------------------------------------------#
$SAIMSK
If GREP="A"  Return : Endif
If GSTK_TRACE=2
  GSTK_ACT="SAIMSK" : GSTK_PGM="IMPSMRS" : Gosub TRACE_DETAILLEE From STKIMP
Endif
Case IMPFIC
  When "SMH"
    #--- Issue X3-220344 by TS
    # Lecture transaction paramétrée dans l'import
    If find("SMH-*61",[M:AOE2]ZONMSK1) & GIMP(61)<>""
      Read [SRT] SRT0=1;GIMP(61)
      If fstat
        Call ECR_TRACE(GIMP(61)-":"-mess(40,114,1),1) From GESECRAN
        GOK=0 : Return
      Endif
      GFLAG    = [F:SRT]SRTNUM
      GSMRNUM  = [F:SRT]SRTNUM
      GPRNCOD  = [F:SRT]PRNCOD1
      # On force l'impression d'étiquettes et le nombre d'impressions à "Non"
      [F:SRT]PRNCOD1  =1
      [F:SRT]PRNNBFLG1=1
    Endif
    If find("SMH-*62",[M:AOE2]ZONMSK1)
      # Récupération destination impression
      GVTETI=GIMP(62)
    Endif
    #---
    #----- Test rupture sur ligne document -----#
    If GSTK_NBLIG
      GSTK_ACTION="RUPT_LIGDOC" : Gosub ACTION From STKIMP : # Articles gérés stock
    Endif
    #-----
    Gosub IMPORT_TEXTE From IMPSMR : # Import des textes entête, pied
    Default File [SMH]  : # Voir si utile ?
    If GSTK_TRACE=2
      GSTK_ACT="SAIMSK" : GSTK_PGM="W0SMR0" : Gosub TRACE_DETAILLEE From STKIMP
    Endif
    Default Mask [SMR0]
    Setmode INBAFF,IAFFCOD,IAFFMASK,IAFFCHP,IAFFIND,IAFFTXT,IAFFRANG,IAFFOPT1,IAFFOPT2
    Call SAIMSK("SMH","IMP_ZONE","SUBIMPOBJ") From W0SMR0
    If mkstat  NBERR+=1 : Call TRACE2(2,GMESSIMP,-10) From SUBIMPOBJ : Endif
    If GREP="A"
      REP="A" : Actzo [SMR0]VCRDES, STOFCY, IPTDAT, PJT, TRSFAM, SRGLOCDEF
    Endif
    Setmode
    If GREP="A"  Return : Endif
    If mkstat  GREP="" : REP="" : mkstat=0 : GOK=0 : Return : Endif
    If [L]WTEST_CCE
      For J=1 To GNBDIE
          [M:STA]CCE(J-1)  =[M:SMR0]CCE(J-1)
          [M:STA]DIE(J-1)=GDIE(J)
      Next J
      # Issue X3-164070 - 2019-11-21 by MAE : alimentation de IPTDAT
      If [M:SMR0]IPTDAT <> AVOID.ADATE
        [M:STA]IPTDAT = [M:SMR0]IPTDAT
      Endif
      # End issue X3-164070

      If GSTK_TRACE=2
        GSTK_ACT="SAIMSK" : GSTK_PGM="W0STOANA" : Gosub TRACE_DETAILLEE From STKIMP
      Endif
      Default Mask [STA]
      Setmode INBAFF,IAFFCOD,IAFFMASK,IAFFCHP,IAFFIND,IAFFTXT,IAFFRANG,IAFFOPT1,IAFFOPT2
      Call SAIMSK("SMH","IMP_ZONE","SUBIMPOBJ") From W0STOANA
      Setmode
      If mkstat  NBERR+=1 : Call TRACE2(2,GMESSIMP,-10) From SUBIMPOBJ : Endif
      If mkstat  GREP="" : REP="" : mkstat=0 : GOK=0 : Return : Endif
      For J=1 To GNBDIE
         [M:SMR0]CCE(J-1)=[M:STA]CCE(J-1)
      Next J
    Endif
    #----- Traitement des textes entête et pied -----#
    If GREP="C"  Gosub IMP_ZONE_TEXTE From IMPSMR : Endif
    #----- Traitement champs invisibles -----#
    If find("[F:SMH]TRSCOD(0)",[M:AOE2]ZONMSK1)
      [M:SMR0]TRSCOD=[F:SMH]TRSCOD
    #--- Issue X3-220344 by TS
    Elsif GIMP(61)<>""
      [M:SMR0]TRSCOD=[F:SRT]TRSCOD
    #---
    Endif
    If find("[F:SMH]ENTCOD(0)",[M:AOE2]ZONMSK1)
      [M:SMR0]ENTCOD=[F:SMH]ENTCOD
    #--- Issue X3-220344 by TS
    Elsif GIMP(61)<>""
      [M:SMR0]ENTCOD=[F:SRT]ENTCOD
    #---
    Endif
    #-----
    GSTK_TRSCOD=[M:SMR0]TRSCOD
    GSTK_ENTCOD=[M:SMR0]ENTCOD
  When "SMD"
    #----- Test rupture sur ligne document -----#
    If GSTK_NBLIG
      GSTK_ACTION="RUPT_LIGDOC" : Gosub ACTION From STKIMP : # Articles gérés stock
    Endif
    #-----
    Gosub IMPORT_TEXTE From IMPSMR : # Import des textes ligne
    [M:SMR1]NBLIG+=1
    nolign=[M:SMR1]NBLIG : indice=nolign-1
    #-----
    status=73
    WNOL=nolign-1       : # Utile pour le traitement de "CAL"
    Default File [SMD]  : # Voir si utile ?
    If GSTK_TRACE=2
      GSTK_ACT="SAI_NBLIG" : GSTK_PGM="W0SMR1" : Gosub TRACE_DETAILLEE From STKIMP
    Endif
    Default Mask [SMR1]
    Setmode INBAFF,IAFFCOD,IAFFMASK,IAFFCHP,IAFFIND,IAFFTXT,IAFFRANG,IAFFOPT1,IAFFOPT2
    Call SAI_NBLIG("SMD","IMP_ZONE","SUBIMPOBJ") From W0SMR1
    If mkstat  NBERR+=1 : Call TRACE2(2,GMESSIMP,-10) From SUBIMPOBJ : Endif
    Setmode
    If mkstat  GREP=""
       REP=""
       mkstat=0
       GOK=0
       Return : Endif
    #-----
    If [F:ITM]ITMREF<>[M:SMR1]ITMREF([M:SMR1]NBLIG-1)
      Read [ITM] ITM0=[M:SMR1]ITMREF([M:SMR1]NBLIG-1)
      If fstat  Raz [F:ITM] : Endif
    Endif
    #----- Traitement des textes entête et pied -----#
    If GREP="C"  Gosub IMP_ZONE_TEXTE From IMPSMR : Endif

  When "CAL"
    #------------------------------------------------------------------#
    # Traitement des comptes et sections analytiques des lignes retour #
    #            left$([M:AOE1]FLGLNK(SEPNUM-1),5)='"PND"'             #
    #------------------------------------------------------------------#
    Default Mask [SMR1]
    [F:CAL]ABRFIC = "SMD"
    [F:CAL]VCRTYP = [M:SMR0]VCRTYP
    Call IMPORT_ACCCCE(WNOL,"","","[M:SMR1]CCE") From TRTX3CPT
    nolign=WNOL+1 : status=75 : # Modif élément
    #-----
    If GSTK_TRACE=2
      GSTK_ACT="SAI_NBLIG" : GSTK_PGM="W0SMR1" : Gosub TRACE_DETAILLEE From STKIMP
    Endif
    indice=nolign-1 : mkstat=0
    GNBAFF=0
    Setmode INBAFF,IAFFCOD,IAFFMASK,IAFFCHP,IAFFIND,IAFFTXT,IAFFRANG,IAFFOPT1,IAFFOPT2
    Call SAI_NBLIG("CAL","IMP_ZONE","SUBIMPOBJ") From W0SMR1
    If mkstat  NBERR+=1 : Call TRACE2(2,GMESSIMP,-10) From SUBIMPOBJ : Endif
    Setmode
    If mkstat  GREP="" : REP="" : mkstat=0 : GOK=0 : Return : Endif
    #-----
  When "SMV"
    Local Integer LLIGW : Raz LLIGW
    Raz [M:SDP]
    [M:SDP]=[F:SMV]
    Gosub CAL_TOT From SUBSDP
    LLIGW = find([M:SMR1]WSTOSEQ([M:SMR1]NBLIG-1),[M:VALW]WSTOSEQ)-1
    If LLIGW>=0
        Call COPSDP2VALW(LLIGW,"VALW","SDP") From SUBSDPCOM
    Endif

  When "STJ"
    GSTK_ACTION="SAIMSK" : Gosub ACTION From STKIMP
Endcase
Return


#-----------------------------------------#
# Equivalent à la saisie d'un champ fiche #
# --------------------------------------- #
# IMPFIC : Abréviation du fichier         #
# IMPMSK : Nom de l'écran en cours        #
# IMPZON : Nom du champ en cours          #
# IMPMOD : Déclenche l'Après_modif        #
# OK     : Conditionne IMP_ZONE standard  #
#-----------------------------------------#
$IMP_ZONE
If GREP="A"  Return : Endif
If dim([L]WTST_CHAMP)<1  Local Libelle  WTST_CHAMP : Endif
Case IMPFIC
  When "SMH"
    Case IMPMSK
      When "SMR0"
        If find("[F:SMH]"+IMPZON+"(0)",[M:AOE2]ZONMSK1)
          If GSTK_TRACE=2
            GSTK_ACT="IMP_ZONE("+IMPZON+")" : GSTK_PGM="IMPSMRS"
            Gosub TRACE_DETAILLEE From STKIMP
          Endif
          If evalue("[M:SMR0]"+IMPZON+"("+num$(indice)+")")<>evalue("[F:SMH]"+IMPZON)
            Assign "[M:SMR0]"+IMPZON+"("+num$(indice)+")" With evalue("[F:SMH]"+IMPZON)
            IMPMOD=1
          Endif
          OK=0
        Endif
      When "STOANA"
        Case IMPZON
          When "NBAXE"
            [M:STA]NBAXE=GNBDIE
          When "CCE"
            If evalue("find('[F:SMH]CCE"+num$(indice+1)+"(0)',[M:AOE2]ZONMSK1)")
              If [M:STA]CCE(indice)<>evalue("[F:SMH]CCE"+num$(indice+1))
                [M:STA]CCE(indice)=evalue("[F:SMH]CCE"+num$(indice+1))
                IMPMOD=1
              Endif
              OK=0
            Endif
        Endcase
    Endcase
  When "SMD"
    Case IMPZON
      When "CCE1", "CCE2", "CCE3", "CCE4", "CCE5", "CCE6", "CCE7", "CCE8", "CCE9", "CCE10",
&          "CCE11","CCE12","CCE13","CCE14","CCE15","CCE16","CCE17","CCE18","CCE19","CCE20"
        #----- Pas de contrôle si les comptes et sections sont importés avec "CAL" -----#
        If find("CPTANALIN",[M:AOE1]FLGFIL(0..[M:AOE1]NBRFLG))
          OK=0 : mkstat=1 : # Zones non concernées par SMVTD
        Endif
        #-----
        When "PRI" : # C'est la zone PRI qui est saisissable. PRIORD étant le résultat d'un calcul.
                     If find("[F:SMD]PRIORD(0)",[M:AOE2]ZONMSK1)
                         If GSTK_TRACE=2
                             GSTK_ACT="IMP_ZONE("+IMPZON+")" : GSTK_PGM="IMPSMRS"
                             Gosub TRACE_DETAILLEE From STKIMP
                         Endif
                         [M:SMR1]PRI(indice) = [F:SMD]PRIORD
                         IMPMOD=1
                         OK=0
                      Endif

    Endcase
    If find("[F:SMD]"+IMPZON+"(0)",[M:AOE2]ZONMSK1)
      If GSTK_TRACE=2
        GSTK_ACT="IMP_ZONE("+IMPZON+")" : GSTK_PGM="IMPSMRS"
        Gosub TRACE_DETAILLEE From STKIMP
      Endif
      If evalue("[M:SMR1]"+IMPZON+"("+num$(indice)+")")<>evalue("[F:SMD]"+IMPZON)
        Assign "[M:SMR1]"+IMPZON+"("+num$(indice)+")" With evalue("[F:SMD]"+IMPZON)
        IMPMOD=1
      Endif
      OK=0
    Endif
  When "STJ"
    GSTK_ACTION="IMP_ZONE" : Gosub ACTION From STKIMP
Endcase
Return


#----------------------------------------------------------------------------#
# Enregistrement du document importé, appelé directement depuis le SUBIMPOBJ #
#----------------------------------------------------------------------------#
$VALID
If GSTK_TRACE=2
  GSTK_ACT='VALID(GREP="'+GREP+'")' : GSTK_PGM="IMPSMRS" : Gosub TRACE_DETAILLEE From STKIMP
Endif
If GREP=""  Raz GSTK_NBLIG : Return : Endif
[L]OK=1 : Raz GERREUR
If GREP="C"
  #-----
  GSTK_ACTION="VALID" : Gosub ACTION From STKIMP
  If ![L]OK  GOK=0 : Goto FIN_GENSMR : Endif
  #-----
  If GSTK_TRACE=2
    GSTK_ACT="VERIF_CRE" : GSTK_PGM="GOBJSUB" : Gosub TRACE_DETAILLEE From STKIMP
  Endif
  [L]ACTION="VERIF_CRE"  : Gosub ACTION From GOBJSUB
  #--- Bug 71029
  If ![L]OK  GOK=0 : Goto FIN_GENSMR : Endif
  #If ![L]OK  GOK=0 : Gosub TRACE_CTL From SUBIMPOBJ : Goto FIN_GENSMR : Endif  # hcb 87116
  #---
Elsif GREP="A"
  If GSTK_TRACE=2
    GSTK_ACT="LIENS" : GSTK_PGM="GOBJSUB" : Gosub TRACE_DETAILLEE From STKIMP
  Endif
  [L]ACTION="LIENS" : Gosub ACTION From GOBJSUB
  If [M:SMR1]NBLIG=0  GOK=0 : Goto FIN_GENSMR : Endif
  [L]SYMBOL2="SMR"+[M:SMR0]VCRNUM : Lock=[L]SYMBOL2
  If fstat
    Call ECR_TRACE("$SMVTH"-[M:SMR0]VCRNUM-mess(10,100,1),1) From GESECRAN
    GOK=0 : Goto FIN_GENSMR
  Endif
  If GSTK_TRACE=2
    GSTK_ACT="VERF_ANU" : GSTK_PGM="GOBJSUB" : Gosub TRACE_DETAILLEE From STKIMP
  Endif
  [L]ACTION="VERF_ANU" : Gosub ACTION From GOBJSUB
  If ![L]OK
    If GMESSAGE<>""  Call ECR_TRACE(GMESSAGE,1) From GESECRAN : Raz GMESSAGE : Endif
    Unlock=[L]SYMBOL2
    GOK=0 : Goto FIN_GENSMR
  Endif
Endif
Call DEBTRANS From GLOCK
#-----
$TR_GENSMR
GOK=1
If GSTK_TRACE=2
  GSTK_ACT="Trbegin" : GSTK_PGM="" : Gosub TRACE_DETAILLEE From STKIMP
Endif
Trbegin [SMH], [SMD]
  Raz [F:SMH], [F:SMD]
  [F:SMH]=[M:SMR0]
  [F:SMH]=[M:SMR1]
  Default File [SMH]
  If GSTK_TRACE=2
    GSTK_ACT="INICRE" : GSTK_PGM="GOBJSUB" : Gosub TRACE_DETAILLEE From STKIMP
  Endif
  [L]ACTION="INICRE"   : Gosub ACTION From GOBJSUB
  If GOK<0  Goto ROLL_GENSMR  Elsif !GOK  Goto AB_GENSMR : Endif
  If GSTK_TRACE=2
    GSTK_ACT="Write [SMH]" : GSTK_PGM="" : Gosub TRACE_DETAILLEE From STKIMP
  Endif
  [F:SMH]CREUSR=GUSER
  [F:SMH]CREDAT=date$
  [F:SMH]EXPNUM = [C]EXPORT    # hcb 114305
  Write [SMH]
  If fstat  GOK=0 : Call FSTA("SMH") From GLOCK : Goto AB_GENSMR : Endif
  If GSTK_TRACE=2
    GSTK_ACT="CREATION" : GSTK_PGM="GOBJSUB" : Gosub TRACE_DETAILLEE From STKIMP
  Endif
  [L]ACTION="CREATION" : Gosub ACTION From GOBJSUB
  If GOK<0  Goto ROLL_GENSMR  Elsif !GOK  Goto AB_GENSMR : Endif
  If GSTK_TRACE=2
    GSTK_ACT="Commit" : GSTK_PGM="" : Gosub TRACE_DETAILLEE From STKIMP
  Endif
Commit
Case GREP
  When "C" : Call TRACE( 0,mess(19,701,1)-[F:SMH]VCRNUM)  From SUBIMPOBJ
  When "M" : Call TRACE( 1,mess(19,701,1)-[M:SMR0]VCRNUM) From SUBIMPOBJ : # Pas activé !
  When "A" : Call TRACE(-1,mess(19,701,1)-[M:SMR0]VCRNUM) From SUBIMPOBJ
Endcase
If GREP="C"
  If GSTK_TRACE=2
    GSTK_ACT="APRES_CRE" : GSTK_PGM="GOBJSUB" : Gosub TRACE_DETAILLEE From STKIMP
  Endif
  [L]ACTION="APRES_CRE" : Gosub ACTION From GOBJSUB
Elsif GREP="A"
  Unlock=[L]SYMBOL2
  If GSTK_TRACE=2
    GSTK_ACT="AP_ANNULE" : GSTK_PGM="GOBJSUB" : Gosub TRACE_DETAILLEE From STKIMP
  Endif
  [L]ACTION="AP_ANNULE" : Gosub ACTION From GOBJSUB
Endif
Goto FIN_GENSMR
#-----
$ROLL_GENSMR
If GSTK_TRACE=2
  GSTK_ACT="Rollback" : GSTK_PGM="" : Gosub TRACE_DETAILLEE From STKIMP
Endif
Rollback
Call ROLL From GLOCK
If GROLL
  If GREP="C"
    If GSTK_TRACE=2
      GSTK_ACT="AB_CREATION" : GSTK_PGM="GOBJSUB" : Gosub TRACE_DETAILLEE From STKIMP
    Endif
    [L]ACTION="AB_CREATION" : Gosub ACTION From GOBJSUB : Goto FIN_GENSMR
  Elsif GREP="A"
    Unlock=[L]SYMBOL2
  Endif
  Goto FIN_GENSMR
Else
  Goto TR_GENSMR
Endif
#-----
$AB_GENSMR
If GSTK_TRACE=2
  GSTK_ACT="Rollback" : GSTK_PGM="" : Gosub TRACE_DETAILLEE From STKIMP
Endif
Rollback
If GREP="C"
  If GSTK_TRACE=2
    GSTK_ACT="AB_CREATION" : GSTK_PGM="GOBJSUB" : Gosub TRACE_DETAILLEE From STKIMP
  Endif
  [L]ACTION="AB_CREATION" : Gosub ACTION From GOBJSUB : Goto FIN_GENSMR
Elsif GREP="A"
  Unlock=[L]SYMBOL2
Endif
#-----
$FIN_GENSMR
Return


#------------#
# Fin import #
#------------#
$IMP_FERME
If GSTK_TRACE=2
  GSTK_ACT="FERME" : GSTK_PGM="GOBJSUB" : Gosub TRACE_DETAILLEE From STKIMP
Endif
#--- X3-245824 by TS
# Issue number - 2019-11-14 by WHA : comment
#If GWEBSERV & [F:SMH]VCRNUM<>""
If GAXTREEM & [F:SMH]VCRNUM<>""
#---
  Call ECR_TRACE("[[VCRNUM:"+num$([F:SMH]VCRNUM)+"]]",0) From GESECRAN
Endif
# End issue number
[L]ACTION="FERME"       : Gosub ACTION From GOBJSUB : Gosub DEFAUT From WOSMR
GSTK_ACTION="IMP_FERME" : Gosub ACTION From STKIMP
Kill GSTK_ACTION, GSTK_BASTAB, GSTK_TRSTYP, GSTK_VCRTYP, GSTK_TRACE
Return
**********
7,"TRT","IMPSMRS",""
2,"TRT","SPESCS","Stock change transactions"
#<AdxTL>@(#)0.0.0.0 $Revision$
$ACTION
  Case ACTION
    When "APRES_CRE" : Gosub APRES_CRE
    When Default
  Endcase
Return

###################################################

$APRES_CRE

  If dim(GYVCRENT)>0
    GYVCRENT = [M:SCS1]VCRNUM
  Endif

Return
**********
7,"TRT","SPESCS","Stock change transactions"
2,"TRT","SPESMO","Uscite diverse"
#<AdxTL>@(#)0.0.0.0 $Revision$
$ACTION
  Case ACTION
    When "APRES_CRE" : Gosub APRES_CRE
    When Default
  Endcase
Return

###################################################

$APRES_CRE

  If dim(GYVCRENT)>0
    GYVCRENT = [M:SMO0]VCRNUM
  Endif

Return
**********
7,"TRT","SPESMO","Uscite diverse"
2,"TRT","SPESMR","Miscellaneous receipts"
#<AdxTL>@(#)0.0.0.0 $Revision$
$ACTION
  Case ACTION
    When "APRES_CRE" : Gosub APRES_CRE
    When Default
  Endcase
Return

###################################################

$APRES_CRE

  If dim(GYVCRENT)>0
    GYVCRENT = [M:SMR0]VCRNUM
  Endif

Return
**********
7,"TRT","SPESMR","Miscellaneous receipts"
2,"TRT","YAX3MCRMLIB",""
#<AdxTL>@(#)0.0.0.0 $Revision$
################################################################################################
#                     LIBRERIA  per Funzioni utilizzate in ambito CRM
################################################################################################

Funprog YREGSTRINGCHECK(YSTRINGTOCHECK)

  Value Char YSTRINGTOCHECK

  # intero usato anche per condizione per ciclo while
  Local Integer YRES: YRES = 0
  Local Char YCHARSVIETATI(50): [L]YCHARSVIETATI = "!£$%&/()=?^[]+:;,#@§*\|<>'_°"
  Local Integer YSTRINGLEN: [L]YSTRINGLEN = len(YCHARSVIETATI)
  Local Integer YINDEX : YINDEX =1
  Local Char YSELCHAR(1)

  If(vireblc(YSTRINGTOCHECK,2) <> AVOID.ACHAR)
    While (YRES=0 & YINDEX <= YSTRINGLEN)

      YSELCHAR = xgetchar(YCHARSVIETATI,YINDEX)
      If (instr(0,YSTRINGTOCHECK,YSELCHAR) <> 0)
        YRES=1
      Endif

      YINDEX +=1
    Wend
  Endif

End YRES

################################################################################
#**
#* Funzione per controllare se un Numero di Tel è ben formato
#*
#* @param YTELSTRINGTOCHECK Alfanumerico associato al N° Telefonico
#*!

Funprog YREG_TELSTRINGCHECK(YTELSTRINGTOCHECK)

  Value Char YTELSTRINGTOCHECK
  Local Integer YRES: YRES = 0
  Local Char YCHARSVIETATI(250): [L]YCHARSVIETATI = "!£$%&/()=?^[]:;,#@§*\|<>'_°abcdefghijklmnopqrstuvwxyz"
  Local Integer YSTRINGLEN: [L]YSTRINGLEN = len(YCHARSVIETATI)
  Local Integer YINDEX : YINDEX =1
  Local Char YSELCHAR(1)

  If(vireblc(YTELSTRINGTOCHECK,2) <> AVOID.ACHAR)
    While (YRES=0 & YINDEX <= YSTRINGLEN)
      YSELCHAR = xgetchar(YCHARSVIETATI,YINDEX)
      YRES = func YUTILS.IIF(instr(0,YTELSTRINGTOCHECK,YSELCHAR) <> 0,1,0)
      YINDEX +=1
    Wend
  Endif

  If(YRES=0)
    YRES = func YUTILS.IIF(instr(1,YTELSTRINGTOCHECK,"+") <> 0,1,0)
  Endif

End YRES

############################################################################################
Funprog YIS_TELVALID(YTEL)

  Value Char YTEL
  Local Integer YRES: YRES = 0


End YRES

############################################################################################
Funprog YIS_MAILVALID(YMAIL)

  Value Char YMAIL
  Local Integer YRES: YRES = 0


End YRES

############################################################################################

Funprog YIS_WEBVALID(YFWEB)

  Value Char YFWEB
  Local Integer YRES: YRES = 0


End YRES


############################################################################################
#**
#* Metodo per popolare un array vuoto passato per riferimento con i codici ISO UE
#*
#* @param UEISOCODES Array dei codici UE ISO
#*!
Subprog YGET_UEISO_CODE(UEISOCODES)

  Variable Char UEISOCODES()()

  UEISOCODES(0)= "AT" : UEISOCODES(1)= "BE" : UEISOCODES(2)= "BG" : UEISOCODES(3)= "CY"
  UEISOCODES(4)= "CZ" : UEISOCODES(5)= "DE" : UEISOCODES(6)= "DK" : UEISOCODES(7)= "EE"
  UEISOCODES(8)= "EL" : UEISOCODES(9)= "ES" : UEISOCODES(10)= "FI" : UEISOCODES(11)= "FR"
  UEISOCODES(12)= "HR" : UEISOCODES(13)= "HU" : UEISOCODES(14)= "IE" : UEISOCODES(15)= "IT"
  UEISOCODES(16)= "LT" : UEISOCODES(17)= "LU" : UEISOCODES(18)= "LV" : UEISOCODES(19)= "MT"
  UEISOCODES(20)= "NL" : UEISOCODES(21)= "PL" : UEISOCODES(22)= "PT" : UEISOCODES(23)= "RO"
  UEISOCODES(24)= "SE" : UEISOCODES(25)= "SI" : UEISOCODES(26)= "SK"
End

############################################################################################
#**
#* Controllo correttezza stringa associata a VAT, se corretta ritorna 0, altrimenti 1
#*
#* @param YVATSTRING stringa VAT
#*!
Funprog YVALIDA_VAT(YVATSTRING)

  Value Char YVATSTRING
  Local Integer YRES,YI
  Local Char UEISOCODES(2)(250)
  Local Char YSPECIALCHARS(50): YSPECIALCHARS = "!£$%&/()=?^ì[]+*çò@à°#ù§-_.:,;<>\|"

  If(len(YVATSTRING)<4)
    YRES = 1
  Else
    #controllo primi 2 caratteri: UE ISO CODE
    #For YI = 0 To func YUTILS.COUN
    #controllo parte restante
  Endif
End YRES

############################################################################################
**********
7,"TRT","YAX3MCRMLIB",""
2,"TRT","YAX3MSELACCCODBPC",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$ACTION

  Case ACTION

    When "SEL_TABLE"    : Gosub SEL_TABLE
    When "FIN"          : Gosub FIN
    When Default
  Endcase

Return

###############################################################

$INIT

  Local Char FUNCTION(5) : FUNCTION = "YBPC"
  Local Char TYPE_FIELD(6) : TYPE_FIELD = "ACCCOD"

Return

###############################################################

$SEL_TABLE

  Gosub INIT
  Local Shortint OPEN : OPEN = 2
  Gosub HANDLE_FILES From YAX3MSEL

  Case COUZON
    When "YSELACCCOD" : Gosub S_YSELACCCOD
  Endcase

Return

################################################################

$S_YSELACCCOD

  Gosub INIT

  Local Char PARAMS(250)(2)
  PARAMS(0) = "ITA"
  PARAMS(1) = [M:YBPC]ACCCOD

  Local Shortint IS_MOBILE : IS_MOBILE = 1
  Gosub CONFIG_GRID From YAX3MSEL
Return

################################################################

$FIN

  Gosub INIT
  Local Shortint OPEN : OPEN = 1
  Gosub HANDLE_FILES From YAX3MSEL

Return
**********
7,"TRT","YAX3MSELACCCODBPC",""
2,"TRT","YAX3MSELACCLNK",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$INIT_GRID
  Local Char TIT(250)(NUM_COLS)
  Local Char COL(250)(NUM_COLS)
  Local Char FIELDS(20)(NUM_COLS)
  Local Integer NBCOL
Return

# Gestione Selezione BPAADD per Funzione ###################################################################################

#YBPC
$ACC_BPC

  Gosub SET_LINK_YBPC

#Infbox "3 - RWCCNT = "- num$(rowcount([LNK]))

  If (IS_MOBILE = 1)
    Gosub INIT_CRITERE_YBPC_FIELDS
  Endif

  Gosub SET_CRITERE_YBPC
  Gosub SET_TITCOL_YBPC
Return

#########################################################################################à
$SET_LINK_YBPC

Return

#####################################################################################
$INIT_CRITERE_YBPC_FIELDS

Return

#######################################################################################

$SET_CRITERE_YBPC

  NUM_COLS = 2

  If IS_MOBILE = 2
    Gosub INIT_GRID
    Filter [LNK] Where evalue(CRITERE)
    COUNT_VALUES = rowcount([LNK])
    FIELDS(0) = "ACCCOD" : FIELDS(1) = "DES"
    NBCOL = 0
  Else
    GSELFAC = 1
    TIT(0) = "Selezione Cod.Contabile"
    ORDRE = "[F:LNK]ACCCOD"
    START = "[F:LNK]ACCCOD"
    DEFPAG = 1
    NBCOL = 1

    Local Char CRITERE(250)
    CRITERE = "1=1 &"-"[F:LNK]COA = '" + PARAMS(0) + "'"
    If(vireblc(PARAMS(1),2)<> AVOID.ACHAR)
      Local Char YACCCOD(10): YACCCOD = vireblc(PARAMS(1),2)
      CRITERE-= "& instr(1, tolower([F:LNK]ACCCOD), tolower('" + YACCCOD + "'))<>0"
    Endif
  Endif
Return

################################################################################à

$SET_TITCOL_YBPC

  Default File [LNK]

  #Imposto Colonne Lookup
  Call TEXTFIC("GACCCODE","ACCCOD",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:LNK]ACCCOD"
  NBCOL += 1 : Call TEXTFIC("GACCCODE","DES",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:LNK]DES"

Return
**********
7,"TRT","YAX3MSELACCLNK",""
2,"TRT","YAX3MSELBADBPC",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$ACTION

  Case ACTION

    When "SEL_TABLE"    : Gosub SEL_TABLE
    When "FIN"          : Gosub FIN
    When Default
  Endcase

Return

$INIT

  Local Char FUNCTION(5) : FUNCTION = "YBPC"
  Local Char TYPE_FIELD(6) : TYPE_FIELD = "BPAADD"

Return

$SEL_TABLE

  Gosub INIT
  Local Shortint OPEN : OPEN = 2
  Gosub HANDLE_FILES From YAX3MSEL

  Case COUZON
    When "YSELBPAD" : Gosub S_YSELBPAD
  Endcase

Return

$S_YSELBPAD

  Gosub INIT

  Local Char PARAMS(250)(1)
  Local Shortint IS_MOBILE : IS_MOBILE = 1
  Gosub CONFIG_GRID From YAX3MSEL

Return

$FIN

  Gosub INIT
  Local Shortint OPEN : OPEN = 1
  Gosub HANDLE_FILES From YAX3MSEL

Return
**********
7,"TRT","YAX3MSELBADBPC",""
2,"TRT","YAX3MSELBPAADDLNK",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$INIT_GRID
  Local Char TIT(250)(NUM_COLS)
  Local Char COL(250)(NUM_COLS)
  Local Char FIELDS(20)(NUM_COLS)
  Local Integer NBCOL
Return

# Gestione Selezione BPAADD per Funzione ###################################################################################

#YBPC
$BPAADD_BPC

  Gosub SET_LINK_YBPC

  If (IS_MOBILE = 1)
    Gosub INIT_CRITERE_YBPC_FIELDS
  Endif

  Gosub SET_CRITERE_YBPC
  Gosub SET_TITCOL_YBPC
Return

#########################################################################################à
$SET_LINK_YBPC

  Filter [LNK] Where ([LNK]CODFIC="ATABDIV" & [LNK]IDENT1 = "13370" & [LNK]ZONE="LNGDES" & [LNK]LANGUE="ITA")

Return

#####################################################################################
$INIT_CRITERE_YBPC_FIELDS

Return

#######################################################################################

$SET_CRITERE_YBPC

  NUM_COLS = 2

  If IS_MOBILE = 2
    Gosub INIT_GRID
    #Filter [LNK] Where evalue(CRITERE)
    #Filter [LNK]
    COUNT_VALUES = rowcount([LNK])
    FIELDS(0) = "BPAADD" : FIELDS(1) = "Descrizione"
    NBCOL = 0
  Else
    GSELFAC = 1
    TIT(0) = "Selezione Tipologia Indirizzo"
#      ORDRE = "[F:YITM]ITMREF;[F:YITM]ITMDES1"
#      START = "[F:YITM]ITMREF"
    DEFPAG = 1
    NBCOL = 1

    Local Char CRITERE(250)
    CRITERE = "1=1"
  Endif

Return

################################################################################à

$SET_TITCOL_YBPC

  Default File [LNK]

  #Imposto Colonne Lookup
  TIT(NBCOL) = "Tipologia Indirizzo"
  COL(NBCOL)="[F:LNK]IDENT2"
  NBCOL += 1 : TIT(NBCOL) = "Descrizione"
  COL(NBCOL)="[F:LNK]TEXTE"
Return
**********
7,"TRT","YAX3MSELBPAADDLNK",""
2,"TRT","YAX3MSELBPCNUMBPC",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$ACTION

  Case ACTION

    When "SEL_TABLE"    : Gosub SEL_TABLE
    When "FIN"          : Gosub FIN
    When Default
  Endcase

Return

$INIT

  Local Char FUNCTION(5) : FUNCTION = "YBPC"
  Local Char TYPE_FIELD(6) : TYPE_FIELD = "BPCNUM"

Return

$SEL_TABLE

  Gosub INIT
  Local Shortint OPEN : OPEN = 2
  Gosub HANDLE_FILES From YAX3MSEL
  Case COUZON
    When "YSELBPC" : Gosub S_YSELBPC
  Endcase

Return

$S_YSELBPC

  Gosub INIT

  Local Char PARAMS(250)(1)
  PARAMS(0) = [M:YBPC]BPCNUM
  Local Shortint IS_MOBILE : IS_MOBILE = 1
  Gosub CONFIG_GRID From YAX3MSEL

Return


$FIN

  Gosub INIT
  Local Shortint OPEN : OPEN = 1
  Gosub HANDLE_FILES From YAX3MSEL

Return
**********
7,"TRT","YAX3MSELBPCNUMBPC",""
2,"TRT","YAX3MSELBPCNUMLNK",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$INIT_GRID
  Local Char TIT(250)(NUM_COLS)
  Local Char COL(250)(NUM_COLS)
  Local Char FIELDS(20)(NUM_COLS)
  Local Integer NBCOL
Return

# Gestione Selezione BPAADD per Funzione ###################################################################################

#YBPC
$BPCNUM_BPC

  Gosub SET_LINK_YBPC

#Infbox "3 - RWCCNT = "- num$(rowcount([LNK]))

  If (IS_MOBILE = 1)
    Gosub INIT_CRITERE_YBPC_FIELDS
  Endif

  Gosub SET_CRITERE_YBPC
  Gosub SET_TITCOL_YBPC
Return

#########################################################################################à
$SET_LINK_YBPC

  Link [YBPC] With
& [YBPA]BPA0=1;[F:YBPC]BPCNUM;[F:YBPC]BPAADD,
& [YBPR]BPR0=[F:YBPC]BPCNUM,
& [YBCG]BCG0=[F:YBPC]BCGCOD,
& [YREP]REP0=[F:YBPC]REP
& As [LNK]

Return

#####################################################################################
$INIT_CRITERE_YBPC_FIELDS

Return

#######################################################################################

$SET_CRITERE_YBPC

  NUM_COLS = 2

  If IS_MOBILE = 2
    Gosub INIT_GRID
    Filter [LNK] Where evalue(CRITERE)
    COUNT_VALUES = rowcount([LNK])
    FIELDS(0) = "BPCNUM" : FIELDS(1) = "BPCNAM"
    NBCOL = 0
  Else
    GSELFAC = 1
    TIT(0) = "Selezione Cliente"
    ORDRE = "[F:YBPC]BPCNUM"
    START = "[F:YBPC]BPCNUM"
    DEFPAG = 1
    NBCOL = 1

    Local Char CRITERE(250)
    CRITERE = "1=1"
    If(vireblc(PARAMS(0),2)<> AVOID.ACHAR)
      Local Char YBPCNUM(15): YBPCNUM = vireblc(PARAMS(0),2)
      CRITERE-= "& instr(1, tolower([F:YBPC]BPCNUM), tolower('" + YBPCNUM + "'))<>0"
    Endif
  Endif
Return

################################################################################à

$SET_TITCOL_YBPC

  Default File [LNK]

  #Imposto Colonne Lookup
  Call TEXTFIC("BPCUSTOMER","BPCNUM",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YBPC]BPCNUM"
  NBCOL += 1 : Call TEXTFIC("BPCUSTOMER","BPCNAM",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YBPC]BPCNAM"

Return
**********
7,"TRT","YAX3MSELBPCNUMLNK",""
2,"TRT","YAX3MSELCTYBPC",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$ACTION

  Case ACTION

    When "SEL_TABLE"    : Gosub SEL_TABLE
    When "FIN"          : Gosub FIN
    When Default
  Endcase

Return

$INIT

  Local Char FUNCTION(5) : FUNCTION = "YBPC"
  Local Char TYPE_FIELD(6) : TYPE_FIELD = "CTY"

Return

$SEL_TABLE

  Gosub INIT
  Local Shortint OPEN : OPEN = 2
  Gosub HANDLE_FILES From YAX3MSEL

  Case COUZON
    When "YSELCTY" : Gosub S_YSELCTY
  Endcase

Return

$S_YSELCTY

  Gosub INIT

  Local Char PARAMS(250)(1)
  PARAMS(0)= [M:YBPC]CRY
  Local Shortint IS_MOBILE : IS_MOBILE = 1
  Gosub CONFIG_GRID From YAX3MSEL

Return

$FIN

  Gosub INIT
  Local Shortint OPEN : OPEN = 1
  Gosub HANDLE_FILES From YAX3MSEL

Return
**********
7,"TRT","YAX3MSELCTYBPC",""
2,"TRT","YAX3MSELCUSTOM",""
#<AdxTL>@(#)0.0.0.0 $Revision$
###############################################################################################################################################
#                                                 SEL CUSTOM per campi per varie funzioni
###############################################################################################################################################

# Elenco delle SELEZIONI CUSTOM per i vari campi, divise per Funzione

#================================================================= ENTRATE ====================================================================

#Selezione Ubicazione (LOC) per Entrate Diverse (ENT)

#**
#* Selezione ubicazione funzione entrate diverse
#*
#* @param FCY prova
#* @param ITMREF
#* @param QUERY
#* @param RESPONSE
#*!
Subprog SEL_LOCENT(FCY, ITMREF, LOC, QUERY, RESPONSE)

  Value Char FCY
  Value Char ITMREF
  Value Char LOC
  Value Char QUERY
  Variable Clbfile RESPONSE

  #parametrizzazioni iniziali
  Local Char FUNCTION(10) : FUNCTION = "USC"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "LOC"
  Local Char PARAMS(250)(1) :  PARAMS(0) = ITMREF
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YITF]STOFCY = '" + FCY + "' & [F:YITF]ITMREF = '" + ITMREF + "' & [F:YSTC]LOKSTA <> 2"

  #QUI voglio che il valore di LOC filtri già il recordset della SEL
  If(vireblc(LOC,2)<> AVOID.ACHAR)
    #QUERY = LOC
  Endif

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#Selezione Articolo (ITMREF) per Entrate Diverse (ENT)

Subprog SEL_ITMENT(FCY,ITMREF,QUERY, RESPONSE)

  Value Char FCY
  Value Char ITMREF
  Value Char QUERY
  Variable Clbfile RESPONSE

Call OUVRE_TRACE("SEL_ITMENT") From LECFIC

  #parametrizzazioni iniziali
  Local Char FUNCTION(10) : FUNCTION = "ENT"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "ITM"
  Local Char PARAMS(250)(1) :  PARAMS(0) = FCY
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YITF]STOFCY = '" + FCY + "'"

  #array opzionale( solo in caso di selezione multicustom)(ATTENZIONE!: associato a subprg: SEL_MULTICUSTOM)
  Local Char SELECTEDFIELDS(15)(2): SELECTEDFIELDS(0) = "SERNUM" : SELECTEDFIELDS(1) = "TCLCOD"

  #QUI voglio che il valore di ITMREF filtri già il recordset della SEL

Call ECR_TRACE("Itmref -SEL_ITMENT :" - FCY- "-"-ITMREF,0) From GESECRAN

  If(vireblc(ITMREF,2)<> AVOID.ACHAR)
    CRITERE(0)-= "& instr(1, tolower([F:YITF]ITMREF), tolower('" + ITMREF + "'))<>0"
  Endif

  #Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL
  Call SEL_MULTICUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, SELECTEDFIELDS, RESPONSE) From YAX3MSEL

  Call YPRINT_CLB(RESPONSE, "RESPONSE_" + "selmulticustom_"+FUNCTION+"_"+TYPE_FIELD, "json") From YUTILS
Call FERME_TRACE From LECFIC

End

#================================================================= USCITE ====================================================================

#Selezione Ubicazione (LOC) per Uscite Diverse (USC)

Subprog SEL_LOCUSC(FCY, ITMREF, QUERY, RESPONSE)

  Value Char FCY
  Value Char ITMREF
  Value Char QUERY
  Variable Clbfile RESPONSE

  #parametrizzazioni iniziali
  Local Char FUNCTION(10) : FUNCTION = "USC"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "LOC"
  Local Char PARAMS(250)(1) :  PARAMS(0) = ITMREF
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YITF]STOFCY = '" + FCY + "' & [F:YITF]ITMREF = '" + ITMREF + "' & [F:YSTC]LOKSTA <> 2"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#Selezione Cod.Articolo (ITMREF) per Uscite Diverse (USC)

Subprog SEL_ITMUSC(FCY, QUERY, RESPONSE)

  Value Char FCY
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "USC"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "ITM"
  Local Char PARAMS(250)(1) :  PARAMS(0) = FCY
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YITF]STOFCY = '" + FCY + "'"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#Selezione Lotto (LOT) per Uscite Diverse (USC)

Subprog SEL_LOTUSC(FCY, ITMREF, QUERY, RESPONSE)
  Value Char FCY
  Value Char ITMREF
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "USC"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "LOT"
  Local Char PARAMS(250)(1) :  PARAMS(0) = ITMREF
  #Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YITF]STOFCY = '" + FCY + "' & [F:YITF]ITMREF = '" + ITMREF + "' & [F:YITM]LOTMGTCOD > 2"
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YSLF]STOFCY = '" + FCY + "' & [F:YSLF]ITMREF = '" + ITMREF + "'"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End


###########TEMPORANEA
Subprog SEL_MULTILOTUSC(FCY, ITMREF, QUERY, SELECTIONFIELDS, RESPONSE)
  Value Char FCY
  Value Char ITMREF
  Value Char QUERY
  Value Char SELECTIONFIELDS()()
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "USC"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "LOT"
  Local Char PARAMS(250)(1) :  PARAMS(0) = ITMREF
  #Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YITF]STOFCY = '" + FCY + "' & [F:YITF]ITMREF = '" + ITMREF + "' & [F:YITM]LOTMGTCOD > 2"
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YSLF]STOFCY = '" + FCY + "' & [F:YSLF]ITMREF = '" + ITMREF + "'"

  #Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL
  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL1
End

#================================================================= YSOH - ORDINI DI VENDITA ====================================================================

#Selezione Tipo Ordine (SOHTYP) per OdV

Subprog SEL_TSOSOH(QUERY, RESPONSE)
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "SOH"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "TSO"
  Local Char PARAMS(250)(1)
  Local Char CRITERE(250)(1)

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#Selezione Cod.Articolo (ITMREF) per Ordini di Vendita

Subprog SEL_ITMSOH(FCY, QUERY, RESPONSE)

  Value Char FCY
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "SOH"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "ITM"
  Local Char PARAMS(250)(1) :  PARAMS(0) = FCY
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YITF]STOFCY = '" + FCY + "'"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#====================================================== CALCOLO GIACENZE ====================================================================

#Selezione Ubicazione (LOC) per Calcolo Giacenze

Subprog SEL_LOCGC(FCY, QUERY, RESPONSE)

  Value Char FCY
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "YCGC1"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "LOC"
  Local Char PARAMS(250)(1)
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YSTO]STOFCY = '" + FCY  + "' & [F:YSTC]LOKSTA <> 2"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#============================================= YBPC-CREAZIONE CLIENTI =======================================================

#Selezione Cliente

Subprog SEL_BPCBPC(BPCNUM,QUERY, RESPONSE)

  Value Char BPCNUM
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "YBPC"
  Local Char TYPE_FIELD(6) : TYPE_FIELD = "BPCNUM"
  Local Char PARAMS(250)(1)
  Local Char CRITERE(250)(1) : CRITERE(0) = "1=1"

  If(vireblc(BPCNUM,2)<> AVOID.ACHAR)
    Local Char YBPCNUM(15): YBPCNUM = vireblc(BPCNUM,2)
    CRITERE(0)-= "& instr(1, tolower([F:YBPC]BPCNUM), tolower('" + YBPCNUM + "'))<>0"
  Endif

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL
End

#Sel VACBPR ( Regime IVA)

Subprog SEL_VACBPC(VACBPR,QUERY, RESPONSE)

  Value Char VACBPR
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "YBPC"
  Local Char TYPE_FIELD(6) : TYPE_FIELD = "VACBPR"
  Local Char PARAMS(250)(1): PARAMS(0) = "ITA"
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:LNK]LEG = '" + PARAMS(0) + "'"

  If(vireblc(VACBPR,2)<> AVOID.ACHAR)
    Local Char YVACBPR(5): YVACBPR = vireblc(VACBPR,2)
    CRITERE(0)-= "& instr(1, tolower([F:LNK]VACBPR), tolower('" + YVACBPR + "'))<>0"
  Endif

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL
End

#Selezione PTE: Cond. pagamento

Subprog SEL_PTEBPC(PTE,QUERY, RESPONSE)

  Value Char PTE
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "YBPC"
  Local Char TYPE_FIELD(6) : TYPE_FIELD = "PTE"
  Local Char PARAMS(250)(3): PARAMS(0) = "ITA" : PARAMS(1)= num$(1)
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:LNK]LEG = '" + PARAMS(0) + "'"#-"& [F:LNK]PTELIN ="+PARAMS(1)

  If(vireblc(PTE,2)<> AVOID.ACHAR)
    Local Char YPTE(5): YPTE = vireblc(PTE,2)
    CRITERE(0)-= "& instr(1, tolower([F:LNK]PTE), tolower('" + YPTE + "'))<>0"
  Endif

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL
End

#Selezione ACCCOD: Cod contabile

Subprog SEL_ACCBPC(ACCCOD,QUERY, RESPONSE)

  Value Char ACCCOD
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "YBPC"
  Local Char TYPE_FIELD(6) : TYPE_FIELD = "ACCCOD"
  Local Char PARAMS(250)(1): PARAMS(0) = "ITA"
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:LNK]COA = '" + PARAMS(0) + "'"

  If(vireblc(ACCCOD,2)<> AVOID.ACHAR)
    Local Char YACCCOD(10): YACCCOD = vireblc(ACCCOD,2)
    CRITERE(0)-= "& instr(1, tolower([F:LNK]ACCCOD), tolower('" + YACCCOD + "'))<>0"
  Endif

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL
End

#Selezione Tipologia Indirizzi (BPAADD)

Subprog SEL_BADBPC(QUERY, RESPONSE)

  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "YBPC"
  Local Char TYPE_FIELD(6) : TYPE_FIELD = "BPAADD"
  Local Char PARAMS(250)(1)
  Local Char CRITERE(250)(1) : CRITERE(0) = "1=1"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#Selezione Cap(POSCOD)

Subprog SEL_PCDBPC(CRY,QUERY, RESPONSE)

  Value Char CRY
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "YBPC"
  Local Char TYPE_FIELD(6) : TYPE_FIELD = "POSCOD"
  Local Char PARAMS(250)(1): PARAMS(0) = CRY
  Local Char CRITERE(250)(1) : CRITERE(0) = "1=1"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#Selezione Città (CTY)

Subprog SEL_CTYBPC(CRY,QUERY, RESPONSE)

  Value Char CRY
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "YBPC"
  Local Char TYPE_FIELD(6) : TYPE_FIELD = "CTY"
  Local Char PARAMS(250)(1): PARAMS(0) = CRY
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YPOS]CRY = '" + PARAMS(0) + "'"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#========================================= YVBPC - RICERCA CLIENTI (CONS) ====================================================
Subprog SEL_BDVBPC(QUERY, RESPONSE)

  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "YVBPC"
  Local Char TYPE_FIELD(6) : TYPE_FIELD = "BPAADD"
  Local Char PARAMS(250)(1)
  Local Char CRITERE(250)(1) : CRITERE(0) = "1=1"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#======================================= YCSTK - CAMBIO STOCK =================================================================

#Selezione Tipo Movimento (per X3 : YAX3MSELSGHCSTK)
Subprog SEL_SGHSTK(FCY,QUERY,RESPONSE)

  Value Char FCY
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "YCSTK"
  Local Char TYPE_FIELD(6) : TYPE_FIELD = "SGHTYP"
  Local Char PARAMS(250)(1): PARAMS(0) = FCY
  Local Char CRITERE(250)(1) : CRITERE(0) = "1=1"
#TODO: compila Critere

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#Selezione LOC Destinazione  (per X3 : YAX3MSELLOCCSTK)

Subprog SEL_LCDSTK(FCY,QUERY,RESPONSE)

  Value Char FCY
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "YCSTK"
  Local Char TYPE_FIELD(6) : TYPE_FIELD = "LOCD"
  Local Char PARAMS(250)(1): PARAMS(0) = FCY
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YSTC]STOFCY = '" + PARAMS(0) + "' & [F:YSTC]LOKSTA <> 2"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#Selezione LOC Origine (per X3 : YAX3MSELLOCCSTK)

Subprog SEL_LOCSTK(FCY,QUERY,RESPONSE)

  Value Char FCY
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "YCSTK"
  Local Char TYPE_FIELD(6) : TYPE_FIELD = "LOC"
  Local Char PARAMS(250)(1): PARAMS(0) = FCY
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YSTC]STOFCY = '" + PARAMS(0) + "' & [F:YSTC]LOKSTA <> 2"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#Selezione Articolo (per X3 : YAX3MSELITMCSTK)
Subprog SEL_ITMSTK(FCY, LOC, QUERY, RESPONSE)

  Value Char FCY
  Value Char LOC
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "YCSTK"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "ITM"
  Local Char PARAMS(250)(2) :  PARAMS(0) = FCY : PARAMS(1) = LOC
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YSTO]STOFCY = '" + PARAMS(0) + "' & [F:YSTO]LOC = '" + PARAMS(1) + "'"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#Selezione Lotto  (per X3 : YAX3MSELLOTCSTK)

Subprog SEL_LOTSTK(FCY, ITMREF,LOC, QUERY, RESPONSE)

  Value Char FCY
  Value Char ITMREF
  Value Char LOC
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "YCSTK"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "LOT"
  Local Char PARAMS(250)(3) :  PARAMS(0) = FCY : PARAMS(1)= ITMREF : PARAMS(2) = LOC
  Local Char CRITERE(250)(1)

  CRITERE(0) = "[F:LNK]ITMREF='"+PARAMS(1)+"'"
  CRITERE(0) -= "& [F:LNK]STOFCY='"+PARAMS(0)+"'"
  CRITERE(0) -= "& [F:LNK]LOT <>AVOID.ACHAR"
  CRITERE(0) -= "& [F:LNK]LOC='"+PARAMS(2)+"'"
  CRITERE(0) -= "& [F:LNK]QTYSTU - [LNK]CUMALLQTY - [LNK]CUMWIPQTY >0"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#Selezione Matricola (per X3 : YAX3MSELSERCSTK)
Subprog SEL_SERSTK(FCY, ITMREF, QUERY, RESPONSE)

  Value Char FCY
  Value Char ITMREF
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "YCSTK"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "SER"
  Local Char PARAMS(250)(1) :  PARAMS(0) = FCY : PARAMS(1)= ITMREF
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YSTS]STOFCY = '" + PARAMS(0) + "' & [F:YSTS]ITMREF = '" + PARAMS(1) + "'"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End
**********
7,"TRT","YAX3MSELCUSTOM",""
2,"TRT","YAX3MSELCUSTOM_BCK",""
#<AdxTL>@(#)0.0.0.0 $Revision$
###############################################################################################################################################
#                                                 SEL CUSTOM per campi per varie funzioni
###############################################################################################################################################

###############################################################################################################################################
# VERSIONE: al 21.07.2025
###############################################################################################################################################

# Elenco delle SELEZIONI CUSTOM per i vari campi, divise per Funzione

#================================================================= ENTRATE ====================================================================

#Selezione Ubicazione (LOC) per Entrate Diverse (ENT)

#**
#* Selezione ubicazione funzione entrate diverse
#*
#* @param FCY prova
#* @param ITMREF
#* @param QUERY
#* @param RESPONSE
#*!
Subprog SEL_LOCENT(FCY, ITMREF, QUERY, RESPONSE)

  Value Char FCY
  Value Char ITMREF
  Value Char QUERY
  Variable Clbfile RESPONSE

  #parametrizzazioni iniziali
  Local Char FUNCTION(10) : FUNCTION = "USC"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "LOC"
  Local Char PARAMS(250)(1) :  PARAMS(0) = ITMREF
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YITF]STOFCY = '" + FCY + "' & [F:YITF]ITMREF = '" + ITMREF + "' & [F:YSTC]LOKSTA <> 2"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#Selezione Articolo (ITMREF) per Entrate Diverse (ENT)

Subprog SEL_ITMENT(FCY, QUERY, RESPONSE)

  Value Char FCY
  Value Char QUERY
  Variable Clbfile RESPONSE

  #parametrizzazioni iniziali
  Local Char FUNCTION(10) : FUNCTION = "ENT"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "ITM"
  Local Char PARAMS(250)(1) :  PARAMS(0) = FCY
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YITF]STOFCY = '" + FCY + "'"

  #array opzionale( solo in caso di selezione multicustom)(ATTENZIONE!: associato a subprg: SEL_MULTICUSTOM)
  Local Char SELECTEDFIELDS(15)(2): SELECTEDFIELDS(0) = "SERNUM" : SELECTEDFIELDS(1) = "TCLCOD"

  #Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL
  Call SEL_MULTICUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, SELECTEDFIELDS, RESPONSE) From YAX3MSEL


  Call YPRINT_CLB(RESPONSE, "RESPONSE_" + "selmulticustom_"+FUNCTION+"_"+TYPE_FIELD, "json") From YUTILS

End

#================================================================= USCITE ====================================================================

#Selezione Ubicazione (LOC) per Uscite Diverse (USC)

Subprog SEL_LOCUSC(FCY, ITMREF, QUERY, RESPONSE)

  Value Char FCY
  Value Char ITMREF
  Value Char QUERY
  Variable Clbfile RESPONSE

  #parametrizzazioni iniziali
  Local Char FUNCTION(10) : FUNCTION = "USC"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "LOC"
  Local Char PARAMS(250)(1) :  PARAMS(0) = ITMREF
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YITF]STOFCY = '" + FCY + "' & [F:YITF]ITMREF = '" + ITMREF + "' & [F:YSTC]LOKSTA <> 2"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#Selezione Cod.Articolo (ITMREF) per Uscite Diverse (USC)

Subprog SEL_ITMUSC(FCY, QUERY, RESPONSE)

  Value Char FCY
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "USC"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "ITM"
  Local Char PARAMS(250)(1) :  PARAMS(0) = FCY
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YITF]STOFCY = '" + FCY + "'"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#Selezione Lotto (LOT) per Uscite Diverse (USC)

Subprog SEL_LOTUSC(FCY, ITMREF, QUERY, RESPONSE)
  Value Char FCY
  Value Char ITMREF
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "USC"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "LOT"
  Local Char PARAMS(250)(1) :  PARAMS(0) = ITMREF
  #Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YITF]STOFCY = '" + FCY + "' & [F:YITF]ITMREF = '" + ITMREF + "' & [F:YITM]LOTMGTCOD > 2"
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YSLF]STOFCY = '" + FCY + "' & [F:YSLF]ITMREF = '" + ITMREF + "'"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End


###########TEMPORANEA
Subprog SEL_MULTILOTUSC(FCY, ITMREF, QUERY, SELECTIONFIELDS, RESPONSE)
  Value Char FCY
  Value Char ITMREF
  Value Char QUERY
  Value Char SELECTIONFIELDS()()
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "USC"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "LOT"
  Local Char PARAMS(250)(1) :  PARAMS(0) = ITMREF
  #Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YITF]STOFCY = '" + FCY + "' & [F:YITF]ITMREF = '" + ITMREF + "' & [F:YITM]LOTMGTCOD > 2"
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YSLF]STOFCY = '" + FCY + "' & [F:YSLF]ITMREF = '" + ITMREF + "'"

  #Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL
  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL1
End

#================================================================= YSOH - ORDINI DI VENDITA ====================================================================

#Selezione Tipo Ordine (SOHTYP) per OdV

Subprog SEL_TSOSOH(QUERY, RESPONSE)
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "SOH"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "TSO"
  Local Char PARAMS(250)(1)
  Local Char CRITERE(250)(1)

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#Selezione Cod.Articolo (ITMREF) per Ordini di Vendita

Subprog SEL_ITMSOH(FCY, QUERY, RESPONSE)

  Value Char FCY
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "SOH"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "ITM"
  Local Char PARAMS(250)(1) :  PARAMS(0) = FCY
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YITF]STOFCY = '" + FCY + "'"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#====================================================== CALCOLO GIACENZE ====================================================================

#Selezione Ubicazione (LOC) per Calcolo Giacenze

Subprog SEL_LOCGC(FCY, QUERY, RESPONSE)

  Value Char FCY
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "YCGC1"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "LOC"
  Local Char PARAMS(250)(1)
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YSTO]STOFCY = '" + FCY  + "' & [F:YSTC]LOKSTA <> 2"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#============================================= YBPC-CREAZIONE CLIENTI =======================================================
#Selezione Tipologia Indirizzi (BPAADD)

Subprog SEL_BADBPC(QUERY, RESPONSE)

  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "YBPC"
  Local Char TYPE_FIELD(6) : TYPE_FIELD = "BPAADD"
  Local Char PARAMS(250)(1)
  Local Char CRITERE(250)(1) : CRITERE(0) = "1=1"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#Selezione Cap(POSCOD)

Subprog SEL_PCDBPC(CRY,QUERY, RESPONSE)

  Value Char CRY
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "YBPC"
  Local Char TYPE_FIELD(6) : TYPE_FIELD = "POSCOD"
  Local Char PARAMS(250)(1): PARAMS(0) = CRY
  Local Char CRITERE(250)(1) : CRITERE(0) = "1=1"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#Selezione Città (CTY)

Subprog SEL_CTYBPC(CRY,QUERY, RESPONSE)

  Value Char CRY
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "YBPC"
  Local Char TYPE_FIELD(6) : TYPE_FIELD = "CTY"
  Local Char PARAMS(250)(1): PARAMS(0) = CRY
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YPOS]CRY = '" + PARAMS(0) + "'"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#========================================= YVBPC - RICERCA CLIENTI (CONS) ====================================================
Subprog SEL_BDVBPC(QUERY, RESPONSE)

  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "YVBPC"
  Local Char TYPE_FIELD(6) : TYPE_FIELD = "BPAADD"
  Local Char PARAMS(250)(1)
  Local Char CRITERE(250)(1) : CRITERE(0) = "1=1"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#======================================= YCSTK - CAMBIO STOCK =================================================================

#Selezione Tipo Movimento (per X3 : YAX3MSELSGHCSTK)
Subprog SEL_SGHSTK(FCY,QUERY,RESPONSE)

  Value Char FCY
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "YCSTK"
  Local Char TYPE_FIELD(6) : TYPE_FIELD = "SGHTYP"
  Local Char PARAMS(250)(1): PARAMS(0) = FCY
  Local Char CRITERE(250)(1) : CRITERE(0) = "1=1"
#TODO: compila Critere

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#Selezione LOC Destinazione  (per X3 : YAX3MSELLOCCSTK)

Subprog SEL_LCDSTK(FCY,QUERY,RESPONSE)

  Value Char FCY
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "YCSTK"
  Local Char TYPE_FIELD(6) : TYPE_FIELD = "LOCD"
  Local Char PARAMS(250)(1): PARAMS(0) = FCY
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YSTC]STOFCY = '" + PARAMS(0) + "' & [F:YSTC]LOKSTA <> 2"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#Selezione LOC Origine (per X3 : YAX3MSELLOCCSTK)

Subprog SEL_LOCSTK(FCY,QUERY,RESPONSE)

  Value Char FCY
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "YCSTK"
  Local Char TYPE_FIELD(6) : TYPE_FIELD = "LOC"
  Local Char PARAMS(250)(1): PARAMS(0) = FCY
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YSTC]STOFCY = '" + PARAMS(0) + "' & [F:YSTC]LOKSTA <> 2"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#Selezione Articolo (per X3 : YAX3MSELITMCSTK)
Subprog SEL_ITMSTK(FCY, LOC, QUERY, RESPONSE)

  Value Char FCY
  Value Char LOC
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "YCSTK"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "ITM"
  Local Char PARAMS(250)(2) :  PARAMS(0) = FCY : PARAMS(1) = LOC
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YSTO]STOFCY = '" + PARAMS(0) + "' & [F:YSTO]LOC = '" + PARAMS(1) + "'"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#Selezione Lotto  (per X3 : YAX3MSELLOTCSTK)

Subprog SEL_LOTSTK(FCY, ITMREF,LOC, QUERY, RESPONSE)

  Value Char FCY
  Value Char ITMREF
  Value Char LOC
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "YCSTK"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "LOT"
  Local Char PARAMS(250)(3) :  PARAMS(0) = FCY : PARAMS(1)= ITMREF : PARAMS(2) = LOC
  Local Char CRITERE(250)(1)

  CRITERE(0) = "[F:LNK]ITMREF='"+PARAMS(1)+"'"
  CRITERE(0) -= "& [F:LNK]STOFCY='"+PARAMS(0)+"'"
  CRITERE(0) -= "& [F:LNK]LOT <>AVOID.ACHAR"
  CRITERE(0) -= "& [F:LNK]LOC='"+PARAMS(2)+"'"
  CRITERE(0) -= "& [F:LNK]QTYSTU - [LNK]CUMALLQTY - [LNK]CUMWIPQTY >0"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End

#Selezione Matricola (per X3 : YAX3MSELSERCSTK)
Subprog SEL_SERSTK(FCY, ITMREF, QUERY, RESPONSE)

  Value Char FCY
  Value Char ITMREF
  Value Char QUERY
  Variable Clbfile RESPONSE

  Local Char FUNCTION(10) : FUNCTION = "YCSTK"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "SER"
  Local Char PARAMS(250)(1) :  PARAMS(0) = FCY : PARAMS(1)= ITMREF
  Local Char CRITERE(250)(1) : CRITERE(0) = "[F:YSTS]STOFCY = '" + PARAMS(0) + "' & [F:YSTS]ITMREF = '" + PARAMS(1) + "'"

  Call SEL_CUSTOM(FUNCTION, TYPE_FIELD, PARAMS, CRITERE, QUERY, RESPONSE) From YAX3MSEL

End
**********
7,"TRT","YAX3MSELCUSTOM_BCK",""
2,"TRT","YAX3MSELITMCSTK",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$ACTION

  Case ACTION

    When "SEL_TABLE"    : Gosub SEL_TABLE
    When "FIN"          : Gosub FIN
    When Default
  Endcase

Return

###############################################################

$INIT

  Local Char FUNCTION(5) : FUNCTION = "YCSTK"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "ITM"

Return

###############################################################

$SEL_TABLE

  Gosub INIT
  Local Shortint OPEN : OPEN = 2
  Gosub HANDLE_FILES From YAX3MSEL

  Case COUZON
    When "YSELITM" : Gosub S_YSELITM
  Endcase

Return

################################################################

$S_YSELITM

  Gosub INIT

  Local Char PARAMS(250)(2)
  PARAMS(0) = [M:YCSTK]FCY
  PARAMS(1) = [M:YCSTK]LOC(nolign-1)

  Local Shortint IS_MOBILE : IS_MOBILE = 1
  Gosub CONFIG_GRID From YAX3MSEL
Return

################################################################

$FIN

  Gosub INIT
  Local Shortint OPEN : OPEN = 1
  Gosub HANDLE_FILES From YAX3MSEL

Return
**********
7,"TRT","YAX3MSELITMCSTK",""
2,"TRT","YAX3MSELITMENT",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$ACTION

  Case ACTION

    When "SEL_TABLE"    : Gosub SEL_TABLE
    When "FIN"          : Gosub FIN
    When "VERF_TABLE"   : Gosub VERF_TABLE
    When Default
  Endcase

Return

###############################################################

$INIT

  Local Char FUNCTION(5) : FUNCTION = "ENT"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "ITM"

Return

###############################################################

$SEL_TABLE

  Gosub INIT
  Local Shortint OPEN : OPEN = 2
  Gosub HANDLE_FILES From YAX3MSEL  #apro le tabelle

  Case COUZON
    When "YSELITM" : Gosub S_YSELITM
  Endcase

Return

################################################################

$VERF_TABLE

  [M:YSMR1]SERNUM(nolign -1) = [F:YSTO]SERNUM
  Affzo [M:YSMR1]SERNUM(nolign -1)

Return

################################################################

$S_YSELITM

  Gosub INIT

  Local Char PARAMS(250)(1)
  PARAMS(0) = [M:YSMR1]FCY

  Local Shortint IS_MOBILE : IS_MOBILE = 1
  Gosub CONFIG_GRID From YAX3MSEL

Return

################################################################

$FIN

  Gosub INIT
  Local Shortint OPEN : OPEN = 1
  Gosub HANDLE_FILES From YAX3MSEL

Return
**********
7,"TRT","YAX3MSELITMENT",""
2,"TRT","YAX3MSELITMLNK",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$INIT_GRID
  Local Char TIT(250)(NUM_COLS)
  Local Char COL(250)(NUM_COLS)
  Local Char FIELDS(20)(NUM_COLS)
  Local Integer NBCOL
Return

#########################################################################################################################
# Gestione Selezione ITM per Funzione
#########################################################################################################################

#Entrate
$ITM_ENT

  #Gosub SET_LINK_ENT_USC_SOH
  Gosub SET_LINK_ENT               #sel multi val

  If (IS_MOBILE = 1)
    Gosub INIT_CRITERE_ENT_FIELDS
  Endif

  #Gosub SET_CRITERE_ENT_USC_SOH
  Gosub SET_CRITERE_ENT            #sel multi val

  #Gosub SET_TITCOL_ENT_USC_SOH
  Gosub SET_TITCOL_ENT             #sel multi val

Return

#Uscite
$ITM_USC

  Gosub SET_LINK_ENT_USC_SOH

  If (IS_MOBILE = 1)
    Gosub INIT_CRITERE_USC_FIELDS
  Endif

  Gosub SET_CRITERE_ENT_USC_SOH
  Gosub SET_TITCOL_ENT_USC_SOH
Return


##################################################
#Ordini di Vendita
$ITM_SOH

  Gosub SET_LINK_ENT_USC_SOH

  If (IS_MOBILE = 1)
    Gosub INIT_CRITERE_SOH_FIELDS
  Endif

  Gosub SET_CRITERE_ENT_USC_SOH
  Gosub SET_TITCOL_ENT_USC_SOH
Return

####################################################
#Cambio Stock

$ITM_CSTK

  Gosub SET_LINK_CSTK

  If (IS_MOBILE = 1)
    Gosub INIT_CRITERE_CSTK_FIELDS
  Endif

  Gosub SET_CRITERE_CSTK
  Gosub SET_TITCOL_CSTK
Return

#################################################################################################################################
#                                                           LINKS
#################################################################################################################################
#NOTA: se una link riutilizzabile, nel nome della subroutine utilizzata aggiungere: "_<nuovo nome funzione>

#Link per funzioni: ENT,USC,SOH

$SET_LINK_ENT_USC_SOH

  Link [YITM] With [YITF]ITF0~=[YITM]ITMREF;PARAMS(0)
&             As [LNK]
  Columns [LNK] ([F:YITF]STOFCY,[F:YITM]ITMREF,[F:YITM]ITMDES1,[F:YITM]TCLCOD,[F:YITM]SEAKEY,[F:YITM]EANCOD,[F:YITM]ITMSTA)

Return

#--------------------------------
$SET_LINK_ENT

  Link [YSTO] With [YITF]ITF0~=[YSTO]ITMREF;PARAMS(0),
&                  [YITM]ITM0~=[YSTO]ITMREF
&             As [LNK] Order By [F:YITM]ITMREF;[F:YSTO]SERNUM
  Columns [LNK] ([F:YITF]STOFCY,[F:YITM]ITMREF,[F:YITM]ITMDES1,[F:YITM]TCLCOD,[F:YITM]SEAKEY,[F:YITM]EANCOD,[F:YITM]ITMSTA,[F:YSTO]SERNUM)

Return


############################################################################################################################

$SET_LINK_CSTK

  Link [YSTO] With [YITF]ITF0~=[YSTO]ITMREF;[YSTO]STOFCY,
&                  [YITM]ITM0~=[YSTO]ITMREF
&             As [LNK] Where ([YSTO]STOFCY = PARAMS(0) & [YSTO]LOC = PARAMS(1) & [F:YSTO]STA = "A")

  Columns [LNK] ([F:YITM]ITMREF,[F:YITM]ITMDES1,[F:YITM]TCLCOD,[F:YITM]SEAKEY,[F:YITM]EANCOD,[F:YITM]ITMSTA,[F:YSTO]STOFCY,[F:YSTO]LOC)

Return

##################################################################################################################################
#                                                           SET_TITCOL
##################################################################################################################################

$SET_TITCOL_ENT_USC_SOH

  NUM_COLS = 6
  Default File [LNK]

  Call TEXTFIC("ITMMASTER","ITMREF",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YITM]ITMREF"
  NBCOL += 1 : Call TEXTFIC("ITMMASTER","ITMDES1",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "func AFNC.TEXTRA('ITMMASTER','DES1AXX',[F:YITM]ITMREF,'')"
  NBCOL += 1 : Call TEXTFIC("ITMMASTER","TCLCOD",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YITM]TCLCOD"
  NBCOL += 1 : Call TEXTFIC("ITMMASTER","SEAKEY",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YITM]SEAKEY"
  NBCOL += 1 : Call TEXTFIC("ITMMASTER","EANCOD",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YITM]EANCOD"
  NBCOL += 1 : Call TEXTFIC("ITMMASTER","ITMSTA",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "mess([F:YITM]ITMSTA,246,1)"
Return

#-------------------------------------------------------------------------------------
$SET_TITCOL_ENT

  NUM_COLS = 7
  Default File [LNK]

  Call TEXTFIC("ITMMASTER","ITMREF",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YITM]ITMREF"
  NBCOL += 1 : Call TEXTFIC("ITMMASTER","ITMDES1",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "func AFNC.TEXTRA('ITMMASTER','DES1AXX',[F:YITM]ITMREF,'')"
  NBCOL += 1 : Call TEXTFIC("ITMMASTER","TCLCOD",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YITM]TCLCOD"
  #COL(NBCOL) = "func AFNC.TEXTRA('ITMCATEG','TCLAXX',[F:YITF]STOFCY,[F:YITM]TCLCOD)"
  NBCOL += 1 : Call TEXTFIC("ITMMASTER","SEAKEY",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YITM]SEAKEY"
  NBCOL += 1 : Call TEXTFIC("ITMMASTER","EANCOD",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YITM]EANCOD"
  NBCOL += 1 : Call TEXTFIC("ITMMASTER","ITMSTA",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "mess([F:YITM]ITMSTA,246,1)"
  NBCOL += 1 : Call TEXTFIC("STOCK","SERNUM",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YSTO]SERNUM"
Return

######################################################################################

$SET_TITCOL_CSTK

  NUM_COLS = 6
  Default File [LNK]

  Call TEXTFIC("ITMMASTER","ITMREF",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YITM]ITMREF"
  NBCOL += 1 : Call TEXTFIC("ITMMASTER","ITMDES1",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "func AFNC.TEXTRA('ITMMASTER','DES1AXX',[F:YITM]ITMREF,'')"
  NBCOL += 1 : Call TEXTFIC("ITMMASTER","TCLCOD",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YITM]TCLCOD"
  NBCOL += 1 : Call TEXTFIC("ITMMASTER","SEAKEY",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YITM]SEAKEY"
  NBCOL += 1 : Call TEXTFIC("ITMMASTER","EANCOD",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YITM]EANCOD"
  NBCOL += 1 : Call TEXTFIC("ITMMASTER","ITMSTA",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "mess([F:YITM]ITMSTA,246,1)"

Return

#####################################################################################################
#                                         INIT_CRITERE_FIELDS
#####################################################################################################

$INIT_CRITERE_ENT_FIELDS
  Local Char FCY(5)
  FCY = [M:YSMR1]FCY
Return

$INIT_CRITERE_USC_FIELDS
  Local Char FCY(5)
  FCY = [M:YSMO1]FCY
Return

$INIT_CRITERE_SOH_FIELDS
  Local Char FCY(5)
  FCY = [M:YSOH1]FCY
Return

$INIT_CRITERE_CSTK_FIELDS
Return

#######################################################################################################
#                                              SET_CRITERE
#######################################################################################################

$SET_CRITERE_ENT_USC_SOH

  NUM_COLS = 6

  If IS_MOBILE = 2
    Gosub INIT_GRID
    Filter [LNK] Where evalue(CRITERE) Order By [F:YITM]ITMREF;[F:YITM]ITMDES1
    COUNT_VALUES = rowcount([LNK])
    FIELDS(0) = "ITMREF" : FIELDS(1) = "ITMDES1" : FIELDS(2) = "TCLCOD"
    FIELDS(3) = "SEAKEY" : FIELDS(4) = "EANCOD" : FIELDS(5) = "ITMSTA"
    NBCOL = 0
  Else
    GSELFAC = 1
    TIT(0) = "Selezione articolo"
    ORDRE = "[F:YITM]ITMREF;[F:YITM]ITMDES1"
    START = "[F:YITM]ITMREF"
    DEFPAG = 1
    NBCOL = 1
    Local Char CRITERE(250)
    CRITERE = "[F:YITF]STOFCY = '" + FCY + "'"
  Endif

Return

#----------------------------------------------------------------------------
$SET_CRITERE_ENT

  NUM_COLS = 7

  If IS_MOBILE = 2
    Gosub INIT_GRID
    Filter [LNK] Where evalue(CRITERE) Order By [F:YITM]ITMREF;[F:YITM]ITMDES1;[F:YSTO]SERNUM
    COUNT_VALUES = rowcount([LNK])
    FIELDS(0) = "ITMREF" : FIELDS(1) = "ITMDES1" : FIELDS(2) = "TCLCOD"
    FIELDS(3) = "SEAKEY" : FIELDS(4) = "EANCOD" : FIELDS(5) = "ITMSTA" : FIELDS(6) = "SERNUM"
    NBCOL = 0
  Else
    #GSELFAC = 1
    TIT(0) = "Selezione articolo"
    #ORDRE = "[F:YITM]ITMREF;[F:YITM]ITMDES1"
    ORDRE = "[F:YITM]ITMREF;[F:YITM]ITMDES1;[F:YSTO]SERNUM"
    START = "[F:YITM]ITMREF"
    #DEFPAG = 1
    NBCOL = 1
    Local Char CRITERE(250)
    CRITERE = "[F:YITF]STOFCY = '" + FCY + "'"
  Endif

Return

#########################################################################################

$SET_CRITERE_CSTK

  NUM_COLS = 6

  If IS_MOBILE = 2
    Gosub INIT_GRID
    Filter [LNK] Where evalue(CRITERE) Order By [F:YITM]ITMREF;[F:YITM]ITMDES1
    COUNT_VALUES = rowcount([LNK])
    FIELDS(0) = "ITMREF" : FIELDS(1) = "ITMDES1" : FIELDS(2) = "TCLCOD"
    FIELDS(3) = "SEAKEY" : FIELDS(4) = "EANCOD" : FIELDS(5) = "ITMSTA"
    NBCOL = 0
  Else
    GSELFAC = 1
    TIT(0) = "Selezione articolo"
    ORDRE = "[F:YITM]ITMREF;[F:YITM]ITMDES1"
    START = "[F:YITM]ITMREF"
    DEFPAG = 1
    NBCOL = 1
    Local Char CRITERE(250)
    #CRITERE = "[F:YSTO]STOFCY = '" + FCY + "'"
  Endif

Return
**********
7,"TRT","YAX3MSELITMLNK",""
2,"TRT","YAX3MSELITMSOH",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$ACTION

  Case ACTION

    When "SEL_TABLE"    : Gosub SEL_TABLE
    When "FIN"          : Gosub FIN
    When Default
  Endcase

Return

$INIT

  Local Char FUNCTION(5) : FUNCTION = "SOH"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "ITM"

Return

$SEL_TABLE

  Gosub INIT
  Local Shortint OPEN : OPEN = 2
  Gosub HANDLE_FILES From YAX3MWSLIB

  Case COUZON
    When "YSELITM" : Gosub S_YSELITM
  Endcase

Return

$S_YSELITM

  Gosub INIT

  Local Char PARAMS(250)(1)
  PARAMS(0) = [M:YSOH1]FCY

  Local Shortint IS_MOBILE : IS_MOBILE = 1
  Gosub CONFIG_GRID From YAX3MWSLIB

Return

$FIN

  Gosub INIT
  Local Shortint OPEN : OPEN = 1
  Gosub HANDLE_FILES From YAX3MWSLIB

Return
**********
7,"TRT","YAX3MSELITMSOH",""
2,"TRT","YAX3MSELITMUSC",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$ACTION

  Case ACTION

    When "SEL_TABLE"    : Gosub SEL_TABLE
    When "FIN"          : Gosub FIN
    When Default
  Endcase

Return

$INIT

  Local Char FUNCTION(5) : FUNCTION = "USC"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "ITM"

Return

$SEL_TABLE

  Gosub INIT
  Local Shortint OPEN : OPEN = 2
  Gosub HANDLE_FILES From YAX3MWSLIB

  Case COUZON
    When "YSELITM" : Gosub S_YSELITM
  Endcase

Return

$S_YSELITM

  Gosub INIT

  Local Char PARAMS(250)(1)
  PARAMS(0) = [M:YSMO1]FCY

  Local Shortint IS_MOBILE : IS_MOBILE = 1
  Gosub CONFIG_GRID From YAX3MWSLIB

Return

$FIN

  Gosub INIT
  Local Shortint OPEN : OPEN = 1
  Gosub HANDLE_FILES From YAX3MWSLIB

Return
**********
7,"TRT","YAX3MSELITMUSC",""
2,"TRT","YAX3MSELLOCCSTK",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$ACTION

  Case ACTION

    When "SEL_TABLE"    : Gosub SEL_TABLE
    When "FIN"          : Gosub FIN
    When Default
  Endcase

Return

###############################################################

$INIT

  Local Char FUNCTION(5) : FUNCTION = "YCSTK"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "LOC"

Return

###############################################################

$SEL_TABLE

  Gosub INIT
  Local Shortint OPEN : OPEN = 2
  Gosub HANDLE_FILES From YAX3MSEL

  Case COUZON
    When "YSELLOCD" : Gosub S_YSELLOCD
    When "YSELLOC" : Gosub S_YSELLOC
  Endcase

Return

################################################################

$S_YSELLOCD

  Gosub INIT
  TYPE_FIELD = "LOCD"
  Local Char PARAMS(250)(1)
  PARAMS(0) = [M:YCSTK]FCY

#Infbox "ysellocDest - params(0)=" -PARAMS(0)

  Local Shortint IS_MOBILE : IS_MOBILE = 1
  Gosub CONFIG_GRID From YAX3MSEL
Return

###############################################################

$S_YSELLOC

  Gosub INIT

  Local Char PARAMS(250)(1)
  PARAMS(0) = [M:YCSTK]FCY

#Infbox "yselloc - params(0)=" -PARAMS(0)

  Local Shortint IS_MOBILE : IS_MOBILE = 1
  Gosub CONFIG_GRID From YAX3MSEL
Return

################################################################

$FIN

  Gosub INIT
  Local Shortint OPEN : OPEN = 1
  Gosub HANDLE_FILES From YAX3MSEL

Return
**********
7,"TRT","YAX3MSELLOCCSTK",""
2,"TRT","YAX3MSELLOCENT",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$ACTION

  Case ACTION

    When "SEL_TABLE"    : Gosub SEL_TABLE
    When "FIN"          : Gosub FIN
    When Default
  Endcase

Return

$INIT

  Local Char FUNCTION(5) : FUNCTION = "ENT"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "LOC"

Return

$SEL_TABLE

  Gosub INIT
  Local Shortint OPEN : OPEN = 2
  Gosub HANDLE_FILES From YAX3MSEL
  Case COUZON
    When "YSELLOC" : Gosub S_YSELLOC
  Endcase

Return

$S_YSELLOC

  Gosub INIT

  Local Char PARAMS(250)(1)
  PARAMS(0) = [M:YSMR1]ITMREF(nolign-1)

  Local Shortint IS_MOBILE : IS_MOBILE = 1
  Gosub CONFIG_GRID From YAX3MSEL

Return


$FIN

  Gosub INIT
  Local Shortint OPEN : OPEN = 1
  Gosub HANDLE_FILES From YAX3MSEL

Return
**********
7,"TRT","YAX3MSELLOCENT",""
2,"TRT","YAX3MSELLOCLNK",""
#<AdxTL>@(#)0.0.0.0 $Revision$

$INIT_GRID
  Local Char TIT(250)(NUM_COLS)
  Local Char COL(250)(NUM_COLS)
  Local Char FIELDS(20)(NUM_COLS)
  Local Integer NBCOL
Return

############################################################################################################################################
#**
#* Sub per Link,Critere,Griglia per Ubicazione Entrate Diverse (YSMR)
#*!

$LOC_ENT

  Link [YSTC] With [YFCY]FCY0~=[YSTC]STOFCY,
&                  [YITF]ITF0~=PARAMS(0);[YFCY]FCY
&             As   [LNK]
  Columns [LNK] ( [F:YITF]STOFCY,[F:YFCY]FCYNAM,[F:YITF]ITMREF,[F:YSTC]LOC,[F:YSTC]OCPCOD,[F:YSTC]LOCTYP,[F:YSTC]LOCCAT,[F:YSTC]LOKSTA )

  If (IS_MOBILE = 1)
    Gosub INIT_CRITERE_ENT_FIELDS
  Endif

  Gosub SET_CRITERE_ENT_USC
  Gosub SET_TITCOL_ENT_USC

Return

#**
#* Sub per Link,Critere,Griglia per Ubicazione Uscite Diverse (YSMO)
#*!

$LOC_USC

  Link [YSTC] With [YFCY]FCY0~=[YSTC]STOFCY,
&                  [YITF]ITF0~=PARAMS(0);[YFCY]FCY
&             As  [LNK]
  Columns [LNK] ( [F:YITF]STOFCY,[F:YFCY]FCYNAM,[F:YITF]ITMREF,[F:YSTC]LOC,[F:YSTC]OCPCOD,[F:YSTC]LOCTYP,[F:YSTC]LOCCAT,[F:YSTC]LOKSTA )

  If (IS_MOBILE = 1)
    Gosub INIT_CRITERE_USC_FIELDS
  Endif

  Gosub SET_CRITERE_ENT_USC
  Gosub SET_TITCOL_ENT_USC

Return

#**
#* Sub per Link,Critere,Griglia per Ubicazione Calcolo Giacenze (YCALCGIAC)
#*!

$LOC_GC

  Link [YSTC] With  [YFCY]FCY0 ~=[YSTC]STOFCY
&             As    [LNK]
  Columns [LNK] ([F:YFCY]FCY,[F:YFCY]FCYNAM,[F:YSTC]LOC,[F:YSTC]OCPCOD,[F:YSTC]LOCTYP,[F:YSTC]LOCCAT,[F:YSTC]LOKSTA )

  If (IS_MOBILE = 1)
    Gosub INIT_CRITERE_GIAC_FIELDS
  Endif

  Gosub SET_CRITERE_GIAC
  Gosub SET_TITCOL_GIAC

Return

#**
#* Sub per Link,Critere,Griglia per Ubicazione Cambio Stock (YCSTK)
#*!

$LOC_CSTK

  Link [YSTC] With  [YFCY]FCY0 ~=[YSTC]STOFCY
&             As    [LNK] Where [YSTC]STOFCY = PARAMS(0)
  Columns [LNK] ([F:YFCY]FCY,[F:YFCY]FCYNAM,[F:YSTC]LOC,[F:YSTC]OCPCOD,[F:YSTC]LOCTYP,[F:YSTC]LOCCAT,[F:YSTC]LOKSTA )

  If (IS_MOBILE = 1)
    Gosub INIT_CRITERE_CSTK_FIELDS
  Endif

  Gosub SET_CRITERE_CSTK
  Gosub SET_TITCOL_CSTK
Return

#**
#* Sub per Link,Critere,Griglia per Ubicazione Destinazione (YLOCDEST) - Cambio Stock (YCSTK)
#*!

$LOCD_CSTK

  Link [YSTC] With  [YFCY]FCY0 ~=[YSTC]STOFCY
&             As    [LNK] Where [YSTC]STOFCY = PARAMS(0)
  Columns [LNK] ([F:YFCY]FCY,[F:YFCY]FCYNAM,[F:YSTC]LOC,[F:YSTC]OCPCOD,[F:YSTC]LOCTYP,[F:YSTC]LOCCAT,[F:YSTC]LOKSTA )

  If (IS_MOBILE = 1)
    Gosub INIT_CRITERE_CSTK_FIELDS
  Endif

  Gosub SET_CRITERE_LOCD_CSTK
  Gosub SET_TITCOL_CSTK
Return

#########################################################################################################################################
#                                                       SET_TITCOL
#########################################################################################################################################

$SET_TITCOL_ENT_USC

  NUM_COLS = 6
  Default File [LNK]

  Call TEXTFIC("FACILITY","FCY",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YITF]STOFCY"
  NBCOL += 1 : Call TEXTFIC("FACILITY","FCYNAM",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YFCY]FCYNAM"
  NBCOL += 1 : Call TEXTFIC("STOLOC","LOC",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YSTC]LOC"
  NBCOL += 1 : Call TEXTFIC("STOLOC","OCPCOD",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "mess([F:YSTC]OCPCOD,757,1)"
  NBCOL += 1 : Call TEXTFIC("TABLOCTYP","LOCTYP",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "func AFNC.TEXTRA('TABLOCTYP','TYPDESAXX',[F:YITF]STOFCY,[F:YSTC]LOCTYP)"
  NBCOL += 1 : Call TEXTFIC("STOLOC","LOCCAT",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "mess([F:YSTC]LOCCAT,2710,1)"

Return

############################################################################################

$SET_TITCOL_GIAC

  NUM_COLS = 6
  Default File [LNK]

  Call TEXTFIC("FACILITY","FCY",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YFCY]FCY"
  NBCOL += 1 : Call TEXTFIC("FACILITY","FCYNAM",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YFCY]FCYNAM"
  NBCOL += 1 : Call TEXTFIC("STOLOC","LOC",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YSTC]LOC"
  NBCOL += 1 : Call TEXTFIC("STOLOC","OCPCOD",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "mess([F:YSTC]OCPCOD,757,1)"
  NBCOL += 1 : Call TEXTFIC("TABLOCTYP","LOCTYP",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "func AFNC.TEXTRA('TABLOCTYP','TYPDESAXX',[F:YSTO]STOFCY,[F:YSTC]LOCTYP)"
  NBCOL += 1 : Call TEXTFIC("STOLOC","LOCCAT",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "mess([F:YSTC]LOCCAT,2710,1)"

Return

############################################################################
#TODO Unisci a Calcgiac
$SET_TITCOL_CSTK

  NUM_COLS = 6
  Default File [LNK]

  Call TEXTFIC("FACILITY","FCY",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YFCY]FCY"
  NBCOL += 1 : Call TEXTFIC("FACILITY","FCYNAM",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YFCY]FCYNAM"
  NBCOL += 1 : Call TEXTFIC("STOLOC","LOC",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YSTC]LOC"
  NBCOL += 1 : Call TEXTFIC("STOLOC","OCPCOD",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "mess([F:YSTC]OCPCOD,757,1)"
  NBCOL += 1 : Call TEXTFIC("STOLOC","LOCTYP",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YSTC]LOCTYP"
  NBCOL += 1 : Call TEXTFIC("STOLOC","LOCCAT",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "mess([F:YSTC]LOCCAT,2710,1)"

Return


##################################################################################################################
#                                             CRITERE FIELDS
##################################################################################################################

$INIT_CRITERE_ENT_FIELDS
  Local Char FCY(5)
  Local Char ITMREF(20)

  FCY = [M:YSMR1]FCY
  ITMREF = [M:YSMR1]ITMREF(nolign-1)
Return

$INIT_CRITERE_USC_FIELDS
  Local Char FCY(5)
  Local Char ITMREF(20)

  FCY = [M:YSMO1]FCY
  ITMREF = [M:YSMO1]ITMREF(nolign-1)
Return

$INIT_CRITERE_GIAC_FIELDS
  Local Char FCY(5)
  FCY = [M:YCGC1]FCY
Return

$INIT_CRITERE_CSTK_FIELDS
  #Local Char FCY(5)
  #FCY = [M:YCSTK]FCY
Return

###############################################################################################################
#                                               SET_CRITERE
###############################################################################################################

$SET_CRITERE_ENT_USC

  NUM_COLS = 6
  If IS_MOBILE = 2
    Gosub INIT_GRID
    Filter [LNK] Where evalue(CRITERE) Order By [F:YITF]STOFCY;[F:YSTC]LOC
    COUNT_VALUES = rowcount([LNK])

    #sono le chiavi presenti in header e data del json di output
    FIELDS(0) = "FCY" : FIELDS(1) = "FCYNAM" : FIELDS(2) = "LOC"
    FIELDS(3) = "OCPCOD" : FIELDS(4) = "LOCTYP" : FIELDS(5) = "LOCCAT"
    NBCOL = 0
  Else
    GSELFAC = 1
    TIT(0) = "Selezione ubicazione"
    ORDRE = "[F:YITF]STOFCY;[F:YSTC]LOC"
    START = "[F:YSTC]LOC"
    DEFPAG = 1
    NBCOL = 1

    Local Char CRITERE(250)
    CRITERE = "[F:YITF]STOFCY = '" + FCY + "' & [F:YITF]ITMREF = '" + ITMREF + "' & [F:YSTC]LOKSTA <> 2"

  Endif
Return

#######################################################################################################################

$SET_CRITERE_GIAC

  NUM_COLS = 6
  If IS_MOBILE = 2 #AX3M
    Gosub INIT_GRID
    Filter [LNK] Where evalue(CRITERE) Order By [F:YSTC]STOFCY;[F:YSTC]LOC
    COUNT_VALUES = rowcount([LNK])
    #sono le chiavi presenti in header e data del json di output
    FIELDS(0) = "FCY" : FIELDS(1) = "FCYNAM" : FIELDS(2) = "LOC"
    FIELDS(3) = "OCPCOD" : FIELDS(4) = "LOCTYP" : FIELDS(5) = "LOCCAT"
    NBCOL = 0
  Else #X3
    GSELFAC = 1
    TIT(0) = "Selezione ubicazione"
    #ORDRE = "[F:YSTO]STOFCY;[F:YSTO]LOC"
    ORDRE = "[F:YSTC]STOFCY"
    START = "[F:YSTC]LOC"
    DEFPAG = 1
    NBCOL = 1

    Local Char CRITERE(250)
    If(FCY <> AVOID.ACHAR)
      CRITERE = "[F:YSTC]LOKSTA <> 2"
    Else
      CRITERE = "[F:YSTC]STOFCY = '" + FCY + "' & [F:YSTC]LOKSTA <> 2"
    Endif
  Endif
Return

########################################################################################################################

$SET_CRITERE_CSTK

  NUM_COLS = 6

  If IS_MOBILE = 2 #AX3M

    Gosub INIT_GRID
    Filter [LNK] Where evalue(CRITERE) Order By [F:YSTC]STOFCY;[F:YSTC]LOC
    COUNT_VALUES = rowcount([LNK])
    #sono le chiavi presenti in header e data del json di output
    FIELDS(0) = "FCY" : FIELDS(1) = "FCYNAM" : FIELDS(2) = "LOC"
    FIELDS(3) = "OCPCOD" : FIELDS(4) = "LOCTYP" : FIELDS(5) = "LOCCAT"
    NBCOL = 0

  Else #X3
    GSELFAC = 1
    TIT(0) = "Selezione ubicazione"
    ORDRE = "[F:YSTC]LOC"
    START = "[F:YSTC]LOC"
    DEFPAG = 1
    NBCOL = 1

    Local Char CRITERE(250)
    CRITERE = "[F:YSTC]LOKSTA <> 2"

  Endif
Return

$SET_CRITERE_LOCD_CSTK

  NUM_COLS = 6

  If IS_MOBILE = 2 #AX3M

    Gosub INIT_GRID
    Filter [LNK] Where evalue(CRITERE) Order By [F:YSTC]STOFCY;[F:YSTC]LOC
    COUNT_VALUES = rowcount([LNK])
    #sono le chiavi presenti in header e data del json di output
    FIELDS(0) = "FCY" : FIELDS(1) = "FCYNAM" : FIELDS(2) = "YLOCDEST"
    FIELDS(3) = "OCPCOD" : FIELDS(4) = "LOCTYP" : FIELDS(5) = "LOCCAT"
    NBCOL = 0

  Else #X3
    GSELFAC = 1
    TIT(0) = "Selezione ubicazione"
    ORDRE = "[F:YSTC]LOC"
    START = "[F:YSTC]LOC"
    DEFPAG = 1
    NBCOL = 1

    Local Char CRITERE(250)
    CRITERE = "[F:YSTC]LOKSTA <> 2"

  Endif
Return
**********
7,"TRT","YAX3MSELLOCLNK",""
2,"TRT","YAX3MSELLOCUSC",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$ACTION

  Case ACTION

    When "SEL_TABLE"    : Gosub SEL_TABLE
    When "FIN"          : Gosub FIN
    When Default
  Endcase

Return

$INIT

  Local Char FUNCTION(5) : FUNCTION = "USC"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "LOC"

Return

$SEL_TABLE

  Gosub INIT
  Local Shortint OPEN : OPEN = 2
  Gosub HANDLE_FILES From YAX3MSEL
  Case COUZON
    When "YSELLOC" : Gosub S_YSELLOC
  Endcase

Return

$S_YSELLOC

  Gosub INIT

  Local Char PARAMS(250)(1)
  PARAMS(0) = [M:YSMO1]ITMREF(nolign-1)

  Local Shortint IS_MOBILE : IS_MOBILE = 1
  Gosub CONFIG_GRID From YAX3MSEL

Return


$FIN

  Gosub INIT
  Local Shortint OPEN : OPEN = 1
  Gosub HANDLE_FILES From YAX3MSEL

Return
**********
7,"TRT","YAX3MSELLOCUSC",""
2,"TRT","YAX3MSELLOTCSTK",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$ACTION

  Case ACTION

    When "SEL_TABLE"    : Gosub SEL_TABLE
    When "FIN"          : Gosub FIN
    When Default
  Endcase

Return

###############################################################

$INIT

  Local Char FUNCTION(5) : FUNCTION = "YCSTK"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "LOT"

Return

###############################################################

$SEL_TABLE

  Gosub INIT
  Local Shortint OPEN : OPEN = 2
  Gosub HANDLE_FILES From YAX3MSEL

  Case COUZON
    When "YSELLOT" : Gosub S_YSELLOT
  Endcase
Return

################################################################

$S_YSELLOT

  Gosub INIT

  Local Char PARAMS(250)(2)
  PARAMS(0) = [M:YCSTK]FCY
  PARAMS(1) = [M:YCSTK]ITMREF(nolign-1)

  Local Shortint IS_MOBILE : IS_MOBILE = 1
  Gosub CONFIG_GRID From YAX3MSEL
Return

################################################################

$FIN

  Gosub INIT
  Local Shortint OPEN : OPEN = 1
  Gosub HANDLE_FILES From YAX3MSEL

Return
**********
7,"TRT","YAX3MSELLOTCSTK",""
2,"TRT","YAX3MSELLOTLNK",""
#<AdxTL>@(#)0.0.0.0 $Revision$

$INIT_GRID
  Local Char TIT(250)(NUM_COLS)
  Local Char COL(250)(NUM_COLS)
  Local Char FIELDS(20)(NUM_COLS)
  Local Integer NBCOL
Return

$LOT_USC
  #Sub per SEL LOTTO USCITE

  NUM_COLS = 3

  #LINK
  Link [YSLF] With [YSTL]STL0=[F:YSLF]ITMREF;[F:YSLF]LOT;[F:YSLF]SLO
&             As [LNK]
  Columns [LNK] ([F:YSLF]STOFCY,[F:YSLF]ITMREF,[F:YSLF]LOT,[F:YSLF]SLO)

#  Link [YSTO] With
#  Columns [LNK] ([F:YSLF]STOFCY,[F:YSLF]ITMREF,[F:YSLF]LOT,[F:YSLF]SLO)

  If IS_MOBILE = 2

    Gosub INIT_GRID
    Filter [LNK] Where evalue(CRITERE) Order By [F:YSLF]ITMREF;[F:YSLF]LOT
    COUNT_VALUES = rowcount([LNK])

    #sono le chiavi presenti in header e data del json di output
    FIELDS(0) = "ITMREF" : FIELDS(1) = "LOT" : FIELDS(2) = "SLO"
    NBCOL = 0
  Else

    GSELFAC = 1
    TIT(0) = mess(2,723,1)#"Selezione lotto"
    ORDRE = "[F:YSLF]ITMREF;[F:YSLF]LOT"
    START = "[F:YSLF]LOT"
    DEFPAG = 1
    NBCOL = 1

    #Critere
    Local Char CRITERE(250)
    CRITERE = "[F:YSLF]ITMREF='"+[M:YSMO1]ITMREF(nolign-1)+"'"
    CRITERE -= "& [F:YSLF]STOFCY='"+[M:YSMO1]FCY+"'"
    CRITERE -= "& [F:YSLF]LOT <>AVOID.ACHAR"
    CRITERE -= "& ([F:YSLF]AAACUMQTY <> 0 | [F:YSLF]QQQCUMQTY <> 0 | [F:YSLF]RRRCUMQTY <> 0)"
  Endif

  Default File [LNK]

  #Imposto Colonne Lookup
  Call TEXTFIC("STOLOTFCY","ITMREF",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL)="[F:YSLF]ITMREF"
  NBCOL += 1 : Call TEXTFIC("STOLOTFCY","LOT",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL)="[F:YSLF]LOT"
  NBCOL+=1 : Call TEXTFIC("STOLOTFCY","SLO",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL)="[F:YSLF]SLO"

Return

################################################################################

$LOT_CSTK

  #Gosub SET_LINK_CSTK
  Gosub SET_LINK_CSTK1

  If (IS_MOBILE = 1)
    Gosub INIT_CRITERE_CSTK_FIELDS
  Endif

  Gosub SET_CRITERE_CSTK
  Gosub SET_TITCOL_CSTK
Return

#################################################################################
#                             LINK
#################################################################################

#USC

#**
#* Sub per Link per Lotto, funzione: YCSTK-Cambio Stock
#*!
$SET_LINK_CSTK

  Link [YSLF] With [YSTL]STL0=[F:YSLF]ITMREF;[F:YSLF]LOT;[F:YSTO]SLO;[F:YSTO]STOFCY
&             As [LNK]
  Columns [LNK] ([F:YSLF]STOFCY,[F:YSLF]ITMREF,[F:YSLF]LOT,[F:YSLF]SLO)

Return

$SET_LINK_CSTK1

#  Link [YSTO] With [YSLF]SLF0~=[F:YSTO]ITMREF;[F:YSTO]LOT;[F:YSLF]SLO
#&             As [LNK]
#  Columns [LNK] ([F:YSLF]STOFCY,[F:YSLF]ITMREF,[F:YSLF]LOT,[F:YSLF]SLO)

Return

$SET_LINK_CSTK2

  #Filter [LNK] Where [LNK]STOFCY = FCY  & [LNK]ITMREF = FCY

Return

##################################################################################
#                           INIT_CRITERE_FIELDS
##################################################################################
#YCSTK
$INIT_CRITERE_CSTK_FIELDS
Return

##################################################################################
#                               SET_CRITERE
##################################################################################

#YCSTK
$SET_CRITERE_CSTK

  #NUM_COLS = 3
  NUM_COLS = 2
  If IS_MOBILE = 2

    Gosub INIT_GRID
    Filter [LNK] Where evalue(CRITERE) Order By [F:LNK]ITMREF;[F:LNK]LOT
    COUNT_VALUES = rowcount([LNK])

Call ECR_TRACE("LOT- SET_CRITERE_CSTK :"-num$(COUNT_VALUES),0) From GESECRAN

    #sono le chiavi presenti in header e data del json di output
    #FIELDS(0) = "ITMREF" : FIELDS(1) = "LOT" : FIELDS(2) = "SLO"
    #FIELDS(0) = "LOT" : FIELDS(1) = "ITMREF" : FIELDS(2) = "SLO"
    FIELDS(0) = "LOT" : FIELDS(1) =  "SLO"
    NBCOL = 0
  Else

    GSELFAC = 1
    TIT(0) = mess(2,723,1)#"Selezione lotto"
    #ORDRE = "[F:YSLF]ITMREF;[F:YSLF]LOT"
    #START = "[F:YSLF]LOT"
    START = "[F:LNK]LOT"
    DEFPAG = 1
    NBCOL = 1

    #Critere
    Local Char CRITERE(250)
#    CRITERE = "[F:YSLF]ITMREF='"+PARAMS(1)+"'"
#    CRITERE -= "& [F:YSLF]STOFCY='"+PARAMS(0)+"'"
#    CRITERE -= "& [F:YSLF]LOT <>AVOID.ACHAR"
#    CRITERE -= "& ([F:YSLF]AAACUMQTY <> 0 | [F:YSLF]QQQCUMQTY <> 0 | [F:YSLF]RRRCUMQTY <> 0)"

    CRITERE = "[F:LNK]ITMREF='"+PARAMS(1)+"'"
    CRITERE -= "& [F:LNK]STOFCY='"+PARAMS(0)+"'"
    CRITERE -= "& [F:LNK]LOT <>AVOID.ACHAR"
    CRITERE -= "& ([F:LNK]QTYSTU - [F:LNK]CUMALLQTY - [F:LNK]CUMWIPQTY >0)"

  Endif

Return

$SET_CRITERE_CSTK2

  #NUM_COLS = 3
  NUM_COLS = 2
  If IS_MOBILE = 2

    Gosub INIT_GRID
    Filter [LNK] Where evalue(CRITERE) Order By [F:YSLF]ITMREF;[F:YSLF]LOT
    COUNT_VALUES = rowcount([LNK])

Call ECR_TRACE("LOT- SET_CRITERE_CSTK :"-num$(COUNT_VALUES),0) From GESECRAN

    #sono le chiavi presenti in header e data del json di output
    #FIELDS(0) = "ITMREF" : FIELDS(1) = "LOT" : FIELDS(2) = "SLO"
    #FIELDS(0) = "LOT" : FIELDS(1) = "ITMREF" : FIELDS(2) = "SLO"
    FIELDS(0) = "LOT" : FIELDS(1) =  "SLO"
    NBCOL = 0
  Else

    GSELFAC = 1
    TIT(0) = mess(2,723,1)#"Selezione lotto"
    #ORDRE = "[F:YSLF]ITMREF;[F:YSLF]LOT"
    START = "[F:YSLF]LOT"
    DEFPAG = 1
    NBCOL = 1

    #Critere
    Local Char CRITERE(250)
    CRITERE = "[F:YSLF]ITMREF='"+PARAMS(1)+"'"
    CRITERE -= "& [F:YSLF]STOFCY='"+PARAMS(0)+"'"
    CRITERE -= "& [F:YSLF]LOT <>AVOID.ACHAR"
    CRITERE -= "& ([F:YSLF]AAACUMQTY <> 0 | [F:YSLF]QQQCUMQTY <> 0 | [F:YSLF]RRRCUMQTY <> 0)"
  Endif

Return


##################################################################################
#                               SET_TITCOL
##################################################################################

#YCSTK
$SET_TITCOL_CSTK

# NUM_COLS = 3
  NUM_COLS = 2
  Default File [LNK]

#  Call TEXTFIC("STOLOTFCY","ITMREF",2,TIT(NBCOL)) From OBJDIV
#  COL(NBCOL)="[F:YSLF]ITMREF"
#  NBCOL += 1 :

#  Call TEXTFIC("STOLOTFCY","LOT",2,TIT(NBCOL)) From OBJDIV
#  COL(NBCOL)="[F:YSLF]LOT"
#  NBCOL+=1 : Call TEXTFIC("STOLOTFCY","SLO",2,TIT(NBCOL)) From OBJDIV
#  COL(NBCOL)="[F:YSLF]SLO"

  Call TEXTFIC("STOLOTFCY","LOT",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL)="[F:LNK]LOT"
  NBCOL+=1 : Call TEXTFIC("STOLOTFCY","SLO",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL)="[F:LNK]SLO"

Return
**********
7,"TRT","YAX3MSELLOTLNK",""
2,"TRT","YAX3MSELLOTUSC",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$ACTION

  Case ACTION

    When "SEL_TABLE"    : Gosub SEL_TABLE
    When "FIN"          : Gosub FIN
    When Default
  Endcase

Return

$INIT

  Local Char FUNCTION(5) : FUNCTION = "USC"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "LOT"

Return

$SEL_TABLE

  Gosub INIT
  Local Shortint OPEN : OPEN = 2
  Gosub HANDLE_FILES From YAX3MSEL

  Case COUZON
    When "YSELLOT" : Gosub S_YSELLOT
  Endcase

Return

$S_YSELLOT

  Gosub INIT

  Local Char PARAMS(250)(1)
  PARAMS(0) = [M:YSMO1]ITMREF(nolign-1)

  Local Shortint IS_MOBILE : IS_MOBILE = 1
  Gosub CONFIG_GRID From YAX3MSEL

Return

$FIN

  Gosub INIT
  Local Shortint OPEN : OPEN = 1
  Gosub HANDLE_FILES From YAX3MSEL

Return
**********
7,"TRT","YAX3MSELLOTUSC",""
2,"TRT","YAX3MSELPCDBPC",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$ACTION

  Case ACTION

    When "SEL_TABLE"    : Gosub SEL_TABLE
    When "FIN"          : Gosub FIN
    When Default
  Endcase

Return

$INIT

  Local Char FUNCTION(5) : FUNCTION = "YBPC"
  Local Char TYPE_FIELD(6) : TYPE_FIELD = "POSCOD"

Return

$SEL_TABLE

  Gosub INIT
  Local Shortint OPEN : OPEN = 2
  Gosub HANDLE_FILES From YAX3MSEL

  Case COUZON
    When "YSELPCD" : Gosub S_YSELPCD
  Endcase

Return

$S_YSELPCD

  Gosub INIT

  Local Char PARAMS(250)(1)
  PARAMS(0)= [M:YBPC]CRY
  Local Shortint IS_MOBILE : IS_MOBILE = 1
  Gosub CONFIG_GRID From YAX3MSEL

Return

$FIN

  Gosub INIT
  Local Shortint OPEN : OPEN = 1
  Gosub HANDLE_FILES From YAX3MSEL

Return
**********
7,"TRT","YAX3MSELPCDBPC",""
2,"TRT","YAX3MSELPOSCODLNK",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$INIT_GRID
  Local Char TIT(250)(NUM_COLS)
  Local Char COL(250)(NUM_COLS)
  Local Char FIELDS(20)(NUM_COLS)
  Local Integer NBCOL
Return

# Gestione Selezione POSCOD/CTY per Funzione ###################################################################################

#YBPC -POSCOD
$POSCOD_BPC

  Gosub SET_LINK_YBPC

  If (IS_MOBILE = 1)
    Gosub INIT_CRITERE_YBPC_FIELDS
  Endif
  Gosub SET_CRITERE_YBPC
  Gosub SET_TITCOL_YBPC

Return

#YBPC -CTY
$CTY_BPC

  Gosub SET_LINK_YBPC

  If (IS_MOBILE = 1)
    Gosub INIT_CRITERE_YBPC_FIELDS
  Endif

  Gosub SET_CRITERE_CTY_YBPC
  Gosub SET_TITCOL_CTY_YBPC
Return

#########################################################################################à
$SET_LINK_YBPC

  Link [YPOS] With [YTCY]TCY0=[F:YPOS]CRY
&              As [LNK]
  #Filter [LNK] Where [LNK]POSCTYCOD = "RM"
  #Where evalue(CRITERE) Order By [LNK]POSCOD
#Infbox "RWCONT = "+num$(rowcount([LNK]))
Return

#####################################################################################
$INIT_CRITERE_YBPC_FIELDS

Return

#######################################################################################

$SET_CRITERE_YBPC

  NUM_COLS = 4

  If IS_MOBILE = 2
    Gosub INIT_GRID
    Filter [LNK] Where evalue(CRITERE)
    #Order By [LNK]POSCOD
    COUNT_VALUES = rowcount([LNK])
#Call ECR_TRACE("4-count=" -num$(COUNT_VALUES),0) From GESECRAN
    FIELDS(0) = "POSCOD" : FIELDS(1) = "POSCTY" : FIELDS(2) = "POSCTYCOD": FIELDS(3) = "CRY"
    NBCOL = 0
  Else
    GSELFAC = 1
    TIT(0) = "Selezione CAP"
    ORDRE = "[YPOS]POSCOD"
    START = "[YPOS]POSCOD"
    DEFPAG = 1
    NBCOL = 1

    Local Char CRITERE(250)
    CRITERE = "[YPOS]CRY = '" + PARAMS(0) + "'"
  Endif

Return

$SET_CRITERE_CTY_YBPC

  NUM_COLS = 4

  If IS_MOBILE = 2
    Gosub INIT_GRID
    Filter [LNK] Where evalue(CRITERE)
    #Order By [LNK]POSCOD
    COUNT_VALUES = rowcount([LNK])
    FIELDS(0) = "POSCTY" : FIELDS(1) = "POSCOD" : FIELDS(2) = "POSCTYCOD": FIELDS(3) = "CRY"
    NBCOL = 0
  Else
    GSELFAC = 1
    TIT(0) = "Selezione CAP"
    ORDRE = "[YPOS]POSCTY"
    START = "[YPOS]POSCTY"
    DEFPAG = 1
    NBCOL = 1

    Local Char CRITERE(250)
    CRITERE = "[YPOS]CRY = '" + PARAMS(0) + "'"
  Endif

Return

################################################################################à

$SET_TITCOL_YBPC

  Default File [LNK]

  #Imposto Colonne Lookup
  Call TEXTFIC("POSCOD","POSCOD",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL)="[F:YPOS]POSCOD"
  NBCOL += 1 : Call TEXTFIC("POSCOD","POSCTY",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YPOS]POSCTY"
  NBCOL += 1 : Call TEXTFIC("POSCOD","POSCTYCOD",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YPOS]POSCTYCOD"
  NBCOL += 1 : Call TEXTFIC("POSCOD","CRY",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YPOS]CRY"

Return

$SET_TITCOL_CTY_YBPC

  Default File [LNK]

  #Imposto Colonne Lookup
  Call TEXTFIC("POSCOD","POSCTY",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL)="[F:YPOS]POSCTY"
  NBCOL += 1 : Call TEXTFIC("POSCOD","POSCOD",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL)="[F:YPOS]POSCOD"
  NBCOL += 1 : Call TEXTFIC("POSCOD","POSCTYCOD",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YPOS]POSCTYCOD"
  NBCOL += 1 : Call TEXTFIC("POSCOD","CRY",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YPOS]CRY"

Return
**********
7,"TRT","YAX3MSELPOSCODLNK",""
2,"TRT","YAX3MSELPTEBPC",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$ACTION

  Case ACTION

    When "SEL_TABLE"    : Gosub SEL_TABLE
    When "FIN"          : Gosub FIN
    When Default
  Endcase

Return

$INIT

  Local Char FUNCTION(5) : FUNCTION = "YBPC"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "PTE"

Return

$SEL_TABLE

  Gosub INIT
  Local Shortint OPEN : OPEN = 2
  Gosub HANDLE_FILES From YAX3MSEL
  Case COUZON
    When "YSELPTE" : Gosub S_YSELPTE
  Endcase

Return

$S_YSELPTE

  Gosub INIT

  Local Char PARAMS(250)(3)
  PARAMS(0) = "ITA"
  PARAMS(1) = num$(1)
  PARAMS(2) = [M:YBPC]PTE
  Local Shortint IS_MOBILE : IS_MOBILE = 1
  Gosub CONFIG_GRID From YAX3MSEL

Return


$FIN

  Gosub INIT
  Local Shortint OPEN : OPEN = 1
  Gosub HANDLE_FILES From YAX3MSEL

Return
**********
7,"TRT","YAX3MSELPTEBPC",""
2,"TRT","YAX3MSELPTELNK",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$INIT_GRID
  Local Char TIT(250)(NUM_COLS)
  Local Char COL(250)(NUM_COLS)
  Local Char FIELDS(20)(NUM_COLS)
  Local Integer NBCOL
Return

# Gestione Selezione VACBPR per Funzione ###################################################################################

#YBPC
$PTE_BPC

  Gosub SET_LINK_YBPC

  If (IS_MOBILE = 1)
    Gosub INIT_CRITERE_YBPC_FIELDS
  Endif
#Infbox "3 -RWCNT ="-num$(rowcount([LNK]))


  Gosub SET_CRITERE_YBPC
  Gosub SET_TITCOL_YBPC
Return

#########################################################################################à
$SET_LINK_YBPC

Return

#####################################################################################
$INIT_CRITERE_YBPC_FIELDS

Return

#######################################################################################

$SET_CRITERE_YBPC

  NUM_COLS = 2

  If IS_MOBILE = 2
    Gosub INIT_GRID
    Filter [LNK] Where evalue(CRITERE)
    COUNT_VALUES = rowcount([LNK])
    FIELDS(0) = "PTE" : FIELDS(1) = "LANDESSHO"
    NBCOL = 0
  Else
    GSELFAC = 1
    TIT(0) = "Selezione Mod. Pagamento"
    ORDRE = "[F:LNK]PTE"
    START = "[F:LNK]PTE"
    DEFPAG = 1
    NBCOL = 1

    Local Char CRITERE(250)
    CRITERE = "[F:LNK]LEG = '" + PARAMS(0) + "'"-"& [F:LNK]PTELIN ="+PARAMS(1)
    If(vireblc(PARAMS(2),2)<> AVOID.ACHAR)
      Local Char YPTE(15): YPTE = vireblc(PARAMS(2),2)
      CRITERE-= "& instr(1, tolower([F:LNK]PTE), tolower('" + YPTE + "'))<>0"
    Endif
  Endif
Return

################################################################################à

$SET_TITCOL_YBPC

  Default File [LNK]

  #Imposto Colonne Lookup
  Call TEXTFIC("TABPAYTERM","PTE",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:LNK]PTE"
  NBCOL += 1 : Call TEXTFIC("TABPAYTERM","LANDESSHO",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:LNK]LANDESSHO"

Return
**********
7,"TRT","YAX3MSELPTELNK",""
2,"TRT","YAX3MSELSERCSTK",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$ACTION

  Case ACTION

    When "SEL_TABLE"    : Gosub SEL_TABLE
    When "FIN"          : Gosub FIN
    When Default
  Endcase

Return

###############################################################

$INIT

  Local Char FUNCTION(5) : FUNCTION = "YCSTK"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "SER"

Return

###############################################################

$SEL_TABLE

  Gosub INIT
  Local Shortint OPEN : OPEN = 2
  Gosub HANDLE_FILES From YAX3MSEL

  Case COUZON
    When "YSELSER" : Gosub S_YSELSER
  Endcase
Return

################################################################

$S_YSELSER

  Gosub INIT

  Local Char PARAMS(250)(2)
  PARAMS(0) = [M:YCSTK]FCY
  PARAMS(1) = [M:YCSTK]ITMREF(nolign-1)

  Local Shortint IS_MOBILE : IS_MOBILE = 1
  Gosub CONFIG_GRID From YAX3MSEL
Return

################################################################

$FIN

  Gosub INIT
  Local Shortint OPEN : OPEN = 1
  Gosub HANDLE_FILES From YAX3MSEL

Return
**********
7,"TRT","YAX3MSELSERCSTK",""
2,"TRT","YAX3MSELSERLNK",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$INIT_GRID
  Local Char TIT(250)(NUM_COLS)
  Local Char COL(250)(NUM_COLS)
  Local Char FIELDS(20)(NUM_COLS)
  Local Integer NBCOL
Return

##############################################################################
##############################################################################
#YCSTK: Cambio Stock
$SER_CSTK

  Gosub SET_LINK_CSTK

  If (IS_MOBILE = 1)
    Gosub INIT_CRITERE_CSTK_FIELDS
  Endif

  Gosub SET_CRITERE_CSTK
  Gosub SET_TITCOL_CSTK

Return

##################################################################################
#                                 LINK
##################################################################################

#YCSTK: Cambio Stock
$SET_LINK_CSTK

   Link [YSTS] With [YITM]ITM0=[F:YSTS]ITMREF
&              As [LNK]
  Columns [LNK] ([F:YSTS]SERNUM,[F:YITM]ITMREF,[F:YITM]ITMDES1)
Return

##################################################################################
#                           INIT_CRITERE_FIELDS
##################################################################################
#YCSTK
$INIT_CRITERE_CSTK_FIELDS

Return

##################################################################################
#                               SET_CRITERE
##################################################################################

#YCSTK
$SET_CRITERE_CSTK

  NUM_COLS = 3
  If IS_MOBILE = 2

    Gosub INIT_GRID
    Filter [LNK] Where evalue(CRITERE) Order By [F:YSTS]ITMREF
    COUNT_VALUES = rowcount([LNK])

    #sono le chiavi presenti in header e data del json di output
    FIELDS(0) = "ITMREF" : FIELDS(1) = "ITMDES1" : FIELDS(2) = "SERNUM"
    NBCOL = 0
  Else

    GSELFAC = 1
    TIT(0) = "Selezione matricola"
    ORDRE = "[F:YSTS]ITMREF"
    START = "[F:YSTS]ITMREF"
    DEFPAG = 1
    NBCOL = 1

    #Critere
    Local Char CRITERE(250)
    CRITERE = "[F:YSTS]STOFCY='"+PARAMS(0)+"'"
    CRITERE -= "& [F:YSTS]ITMREF='"+PARAMS(1)+"'"
  Endif

Return

##################################################################################
#                               SET_TITCOL
##################################################################################

#YCSTK
$SET_TITCOL_CSTK

  NUM_COLS = 3
  Default File [LNK]

  Call TEXTFIC("STOSER","ITMREF",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL)="[F:YSTS]ITMREF"
  NBCOL += 1 : Call TEXTFIC("ITMMASTER","ITMDES1",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL)="func AFNC.TEXTRA('ITMMASTER','DES1AXX',[F:YITM]ITMREF,'')"
  NBCOL+=1 : Call TEXTFIC("STOSER","SERNUM",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL)="[F:YSTS]SERNUM"

Return
**********
7,"TRT","YAX3MSELSERLNK",""
2,"TRT","YAX3MSELTSOLNK",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$INIT_GRID
  Local Char TIT(250)(NUM_COLS)
  Local Char COL(250)(NUM_COLS)
  Local Char FIELDS(20)(NUM_COLS)
  Local Integer NBCOL
Return

$TSO_SOH
  #Sub per SEL TIPO ORDINE  - SOH (OdV)
  #NUM_COLS = 3
  NUM_COLS = 5

  #LINK
  Link [YTSO] With [AXX]AXX0="TABSOHTYP";"DESAXX";GLANGUE;[F:YTSO]SOHTYP;[F:YTSO]LEG,
&                  [AX3]AXX0="TABSOHTYP";"SHOAXX";GLANGUE;[F:YTSO]SOHTYP;[F:YTSO]LEG,
&                  [YTSD]TSD0=[F:YTSO]SDHTYP;[F:YTSO]LEG
&             As [LNK]

#Where ([F:YTSO]SOHCAT = 1 & [F:YTSO]SOHTYP <> "SONBC")

  If IS_MOBILE = 2

    Gosub INIT_GRID
    Filter [LNK] Order By [F:YTSO]SOHTYP
    COUNT_VALUES = rowcount([LNK])

    #sono le chiavi presenti in header e data del json di output
#    FIELDS(0) = "SOHTYP" : FIELDS(1) = "SDHTYP" : FIELDS(2) = "LANDESSHO"

    FIELDS(0) = "SOHTYP"
    FIELDS(1) = "LANDESSHO"
    FIELDS(2) = "SOHCAT"
    FIELDS(3) = "CUSTOM3"
    FIELDS(4) = "CUSTOM4"

    NBCOL = 0
  Else

    GSELFAC = 1
    TIT(0) = "Selezione Tipo Ordine"  # TODO: mettere messaggio?
    ORDRE = "[F:YTSO]SOHTYP"
    START = "[F:YTSO]SOHTYP"
    DEFPAG = 1
    NBCOL = 1

    #Critere
#    Local Char CRITERE(250)
  Endif

  Default File [LNK]

  Call TEXTFIC("TABSOHTYP","SOHTYP",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL)="[F:YTSO]SOHTYP"
  NBCOL += 1 : Call TEXTFIC("TABSOHTYP","LANDESSHO",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL)="func AFNC.TEXTRA('TABSOHTYP','LANDESSHO',[F:YTSO]SOHTYP,'')"
  NBCOL+=1 : Call TEXTFIC("TABSOHTYP","SOHCAT",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL)="mess([F:YTSO]SOHCAT(0),412,1)"

  NBCOL += 1 : Call TEXTFIC("TABSOHTYP","GFY",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL)="string$([F:YTSO]LEG<>'',[F:YTSO]LEG)+string$([F:YTSO]LEG='',mess(91,187,1))"
  NBCOL+=1 : Call TEXTFIC("TABSOHTYP","GFY",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL)="string$([F:YTSO]GFY<>'',[F:YTSO]GFY)+string$([F:YTSO]GFY='',mess(220,117,1))"

Return
**********
7,"TRT","YAX3MSELTSOLNK",""
2,"TRT","YAX3MSELTSOSOH",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$ACTION

  Case ACTION

    When "SEL_TABLE"    : Gosub SEL_TABLE
    When "FIN"          : Gosub FIN
    When Default
  Endcase

Return

$INIT

  Local Char FUNCTION(5) : FUNCTION = "SOH"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "TSO"

Return

$SEL_TABLE

  Gosub INIT
  Local Shortint OPEN : OPEN = 2
  Gosub HANDLE_FILES From YAX3MWSLIB

  Case COUZON
    When "YSELTSO" : Gosub S_YSELTSO
  Endcase

Return

$S_YSELTSO

  Gosub INIT

  Local Char PARAMS(250)(1)

  Local Shortint IS_MOBILE : IS_MOBILE = 1
  Gosub CONFIG_GRID From YAX3MWSLIB

Return

$FIN

  Gosub INIT
  Local Shortint OPEN : OPEN = 1
  Gosub HANDLE_FILES From YAX3MWSLIB

Return
**********
7,"TRT","YAX3MSELTSOSOH",""
2,"TRT","YAX3MSELVACBPC",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$ACTION

  Case ACTION

    When "SEL_TABLE"    : Gosub SEL_TABLE
    When "FIN"          : Gosub FIN
    When Default
  Endcase

Return

$INIT

  Local Char FUNCTION(5) : FUNCTION = "YBPC"
  Local Char TYPE_FIELD(5) : TYPE_FIELD = "VAC"

Return

$SEL_TABLE

  Gosub INIT
  Local Shortint OPEN : OPEN = 2
  Gosub HANDLE_FILES From YAX3MSEL
  Case COUZON
    When "YSELVAC" : Gosub S_YSELVAC
  Endcase

Return

$S_YSELVAC

  Gosub INIT

  Local Char PARAMS(250)(1)
  PARAMS(0) = [M:YBPC]VACBPR
  Local Shortint IS_MOBILE : IS_MOBILE = 1
  Gosub CONFIG_GRID From YAX3MSEL

Return


$FIN

  Gosub INIT
  Local Shortint OPEN : OPEN = 1
  Gosub HANDLE_FILES From YAX3MSEL

Return
**********
7,"TRT","YAX3MSELVACBPC",""
2,"TRT","YAX3MSELVACBPRBPC",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$ACTION

  Case ACTION

    When "SEL_TABLE"    : Gosub SEL_TABLE
    When "FIN"          : Gosub FIN
    When Default
  Endcase

Return

###############################################################

$INIT

  Local Char FUNCTION(5) : FUNCTION = "YBPC"
  Local Char TYPE_FIELD(6) : TYPE_FIELD = "VACBPR"

Return

###############################################################

$SEL_TABLE

  Gosub INIT
  Local Shortint OPEN : OPEN = 2
  Gosub HANDLE_FILES From YAX3MSEL

  Case COUZON
    When "YSELVACBPR" : Gosub S_YSELVACBPR
  Endcase

Return

################################################################

$S_YSELVACBPR

  Gosub INIT

  Local Char PARAMS(250)(2)
  PARAMS(0) = "ITA"
  PARAMS(1) = [M:YBPC]VACBPR

  Local Shortint IS_MOBILE : IS_MOBILE = 1
  Gosub CONFIG_GRID From YAX3MSEL
Return

################################################################

$FIN

  Gosub INIT
  Local Shortint OPEN : OPEN = 1
  Gosub HANDLE_FILES From YAX3MSEL

Return
**********
7,"TRT","YAX3MSELVACBPRBPC",""
2,"TRT","YAX3MSELVACLNK",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$INIT_GRID
  Local Char TIT(250)(NUM_COLS)
  Local Char COL(250)(NUM_COLS)
  Local Char FIELDS(20)(NUM_COLS)
  Local Integer NBCOL
Return

# Gestione Selezione VACBPR per Funzione ###################################################################################

#YBPC
$VAC_BPC

  Gosub SET_LINK_YBPC

  If (IS_MOBILE = 1)
    Gosub INIT_CRITERE_YBPC_FIELDS
  Endif
#Infbox "3 -RWCNT ="-num$(rowcount([LNK]))

  Gosub SET_CRITERE_YBPC
  Gosub SET_TITCOL_YBPC
Return

#########################################################################################à
$SET_LINK_YBPC

Return

#####################################################################################
$INIT_CRITERE_YBPC_FIELDS

Return

#######################################################################################

$SET_CRITERE_YBPC

  NUM_COLS = 1

  If IS_MOBILE = 2
    Gosub INIT_GRID
    Filter [LNK] Where evalue(CRITERE)
    COUNT_VALUES = rowcount([LNK])
    FIELDS(0) = "VACBPR" #: FIELDS(1) = "BPCNAM"
    NBCOL = 0
  Else
    GSELFAC = 1
    TIT(0) = "Selezione Regime IVA"
    ORDRE = "[F:LNK]VACBPR"
    START = "[F:LNK]VACBPR"
    DEFPAG = 1
    NBCOL = 1

    Local Char CRITERE(250)
    CRITERE = "1=1 & "-"[F:LNK]LEG = '" + PARAMS(0) + "'"
    If(vireblc(PARAMS(1),2)<> AVOID.ACHAR)
      Local Char YVACBPR(5): YVACBPR = vireblc(PARAMS(1),2)
      CRITERE-= "& instr(1, tolower([F:LNK]VACBPR), tolower('" + YVACBPR + "'))<>0"
    Endif
  Endif
Return

################################################################################à

$SET_TITCOL_YBPC

  Default File [LNK]

  #Imposto Colonne Lookup
  Call TEXTFIC("TABVACBPR","VACBPR",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:LNK]VACBPR"
#  NBCOL += 1 : Call TEXTFIC("BPCUSTOMER","BPCNAM",2,TIT(NBCOL)) From OBJDIV
#  COL(NBCOL) = "[F:YBPC]BPCNAM"

Return
**********
7,"TRT","YAX3MSELVACLNK",""
2,"TRT","YAX3MSELVCRLNK",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$INIT_GRID
  Local Char TIT(250)(NUM_COLS)
  Local Char COL(250)(NUM_COLS)
  Local Char FIELDS(20)(NUM_COLS)
  Local Integer NBCOL
Return

############################################################################################################################################
#**
#* Sub per Link,Critere,Griglia per VCRNUM (YVXRUNI)
#*!

$VCR_VXRUNI

#  Link [YSTC] With [YFCY]FCY0~=[YSTC]STOFCY,
#&                  [YITF]ITF0~=PARAMS(0);[YFCY]FCY
#&             As   [LNK]
#  Columns [LNK] ( [F:YITF]STOFCY,[F:YFCY]FCYNAM,[F:YITF]ITMREF,[F:YSTC]LOC,[F:YSTC]OCPCOD,[F:YSTC]LOCTYP,[F:YSTC]LOCCAT,[F:YSTC]LOKSTA )

  If (IS_MOBILE = 1)
    Gosub INIT_CRITERE_VXRUNI_FIELDS
  Endif

  Gosub SET_CRITERE_VXRUNI
  Gosub SET_TITCOL_VXRUNI

Return

#########################################################################################################################################
#                                                         LINK
#########################################################################################################################################
#**
#* Link per Selezione VCRNUM - YVXRUNI
#*!
$LINK_VXRUNI

  Link [YMFG] With [YMWH]MWH0=10;[YMFG]MFGNUM
&             As [LNK]
Return

#########################################################################################################################################
#                                                       SET_TITCOL
#########################################################################################################################################
#**
#* Imposto Titoli e Colonne per Selezione VCRNUM - YVXRUNI
#*!
$SET_TITCOL_VXRUNI

#  NUM_COLS = 6
#  Default File [LNK]
#
#  Call TEXTFIC("FACILITY","FCY",2,TIT(NBCOL)) From OBJDIV
#  COL(NBCOL) = "[F:YITF]STOFCY"
#  NBCOL += 1 : Call TEXTFIC("FACILITY","FCYNAM",2,TIT(NBCOL)) From OBJDIV
#  COL(NBCOL) = "[F:YFCY]FCYNAM"
#  NBCOL += 1 : Call TEXTFIC("STOLOC","LOC",2,TIT(NBCOL)) From OBJDIV
#  COL(NBCOL) = "[F:YSTC]LOC"
#  NBCOL += 1 : Call TEXTFIC("STOLOC","OCPCOD",2,TIT(NBCOL)) From OBJDIV
#  COL(NBCOL) = "mess([F:YSTC]OCPCOD,757,1)"
#  NBCOL += 1 : Call TEXTFIC("TABLOCTYP","LOCTYP",2,TIT(NBCOL)) From OBJDIV
#  COL(NBCOL) = "func AFNC.TEXTRA('TABLOCTYP','TYPDESAXX',[F:YITF]STOFCY,[F:YSTC]LOCTYP)"
#  NBCOL += 1 : Call TEXTFIC("STOLOC","LOCCAT",2,TIT(NBCOL)) From OBJDIV
#  COL(NBCOL) = "mess([F:YSTC]LOCCAT,2710,1)"

Return

##################################################################################################################
#                                             CRITERE FIELDS
##################################################################################################################

$INIT_CRITERE_VXRUNI_FIELDS
#  Local Char FCY(5)
#  Local Char ITMREF(20)
#
#  FCY = [M:YSMR1]FCY
#  ITMREF = [M:YSMR1]ITMREF(nolign-1)
Return

###############################################################################################################
#                                               SET_CRITERE
###############################################################################################################

$SET_CRITERE_VXRUNI

  #NUM_COLS = 6
  If IS_MOBILE = 2
    Gosub INIT_GRID

    Filter [LNK] Where evalue(CRITERE)
    COUNT_VALUES = rowcount([LNK])

    #sono le chiavi presenti in header e data del json di output
#    FIELDS(0) = "FCY" : FIELDS(1) = "FCYNAM" : FIELDS(2) = "LOC"
#    FIELDS(3) = "OCPCOD" : FIELDS(4) = "LOCTYP" : FIELDS(5) = "LOCCAT"
    NBCOL = 0
  Else
    GSELFAC = 1
    TIT(0) = "Selezione VCRNUM"
#    ORDRE = "[F:YITF]STOFCY;[F:YSTC]LOC"
#    START = "[F:YSTC]LOC"
#    DEFPAG = 1
#    NBCOL = 1
#
#    Local Char CRITERE(250)
#    CRITERE = "[F:YITF]STOFCY = '" + FCY + "' & [F:YITF]ITMREF = '" + ITMREF + "' & [F:YSTC]LOKSTA <> 2"

  Endif
Return
**********
7,"TRT","YAX3MSELVCRLNK",""
2,"TRT","YAX3MSTOCKLIB",""
#<AdxTL>@(#)0.0.0.0 $Revision$
#**
#* Funzione per ottenere la Legislazione, dato il Sito#*
#* @param YFCY Sito
#*!

Funprog YGET_LEG(YFCY)

  Value Char YFCY
  Local File FACILITY [F:YFCY]
  Local File COMPANY [F:YCPY]
  Local Char YLEGCPY(5),YLEG(20)

  Columns [F:YFCY](FCY,FCYNAM,LEGCPY)
  Read [F:YFCY]FCY0 = YFCY

  If !fstat
    YLEGCPY = [F:YFCY]LEGCPY
    Columns [F:YCPY](CPY,LEG)
    Read [F:YCPY]CPY0 = YLEGCPY
    If !fstat
      YLEG = [F:YCPY]LEG
    Else
      #ax3mlog
    Endif
  Else
   #ax3mlog
  Endif
End YLEG

###########################################################################################
#**
#* Controllo della disponibilità in Stock di un Articolo in un Sito & ubicazione
#*
#* @param FCY Sito dove controllare qtà disponibile
#* @param ITMREF Cod articolo di cui controllare la qtà disponibile
#* @param LOC Ubicazione dove contrllare qtà disponibile
#* @param YSTODIS Qtà Stodispo
#*!

Subprog YGETSTODISPO(FCY,ITMREF,LOC,LOT,YSTODIS)

  Value Char FCY
  Value Char ITMREF
  Value Char LOC
  Value Char LOT
  Variable Decimal YSTODIS

  Local File ITMMVT [F:YITV]
  Local File ITMMASTER [F:YITM]
  Local File ITMCATEG [F:ITG]
  Local Integer YSTA

  Read [F:YITM]ITM0 = ITMREF
  Columns [F:YITM](TCLCOD)
  Read [F:ITG]ITG0 = "";[F:YITM]TCLCOD
  Columns [F:ITG](GLOAAAFLG,GLOQQQFLG,GLORRRFLG)
  Read [F:YITV]ITV0=ITMREF;FCY

  If [F:ITG]GLOAAAFLG = 2 YSTA += 1 Endif
  If [F:ITG]GLOQQQFLG = 2 YSTA += 2 Endif
  If [F:ITG]GLORRRFLG = 2 YSTA += 4 Endif

  Call STODISPO("[F:YITV]",FCY,ITMREF,"*",LOC,1,YSTA,"","","","",YSTODIS) From STKLIB
  #Call STODISPO("[F:YITV]",FCY,ITMREF,LOT,LOC,1,YSTA,"","","","",YSTODIS) From STKLIB
End

################################

Subprog YGETSTODISPO1(YFCY,YITMREF,YLOC,YLOT,YSTODIS)

  Value Char YFCY
  Value Char YITMREF
  Value Char YLOC
  Value Char YLOT
  Variable Decimal YSTODIS

  Local File STOCK [F:YSTO]

  Filter [F:YSTO] Where ([F:YSTO]STOFCY = YFCY & [F:YSTO]ITMREF = YITMREF & [F:YSTO]LOT = YLOT & [F:YSTO]LOC = YLOC)
  For [F:YSTO]
    YSTODIS += ([F:YSTO]QTYSTU - [F:YSTO]CUMALLQTY - [F:YSTO]CUMWIPQTY)
  Next

  Filter [F:YSTO]
End

##############################################################################
#**
#* Metodo per ricavare Tipo Ubicazione
#* @param YFCY Sito
#* @param YLOC Ubicazione
#*!

Funprog YGET_LOCTYP(YFCY,YLOC)

  Value Char YFCY
  Value Char YLOC
  Local File STOLOC [F:YSTC]
  Local Char YLOCTYP(5)

  Columns [F:YSTC](LOCTYP)
  Read [F:YSTC]STC0 = YFCY;YLOC

  If(!fstat)
    YLOCTYP = [F:YSTC]LOCTYP
  Endif
End YLOCTYP
#####################################################################################
#**
#* Funzione che ritorna 2: se ubic(YLOC) è MONOITM, 1: Altrimenti
#*
#* @param YFCY Sito
#* @param YLOC Ubicazione da valutare se Monoitm o meno
#*!

Funprog YISMONOITM(YFCY,YLOC)

  Value Char YFCY
  Value Char YLOC

  Local Integer YMONOFLG
  Local File STOLOC [F:YSTC]
  Read [F:YSTC]STC0 = YFCY;YLOC
  YMONOFLG = [F:YSTC]MONITMFLG

Call ECR_TRACE("YISMONOITM:"-YFCY-"-"-YLOC-"-"-num$(YMONOFLG),0) From GESECRAN

End YMONOFLG
**********
7,"TRT","YAX3MSTOCKLIB",""
2,"TRT","YAX3MWSLIBCUSTOM",""
#<AdxTL>@(#)0.0.0.0 $Revision$
###############################################################################################################################
#                          GESTORE APERTURA TABELLE e CONFIGURATORI GRIGLIE per SELEZIONI CUSTOM
#                                           (Libreria contestuale al progetto)
###############################################################################################################################
#**
#*Sub per apertura tabelle necessarie a creazione della Link (contestuale a Funzione & Campo sui cui fare la Selezione Custom)
#*!

$HANDLE_FILES

  Case FUNCTION
    When "ENT", "USC"

      Case TYPE_FIELD
        When "LOC"
          If OPEN = 2
            If clalev([F:YSTC])=0 : Local File STOLOC [YSTC] : Endif
            If clalev([F:YITF])=0 : Local File ITMFACILIT [YITF] : Endif
            If clalev([F:YFCY])=0 : Local File FACILITY [YFCY] : Endif
          Endif
        When "ITM"
          #If OPEN = 2
            If clalev([F:YITM])=0 : Local File ITMMASTER [YITM] : Endif
            If clalev([F:YITG])=0 : Local File ITMCATEG [YITG] : Endif
            If clalev([F:YITF])=0 : Local File ITMFACILIT [YITF] : Endif
            If clalev([F:YSTO])=0 : Local File STOCK [YSTO] : Endif
          #Endif
        When "LOT"
          If OPEN = 2
            Local File STOLOT    [YSTL]
            Local File STOLOTFCY [YSLF]
          Endif

        When Default
      Endcase

    When "YCSTK"

      Case TYPE_FIELD
        When "LOC","LOCD"
          If OPEN = 2
            If clalev([F:YSTC])=0 : Local File STOLOC [YSTC] : Endif
            #If clalev([F:YITF])=0 : Local File ITMFACILIT [YITF] : Endif
            If clalev([F:YFCY])=0 : Local File FACILITY [YFCY] : Endif
            If clalev([F:YSTO])=0 : Local File STOCK [YSTO] : Endif
          Endif
        When "ITM"
          #If OPEN = 2
            If clalev([F:YSTO])=0 : Local File STOCK [YSTO] : Endif
            If clalev([F:YITM])=0 : Local File ITMMASTER [YITM] : Endif
            If clalev([F:YITG])=0 : Local File ITMCATEG [YITG] : Endif
            If clalev([F:YITF])=0 : Local File ITMFACILIT [YITF] : Endif
          #Endif
        When "LOT"
          If OPEN = 2
            #Local File STOLOT    [YSTL]
            #Local File STOLOTFCY [YSLF]
            #Local File STOCK [YSTO]
            Local File STOCK [LNK]

            #Local File STOLOTFCY [LNK]
          Endif

        When "SER"
          If OPEN = 2
            If clalev([F:YSTS])=0 : Local File STOSER    [YSTS] : Endif
            If clalev([F:YITM])=0 : Local File ITMMASTER [YITM] : Endif
          Endif

        When Default
      Endcase

    When "SOH"

       Case TYPE_FIELD
          When "TSO"
            If OPEN = 2
              Local File TABSOHTYP [YTSO]
              Local File TABSDHTYP [YTSD]
              Local File ATEXTRA [AXX]
              Local File ATEXTRA [AX3]
            Endif

          When "ITM"
            If OPEN = 2
              Local File ITMMASTER [YITM]
              Local File ITMFACILIT [YITF]
            Endif

          When Default
       Endcase

    When "YCGC1" #CONS
       Case TYPE_FIELD
          When "YCGC1" #YCALCGIAC
          When "LOC"
            If OPEN = 2
               Local File FACILITY [YFCY]
               Local File STOCK [YSTO]
               Local File STOLOC [YSTC]
            Endif
          When Default
       Endcase

    When "YBPC","YVBPC"
      Case TYPE_FIELD
          When "BPCNUM"
            If OPEN = 2
               Local File BPCUSTOMER [YBPC]
               Local File BPADDRESS [YBPA]
               Local File BPARTNER [YBPR]
               Local File BPCCATEG [YBCG]
               Local File SALESREP [YREP]
            Endif

          When "VACBPR"
            If OPEN = 2
               Local File TABVACBPR [LNK]
            Endif

          When "PTE"
            If OPEN = 2
               Local File TABPAYTERM [LNK]
            Endif

          When "ACCCOD"
            If OPEN = 2
               Local File GACCCODE [LNK]
            Endif

          When "BPAADD"
            If OPEN = 2
               Local File ATEXTRA [LNK]
            Endif

          When "POSCOD","CTY"  #Stessa SEL per CAP,Città
            If OPEN = 2
               Local File POSCOD [YPOS]
               Local File TABCOUNTRY [YTCY]
            Endif
          When Default
       Endcase

    When "VXRUNI"
      Case TYPE_FIELD
          When "VCRNUM"
            If OPEN = 2
              Local File MFGWIP [YMFG]
              Local File MFGHEAD[YMWH]
            Endif
          When Default
       Endcase

    When Default
  Endcase

Return

###############################################################################################
#**
#*Sub per Configurazione della Griglia (contestuale a Funzione & campo su cui fare le Selezione Custom)
#*!

$CONFIG_GRID

  #costante che definisce il numero di colonne della selezione custom
  Const Shortint NUM_COLS

  Case FUNCTION
    When "ENT"  #ENTRATE DIVERSE
      Case TYPE_FIELD

        When "LOC"
          Gosub LOC_ENT From YAX3MSELLOCLNK

        When "ITM"
          Gosub ITM_ENT From YAX3MSELITMLNK

        When Default
      Endcase

    When "USC"  #USCITE DIVERSE
      Case TYPE_FIELD

        When "LOC"
          Gosub LOC_USC From YAX3MSELLOCLNK

        When "ITM"
          Gosub ITM_USC From YAX3MSELITMLNK

        When "LOT"
          Gosub LOT_USC From YAX3MSELLOTLNK

        When Default
      Endcase

    When "YCSTK"  #CAMBIO STOCK
      Case TYPE_FIELD

        When "LOC"
          Gosub LOC_CSTK From YAX3MSELLOCLNK

         When "LOCD"
          Gosub LOCD_CSTK From YAX3MSELLOCLNK

        When "ITM"
          Gosub ITM_CSTK From YAX3MSELITMLNK

        When "LOT"
          Gosub LOT_CSTK From YAX3MSELLOTLNK

        When "SER"
          Gosub SER_CSTK From YAX3MSELSERLNK

        When Default
      Endcase

    When "SOH"  #ORDINI DI VENDITA
      Case TYPE_FIELD
        When "TSO"
          Gosub TSO_SOH From YAX3MSELTSOLNK

        When "ITM"
          Gosub ITM_SOH From YAX3MSELITMLNK

        When Default
      Endcase

    When "YCGC1"  #CONS
      Case TYPE_FIELD

        When "YCGC1"  # Bottone di ricerca per Consultazione #YCALCGIAC
          #Gosub READ_YCGC1 From YCALCGIAC
          Gosub READ_YCALCGIAC From YAX3MSETCONS
        When "LOC"
          Gosub LOC_GC From YAX3MSELLOCLNK
        When Default
      Endcase

     When "YBPC","YVBPC"  #Creaz Cliente
      Case TYPE_FIELD

        When "BPCNUM"
          Gosub BPCNUM_BPC From YAX3MSELBPCNUMLNK

        When "VACBPR"
          Gosub VAC_BPC From YAX3MSELVACLNK

        When "PTE"
          Gosub PTE_BPC From YAX3MSELPTELNK

        When "ACCCOD"
          Gosub ACC_BPC From YAX3MSELACCLNK

        When "BPAADD"
          Gosub BPAADD_BPC From YAX3MSELBPAADDLNK

        When "POSCOD"
          Gosub POSCOD_BPC From YAX3MSELPOSCODLNK

        When "CTY"
          Gosub CTY_BPC From YAX3MSELPOSCODLNK

        When Default
      Endcase

     When "VXRUNI" #Inizio Produzione
      Case TYPE_FIELD
        When "VCRNUM"
          #Gosub VCR_VXRUNI From YAX3MSELVCRLNK

        When Default
      Endcase

    When Default
  Endcase

Return
**********
7,"TRT","YAX3MWSLIBCUSTOM",""
2,"TRT","YAX3MWSLIBCUSTOM_BCK",""
#<AdxTL>@(#)0.0.0.0 $Revision$
###############################################################################################################################
#                          GESTORE APERTURA TABELLE e CONFIGURATORI GRIGLIE per SELEZIONI
#                                           (Libreria contestuale al progetto)
###############################################################################################################################

#**
#*Sub per apertura tabelle necessarie a creazione della Link (contestuale a Funzione & Campo sui cui fare la Selezione Custom)
#*!

$HANDLE_FILES

  Case FUNCTION
    When "ENT", "USC"

      Case TYPE_FIELD
        When "LOC"
          If OPEN = 2
            If clalev([F:YSTC])=0 : Local File STOLOC [YSTC] : Endif
            If clalev([F:YITF])=0 : Local File ITMFACILIT [YITF] : Endif
            If clalev([F:YFCY])=0 : Local File FACILITY [YFCY] : Endif
          Endif
        When "ITM"
          #If OPEN = 2
            If clalev([F:YITM])=0 : Local File ITMMASTER [YITM] : Endif
            If clalev([F:YITG])=0 : Local File ITMCATEG [YITG] : Endif
            If clalev([F:YITF])=0 : Local File ITMFACILIT [YITF] : Endif
            If clalev([F:YSTO])=0 : Local File STOCK [YSTO] : Endif
          #Endif
        When "LOT"
          If OPEN = 2
            Local File STOLOT    [YSTL]
            Local File STOLOTFCY [YSLF]
          Endif

        When Default
      Endcase

    When "YCSTK"

      Case TYPE_FIELD
        When "LOC","LOCD"
          If OPEN = 2
            If clalev([F:YSTC])=0 : Local File STOLOC [YSTC] : Endif
            #If clalev([F:YITF])=0 : Local File ITMFACILIT [YITF] : Endif
            If clalev([F:YFCY])=0 : Local File FACILITY [YFCY] : Endif
            If clalev([F:YSTO])=0 : Local File STOCK [YSTO] : Endif
          Endif
        When "ITM"
          #If OPEN = 2
            If clalev([F:YSTO])=0 : Local File STOCK [YSTO] : Endif
            If clalev([F:YITM])=0 : Local File ITMMASTER [YITM] : Endif
            If clalev([F:YITG])=0 : Local File ITMCATEG [YITG] : Endif
            If clalev([F:YITF])=0 : Local File ITMFACILIT [YITF] : Endif
          #Endif
        When "LOT"
          If OPEN = 2
            #Local File STOLOT    [YSTL]
            #Local File STOLOTFCY [YSLF]
            #Local File STOCK [YSTO]
            Local File STOCK [LNK]

            #Local File STOLOTFCY [LNK]
          Endif

        When "SER"
          If OPEN = 2
            If clalev([F:YSTS])=0 : Local File STOSER    [YSTS] : Endif
            If clalev([F:YITM])=0 : Local File ITMMASTER [YITM] : Endif
          Endif

        When Default
      Endcase

    When "SOH"

       Case TYPE_FIELD
          When "TSO"
            If OPEN = 2
              Local File TABSOHTYP [YTSO]
              Local File TABSDHTYP [YTSD]
              Local File ATEXTRA [AXX]
              Local File ATEXTRA [AX3]
            Endif

          When "ITM"
            If OPEN = 2
              Local File ITMMASTER [YITM]
              Local File ITMFACILIT [YITF]
            Endif

          When Default
       Endcase

    When "YCGC1" #CONS
       Case TYPE_FIELD
          When "YCGC1" #YCALCGIAC
          When "LOC"
            If OPEN = 2
               Local File FACILITY [YFCY]
               Local File STOCK [YSTO]
               Local File STOLOC [YSTC]
            Endif
          When Default
       Endcase

    When "YBPC","YVBPC"
      Case TYPE_FIELD
          When "BPAADD"
            If OPEN = 2
               Local File ATEXTRA [LNK]
            Endif

          When "POSCOD","CTY"  #Stessa SEL per CAP,Città
            If OPEN = 2
               Local File POSCOD [YPOS]
               Local File TABCOUNTRY [YTCY]
            Endif
          When Default
       Endcase

    When "VXRUNI"
      Case TYPE_FIELD
          When "VCRNUM"
            If OPEN = 2
              Local File MFGWIP [YMFG]
              Local File MFGHEAD[YMWH]
            Endif
          When Default
       Endcase

    When Default
  Endcase

Return

###############################################################################################
#**
#*Sub per Configurazione della Griglia (contestuale a Funzione & campo su cui fare le Selezione Custom)
#*!

$CONFIG_GRID

  #costante che definisce il numero di colonne della selezione custom
  Const Shortint NUM_COLS

  Case FUNCTION
    When "ENT"  #ENTRATE DIVERSE
      Case TYPE_FIELD

        When "LOC"
          Gosub LOC_ENT From YAX3MSELLOCLNK

        When "ITM"
          Gosub ITM_ENT From YAX3MSELITMLNK

        When Default
      Endcase

    When "USC"  #USCITE DIVERSE
      Case TYPE_FIELD

        When "LOC"
          Gosub LOC_USC From YAX3MSELLOCLNK

        When "ITM"
          Gosub ITM_USC From YAX3MSELITMLNK

        When "LOT"
          Gosub LOT_USC From YAX3MSELLOTLNK

        When Default
      Endcase

    When "YCSTK"  #CAMBIO STOCK
      Case TYPE_FIELD

        When "LOC"
          Gosub LOC_CSTK From YAX3MSELLOCLNK

         When "LOCD"
          Gosub LOCD_CSTK From YAX3MSELLOCLNK

        When "ITM"
          Gosub ITM_CSTK From YAX3MSELITMLNK

        When "LOT"
          Gosub LOT_CSTK From YAX3MSELLOTLNK

        When "SER"
          Gosub SER_CSTK From YAX3MSELSERLNK

        When Default
      Endcase

    When "SOH"  #ORDINI DI VENDITA
      Case TYPE_FIELD
        When "TSO"
          Gosub TSO_SOH From YAX3MSELTSOLNK

        When "ITM"
          Gosub ITM_SOH From YAX3MSELITMLNK

        When Default
      Endcase

    When "YCGC1"  #CONS
      Case TYPE_FIELD

        When "YCGC1"  # Bottone di ricerca per Consultazione #YCALCGIAC
          #Gosub READ_YCGC1 From YCALCGIAC
          Gosub READ_YCALCGIAC From YAX3MSETCONS
        When "LOC"
          Gosub LOC_GC From YAX3MSELLOCLNK
        When Default
      Endcase

     When "YBPC","YVBPC"  #Creaz Cliente
      Case TYPE_FIELD

        When "BPAADD"
          Gosub BPAADD_BPC From YAX3MSELBPAADDLNK

        When "POSCOD"
          Gosub POSCOD_BPC From YAX3MSELPOSCODLNK

        When "CTY"
          Gosub CTY_BPC From YAX3MSELPOSCODLNK

        When Default
      Endcase

     When "VXRUNI" #Inizio Produzione
      Case TYPE_FIELD
        When "VCRNUM"
          #Gosub VCR_VXRUNI From YAX3MSELVCRLNK

        When Default
      Endcase

    When Default
  Endcase

Return
**********
7,"TRT","YAX3MWSLIBCUSTOM_BCK",""
2,"TRT","YAX3MWSLIBOBJECT",""
#<AdxTL>@(#)0.0.0.0 $Revision$
###############################################################################################################################
#                              GESTORE APERTURA TABELLE e Creazione LINK per SELEZIONI AD OGGETTO
#                                           (Libreria contestuale al progetto)
###############################################################################################################################

#NOTA: ad ogni nuovo oggetto di cui si ha bisogno, aggiungere un "When" con il suo codice e assegnare le tabelle associate
# (si vedano i trt "WO_" o "WGO_")
#**
#*Sub per apertura tabelle e creazione LINK (contestualmente all'oggetto in esame) usate per la Selezione ad Oggetto
#*!

$GET_LINK

  Case OBJECT
    When "ITM"
      If clalev([F:ITF])=0 : Local File ITMFACILIT [ITF] : Endif
      If clalev([F:ITM])=0 : Local File ITMMASTER [ITM] : Endif
      If clalev([F:ITS])=0 : Local File ITMSALES [ITS] : Endif
      If clalev([F:AXX])=0 : Local File ATEXTRA [AXX] : Endif
      If clalev([F:AX3])=0 : Local File ATEXTRA [AX3] : Endif
      If clalev([F:AX4])=0 : Local File ATEXTRA [AX4] : Endif

      Gosub OUVFIC_LISTE From = "WO" + OBJECT

      Default File "[" + OBJECT + "_]"

    When "FCY"
      If clalev([F:CPY3])=0 : Local File COMPANY [CPY3] : Endif
      If clalev([F:FCY])=0 : Local File FACILITY [FCY] : Endif

      Gosub INIT_BOITE From  = "WGO" + OBJECT

      Default File "[" + OBJECT + "_]"

    When "LOC"
      If clalev([F:AFF])=0 : Local File AFCTFCY  [AFF] : Endif
      If clalev([F:FGR])=0 : Local File FACGROUP [FGR] : Endif
      If clalev([F:STC])=0 : Local File STOLOC [STC] : Endif

      Gosub INIT_BOITE From  = "WGO" + OBJECT

      Default File "[STC_]"

    When "TSO"
      If clalev([F:TSO])=0 : Local File TABSOHTYP [TSO] : Endif
      If clalev([F:AXX])=0 : Local File ATEXTRA [AXX] : Endif
      If clalev([F:AX3])=0 : Local File ATEXTRA [AX3] : Endif
      If clalev([F:TSD])=0 : Local File TABSDHTYP [TSD] : Endif

      Gosub INIT_BOITE From  = "WGO" + OBJECT

      Default File "[" + OBJECT + "_]"

      # Aggiunto filtro su Categoria d'ordine a 1 (Normale) come da comportamento su funzione nativa ODV
      Filter [F] Where [F]SOHCAT = 1

    When "BPR"
      If clalev([F:BPR])=0 : Local File BPARTNER [BPR] : Endif
      If clalev([F:BPC])=0 : Local File BPCUSTOMER [BPC] : Endif
      If clalev([F:BPS])=0 : Local File BPSUPPLIER [BPS] : Endif
      If clalev([F:BPA])=0 : Local File BPADDRESS [BPA] : Endif

      Gosub INIT_BOITE From  = "WGO" + OBJECT

      Default File "[" + OBJECT + "_]"

    When "BCG"
      If clalev([F:BCG])=0 : Local File BPCCATEG [BCG] : Endif
      If clalev([F:TMD])=0 : Local File TABMODELIV [TMD] : Endif
      If clalev([F:TCU])=0 : Local File TABCUR [TCU] : Endif
      If clalev([F:AXX])=0 : Local File ATEXTRA [AXX] : Endif
      If clalev([F:AX3])=0 : Local File ATEXTRA [AX3] : Endif

      Gosub INIT_BOITE From  = "WGO" + OBJECT

      Default File "[" + OBJECT + "_]"

    When "SOH"
      If clalev([F:SOH])=0 : Local File SORDER  [SOH] : Endif
      If clalev([F:AFF])=0 : Local File AFCTFCY  [AFF] : Endif
      If clalev([F:FGR])=0 : Local File FACGROUP [FGR] : Endif
      If clalev([F:TSO])=0 : Local File TABSOHTYP [TSO] : Endif
      If clalev([F:REP])=0 : Local File SALESREP [REP] : Endif
      If clalev([F:TMD])=0 : Local File TABMODELIV [TMD] : Endif
      If clalev([F:BPA])=0 : Local File BPADDRESS [BPA] : Endif

      Gosub INIT_BOITE From  = "WGO" + OBJECT

      Default File "[" + OBJECT + "_]"

    When "TCY"
      If clalev([F:TCY])=0 : Local File TABCOUNTRY [TCY] : Endif
      If clalev([F:AXX])=0 : Local File ATEXTRA [AXX] : Endif
      If clalev([F:AX3])=0 : Local File ATEXTRA [AX3] : Endif
      If clalev([F:AX4])=0 : Local File ATEXTRA [AX4] : Endif

      Gosub INIT_BOITE From  = "WGO" + OBJECT

      Default File "[" + OBJECT + "_]"

    When "BPC"
      If clalev([F:BPC])=0 : Local File BPCUSTOMER [BPC] : Endif
      If clalev([F:BPA])=0 : Local File BPADDRESS [BPA] : Endif
      If clalev([F:BPR])=0 : Local File BPARTNER [BPR] : Endif
      If clalev([F:BCG])=0 : Local File BPCCATEG [BCG] : Endif
      If clalev([F:REP])=0 : Local File SALESREP [REP] : Endif

      Gosub INIT_BOITE From  = "WGO" + OBJECT

      Default File "[" + OBJECT + "_]"

     When "TLP"
      #Sel a oggetto: CFGLIN (Linea Produzione)
      If clalev([F:AXX])=0 : Local File ATEXTRA [AXX] : Endif
      If clalev([F:TLP])=0 : Local File TABLINCFG [TLP] : Endif

      Gosub INIT_BOITE From  = "WGO" + OBJECT

      Default File "[" + OBJECT + "_]"


    When Default

  Endcase

Return
**********
7,"TRT","YAX3MWSLIBOBJECT",""
2,"TRT","YAX3MWSLIBOBJECT_BCK",""
#<AdxTL>@(#)0.0.0.0 $Revision$
###############################################################################################################################
#                              GESTORE APERTURA TABELLE e Creazione LINK per SELEZIONI AD OGGETTO
#                                           (Libreria contestuale al progetto)
###############################################################################################################################

#NOTA: ad ogni nuovo oggetto di cui si ha bisogno, aggiungere un "When" con il suo codice e assegnare le tabelle associate
# (si vedano i trt "WO_" o "WGO_")
#**
#*Sub per apertura tabelle e creazione LINK (contestualmente all'oggetto in esame) usate per la Selezione ad Oggetto
#*!

$GET_LINK

  Case OBJECT
    When "ITM"
      If clalev([F:ITF])=0 : Local File ITMFACILIT [ITF] : Endif
      If clalev([F:ITM])=0 : Local File ITMMASTER [ITM] : Endif
      If clalev([F:ITS])=0 : Local File ITMSALES [ITS] : Endif
      If clalev([F:AXX])=0 : Local File ATEXTRA [AXX] : Endif
      If clalev([F:AX3])=0 : Local File ATEXTRA [AX3] : Endif
      If clalev([F:AX4])=0 : Local File ATEXTRA [AX4] : Endif

      Gosub OUVFIC_LISTE From = "WO" + OBJECT

      Default File "[" + OBJECT + "_]"

    When "FCY"
      If clalev([F:CPY3])=0 : Local File COMPANY [CPY3] : Endif
      If clalev([F:FCY])=0 : Local File FACILITY [FCY] : Endif

      Gosub INIT_BOITE From  = "WGO" + OBJECT

      Default File "[" + OBJECT + "_]"

    When "LOC"
      If clalev([F:AFF])=0 : Local File AFCTFCY  [AFF] : Endif
      If clalev([F:FGR])=0 : Local File FACGROUP [FGR] : Endif
      If clalev([F:STC])=0 : Local File STOLOC [STC] : Endif

      Gosub INIT_BOITE From  = "WGO" + OBJECT

      Default File "[STC_]"

    When "TSO"
      If clalev([F:TSO])=0 : Local File TABSOHTYP [TSO] : Endif
      If clalev([F:AXX])=0 : Local File ATEXTRA [AXX] : Endif
      If clalev([F:AX3])=0 : Local File ATEXTRA [AX3] : Endif
      If clalev([F:TSD])=0 : Local File TABSDHTYP [TSD] : Endif

      Gosub INIT_BOITE From  = "WGO" + OBJECT

      Default File "[" + OBJECT + "_]"

      # Aggiunto filtro su Categoria d'ordine a 1 (Normale) come da comportamento su funzione nativa ODV
      Filter [F] Where [F]SOHCAT = 1

    When "BPR"
      If clalev([F:BPR])=0 : Local File BPARTNER [BPR] : Endif
      If clalev([F:BPC])=0 : Local File BPCUSTOMER [BPC] : Endif
      If clalev([F:BPS])=0 : Local File BPSUPPLIER [BPS] : Endif
      If clalev([F:BPA])=0 : Local File BPADDRESS [BPA] : Endif

      Gosub INIT_BOITE From  = "WGO" + OBJECT

      Default File "[" + OBJECT + "_]"

    When "BCG"
      If clalev([F:BCG])=0 : Local File BPCCATEG [BCG] : Endif
      If clalev([F:TMD])=0 : Local File TABMODELIV [TMD] : Endif
      If clalev([F:TCU])=0 : Local File TABCUR [TCU] : Endif
      If clalev([F:AXX])=0 : Local File ATEXTRA [AXX] : Endif
      If clalev([F:AX3])=0 : Local File ATEXTRA [AX3] : Endif

      Gosub INIT_BOITE From  = "WGO" + OBJECT

      Default File "[" + OBJECT + "_]"

    When "SOH"
      If clalev([F:SOH])=0 : Local File SORDER  [SOH] : Endif
      If clalev([F:AFF])=0 : Local File AFCTFCY  [AFF] : Endif
      If clalev([F:FGR])=0 : Local File FACGROUP [FGR] : Endif
      If clalev([F:TSO])=0 : Local File TABSOHTYP [TSO] : Endif
      If clalev([F:REP])=0 : Local File SALESREP [REP] : Endif
      If clalev([F:TMD])=0 : Local File TABMODELIV [TMD] : Endif
      If clalev([F:BPA])=0 : Local File BPADDRESS [BPA] : Endif

      Gosub INIT_BOITE From  = "WGO" + OBJECT

      Default File "[" + OBJECT + "_]"

    When "TCY"
      If clalev([F:TCY])=0 : Local File TABCOUNTRY [TCY] : Endif
      If clalev([F:AXX])=0 : Local File ATEXTRA [AXX] : Endif
      If clalev([F:AX3])=0 : Local File ATEXTRA [AX3] : Endif
      If clalev([F:AX4])=0 : Local File ATEXTRA [AX4] : Endif

      Gosub INIT_BOITE From  = "WGO" + OBJECT

      Default File "[" + OBJECT + "_]"

    When "BPC"
      If clalev([F:BPC])=0 : Local File BPCUSTOMER [BPC] : Endif
      If clalev([F:BPA])=0 : Local File BPADDRESS [BPA] : Endif
      If clalev([F:BPR])=0 : Local File BPARTNER [BPR] : Endif
      If clalev([F:BCG])=0 : Local File BPCCATEG [BCG] : Endif
      If clalev([F:REP])=0 : Local File SALESREP [REP] : Endif

      Gosub INIT_BOITE From  = "WGO" + OBJECT

      Default File "[" + OBJECT + "_]"

     When "TLP"
      #Sel a oggetto: CFGLIN (Linea Produzione)
      If clalev([F:AXX])=0 : Local File ATEXTRA [AXX] : Endif
      If clalev([F:TLP])=0 : Local File TABLINCFG [TLP] : Endif

      Gosub INIT_BOITE From  = "WGO" + OBJECT

      Default File "[" + OBJECT + "_]"

    When Default

  Endcase

Return
**********
7,"TRT","YAX3MWSLIBOBJECT_BCK",""
2,"TRT","YBPC",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$ACTION

#If GUSER='ADMIN' : Infbox(ACTION) : Endif

  Case ACTION
    When "OUVRE"         : Gosub OUVRE
    When "DEBUT"         : Gosub DEBUT
    When "FIN"           : Gosub FIN
    When Default
  Endcase

Return

#################################################################################

$OUVRE
Return

#################################################################################

$DEBUT
  Call OUVRE_TRACE ("YAX3M - YBPC - Gestione Clienti - " - num$(date$)) From LECFIC
  Call ECR_TRACE("# -- Gestione Clienti --- ",0) From GESECRAN
Return

################################################################################

$FIN
  Call FERME_TRACE From LECFIC
Return

#######################################################################################################################
#######################################################################################################################
#**
#* Inizializzazione - NOTA: Se la finestra è composta da più  maschere, aggiungere YCURRMSK1, YCURRMSKALIAS1,...
#*!

$INIT_FILE

  Local Char YWINNAME(20): YWINNAME = "YBPC"
  Local Char YCURRMSK(20): YCURRMSK = "YBPC"           #NOTA: Se la finestra è composta da più  maschere: Local Char YCURRMSK1(20): YCURRMSK1 = "<Nome>"
  Local Char YCURRMSKALIAS(20): YCURRMSKALIAS= "YBPC"  #NOTA: Se la finestra è composta da più  maschere: Local Char YCURRMSKALIAS1(20): YCURRMSKALIAS1 = "<NomeAlias>"
  Local Char YACTION(20)
  Local Char YCURRFIELD(20)
Return

########################################################################################################################
################################################ SUBPROG /FUNPROG ######################################################
########################################################################################################################

#=============================================== AZIONI-CAMPO ==========================================================
#BPCNUM: (gestione a Barcode & QrCode)SEL,gestione se esiste già-- in modifica: controllo assenza caratteri

Subprog C_BPCNBPC(BPCNUM,BPRNAM,BCGCOD,EECNUM,VACBPR,PTE,ACCCOD,YAX3MRESP,YRESPONSE,BPAADD,BPAADDLIG,TEL,WEB,FCYWEB,CRY,POSCOD,CTY)

  Variable Char BPCNUM
  Variable Char BPRNAM
  Variable Char BCGCOD
  Variable Char EECNUM
  Variable Char VACBPR
  Variable Char PTE
  Variable Char ACCCOD

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char BPAADD()
  Variable Char BPAADDLIG()
  Variable Char CRY()
  Variable Char TEL()
  Variable Char WEB()
  Variable Char FCYWEB()
  Variable Char POSCOD()
  Variable Char CTY()

  Local File BPCUSTOMER [F:YBPC]
  Local File BPADDRESS [F:YBPA]
  Local File BPARTNER [F:YBPR]
  Local Integer K,I
  Local Integer YMODIF,YMODIF_RIQUADRO_COUNT
  Local Char YBPCNUM(15): YBPCNUM = vireblc(BPCNUM,2)

  Call OUVRE_TRACE("C_BPCNBPC") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCBPCNBPC"
  YCURRFIELD = "BPCNUM"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  Read [F:YBPC]BPC0 = BPCNUM
  If(fstat)
    #Cliente nuovo
    Call YAX3MOB_SETLABEL(YFIELDS,YCURRFIELD,0,"*Modalità Creazione",CURRENTROW) From YAX3MUTILS
    Call ECR_TRACE (YBPCNUM -":"-"*Modalità Creazione Cliente",0) From GESECRAN

    #pulisco videata
    Raz BPRNAM,BCGCOD,EECNUM,VACBPR,PTE,ACCCOD
    Gosub YAFFZO_HEADER_YBPC

    For K = 0 To func YUTILS.COUNT(BPAADD)-1
      Raz BPAADD(K),BPAADDLIG(K),TEL(K),WEB(K),FCYWEB(K),CRY(K),POSCOD(K),CTY(K)

      Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"BPAADD",K) From YAX3MUTILS
      Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"BPAADDLIG",K) From YAX3MUTILS
      Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"TEL",K) From YAX3MUTILS
      Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"WEB",K) From YAX3MUTILS
      Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"FCYWEB",K) From YAX3MUTILS
      Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"CRY",K) From YAX3MUTILS
      Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"POSCOD",K) From YAX3MUTILS
      Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"CTY",K) From YAX3MUTILS
    Next

    #Aggiorno (lato X3) righe Riquadro
    Call YAX3MOB_UPDATE_NBLIG(YCURRMSKALIAS,"NBLIG",1) From YAX3MUTILS
  Else
    #Cliente esistente(IN MODIFICA)
    Call YAX3MOB_SETLABEL(YFIELDS,YCURRFIELD,0,"*Modalità Modifica",CURRENTROW) From YAX3MUTILS
    Call ECR_TRACE (YBPCNUM -":"-"*Modalità Modifica Cliente",0) From GESECRAN

    #pulisco videata
    Raz BPRNAM,BCGCOD,EECNUM,VACBPR,PTE,ACCCOD
    For K = 0 To func YUTILS.COUNT(BPAADD)-1
      Raz BPAADD(K),BPAADDLIG(K),TEL(K),WEB(K),FCYWEB(K),CRY(K),POSCOD(K),CTY(K)
    Next

    #LINK: estrai dati(record set) : cerco i terzi: BPATYP = 1
    Link [YBPA] With [F:YBPC]BPC0 ~=[F:YBPA]BPANUM,
&               [F:YBPR]BPR0 ~=[F:YBPA]BPANUM
&               As [LNK] Where ([F:YBPA]BPATYP = 1 & [F:YBPC]BPCNUM = YBPCNUM)
&               Order By Key KEYBPA = [F:YBPA]BPANUM;[F:YBPA]BPAADD

    Columns [LNK]([F:YBPC]BCGCOD,[F:YBPC]BPCNUM,[F:YBPC]BPCNAM,[F:YBPR]EECNUM,[F:YBPC]VACBPR,[F:YBPC]PTE,[F:YBPC]ACCCOD,
&                 [F:YBPA]BPAADD,[F:YBPA]BPAADDLIG,[F:YBPA]TEL,[F:YBPA]WEB,[F:YBPA]FCYWEB,[F:YBPA]CRY,[F:YBPA]POSCOD,[F:YBPA]CTY)

    Call ECR_TRACE("ROWCOUNT ="-num$(rowcount([LNK])),0) From GESECRAN
    Call YAX3MOB_UPDATE_NBLIG(YCURRMSKALIAS,"NBLIG",rowcount([LNK])) From YAX3MUTILS

    #Popolamento Campi
    For [LNK]KEYBPA(1)
      BCGCOD = [F:YBPC]BCGCOD
      BPRNAM = [F:YBPC]BPCNAM
      EECNUM = [F:YBPR]EECNUM
      VACBPR = [F:YBPC]VACBPR
      PTE    = [F:YBPC]PTE
      ACCCOD = [F:YBPC]ACCCOD

      Gosub YAFFZO_HEADER_YBPC

      For [LNK]KEYBPA(2)

         BPAADD(I)    = [F:YBPA]BPAADD
         BPAADDLIG(I) = [F:YBPA]BPAADDLIG
         TEL(I)       = [F:YBPA]TEL
         WEB(I)       = [F:YBPA]WEB
         FCYWEB(I)    = [F:YBPA]FCYWEB
         CRY(I)       = [F:YBPA]CRY
         POSCOD(I)    = [F:YBPA]POSCOD
         CTY(I)       = [F:YBPA]CTY

         Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"BPAADD",I) From YAX3MUTILS
         Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"BPAADDLIG",I) From YAX3MUTILS
         Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"TEL",I) From YAX3MUTILS
         Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"WEB",I) From YAX3MUTILS
         Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"FCYWEB",I) From YAX3MUTILS
         Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"CRY",I) From YAX3MUTILS
         Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"POSCOD",I) From YAX3MUTILS
         Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"CTY",I) From YAX3MUTILS

         I += 1
      Next
    Next

    If(type(YMODIF)< 0 | type(YMODIF_RIQUADRO_COUNT)< 0)
      Local Integer YMODIF,YMODIF_RIQUADRO_COUNT
    Endif

    YMODIF = 1
    YMODIF_RIQUADRO_COUNT = I
    Call YAX3MOB_UPDATE_NBLIG(YCURRMSKALIAS,"NBLIG",YMODIF_RIQUADRO_COUNT) From YAX3MUTILS
  Endif
  mkstat = 0

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

########################################################################################################################################
#BCG: C, SEL_obj

Subprog C_BCGBPC(BPCNUM,BPRNAM,BCGCOD,EECNUM,VACBPR,PTE,ACCCOD,YAX3MRESP,YRESPONSE,BPAADD,BPAADDLIG,TEL,WEB,FCYWEB,CRY,POSCOD,CTY)

  Variable Char BPCNUM
  Variable Char BPRNAM
  Variable Char BCGCOD
  Variable Char EECNUM
  Variable Char VACBPR
  Variable Char PTE
  Variable Char ACCCOD

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char BPAADD()
  Variable Char BPAADDLIG()
  Variable Char CRY()
  Variable Char TEL()
  Variable Char WEB()
  Variable Char FCYWEB()
  Variable Char POSCOD()
  Variable Char CTY()

  Call OUVRE_TRACE("C_BCGBPC") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCBCGBPC"
  YCURRFIELD = "BCGCOD"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  Local File BPCCATEG [F:YBCG]
  Read [F:YBCG]BCG0 = BCGCOD

  If fstat
    mkstat = 2
    YMESSAGE = "ATTENZIONE! Categoria inesistente!"
    Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
  Else
    mkstat = 0
    Call YAX3MOB_SETLABEL(YFIELDS,YCURRFIELD,0,[F:YBCG]BCGDES, CURRENTROW) From YAX3MUTILS
    #YMESSAGE = [F:YBCG]BCGDES    #In YMESSAGE metto Descrizione Categoria inserito (valido)
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

#######################################################################################################
#VACBPR: Regime IVA (d'imposta) : C, SEL-OBJ

Subprog C_VACBPC(BPCNUM,BPRNAM,BCGCOD,EECNUM,VACBPR,PTE,ACCCOD,YAX3MRESP,YRESPONSE,BPAADD,BPAADDLIG,TEL,WEB,FCYWEB,CRY,POSCOD,CTY)

  Variable Char BPCNUM
  Variable Char BPRNAM
  Variable Char BCGCOD
  Variable Char EECNUM
  Variable Char VACBPR
  Variable Char PTE
  Variable Char ACCCOD

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char BPAADD()
  Variable Char BPAADDLIG()
  Variable Char CRY()
  Variable Char TEL()
  Variable Char WEB()
  Variable Char FCYWEB()
  Variable Char POSCOD()
  Variable Char CTY()

  Local File TABVACBPR [F:YTVB]
  Local Char YLEG(20):YLEG = "ITA"

  Call OUVRE_TRACE("C_VACBPC") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCVACBPC"
  YCURRFIELD = "VACBPR"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  VACBPR = vireblc(VACBPR,2)
  Read [F:YTVB]TVB0 = VACBPR;YLEG
  If(!fstat)
    mkstat = 0
    #Call YAX3MOB_SETLABEL(YFIELDS,YCURRFIELD,0,[F:YTVB]SHOAXX,CURRENTROW) From YAX3MUTILS
    Call YAX3MOB_RAZLABEL(YFIELDS,YCURRFIELD,CURRENTROW) From YAX3MUTILS
  Else
    mkstat = 2
    YMESSAGE = "Attenzione! Regime IVA non in anagrafica!"
    Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC

End

#######################################################################################################
#PTE:Cond. pagamento : C, SEL-OBJ

Subprog C_PTEBPC(BPCNUM,BPRNAM,BCGCOD,EECNUM,VACBPR,PTE,ACCCOD,YAX3MRESP,YRESPONSE,BPAADD,BPAADDLIG,TEL,WEB,FCYWEB,CRY,POSCOD,CTY)

  Variable Char BPCNUM
  Variable Char BPRNAM
  Variable Char BCGCOD
  Variable Char EECNUM
  Variable Char VACBPR
  Variable Char PTE
  Variable Char ACCCOD

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char BPAADD()
  Variable Char BPAADDLIG()
  Variable Char CRY()
  Variable Char TEL()
  Variable Char WEB()
  Variable Char FCYWEB()
  Variable Char POSCOD()
  Variable Char CTY()

  Local File TABPAYTERM [F:YTPT]
  Local Char YLEG(20):YLEG = "ITA"    #legislazione
  Local Integer YPTELIN: YPTELIN = 1  #riga condizione

  Call OUVRE_TRACE("C_PTEBPC") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCPTEBPC"
  YCURRFIELD = "PTE"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  PTE = vireblc(PTE,2)
  Read [F:YTPT]TPT0 = PTE;YLEG;YPTELIN
  If(!fstat)
    mkstat = 0
    #Call YAX3MOB_SETLABEL(YFIELDS,YCURRFIELD,0,[F:YTPT]DESAXX,CURRENTROW) From YAX3MUTILS
    Call YAX3MOB_RAZLABEL(YFIELDS,YCURRFIELD,CURRENTROW) From YAX3MUTILS
  Else
    mkstat = 2
    YMESSAGE = "Attenzione! Cond.Pagamento non in anagrafica!"
    Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End


########################################################################################################
#ACCCOD: Codice Contabile: C, SEL_OBJ

Subprog C_ACCDBPC(BPCNUM,BPRNAM,BCGCOD,EECNUM,VACBPR,PTE,ACCCOD,YAX3MRESP,YRESPONSE,BPAADD,BPAADDLIG,TEL,WEB,FCYWEB,CRY,POSCOD,CTY)

  Variable Char BPCNUM
  Variable Char BPRNAM
  Variable Char BCGCOD
  Variable Char EECNUM
  Variable Char VACBPR
  Variable Char PTE
  Variable Char ACCCOD

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char BPAADD()
  Variable Char BPAADDLIG()
  Variable Char CRY()
  Variable Char TEL()
  Variable Char WEB()
  Variable Char FCYWEB()
  Variable Char POSCOD()
  Variable Char CTY()

  Local File GACCCODE [F:YCAC]
  Local Char YCOA(20):YCOA = "ITA"
  Local Char YACCCOD(10)

  Call OUVRE_TRACE("C_ACCDBPC") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCACCDBPC"
  YCURRFIELD = "ACCCOD"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  YACCCOD = vireblc(ACCCOD,2)
  Filter [F:YCAC] Where ([F:YCAC]COA = YCOA & [F:YCAC]ACCCOD = YACCCOD)
  If(rowcount([F:YCAC])=0)
    mkstat = 2
    YMESSAGE = "Attenzione! Cod.Contabile non in anagrafica!"
    Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
  Else
    mkstat = 0
    Call YAX3MOB_RAZLABEL(YFIELDS,YCURRFIELD,CURRENTROW) From YAX3MUTILS
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC

End

#######################################################################################################
#BPAADD: C, SEL(su tabella diversa Tipolgia Indirizzi)

Subprog C_BPDDGBPC(BPCNUM,BPRNAM,BCGCOD,EECNUM,VACBPR,PTE,ACCCOD,YAX3MRESP,YRESPONSE,BPAADD,BPAADDLIG,TEL,WEB,FCYWEB,CRY,POSCOD,CTY)

  Variable Char BPCNUM
  Variable Char BPRNAM
  Variable Char BCGCOD
  Variable Char EECNUM
  Variable Char VACBPR
  Variable Char PTE
  Variable Char ACCCOD

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char BPAADD()
  Variable Char BPAADDLIG()
  Variable Char CRY()
  Variable Char TEL()
  Variable Char WEB()
  Variable Char FCYWEB()
  Variable Char POSCOD()
  Variable Char CTY()

  Local Char YBPAADD(5)
  Call OUVRE_TRACE("C_BPDDGBPC") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCBPDDGBPC"
  YCURRFIELD = "BPAADD"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic: query su tabella diversa
  Call YSTRVALEUR(BPAADD,YBPAADD,CURRENTROW) From YAX3MUTILS
  Local File ATEXTRA [LNK]
  #prendo lo stesso dataset della SEL
  Gosub SET_LINK_YBPC From YAX3MSELBPAADDLNK
  Filter [LNK] Where [LNK]IDENT2 = YBPAADD

  If(rowcount([LNK])=0)
    mkstat = 2
    YMESSAGE = "ATTENZIONE! Tipologia Indirizzo inesistente!"
    Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE,CURRENTROW) From YAX3MUTILS
  Else
    mkstat = 0
    #If(BCGCOD="IT")
      CRY(CURRENTROW)= "IT"
      Call YAX3MOB_DISZO_RIQUADRO(YFIELDS,YCURRMSKALIAS,"CRY",CURRENTROW) From YAX3MUTILS
      Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"CRY",CURRENTROW) From YAX3MUTILS
    #Endif
    #YMESSAGE = [F:YBCG]BCGDES    #In YMESSAGE metto Descrizione Categoria inserito (valido)?
  Endif
  Filter [LNK]

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

######################################################################################################
# TEL: C
Subprog C_TELBPC(BPCNUM,BPRNAM,BCGCOD,EECNUM,VACBPR,PTE,ACCCOD,YAX3MRESP,YRESPONSE,BPAADD,BPAADDLIG,TEL,WEB,FCYWEB,CRY,POSCOD,CTY)

  Variable Char BPCNUM
  Variable Char BPRNAM
  Variable Char BCGCOD
  Variable Char EECNUM
  Variable Char VACBPR
  Variable Char PTE
  Variable Char ACCCOD

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char BPAADD()
  Variable Char BPAADDLIG()
  Variable Char CRY()
  Variable Char TEL()
  Variable Char WEB()
  Variable Char FCYWEB()
  Variable Char POSCOD()
  Variable Char CTY()

  Call OUVRE_TRACE("C_TELBPC") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCTELBPC"
  YCURRFIELD = "TEL"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  Local Char YTEL (20)
  Call YSTRVALEUR(TEL,YTEL,CURRENTROW) From YAX3MUTILS
  If(func YAX3MCRMLIB.YREG_TELSTRINGCHECK(YTEL)>0)
    mkstat =2
    YMESSAGE = "Attenzione!Il N°di telefono inserito non ha un formato corretto!"
    Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE,CURRENTROW) From YAX3MUTILS
  Else
    mkstat =0
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD_NOFOCUS From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

#######################################################################################################
# WEB: C

Subprog C_WEBBPC(BPCNUM,BPRNAM,BCGCOD,EECNUM,VACBPR,PTE,ACCCOD,YAX3MRESP,YRESPONSE,BPAADD,BPAADDLIG,TEL,WEB,FCYWEB,CRY,POSCOD,CTY)

  Variable Char BPCNUM
  Variable Char BPRNAM
  Variable Char BCGCOD
  Variable Char EECNUM
  Variable Char VACBPR
  Variable Char PTE
  Variable Char ACCCOD

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char BPAADD()
  Variable Char BPAADDLIG()
  Variable Char CRY()
  Variable Char TEL()
  Variable Char WEB()
  Variable Char FCYWEB()
  Variable Char POSCOD()
  Variable Char CTY()

  Call OUVRE_TRACE("C_WEBBPC") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCWEBBPC"
  YCURRFIELD = "WEB"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  mkstat =0

  #end
  Gosub YAX3MOB_END_ACTIONFIELD_NOFOCUS From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

#######################################################################################################
# FCYWEB - sito web: C

Subprog C_FWEBBPC(BPCNUM,BPRNAM,BCGCOD,EECNUM,VACBPR,PTE,ACCCOD,YAX3MRESP,YRESPONSE,BPAADD,BPAADDLIG,TEL,WEB,FCYWEB,CRY,POSCOD,CTY)

  Variable Char BPCNUM
  Variable Char BPRNAM
  Variable Char BCGCOD
  Variable Char EECNUM
  Variable Char VACBPR
  Variable Char PTE
  Variable Char ACCCOD

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char BPAADD()
  Variable Char BPAADDLIG()
  Variable Char CRY()
  Variable Char TEL()
  Variable Char WEB()
  Variable Char FCYWEB()
  Variable Char POSCOD()
  Variable Char CTY()

  Call OUVRE_TRACE("C_FWEBBPC") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCFWEBBPC"
  YCURRFIELD = "FCYWEB"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  mkstat =0

  #end
  Gosub YAX3MOB_END_ACTIONFIELD_NOFOCUS From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

#######################################################################################################
#CRY : C

Subprog C_CRYBPC(BPCNUM,BPRNAM,BCGCOD,EECNUM,VACBPR,PTE,ACCCOD,YAX3MRESP,YRESPONSE,BPAADD,BPAADDLIG,TEL,WEB,FCYWEB,CRY,POSCOD,CTY)

  Variable Char BPCNUM
  Variable Char BPRNAM
  Variable Char BCGCOD
  Variable Char EECNUM
  Variable Char VACBPR
  Variable Char PTE
  Variable Char ACCCOD

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char BPAADD()
  Variable Char BPAADDLIG()
  Variable Char CRY()
  Variable Char TEL()
  Variable Char WEB()
  Variable Char FCYWEB()
  Variable Char POSCOD()
  Variable Char CTY()

  Local Char YCRY(5)
  Call OUVRE_TRACE("C_CRYBPC") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCCRYBPC"
  YCURRFIELD = "CRY"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  Call YSTRVALEUR(CRY,YCRY,CURRENTROW) From YAX3MUTILS
  Local File TABCOUNTRY [F:TCY]
  #Local Char YCRY(3): YCRY = toupper(CRY)
  Read [F:TCY]TCY0= toupper(YCRY)

  If(fstat >0)
    mkstat =2
    YMESSAGE = "ATTENZIONE! Nazione inesistente!"
    Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE,CURRENTROW) From YAX3MUTILS
  Else
    mkstat =0
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

#######################################################################################################
#POSCOD: C, SEL

Subprog C_POSCBPC(BPCNUM,BPRNAM,BCGCOD,EECNUM,VACBPR,PTE,ACCCOD,YAX3MRESP,YRESPONSE,BPAADD,BPAADDLIG,TEL,WEB,FCYWEB,CRY,POSCOD,CTY)

  Variable Char BPCNUM
  Variable Char BPRNAM
  Variable Char BCGCOD
  Variable Char EECNUM
  Variable Char VACBPR
  Variable Char PTE
  Variable Char ACCCOD

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char BPAADD()
  Variable Char BPAADDLIG()
  Variable Char CRY()
  Variable Char TEL()
  Variable Char WEB()
  Variable Char FCYWEB()
  Variable Char POSCOD()
  Variable Char CTY()

  Call OUVRE_TRACE("C_POSCBPC") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCPOSCBPC"
  YCURRFIELD = "POSCOD"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic:
#  Local File POSCOD [F:YPOS]
#  Local Char YCRY(3): YCRY = CRY(CURRENTROW)
#  Local Char YPOSCOD(10): YPOSCOD = POSCOD
#
#  If(YCRY ="IT")
#    Filter [F:YPOS] Where ([F:YPOS]CRY = YCRY & [F:YPOS]POSCOD = YPOSCOD)
#
#    If(rowcount([F:YPOS])=0)
#      mkstat = 2
#      YMESSAGE = "ATTENZIONE! CAP inesistente!"
#      Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
#    Else
      mkstat = 0
#    Endif
#    Filter [F:YPOS]
#  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

###################################################################################
#CTY: C, SEL

Subprog C_CTYBPC(BPCNUM,BPRNAM,BCGCOD,EECNUM,VACBPR,PTE,ACCCOD,YAX3MRESP,YRESPONSE,BPAADD,BPAADDLIG,TEL,WEB,FCYWEB,CRY,POSCOD,CTY)

  Variable Char BPCNUM
  Variable Char BPRNAM
  Variable Char BCGCOD
  Variable Char EECNUM
  Variable Char VACBPR
  Variable Char PTE
  Variable Char ACCCOD

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char BPAADD()
  Variable Char BPAADDLIG()
  Variable Char CRY()
  Variable Char TEL()
  Variable Char WEB()
  Variable Char FCYWEB()
  Variable Char POSCOD()
  Variable Char CTY()

  Call OUVRE_TRACE("C_CTYBPC") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCCTYBPC"
  YCURRFIELD = "CTY"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS


  #business logic:
#  Local File POSCOD [F:YPOS]
#  Local Char YCRY(3): YCRY = CRY(CURRENTROW)
#  Local Char YPOSCOD(10): YPOSCOD = POSCOD(CURRENTROW)
#
#  If(YCRY ="IT")
#    Filter [F:YPOS] Where ([F:YPOS]CRY = YCRY & [F:YPOS]POSCOD = YPOSCOD & [F:YPOS]POSCTY=CTY)
#
#    If(rowcount([F:YPOS])=0)
#      mkstat = 2
#      YMESSAGE = "ATTENZIONE! Città inesistente!"
#      Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
#    Else
      mkstat = 0
#    Endif
#    Filter [F:YPOS]
#  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD_NOFOCUS From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

########################################################################################################
#                              BOTTONE DI FINESTRA
########################################################################################################

Subprog YCREA_BPC(BPCNUM,BPRNAM,BCGCOD,EECNUM,VACBPR,PTE,ACCCOD,YAX3MRESP,YRESPONSE,BPAADD,BPAADDLIG,TEL,WEB,FCYWEB,CRY,POSCOD,CTY)

  Variable Char BPCNUM
  Variable Char BPRNAM
  Variable Char BCGCOD
  Variable Char EECNUM
  Variable Char VACBPR
  Variable Char PTE
  Variable Char ACCCOD

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char BPAADD()
  Variable Char BPAADDLIG()
  Variable Char CRY()
  Variable Char TEL()
  Variable Char WEB()
  Variable Char FCYWEB()
  Variable Char POSCOD()
  Variable Char CTY()

  Local Integer K, YSUCCESS : YSUCCESS = 0

  #apertura traccia
  Call OUVRE_TRACE("YCREA_BPC") From LECFIC
  Gosub INIT_FILE
  YACTION = "YCREABPC"
  YCURRFIELD = ""

  #init
  Gosub YAX3MOB_INIT_BUTTONACTION From YAX3MUTILS
  #parametrizzazioni iniziali (contestuali)
  YFUNC_NAME = "YBPC"
  YFUNC_TYPE = "DOC"
  YIMP_CODE = "YBPC1"        #"YBPC"
  YMEX_DOCTYPE = "Gestione Cliente"

  #business logic
  Local Integer YMODIF_MODE  # =0 : Creaz, =1 Modifica
  Local Char YBPC_ACTION(10)

  #Controllo campi Testata
  Call YCHKHEADER_YBPC(BPCNUM,BPRNAM,BCGCOD,EECNUM,VACBPR,PTE,ACCCOD,YSUCCESS,YMESSAGE)
  If(YSUCCESS >0)
    Call ECR_TRACE("Controllo TESTATA YBPC :"-YMESSAGE,0) From GESECRAN
    YALERT_MESSAGE -= YMESSAGE
    Call YAX3MOB_SHOWALERT(2, YALERT_TYPE, YALERT_MESSAGE) From YAX3MUTILS
  Else
    Local Integer YRES
    Call YCHECK_BPRCRE(BPCNUM,YRES)
    YMODIF_MODE = func YUTILS.IIF(YRES >0,0,1)
    YBPC_ACTION = func YUTILS.STR_IIF(YMODIF_MODE = 0, "Creazione", "Modifica")
  Endif

  #crea Terzo tramite modello di Import
#  Local Clbfile YCSVTEXT0(2)
#  If(BCG <> "EU")
#
#    Gosub YCSVBPR_FILL
#    Call YPRINT_CLB(YCSVTEXT0,YFUNC_NAME-"BPR", "csv") From YUTILS                           #stampo CSV(opzionale)
#    #TODO:Check correttezza codice Modello import impostato?
#    Call YAX3MOB_IMPORTSIL("BPR", YCSVTEXT0, YSUCCESS, YMESSAGE) From YAX3MUTILS
#    Call YCHECK_BPRCRE(BPCNUM,YSUCCESS)                                               #Verifica/esito Creazione Cliente
#
##    If(YSUCCESS<>2)
##     YMESSAGE = "Creazione terzo" - BPCNUM - "avvenuta con successo!"
##Infbox "terzo :"-YMESSAGE
##    Endif
#  Endif

  If(YSUCCESS=0)
    #Gosub YFILL_YBPCCSV
    Gosub YFILL_YBPCCSV1

    Call YPRINT_CLB(YCSVTEXT,YFUNC_NAME, "csv") From YUTILS                           #stampo CSV(opzionale)
    #TODO:Check correttezza codice Modello import impostato?
    Call YAX3MOB_IMPORTSIL(YIMP_CODE, YCSVTEXT, YSUCCESS, YMESSAGE) From YAX3MUTILS
    Call YCHECK_BPCCRE(BPCNUM,YSUCCESS)

    #Verifica/esito Creazione Cliente
    If(YSUCCESS>0)
      YMESSAGE = func YUTILS.IIF(YMESSAGE = AVOID.ACHAR, "Movimento di" -YBPC_ACTION- "cliente fallito! Impossibile proseguire!", YMESSAGE)
    Else
      YMESSAGE = YBPC_ACTION-"cliente" - BPCNUM - "avvenuta con successo!"
    Endif
    YALERT_MESSAGE -= YMESSAGE
 Call ECR_TRACE(YMESSAGE,0) From GESECRAN  # metti nel LOG AX3M

    If(YSUCCESS = 1)
      Call YAX3MOB_SHOWALERT(2, YALERT_TYPE, YALERT_MESSAGE) From YAX3MUTILS
    Else
      Raz BCGCOD,BPCNUM,BPRNAM,EECNUM,VACBPR,PTE,ACCCOD

      Call YAX3MOB_RAZLABEL(YFIELDS,"BCGCOD",CURRENTROW) From YAX3MUTILS
      Call YAX3MOB_RAZLABEL(YFIELDS,"BPCNUM",CURRENTROW) From YAX3MUTILS
      Call YAX3MOB_RAZLABEL(YFIELDS,"BPRNAM",CURRENTROW) From YAX3MUTILS
      Call YAX3MOB_RAZLABEL(YFIELDS,"EECNUM",CURRENTROW) From YAX3MUTILS
      Call YAX3MOB_RAZLABEL(YFIELDS,"VACBPR",CURRENTROW) From YAX3MUTILS
      Call YAX3MOB_RAZLABEL(YFIELDS,"PTE",CURRENTROW) From YAX3MUTILS
      Call YAX3MOB_RAZLABEL(YFIELDS,"ACCCOD",CURRENTROW) From YAX3MUTILS

      For K = 0 To func YUTILS.COUNT(BPAADD) - 1
        #Raz BPAADD(K),BPAADDLIG(K),CRY(K),POSCOD(K),CTY(K) #dettaglio
        Raz BPAADD(K),BPAADDLIG(K),TEL(K),WEB(K),FCYWEB(K),CRY(K),POSCOD(K),CTY(K)

        Call YAX3MOB_RAZRIQUADRO(YFIELDS,YCURRMSKALIAS) From YAX3MUTILS
        Call YAX3MOB_RAZMESSAGES(YFIELDS)From YAX3MUTILS
      Next
      Call YAX3MOB_SHOWALERT(1, YALERT_TYPE, YALERT_MESSAGE) From YAX3MUTILS
    Endif
  Endif

  #end
  Gosub YAX3MOB_END_BUTTONACTION From YAX3MUTILS
  Call FERME_TRACE From LECFIC

End

######################################################################################################
######################################################################################################
#**
#* Sub per riempimento contenuto csv per Modello di Import Creazione Cliente
#*!

$YFILL_YBPCCSV

  #INIZIO creaz csv
  Call YAX3MOB_APPEND(YCSVTEXT, "B", 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, "EU", 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, BPCNUM, 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, BPRNAM, 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS  #bprsho
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS  #bprlog
  Call YAX3MOB_APPEND(YCSVTEXT, "SL", 0) From YAX3MUTILS         #bpainv
  Call YAX3MOB_APPEND(YCSVTEXT, "SL", 0) From YAX3MUTILS         #bpapyr

  Call YAX3MOB_APPEND(YCSVTEXT, "SL", 0) From YAX3MUTILS #bpaadd
#Call YAX3MOB_APPEND(YCSVTEXT, BPAADD(0), 0) From YAX3MUTILS #bpaadd
#  If(func YUTILS.COUNT(BPAADD)>0)
#   Call YAX3MOB_APPEND(YCSVTEXT, BPAADD(0), 0) From YAX3MUTILS #bpaadd
#  Else
#    Call YAX3MOB_APPEND(YCSVTEXT, "SL", 0) From YAX3MUTILS #bpaadd
#  Endif

  Call YAX3MOB_APPEND(YCSVTEXT, "SL", 0) From YAX3MUTILS #bpdadd

  Call YAX3MOB_APPEND(YCSVTEXT, "EUR", 0) From YAX3MUTILS           #cur
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS     #crn
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS     #naf
  Call YAX3MOB_APPEND(YCSVTEXT, EECNUM, 0) From YAX3MUTILS          #eecnum
  Call YAX3MOB_APPEND(YCSVTEXT, BPCNUM, 0) From YAX3MUTILS          #bpcinv = bpcnum
  Call YAX3MOB_APPEND(YCSVTEXT, "VCE", 0) From YAX3MUTILS           #vacbpr
  Call YAX3MOB_APPEND(YCSVTEXT, "ITBON30GGFM", 0) From YAX3MUTILS   #pte
  Call YAX3MOB_APPEND(YCSVTEXT, "ITUE", 0) From YAX3MUTILS          #acccod
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS     #tsccod0
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 1) From YAX3MUTILS     #tsccod1

#Call ECR_TRACE("NUM addr= "-num$(func YUTILS.COUNT(BPAADD)),0) From GESECRAN

  Local Integer I,J : I = 0 : J = 0
  For I=0 To func YUTILS.COUNT(BPAADD) - 1
    # Row A
    Call YAX3MOB_APPEND(YCSVTEXT, "A", 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, BPAADD(I), 0) From YAX3MUTILS       #bpsadd
    Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS     #bpades
    Call YAX3MOB_APPEND(YCSVTEXT, BPAADDLIG(I), 0) From YAX3MUTILS    #bpaaddlig
    Call YAX3MOB_APPEND(YCSVTEXT, POSCOD(I), 0) From YAX3MUTILS       #poscod
    Call YAX3MOB_APPEND(YCSVTEXT, CTY(I), 0) From YAX3MUTILS          #cty
    Call YAX3MOB_APPEND(YCSVTEXT, CRY(I), 0) From YAX3MUTILS          #cry
    Call YAX3MOB_APPEND(YCSVTEXT, "0542 619234", 1) From YAX3MUTILS   #tel
  Next
  #FINE creaz csv
Return

##########################################################
$YFILL_YBPCCSV1

  #INIZIO creaz csv
  Call YAX3MOB_APPEND(YCSVTEXT, "B", 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, "EU", 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, BPCNUM, 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, BPRNAM, 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS  #bprsho
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS  #bprlog
  Call YAX3MOB_APPEND(YCSVTEXT, "SL", 0) From YAX3MUTILS         #bpainv
  Call YAX3MOB_APPEND(YCSVTEXT, "SL", 0) From YAX3MUTILS         #bpapyr

  #Call YAX3MOB_APPEND(YCSVTEXT, "SL", 0) From YAX3MUTILS #bpaadd
#Call YAX3MOB_APPEND(YCSVTEXT, BPAADD(0), 0) From YAX3MUTILS #bpaadd
#
  If(func YUTILS.COUNT(BPAADD)>0)
   Call YAX3MOB_APPEND(YCSVTEXT, BPAADD(0), 0) From YAX3MUTILS #bpaadd
  Else
    Call YAX3MOB_APPEND(YCSVTEXT, "SL", 0) From YAX3MUTILS #bpaadd
  Endif

  Call YAX3MOB_APPEND(YCSVTEXT, "SL", 0) From YAX3MUTILS #bpdadd

  Call YAX3MOB_APPEND(YCSVTEXT, "EUR", 0) From YAX3MUTILS           #cur
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS     #crn
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS     #naf
  Call YAX3MOB_APPEND(YCSVTEXT, EECNUM, 0) From YAX3MUTILS          #eecnum
  Call YAX3MOB_APPEND(YCSVTEXT, BPCNUM, 0) From YAX3MUTILS          #bpcinv = bpcnum

  #Call YAX3MOB_APPEND(YCSVTEXT, "VCE", 0) From YAX3MUTILS           #vacbpr
  Call YAX3MOB_APPEND(YCSVTEXT, VACBPR, 0) From YAX3MUTILS           #vacbpr

  #Call YAX3MOB_APPEND(YCSVTEXT, "ITBON30GGFM", 0) From YAX3MUTILS   #pte
  Call YAX3MOB_APPEND(YCSVTEXT, PTE, 0) From YAX3MUTILS   #pte

  #Call YAX3MOB_APPEND(YCSVTEXT, "ITUE", 0) From YAX3MUTILS          #acccod
  Call YAX3MOB_APPEND(YCSVTEXT, ACCCOD, 0) From YAX3MUTILS          #acccod

  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS     #tsccod0
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 1) From YAX3MUTILS     #tsccod1

  Local Integer I,J : I = 0 : J = 0
  For I=0 To func YUTILS.COUNT(BPAADD) - 1
    # Row A
    Call YAX3MOB_APPEND(YCSVTEXT, "A", 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, BPAADD(I), 0) From YAX3MUTILS       #bpsadd
    Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS     #bpades
    Call YAX3MOB_APPEND(YCSVTEXT, BPAADDLIG(I), 0) From YAX3MUTILS    #bpaaddlig
    Call YAX3MOB_APPEND(YCSVTEXT, POSCOD(I), 0) From YAX3MUTILS       #poscod
    Call YAX3MOB_APPEND(YCSVTEXT, CTY(I), 0) From YAX3MUTILS          #cty
    Call YAX3MOB_APPEND(YCSVTEXT, CRY(I), 0) From YAX3MUTILS          #cry

    Call YAX3MOB_APPEND(YCSVTEXT, TEL(I), 0) From YAX3MUTILS          #tel
    Call YAX3MOB_APPEND(YCSVTEXT, WEB(I), 0) From YAX3MUTILS          #mail (web)
    Call YAX3MOB_APPEND(YCSVTEXT, FCYWEB(I), 1) From YAX3MUTILS       #sitoweb (fcyweb)
  Next
  #FINE creaz csv
Return


######################################################################################################
#**
#* Sub per riempimento contenuto csv per Modello di Import Creazione Terzo
#*!

$YCSVBPR_FILL

  #INIZIO creaz csv
  Call YAX3MOB_APPEND(YCSVTEXT0, "B", 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT0, BPCNUM, 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT0, BPRNAM, 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT0, AVOID.ACHAR, 0) From YAX3MUTILS  #bprsho
  Call YAX3MOB_APPEND(YCSVTEXT0, AVOID.ACHAR, 0) From YAX3MUTILS  #bprlog
  Call YAX3MOB_APPEND(YCSVTEXT0, "ITA", 0) From YAX3MUTILS  #lan
  Call YAX3MOB_APPEND(YCSVTEXT0, "EUR", 0) From YAX3MUTILS  #cur
  Call YAX3MOB_APPEND(YCSVTEXT0, AVOID.ACHAR, 0) From YAX3MUTILS  #crn
  Call YAX3MOB_APPEND(YCSVTEXT0, AVOID.ACHAR, 0) From YAX3MUTILS  #naf
  Call YAX3MOB_APPEND(YCSVTEXT0, EECNUM, 0) From YAX3MUTILS   #eecnum
  Call YAX3MOB_APPEND(YCSVTEXT0, num$(1), 0) From YAX3MUTILS   #bpracc
  Call YAX3MOB_APPEND(YCSVTEXT0, "ITUE", 1) From YAX3MUTILS  #acccod

#Call ECR_TRACE("NUM addr= "-num$(func YUTILS.COUNT(BPAADD)),0) From GESECRAN
  Local Integer I,J : I = 0 : J = 0
  For I=0 To func YUTILS.COUNT(BPAADD) - 1
    # Row B
    Call YAX3MOB_APPEND(YCSVTEXT0, "A", 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT0, BPAADD(I), 0) From YAX3MUTILS  #bpaadd
    Call YAX3MOB_APPEND(YCSVTEXT0, AVOID.ACHAR, 0) From YAX3MUTILS #bpades
    Call YAX3MOB_APPEND(YCSVTEXT0, BPAADDLIG(I), 0) From YAX3MUTILS  #bpaaddlig
    Call YAX3MOB_APPEND(YCSVTEXT0, AVOID.ACHAR, 0) From YAX3MUTILS  #bpaaddlig
    Call YAX3MOB_APPEND(YCSVTEXT0, AVOID.ACHAR, 0) From YAX3MUTILS  #bpaaddlig
    Call YAX3MOB_APPEND(YCSVTEXT0, POSCOD(I), 0) From YAX3MUTILS     #poscod
    Call YAX3MOB_APPEND(YCSVTEXT0, CTY(I), 0) From YAX3MUTILS        #cty
    Call YAX3MOB_APPEND(YCSVTEXT0, CRY(I), 0) From YAX3MUTILS        #cry
    Call YAX3MOB_APPEND(YCSVTEXT0, "0542 619234", 0) From YAX3MUTILS   #tel
    Call YAX3MOB_APPEND(YCSVTEXT0, AVOID.ACHAR, 1) From YAX3MUTILS   #fax
  Next
  #FINE creaz csv
Return

########################################################################################################
#                                             Utilità
########################################################################################################
#**
#* Metodo per Controllo Creazione Terzo in Anagrafica
#*
#* @param BPCNUM Codice Cliente
#* @param YSUCCESS Booleano per successo/insuccesso
#*!

Subprog YCHECK_BPCCRE(BPCNUM,YSUCCESS)

  Value Char BPCNUM
  Variable Integer YSUCCESS

  Local File BPARTNER [F:YBPR]
  Read [F:YBPR]BPR0=toupper(BPCNUM)
  If(fstat>0)
    YSUCCESS=1
  Endif
End

##########################################################################
#**
#* Metodo per Controllo Creazione Cliente in Anagrafica
#*
#* @param BPCNUM Codice Cliente
#* @param YSUCCESS Booleano per successo/insuccesso
#*!

Subprog YCHECK_BPRCRE(BPCNUM,YSUCCESS)

  Value Char BPCNUM
  Variable Integer YSUCCESS

  Local File BPCUSTOMER [F:YBPC]
  Read [F:YBPC]BPC0=toupper(BPCNUM)
  If(fstat>0)
    YSUCCESS=1
  Endif
End

#############################################################################
#**
#* Metodo per Controllo TESTATA YBPC pre lancio azione Bottone di Finestra
#*
#* @param BPCNUM
#* @param BPRNAM
#* @param BCGCOD
#* @param EECNUM
#* @param VACBPR
#* @param PTE
#* @param ACCCOD
#* @param YSUCCESS
#* @param YMESSAGE
#*!

Subprog YCHKHEADER_YBPC(BPCNUM,BPRNAM,BCGCOD,EECNUM,VACBPR,PTE,ACCCOD,YSUCCESS,YMESSAGE)

  Variable Char BPCNUM
  Variable Char BPRNAM
  Variable Char BCGCOD
  Variable Char EECNUM
  Variable Char VACBPR
  Variable Char PTE
  Variable Char ACCCOD

  Variable Integer YSUCCESS
  Variable Char YMESSAGE

  YSUCCESS = func YUTILS.IIF(vireblc(BPCNUM,2)<> AVOID.ACHAR,0,2)
  If(YSUCCESS >0)
    YMESSAGE = "Attenzione! Campo Codice Cliente non imputato!"
    End
  Endif

  YSUCCESS = func YUTILS.IIF(vireblc(BCGCOD,2)<> AVOID.ACHAR,0,2)
  If(YSUCCESS >0)
    YMESSAGE = "Attenzione! Campo Categoria Cliente non imputata!"
    End
  Endif

  YSUCCESS = func YUTILS.IIF(vireblc(BCGCOD,2)<> AVOID.ACHAR,0,2)
  If(YSUCCESS >0)
    YMESSAGE = "Attenzione! campo Categoria Cliente non imputata!"
    End
  Endif

  YSUCCESS = func YUTILS.IIF(vireblc(EECNUM,2)<> AVOID.ACHAR,0,2)
  If(YSUCCESS >0)
    YMESSAGE = "Attenzione! Campo IVA non imputato!"
    End
  Endif

  YSUCCESS = func YUTILS.IIF(vireblc(VACBPR,2)<> AVOID.ACHAR,0,2)
  If(YSUCCESS >0)
    YMESSAGE = "Attenzione! Campo Regime IVA non imputato!"
    End
  Endif

  YSUCCESS = func YUTILS.IIF(vireblc(VACBPR,2)<> AVOID.ACHAR,0,2)
  If(YSUCCESS >0)
    YMESSAGE = "Attenzione! Campo Mod. pagamento non imputato!"
    End
  Endif

  YSUCCESS = func YUTILS.IIF(vireblc(VACBPR,2)<> AVOID.ACHAR,0,2)
  If(YSUCCESS >0)
    YMESSAGE = "Attenzione! Campo Cod.Contabile non imputato!"
    End
  Endif
End

##############################################################################
#**
#* Sub per Aggiornamento (lato X3) campi Testata YBPC
#*!

$YAFFZO_HEADER_YBPC

   Call YAX3MOB_AFFZO(YCURRMSKALIAS,"BPRNAM") From YAX3MUTILS
   Call YAX3MOB_AFFZO(YCURRMSKALIAS,"BCGCOD") From YAX3MUTILS
   Call YAX3MOB_AFFZO(YCURRMSKALIAS,"EECNUM") From YAX3MUTILS
   Call YAX3MOB_AFFZO(YCURRMSKALIAS,"VACBPR") From YAX3MUTILS
   Call YAX3MOB_AFFZO(YCURRMSKALIAS,"PTE") From YAX3MUTILS
   Call YAX3MOB_AFFZO(YCURRMSKALIAS,"ACCCOD") From YAX3MUTILS

Return
**********
7,"TRT","YBPC",""
2,"TRT","YCALCGIAC",""
#<AdxTL>@(#)0.0.0.0 $Revision$
#############################################################################################################################
#
#MC - CONSULTAZIONE GIACENZE - Consultazione App ArgoX3 Mobile - 22/05/2024
#
#############################################################################################################################

$ACTION

#If GUSER='ADMIN' : Infbox(ACTION) : Endif

  Case ACTION
    When "DEBUT"         : Gosub DEBUT
    When "FIN"           : Gosub FIN
    When Default
  Endcase
Return

###########################################################

$DEBUT

  Call OUVRE_TRACE ("YAX3M - YCALCGIAC - Calcolo Giacenze AX3M- " - num$(date$)) From LECFIC
  Call ECR_TRACE("# -- Calcolo Giacenze AX3M -- ",0) From GESECRAN
  Raz [M:YCGC1]

Return

##########################################################

$FIN
  Call FERME_TRACE From LECFIC
  Call LEC_TRACE From LECFIC
Return

########################################################################################################################

#**
#* Inizializzazione - NOTA: Se la finestra è composta da più  maschere, aggiungere YCURRMSK1, YCURRMSKALIAS1,...
#*!

$INIT_FILE

  Local Char YWINNAME(20): YWINNAME = "YCALCGIAC"
  Local Char YCURRMSK(20): YCURRMSK = "YCALCGIAC1"      #NOTA: Se la finestra è composta da più  maschere: Local Char YCURRMSK1(20): YCURRMSK1 = "<Nome>"
  Local Char YCURRMSKALIAS(20): YCURRMSKALIAS = "YCGC1"  #NOTA: Se la finestra è composta da più  maschere: Local Char YCURRMSKALIAS1(20): YCURRMSKALIAS1 = "<NomeAlias>"
  Local Char YACTION(20)
  Local Char YCURRFIELD(20)
Return

########################################################################################################################
################################################ SUBPROG /FUNPROG ######################################################
########################################################################################################################

#=======================================================================================================================
#                                                  AZIONI-CAMPO
#=======================================================================================================================

# AZIONE-CAMPO - C - Controllo FCY in anagrafica STOCK => NON ASSEGNATA!!!!
Subprog C_GIACFCY(FCY, YCODICE, LOC, YAX3MRESP, YRESPONSE,ITMREF, EANCOD, SERNUM, YLOC, LOT, STA, QTY, STU )

  Variable Char FCY
  Variable Char YCODICE
  Variable Char LOC

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char EANCOD()
  Variable Char SERNUM()
  Variable Char YLOC()
  Variable Char LOT()
  Variable Char STA()
  Variable Decimal QTY()
  Variable Char STU()

  Local File STOCK [F:YSTO]

  Call OUVRE_TRACE("C_GIACFCY") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCGIACFCY"
  YCURRFIELD = "FCY"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  #Se campo sito inserito, controllo in anagrafica(STOCK)
  If(vireblc(FCY,2) <> AVOID.ACHAR)
    Filter [F:YSTO] Where ([F:YSTO]STOFCY = FCY)
    If(rowcount([F:YSTO])= 0)
      mkstat=2
      YMESSAGE= "ATTENZIONE! Sito non in anagrafica STOCK"
      Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
    Else
      mkstat=0
    Endif
    Filter [F:YSTO]
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End


#################################################################################################################
# AZIONE-CAMPO - C - Controllo codice in anagrafica STOCK

Subprog C_GIACYCOD(FCY, YCODICE, LOC, YAX3MRESP, YRESPONSE,ITMREF, EANCOD, SERNUM, YLOC, LOT, STA, QTY, STU )

  Variable Char FCY
  Variable Char YCODICE
  Variable Char LOC

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char EANCOD()
  Variable Char SERNUM()
  Variable Char YLOC()
  Variable Char LOT()
  Variable Char STA()
  Variable Decimal QTY()
  Variable Char STU()

  Call OUVRE_TRACE("C_GIACYCOD") From LECFIC
  Gosub INIT_FILE
  YACTION = "YCGIACYCOD"
  YCURRFIELD = "YCODICE"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  Local File STOCK [F:YSTO]
  Local File ITMMASTER [F:YITM]
  YCODICE = vireblc(YCODICE,2)

  Link [YSTO] With [YITM]ITM0=[YSTO]ITMREF
&             As [LNK]
  Columns [LNK] ([YSTO]ITMREF,[YITM]ITMDES1,[YITM]EANCOD,[YSTO]SERNUM)
  Filter [LNK]  Where ([F:YSTO]ITMREF = YCODICE | [F:YITM]EANCOD = YCODICE | [F:YSTO]SERNUM = YCODICE)

  If(rowcount([LNK]) > 0)
    mkstat = 0
  Else
    mkstat = 2
    YMESSAGE = "Il codice" - YCODICE - "non è presente in anagrafica!"
    Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
  Endif
  Filter [LNK]

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

#############################################################################################################################

#LOC
Subprog C_GIACLOC(FCY, YCODICE, LOC, YAX3MRESP, YRESPONSE,ITMREF, EANCOD, SERNUM, YLOC, LOT, STA, QTY, STU )

  Variable Char FCY
  Variable Char YCODICE
  Variable Char LOC

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char EANCOD()
  Variable Char SERNUM()
  Variable Char YLOC()
  Variable Char LOT()
  Variable Char STA()
  Variable Decimal QTY()
  Variable Char STU()

  Local File STOCK [F:YSTO]
  Local Char YYLOC(10):YYLOC=LOC
  Local Char YCRITERE(250): YCRITERE ="1=1"

  Call OUVRE_TRACE("C_GIACLOC") From LECFIC
  Gosub INIT_FILE
  YACTION = "YCGIACLOC"
  YCURRFIELD = "LOC"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic: se campo Ubic inserito, controllo in anagrafica(STOCK)
  If(vireblc(FCY,2) <> AVOID.ACHAR)
    YCRITERE-="& instr(1, tolower([F:YSTO]STOFCY), tolower('" + FCY + "'))<>0"
  Endif

  If(vireblc(LOC,2) <> AVOID.ACHAR)
    YCRITERE-="& instr(1, tolower([F:YSTO]LOC), tolower('" + YYLOC + "'))<>0"
  Endif

  If(vireblc(LOC,2) <> AVOID.ACHAR)
    Filter [F:YSTO] Where evalue(YCRITERE)
    If(rowcount([F:YSTO])= 0)
      mkstat=2
      YMESSAGE= "ATTENZIONE! Ubicazione non in anagrafica STOCK"
      Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
    Else
      mkstat=0
    Endif
    Filter [F:YSTO]
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

#=======================================================================================================================
#                                               BOTTONI DI FINESTRA
#=======================================================================================================================

Subprog YCALC_GC(YLAYOUT,FCY,YCODICE,LOC,YAX3MRESP,YRESPONSE,ITMREF,EANCOD,SERNUM,YLOC,LOT,STA,QTY,STU)

  Value Integer YLAYOUT
  Variable Char FCY
  Variable Char YCODICE
  Variable Char LOC

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char EANCOD()
  Variable Char SERNUM()
  Variable Char YLOC()
  Variable Char LOT()
  Variable Char STA()
  Variable Decimal QTY()
  Variable Char STU()

  Local Integer K,YI,YSUCCESS : YSUCCESS = 0

  #apertura traccia
  Call OUVRE_TRACE("YCALC_GC") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCALCGC"
  YCURRFIELD = ""

  #init
  Gosub YAX3MOB_INIT_BUTTONACTION From YAX3MUTILS
  YFUNC_NAME = "YCALCGIAC" : YFUNC_TYPE = "CONS"
  NUM_COLS=9 #num campi riquadro (per AX3M)(N° campi Riq +1 (ITMDES1 in legame esteso)

  #business logic
  Gosub OPEN_FILES     #Apertura Tabelle
  Gosub SET_CRITERE    #Critere
  Gosub SET_LINK       #Creaz Link [LNK]

  #filter LINK + rowcount
  Filter [LNK] Where evalue(CRITERE)
  COUNT_VALUES = rowcount([LNK])

  #Popolamento
  If(COUNT_VALUES=0)
    YSUCCESS=1
    mkstat=2
  Else
    YSUCCESS =0
    #YMESSAGE = "rwcnt= "- num$(COUNT_VALUES)


    For [LNK]
      ITMREF(YI)= [F:YSTO]ITMREF
      EANCOD(YI)= [F:YITM]EANCOD
      SERNUM(YI)= [F:YSTO]SERNUM
      YLOC(YI)= [F:YSTO]LOC
      LOT(YI) = [F:YSTO]LOT
      STA(YI) = [F:YSTO]STA
      QTY(YI)= [F:YSTO]QTYSTU - [YSTO]CUMALLQTY - [YSTO]CUMWIPQTY
      STU(YI)= [F:YITM]STU

      Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"ITMREF",YI) From YAX3MUTILS
      Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"EANCOD",YI) From YAX3MUTILS
      Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"SERNUM",YI) From YAX3MUTILS
      Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"YLOC",YI) From YAX3MUTILS
      Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"LOT",YI) From YAX3MUTILS
      Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"STA",YI) From YAX3MUTILS
      Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"QTY",YI) From YAX3MUTILS
      Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"STU",YI) From YAX3MUTILS

      YI+=1

      If(YI= maxtab(ITMREF))
        Break
      Endif
    Next

    #TODO:TRADUCI PER AX3M : YAX3MOB_AFFZO_NBLIG(YCURRMASKALIAS,"NBLIG")
    If(![V]GWEBSERV)
      [M:YCGC1]NBLIG = YI
      Affzo[M:YCGC1]
    Endif
    #Call YAX3MOB_UPDATE_NBLIG(YMSKALIAS,"NBLIG",YI) From YAX3MUTILS_BETA
  Endif

#Call ECR_TRACE("QUI"-"- RWCNT = "-num$(COUNT_VALUES),0) From GESECRAN

  #end
  Gosub YAX3MOB_END_BUTTONACTION From YAX3MUTILS
  Call FERME_TRACE From LECFIC

End

##########################################################################################################################################
#Bottone Pulizia Videata

Subprog YCLEARCGC(FCY,YCODICE,LOC,YAX3MRESP,YRESPONSE,ITMREF,EANCOD,SERNUM,YLOC,LOT,STA,QTY,STU)

  Variable Char FCY
  Variable Char YCODICE
  Variable Char LOC

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char EANCOD()
  Variable Char SERNUM()
  Variable Char YLOC()
  Variable Char LOT()
  Variable Char STA()
  Variable Decimal QTY()
  Variable Char STU()

  Local Integer K

  Call OUVRE_TRACE("YCLEARCGC") From LECFIC
  Gosub INIT_FILE
  YACTION = "YCLEARCGC"
  YCURRFIELD = ""

  #init
  Gosub YAX3MOB_INIT_BUTTONACTION From YAX3MUTILS

  #business logic
  Raz FCY,YCODICE,LOC

  Call YAX3MOB_AFFZO(YCURRMSKALIAS,"FCY") From YAX3MUTILS
  Call YAX3MOB_AFFZO(YCURRMSKALIAS,"YCODICE") From YAX3MUTILS
  Call YAX3MOB_AFFZO(YCURRMSKALIAS,"LOC") From YAX3MUTILS

  For K = 0 To func YUTILS.COUNT(ITMREF) - 1
    Raz ITMREF(K),EANCOD(K),SERNUM(K),YLOC(K),LOT(K),STA(K),QTY(K),STU(K) #dettaglio

    Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"ITMREF",K) From YAX3MUTILS
    Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"ITMDES1",K) From YAX3MUTILS
    Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"EANCOD",K) From YAX3MUTILS
    Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"SERNUM",K) From YAX3MUTILS
    Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"YLOC",K) From YAX3MUTILS
    Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"LOT",K) From YAX3MUTILS
    Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"STA",K) From YAX3MUTILS
    Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"QTY",K) From YAX3MUTILS
    Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"STU",K) From YAX3MUTILS
  Next

  #end
  Gosub YAX3MOB_END_ACTIONFIELD_NOFOCUS From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

###########################################################################################################################################
#**
#*Sub dove vengono aperte le tabelle per la Link
#*(Body della Sub: contestuale alla funzione di Consultazione)
#*!

$OPEN_FILES

  Local File ITMMASTER [F:YITM]
  Local File STOSER [F:YSTS]
  Local File STOCK [F:YSTO]
Return

############################################################################################################################################
#**
#*Sub dove viene impostato il Critere attraverso cui filtrare la Link
#*(Body della Sub: contestuale alla funzione di Consultazione)
#*!

$SET_CRITERE

  Local Integer YNITM,YNSERN,YNEAN

  Local Char YTRIVCOND(10): YTRIVCOND = "1=1"
  CRITERE(0) = YTRIVCOND                # "1=1"
  CRITERE(1) = chr$(32)+"&"+YTRIVCOND   #" & 1=1"

  #filtro: FCY
  If(vireblc(FCY,2) <> AVOID.ACHAR)
    CRITERE(0)-="& instr(1, tolower([F:YSTO]STOFCY), tolower('" + FCY + "'))<>0"
  Endif

  #filtro: YCODICE
  If(vireblc(YCODICE,2) <> AVOID.ACHAR)

    #cerco eventuali Cod.Articolo
    Filter [F:YSTO] Where [F:YSTO]ITMREF = YCODICE
    YNITM= rowcount([F:YSTO])
    Filter [F:YSTO]

    #cerco eventuali Matricole
    Filter [F:YSTO] Where [F:YSTO]SERNUM = YCODICE
    YNSERN= rowcount([F:YSTO])
    Filter [F:YSTO]

    #cerco eventuali Cod.EAN
    Filter [F:YITM] Where [F:YITM]EANCOD = YCODICE
    YNEAN= rowcount([F:YITM])
    Filter [F:YITM]

    If(YNITM>0)
      CRITERE(0)-="& instr(1, tolower([F:YSTO]ITMREF), tolower('" + YCODICE + "'))<>0"
    Endif
    If(YNSERN>0)
      CRITERE(0)-="& instr(1, tolower([F:YSTO]SERNUM), tolower('" + YCODICE + "'))<>0"
    Endif
    If(YNEAN>0)
      CRITERE(0)-="& instr(1, tolower([F:YITM]EANCOD), tolower('" + YCODICE + "'))<>0"
    Endif
  Endif

  #filtro: LOC
  If(vireblc(LOC,2) <> AVOID.ACHAR)
    #CRITERE(1)-="& instr(1, tolower([F:YSTO]LOC), tolower('" + LOC + "'))<>0"
    CRITERE(1)-="& [F:YSTO]LOC ='" + LOC + "'"
  Endif

Return

############################################################################################################################################
#**
#*Sub dove viene impostata la LINK
#*(Body della Sub: contestuale alla funzione di Consultazione)
#*!

$SET_LINK

  Link [YSTO] With [YITM]ITM0=[YSTO]ITMREF,
&                  [YSTS]STS0=[YSTO]ITMREF;[YSTO]SERNUM
&                  As [LNK] Where ([F:YSTO]QTYSTU - [YSTO]CUMALLQTY - [YSTO]CUMWIPQTY >0)

  Columns [LNK] ([YSTO]ITMREF,[YITM]ITMDES1,[YITM]EANCOD,[YSTO]SERNUM,[YSTO]LOC,[YSTO]LOT,[YSTO]STA,[YSTO]QTYSTU,
&                [YSTO]CUMALLQTA,[YSTO]CUMALLQTY,[YSTO]CUMWIPQTY,[YITM]STU)
Return

##################################################################################################################
#                         SOLO AX3M
##################################################################################################################
#**
#*Sub per Valori ed Etichette della Grid [SOLO  MOBILE!]
#*(Body della Sub: contestuale alla funzione di Consultazione)
#*!

$SET_AX3M_TIT_COL

  Call TEXTFIC("STOCK","ITMREF",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YSTO]ITMREF"
  NBCOL += 1 : Call TEXTFIC("ITMMASTER","ITMDES1",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "func AFNC.TEXTRA('ITMMASTER','DES1AXX',[F:YSTO]ITMREF,'')"
  NBCOL += 1 : Call TEXTFIC("ITMMASTER","EANCOD",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YITM]EANCOD"
  NBCOL += 1 : Call TEXTFIC("STOCK","SERNUM",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YSTO]SERNUM"
  NBCOL += 1 : Call TEXTFIC("STOCK","LOC",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YSTO]LOC"
  NBCOL += 1 : Call TEXTFIC("STOCK","LOT",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YSTO]LOT"
  NBCOL += 1 : Call TEXTFIC("STOCK","STA",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YSTO]STA"
  NBCOL += 1 : TIT(NBCOL)="Giacenza"
  COL(NBCOL) = "num$([F:YSTO]QTYSTU-[F:YSTO]CUMALLQTY-[F:YSTO]CUMWIPQTY)"
  NBCOL += 1 : Call TEXTFIC("ITMMASTER","STU",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YITM]STU"

Return

###################################################################################################################
#ITMREF,EANCOD,SERNUM,YLOC,LOT,STA,QTY,STU

#**
#*Sub per Etichette (Valori della matrice Header) [SOLO  MOBILE!]
#*(Body della Sub: contestuale alla funzione di Consultazione)
#*!

$SET_AX3M_FIELDS

  FIELDS(0) = "ITMREF" : FIELDS(1) = "ITMDES1": FIELDS(2) = "EANCOD" : FIELDS(3) = "SERNUM"
  FIELDS(4) = "YLOC" : FIELDS(5) = "LOT" : FIELDS(6) = "STA" : FIELDS(7) = "QTY" : FIELDS(8) = "STU"

Return

###################################################################################################################
###################################################################################################################

Funprog YAX3MOB_SWFLDVAL(YFIELDS,YPARAM,YFIELDCODE)

  Variable Char YFIELDS()(,)
  Value Char YPARAM
  Value Char YFIELDCODE
  Local Char YVALUE(250)
  Const Integer YCOL_VALUE : YCOL_VALUE = 2

  If(![V]GWEBSERV)
    YVALUE = YPARAM
  Else
    Local Integer YI : YI = func YUTILS.FIND_ITEM(YFIELDS,YFIELDCODE)
    YVALUE = YFIELDS(YI,YCOL_VALUE)
  Endif

End YVALUE
**********
7,"TRT","YCALCGIAC",""
2,"TRT","YCSTK",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$ACTION

#If GUSER='ADMIN' : Infbox(ACTION) : Endif

  Case ACTION
    When "OUVRE"         : Gosub OUVRE
    When "DEBUT"         : Gosub DEBUT
    When "FIN"           : Gosub FIN
    When Default
  Endcase

Return

###########################################################

$OUVRE
Return

###########################################################

$DEBUT
  Call OUVRE_TRACE ("YAX3M - YCSTK - Gestione Cambio Stock - " - num$(date$)) From LECFIC
  Call ECR_TRACE("# -- Gestione Cambio Stock --- ",0) From GESECRAN
Return

###########################################################

$FIN
  Call FERME_TRACE From LECFIC
Return

#######################################################################################################################
#**
#* Inizializzazione - NOTA: Se la finestra è composta da più  maschere, aggiungere YCURRMSK1, YCURRMSKALIAS1,...
#*!

$INIT_FILE

  Local Char YWINNAME(20): YWINNAME = "YCSTK"
  Local Char YCURRMSK(20): YCURRMSK = "YCSTK"           #NOTA: Se la finestra è composta da più  maschere: Local Char YCURRMSK1(20): YCURRMSK1 = "<Nome>"
  Local Char YCURRMSKALIAS(20): YCURRMSKALIAS = "YCSTK"  #NOTA: Se la finestra è composta da più  maschere: Local Char YCURRMSKALIAS1(20): YCURRMSKALIAS1 = "<NomeAlias>"
  Local Char YACTION(20)
  Local Char YCURRFIELD(20)
Return

########################################################################################################################
################################################ SUBPROG /FUNPROG ######################################################
########################################################################################################################

#=============================================== AZIONI-CAMPO ==========================================================
#FCY: C, SEL(obj) +valorizza IPTDAT, TRSFAM

Subprog C_FCYCSTK(FCY,SGHTYP,VCRNUM,IPTDAT,TRSFAM,YLOCDEST,YAX3MRESP,YRESPONSE,LOC,ITMREF,ITMDES1,PCU,PCUSTUCOE,STA,LOT,QTYPCU,SERNUM)

  Variable Char FCY
  Variable Char SGHTYP
  Variable Char VCRNUM
  Variable Date IPTDAT
  Variable Char TRSFAM
  Variable Char YLOCDEST

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char LOC()
  Variable Char ITMREF()
  Variable Char ITMDES1()
  Variable Char PCU()
  Variable Decimal PCUSTUCOE()
  Variable Char STA()
  Variable Char LOT()
  Variable Decimal QTYPCU()
  Variable Char SERNUM()

  Local File FACILITY [F:YFCY]
  Local File STKTRS [F:YSRT]

  Call OUVRE_TRACE("C_FCYCSTK") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCFCYCSTK"
  YCURRFIELD = "FCY"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  Local Integer YSRTTYP: YSRTTYP = 3  #Menù locale 2721
  Local Char YSRTNUM(5): YSRTNUM = "CUB"   #rendi dinamico: Parametro globale o derivato

  Columns [F:YSRT](TRSFAM,TRSFAMCOD,TRSFAMDEF,SRTNUM,SRTDES,TRSCOD)
  Read [F:YSRT]SRT0 = YSRTTYP;YSRTNUM
  If(!fstat)
    mkstat = 0
    TRSFAM = [F:YSRT]TRSFAMDEF
    Call YAX3MOB_AFFZO(YCURRMSKALIAS,"TRSFAM") From YAX3MUTILS
  Endif

  IPTDAT = date$
  Call YAX3MOB_AFFZO(YCURRMSKALIAS,"IPTDAT") From YAX3MUTILS

  Columns [F:YFCY](FCY,FCYNAM)
  Read [F:YFCY]FCY0 = FCY

  If(fstat>0)
    mkstat = 2
    YMESSAGE = "ATTENZIONE! Sito non in anagrafica!"
    Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
  Else
    mkstat = 0
    Call YAX3MOB_SETLABEL(YFIELDS,YCURRFIELD,0,[F:YFCY]FCYNAM,CURRENTROW) From YAX3MUTILS  #label per FCY valorizzat con FCYNAM

    If(vireblc(YLOCDEST,2)<> AVOID.ACHAR | func YISRIQVALUED_YCSTK(LOC,ITMREF,ITMDES1,PCU,PCUSTUCOE,STA,LOT,QTYPCU,SERNUM)>0)
      Raz YLOCDEST
      Call YAX3MOB_AFFZO(YCURRMSKALIAS,"YLOCDEST") From YAX3MUTILS
      Call YAX3MOB_RAZLABEL(YFIELDS,"YLOCDEST",CURRENTROW) From YAX3MUTILS  #Pulisco label
      #CLEAN LABELS
      Call YCLEANRIQ_YCSTK(LOC,ITMREF,ITMDES1,PCU,PCUSTUCOE,STA,LOT,QTYPCU,SERNUM)
      Call YAFFZORIQ_YCSTK(YCURRMSKALIAS,LOC,ITMREF,ITMDES1,PCU,PCUSTUCOE,STA,LOT,QTYPCU,SERNUM)
    Endif
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

############################################################################
#SGHTYP: C,SEL(custom), (Params: FCY ---> LEG)

Subprog C_SGHCSTK(FCY,SGHTYP,VCRNUM,IPTDAT,TRSFAM,YLOCDEST,YAX3MRESP,YRESPONSE,LOC,ITMREF,ITMDES1,PCU,PCUSTUCOE,STA,LOT,QTYPCU,SERNUM)

  Variable Char FCY
  Variable Char SGHTYP
  Variable Char VCRNUM
  Variable Date IPTDAT
  Variable Char TRSFAM
  Variable Char YLOCDEST

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char LOC()
  Variable Char ITMREF()
  Variable Char ITMDES1()
  Variable Char PCU()
  Variable Decimal PCUSTUCOE()
  Variable Char STA()
  Variable Char LOT()
  Variable Decimal QTYPCU()
  Variable Char SERNUM()

  Local File TABSGHTYP [F:YTSG]
  Local File STKTRS [F:YSRT]

  Call OUVRE_TRACE("C_SGHCSTK") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCSGHCSTK"
  YCURRFIELD = "SGHTYP"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  Local Char YSGHTYP(5):YSGHTYP = SGHTYP
  Local Integer YSRTTYP: YSRTTYP = 3  #Menù locale 2721
  Local Char YSRTNUM(5): YSRTNUM = "CUB"   #rendi dinamico: Parametro globale o derivato
  Local Char YLEG(20): YLEG = func YAX3MSTOCKLIB.YGET_LEG(FCY)
#Infbox "YLEG" -YLEG

  Columns [F:YTSG](SGHTYP)
  #Read [F:YTSG]TSG0 = FCY;YLEG
  Filter [F:YTSG] Where [F:YTSG]SGHTYP = YSGHTYP

  #If(fstat>0)
  If(rowcount([F:YTSG])=0)
    mkstat = 2
    YMESSAGE = "ATTENZIONE! Tipo Cambio Stock non in anagrafica!"
    Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
  Else
    Columns [F:YSRT](TRSFAM,TRSFAMCOD,TRSFAMDEF,SRTNUM,SRTDES,TRSCOD)
    Read [F:YSRT]SRT0 = YSRTTYP;YSRTNUM

    If(!fstat)
      TRSFAM = [F:YSRT]TRSFAMDEF
      Call YAX3MOB_AFFZO(YCURRMSKALIAS,"TRSFAM") From YAX3MUTILS
      mkstat = 0
    Else
      mkstat = 2
      YMESSAGE = "ATTENZIONE! Transazione in Stock non in anagrafica!"
      Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
    Endif
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

##############################################################################
#VCRNUM: C  (in modifica)
Subprog C_VCRCSTK(FCY,SGHTYP,VCRNUM,IPTDAT,TRSFAM,YLOCDEST,YAX3MRESP,YRESPONSE,LOC,ITMREF,ITMDES1,PCU,PCUSTUCOE,STA,LOT,QTYPCU,SERNUM)

  Variable Char FCY
  Variable Char SGHTYP
  Variable Char VCRNUM
  Variable Date IPTDAT
  Variable Char TRSFAM
  Variable Char YLOCDEST

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char LOC()
  Variable Char ITMREF()
  Variable Char ITMDES1()
  Variable Char PCU()
  Variable Decimal PCUSTUCOE()
  Variable Char STA()
  Variable Char LOT()
  Variable Decimal QTYPCU()
  Variable Char SERNUM()


End

##############################################################################
#YLOCDEST: LOC Destinazione: C, SEL + valorizza YLOCTYPDEST

Subprog C_LOCDCSTK(FCY,SGHTYP,VCRNUM,IPTDAT,TRSFAM,YLOCDEST,YAX3MRESP,YRESPONSE,LOC,ITMREF,ITMDES1,PCU,PCUSTUCOE,STA,LOT,QTYPCU,SERNUM)

  Variable Char FCY
  Variable Char SGHTYP
  Variable Char VCRNUM
  Variable Date IPTDAT
  Variable Char TRSFAM
  Variable Char YLOCDEST

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char LOC()
  Variable Char ITMREF()
  Variable Char ITMDES1()
  Variable Char PCU()
  Variable Decimal PCUSTUCOE()
  Variable Char STA()
  Variable Char LOT()
  Variable Decimal QTYPCU()
  Variable Char SERNUM()

  Local File STOLOC [F:YSTC]
  Call OUVRE_TRACE("C_LOCDCSTK") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCLOCDCSTK"
  YCURRFIELD = "YLOCDEST"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  YLOCDEST = vireblc(YLOCDEST,2)
  Columns [F:YSTC](LOCTYP)
  Read [F:YSTC]STC0 = FCY;YLOCDEST

  If(fstat>0)
    mkstat = 2
    YMESSAGE = "ATTENZIONE! Ubic. di Destinazione non in anagrafica!"
    Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
  Else
    mkstat =0
    If(func YAX3MSTOCKLIB.YISMONOITM(FCY,YLOCDEST)=2)
      YMESSAGE = "ATTENZIONE! Ubic. di Destinazione è MonoArticolo!"
      Call YAX3MOB_SETLABEL(YFIELDS,YCURRFIELD,0,YMESSAGE,CURRENTROW) From YAX3MUTILS  #label per YLOCDEST
    Else
      Call YAX3MOB_RAZLABEL(YFIELDS,YCURRFIELD,CURRENTROW) From YAX3MUTILS  #Pulisco label
    Endif
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

#################################################################################
# Inizio CAMPI RIQUADRO #
#################################################################################
#LOC (origine) : C, SEL

Subprog C_LCOCSTK(FCY,SGHTYP,VCRNUM,IPTDAT,TRSFAM,YLOCDEST,YAX3MRESP,YRESPONSE,LOC,ITMREF,ITMDES1,PCU,PCUSTUCOE,STA,LOT,QTYPCU,SERNUM)

  Variable Char FCY
  Variable Char SGHTYP
  Variable Char VCRNUM
  Variable Date IPTDAT
  Variable Char TRSFAM
  Variable Char YLOCDEST

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char LOC()
  Variable Char ITMREF()
  Variable Char ITMDES1()
  Variable Char PCU()
  Variable Decimal PCUSTUCOE()
  Variable Char STA()
  Variable Char LOT()
  Variable Decimal QTYPCU()
  Variable Char SERNUM()

  Local File STOLOC [F:YSTC]
  Local File STOCK [F:YSTO]
  Local Char YLOC(10)
  Call OUVRE_TRACE("C_LCOCSTK") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCLCOCSTK"
  YCURRFIELD = "LOC"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  Call YSTRVALEUR(LOC,YLOC,CURRENTROW) From YAX3MUTILS
  YLOC = vireblc(YLOC,2)

  Columns [F:YSTC](LOCTYP)
  Read [F:YSTC]STC0 = FCY;YLOC

  If(fstat>0)
    mkstat = 2
    YMESSAGE = "ATTENZIONE! Ubicazione di Destinazione non in anagrafica!"
    Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS,YCURRFIELD, mkstat,YMESSAGE,CURRENTROW) From YAX3MUTILS

    #Raz YLOC & campi a valle
    Raz YLOC, ITMREF(CURRENTROW),ITMDES1(CURRENTROW),PCU(CURRENTROW),STA(CURRENTROW),LOT(CURRENTROW),QTYPCU(CURRENTROW),SERNUM(CURRENTROW)
    Call YSETSTRVALEUR(LOC,YLOC,CURRENTROW) From YAX3MUTILS
    Gosub AFFZO_YCSTK_ROW
  Else
    #Modifica ubic già inserita
    Filter [F:YSTO] Where([F:YSTO]STOFCY = FCY & [F:YSTO]LOC = YLOC & [F:YSTO]ITMREF = ITMREF(CURRENTROW)& [F:YSTO]STA ="A")
    If(rowcount([F:YSTO])=0)
      Raz ITMREF(CURRENTROW),ITMDES1(CURRENTROW),PCU(CURRENTROW),STA(CURRENTROW),LOT(CURRENTROW),QTYPCU(CURRENTROW),SERNUM(CURRENTROW)
    Endif
    Filter [F:YSTO]

    Call YSETSTRVALEUR(LOC,YLOC,CURRENTROW) From YAX3MUTILS
    Gosub AFFZO_YCSTK_ROW
    mkstat =0
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

#################################################################################
#ITMREF: C, SEL (Where STA = 'A' + valorizza ITMDES1,PCU,PCUSTUCOE, (LOTMGTCOD -->  gestione LOT), (SERMGTCOD -->  gestione SERNUM))

Subprog C_ITRCSTK(FCY,SGHTYP,VCRNUM,IPTDAT,TRSFAM,YLOCDEST,YAX3MRESP,YRESPONSE,LOC,ITMREF,ITMDES1,PCU,PCUSTUCOE,STA,LOT,QTYPCU,SERNUM)

  Variable Char FCY
  Variable Char SGHTYP
  Variable Char VCRNUM
  Variable Date IPTDAT
  Variable Char TRSFAM
  Variable Char YLOCDEST

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char LOC()
  Variable Char ITMREF()
  Variable Char ITMDES1()
  Variable Char PCU()
  Variable Decimal PCUSTUCOE()
  Variable Char STA()
  Variable Char LOT()
  Variable Decimal QTYPCU()
  Variable Char SERNUM()

  Local File STOCK [F:YSTO]
  Local File ITMMASTER [F:YITM]
  Local File ITMFACILIT [F:YITF]
  Local Char YITMREF(20),YLOC(10)

  Call OUVRE_TRACE("C_ITRCSTK") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCITRCSTK"
  YCURRFIELD = "ITMREF"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  Call YSTRVALEUR(ITMREF,YITMREF,CURRENTROW) From YAX3MUTILS
  YLOC = LOC(CURRENTROW)
  Read [F:YITF]ITF0 = YITMREF;FCY

  If(!fstat)
    Filter [F:YSTO] Where([F:YSTO]STOFCY = FCY & [F:YSTO]LOC = YLOC & [F:YSTO]ITMREF = YITMREF)
    If(rowcount([F:YSTO])>0)
      Read [F:YITM]ITM0 = YITMREF

      ITMDES1(CURRENTROW) = [F:YITM]ITMDES1
      Read [F:YSTO] First
#      PCU(CURRENTROW) = [F:YITM]PCU
#      PCUSTUCOE(CURRENTROW) = [F:YITM]PCUSTUCOE
#      STA(CURRENTROW) = "A"

      PCU(CURRENTROW) = [F:YSTO]PCU
      PCUSTUCOE(CURRENTROW) = [F:YSTO]PCUSTUCOE
      STA(CURRENTROW) = [F:YSTO]STA

      Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"ITMDES1",CURRENTROW) From YAX3MUTILS
      Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"PCU",CURRENTROW) From YAX3MUTILS
      Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"PCUSTUCOE",CURRENTROW) From YAX3MUTILS
      Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"STA",CURRENTROW) From YAX3MUTILS

      #Gestione a matricola, qta forzata a 1
      If([F:YITM]SERMGTCOD=3)
        QTYPCU(CURRENTROW)=1 #se gestione a matricola
        Call YAX3MOB_DISZO_RIQUADRO(YFIELDS,YCURRMSKALIAS,"QTYPCU",CURRENTROW) From YAX3MUTILS  #?
        Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"QTYPCU",CURRENTROW) From YAX3MUTILS  #?
      Else
        Call YAX3MOB_DISZO_RIQUADRO(YFIELDS,YCURRMSKALIAS,"SERNUM",CURRENTROW) From YAX3MUTILS
      Endif

      #Gestione NON a lotto, disabilito il campo lotto
      If([F:YITM]LOTMGTCOD < 2)
        Call YAX3MOB_DISZO_RIQUADRO(YFIELDS,YCURRMSKALIAS,"LOT",CURRENTROW) From YAX3MUTILS
      Endif
      mkstat=0
   Else
     mkstat=2
     Raz YITMREF,ITMDES1(CURRENTROW),PCU(CURRENTROW),STA(CURRENTROW),LOT(CURRENTROW),QTYPCU(CURRENTROW),SERNUM(CURRENTROW)
     Call YSETSTRVALEUR(ITMREF,YITMREF,CURRENTROW) From YAX3MUTILS
     Gosub AFFZO_YCSTK_ROW

     YMESSAGE="ATTENZIONE! Cod. Articolo non aasociato al Sito o all'Ubicazione scelta!"
     Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE,CURRENTROW) From YAX3MUTILS
   Endif
  Else
    mkstat=2
    Raz YITMREF,ITMDES1(CURRENTROW),PCU(CURRENTROW),STA(CURRENTROW),LOT(CURRENTROW),QTYPCU(CURRENTROW),SERNUM(CURRENTROW)
    Call YSETSTRVALEUR(ITMREF,YITMREF,CURRENTROW) From YAX3MUTILS
    Gosub AFFZO_YCSTK_ROW
    YMESSAGE="ATTENZIONE! Cod. Articolo non associato al sito o inesistente!"
    Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE,CURRENTROW) From YAX3MUTILS
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

############################################################################################
#LOT: C, SEL

Subprog C_LOTCSTK(FCY,SGHTYP,VCRNUM,IPTDAT,TRSFAM,YLOCDEST,YAX3MRESP,YRESPONSE,LOC,ITMREF,ITMDES1,PCU,PCUSTUCOE,STA,LOT,QTYPCU,SERNUM)

  Variable Char FCY
  Variable Char SGHTYP
  Variable Char VCRNUM
  Variable Date IPTDAT
  Variable Char TRSFAM
  Variable Char YLOCDEST

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char LOC()
  Variable Char ITMREF()
  Variable Char ITMDES1()
  Variable Char PCU()
  Variable Decimal PCUSTUCOE()
  Variable Char STA()
  Variable Char LOT()
  Variable Decimal QTYPCU()
  Variable Char SERNUM()

  Local File STOCK [F:YSTO]
  Local File STOLOC [F:YSTC]

  Call OUVRE_TRACE("C_LOTCSTK") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCLOTCSTK"
  YCURRFIELD = "LOT"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  Local Decimal YSTODIS
  Local Char YLOT(15)

  Call YSTRVALEUR(LOT,YLOT,CURRENTROW) From YAX3MUTILS
  If (vireblc(YLOT,2) = AVOID.ACHAR)
    mkstat = 2
    YMESSAGE = "ATTENZIONE! Lotto obbligatorio!"
    Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE,CURRENTROW) From YAX3MUTILS
  Else
    #controllo Lotto in anagrafica
    #Columns [F:YSTO](LOT)
    Local Char YITMREF(20): YITMREF = ITMREF(CURRENTROW)
    Local Char YLOC(20): YLOC = LOC(CURRENTROW)
    Filter [F:YSTO] Where ([F:YSTO]STOFCY = FCY & [F:YSTO]ITMREF = YITMREF & [F:YSTO]LOC = YLOC & [F:YSTO]LOT = YLOT)
    #Filter [F:YSTO] Where ([F:YSTO]STOFCY = FCY & [F:YSTO]ITMREF = YITMREF & [F:YSTO]LOT = YLOT)

Call ECR_TRACE("Sito =" -FCY-"-"-"itmref =" -ITMREF(CURRENTROW)-"lotto =" -YLOT - "rwcount =" -num$(rowcount([F:YSTO])),0) From GESECRAN
#Infbox "Sito =" -FCY-"-"-"itmref =" -ITMREF(CURRENTROW)-"lotto =" -YLOT - "rwcount =" -num$(rowcount([F:YSTO]))

    If(rowcount([F:YSTO])=0)
     mkstat =2
     YMESSAGE = "ATTENZIONE! Lotto " + YLOT + " non in anagrafica!"
     Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE, CURRENTROW) From YAX3MUTILS
     Raz YLOT,QTYPCU(CURRENTROW),SERNUM(CURRENTROW)
     Call YAX3MOB_RAZLABEL(YFIELDS,"QTYPCU",CURRENTROW) From YAX3MUTILS  #Pulisco label QTYSTU
    Else
      mkstat = 0
      Call YGETSTODISPO1(FCY,ITMREF(CURRENTROW),LOC(CURRENTROW),YLOT,YSTODIS) From YAX3MSTOCKLIB
      Call YAX3MOB_SETLABEL(YFIELDS,"QTYPCU",0,"Qtà disponibile = "-num$(YSTODIS),CURRENTROW) From YAX3MUTILS
    Endif
    Filter [F:YSTO]
  Endif

  Call YSETSTRVALEUR(LOT,YLOT,CURRENTROW) From YAX3MUTILS
  Gosub AFFZO_YCSTK_ROW #Aggiorno Riga (X3)

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

#############################################################################################
#QTYPCU: C, usa STODISPO

Subprog C_QTPCCSTK(FCY,SGHTYP,VCRNUM,IPTDAT,TRSFAM,YLOCDEST,YAX3MRESP,YRESPONSE,LOC,ITMREF,ITMDES1,PCU,PCUSTUCOE,STA,LOT,QTYPCU,SERNUM)

  Variable Char FCY
  Variable Char SGHTYP
  Variable Char VCRNUM
  Variable Date IPTDAT
  Variable Char TRSFAM
  Variable Char YLOCDEST

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char LOC()
  Variable Char ITMREF()
  Variable Char ITMDES1()
  Variable Char PCU()
  Variable Decimal PCUSTUCOE()
  Variable Char STA()
  Variable Char LOT()
  Variable Decimal QTYPCU()
  Variable Char SERNUM()

  Local Decimal YQTYPCU,YSTODIS
  Call OUVRE_TRACE("C_QTPCCSTK") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCQTPCCSTK"
  YCURRFIELD = "QTYPCU"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  Call YDECVALEUR(QTYPCU,YQTYPCU,CURRENTROW) From YAX3MUTILS
  If(YQTYPCU<>0)
    #Call YGETSTODISPO(FCY,ITMREF(CURRENTROW),LOC(CURRENTROW),LOT(CURRENTROW),YSTODIS) From YAX3MSTOCKLIB
    Call YGETSTODISPO1(FCY,ITMREF(CURRENTROW),LOC(CURRENTROW),LOT(CURRENTROW),YSTODIS) From YAX3MSTOCKLIB

    Call ECR_TRACE("# FCY :"-FCY-"- ITMREF :"-ITMREF(CURRENTROW)-"- LOC :"-LOC(CURRENTROW)-"- LOT :"-LOT(CURRENTROW),0) From GESECRAN
    Call ECR_TRACE("# QTYSTU ="-num$(YQTYPCU*PCUSTUCOE(CURRENTROW))- "STODIS = "-num$(YSTODIS),0) From GESECRAN

    #controllo che QTYSTU non sia > QTA DISPO
    If(YQTYPCU*PCUSTUCOE(CURRENTROW) > YSTODIS)
      mkstat=2
      YMESSAGE = "ATTENZIONE! Quantità prelevata superiore alla disponibilità!"
      Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE,CURRENTROW) From YAX3MUTILS
    Else
      mkstat=0
      Call YSETDECVALEUR(QTYPCU,YQTYPCU,CURRENTROW) From YAX3MUTILS
      Call YAX3MOB_SETLABEL(YFIELDS,YCURRFIELD,0,"Qtà disponibile = "-num$(YSTODIS),CURRENTROW) From YAX3MUTILS
    Endif
  Else
    mkstat = 2
    YMESSAGE = "Attenzione! Quantità inserita nulla!"
    Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE,CURRENTROW) From YAX3MUTILS
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

###########################################################################################
#SERNUM: C (controllare che non sia già stata inserita precedentemente), SEL

Subprog C_SERCSTK(FCY,SGHTYP,VCRNUM,IPTDAT,TRSFAM,YLOCDEST,YAX3MRESP,YRESPONSE,LOC,ITMREF,ITMDES1,PCU,PCUSTUCOE,STA,LOT,QTYPCU,SERNUM)

  Variable Char FCY
  Variable Char SGHTYP
  Variable Char VCRNUM
  Variable Date IPTDAT
  Variable Char TRSFAM
  Variable Char YLOCDEST

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char LOC()
  Variable Char ITMREF()
  Variable Char ITMDES1()
  Variable Char PCU()
  Variable Decimal PCUSTUCOE()
  Variable Char STA()
  Variable Char LOT()
  Variable Decimal QTYPCU()
  Variable Char SERNUM()

  Local File STOSER [F:YSTS]
  Local Char YSERNUM(20)

  Call OUVRE_TRACE("C_SERCSTK") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCSERCSTK"
  YCURRFIELD = "SERNUM"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  Call YSTRVALEUR(SERNUM,YSERNUM,CURRENTROW) From YAX3MUTILS
  If(vireblc(YSERNUM,2) = AVOID.ACHAR)
    mkstat =2
    YMESSAGE = "ATTENZIONE! Matricola obbligatoria per questo articolo!"
    Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE,CURRENTROW) From YAX3MUTILS
  Else
    Columns [F:YSTS](SERNUM)
    Read [F:YSTS]STS0 = ITMREF(CURRENTROW);SERNUM
    If(fstat >0)
      mkstat =2
      YMESSAGE = "ATTENZIONE! Matricola non esistente!"
      Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE,CURRENTROW) From YAX3MUTILS
    Else
      mkstat =0
    Endif
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC

End
###########################################################################################
#                                         BOTTONI DI FINESTRA
###########################################################################################

Subprog YCHNGSTK(FCY,SGHTYP,VCRNUM,IPTDAT,TRSFAM,YLOCDEST,YAX3MRESP,YRESPONSE,LOC,ITMREF,ITMDES1,PCU,PCUSTUCOE,STA,LOT,QTYPCU,SERNUM)

  Variable Char FCY
  Variable Char SGHTYP
  Variable Char VCRNUM
  Variable Date IPTDAT
  Variable Char TRSFAM
  Variable Char YLOCDEST

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char LOC()
  Variable Char ITMREF()
  Variable Char ITMDES1()
  Variable Char PCU()
  Variable Decimal PCUSTUCOE()
  Variable Char STA()
  Variable Char LOT()
  Variable Decimal QTYPCU()
  Variable Char SERNUM()

  Local Integer K, YSUCCESS : YSUCCESS = 0
  Local Char YIMPMESSAGE(250)

  #apertura traccia
  Call OUVRE_TRACE("YCHNGSTK") From LECFIC
  Gosub INIT_FILE
  YACTION = "YCHNGSTK"
  YCURRFIELD = ""

  #init
  Gosub YAX3MOB_INIT_BUTTONACTION From YAX3MUTILS
  #parametrizzazioni iniziali (contestuali)
  YFUNC_NAME = "YCSTK" : YFUNC_TYPE = "DOC" : YIMP_CODE= "YSCS" : YMEX_DOCTYPE = "Cambio Stock"

  #Business logic
  Gosub YFILL_YSCSCSV
  Call YPRINT_CLB(YCSVTEXT,YFUNC_NAME, "csv") From YUTILS  #stampa csv (opzionale)#!! LOG
  #Check correttezza codice Modello import impostato?

  If dim(GYVCRENT)<0
    Global Char GYVCRENT(20)
  Endif
  Raz GYVCRENT

  Call YAX3MOB_IMPORTSIL(YIMP_CODE, YCSVTEXT, YSUCCESS, YIMPMESSAGE) From YAX3MUTILS
  If (vireblc(GYVCRENT,2)= AVOID.ACHAR)
    YMESSAGE = func YUTILS.IIF(YMESSAGE = AVOID.ACHAR, "Movimento di Cambio Stock fallito! Impossibile proseguire!", YMESSAGE)
    YSUCCESS=1
  Else
    YMESSAGE = "Cambio Stock ("-GYVCRENT-")avvenuto con successo!"
  Endif

  If dim(GYVCRENT)>0
   Kill GYVCRENT
  Endif
  YALERT_MESSAGE -= YMESSAGE

  If YSUCCESS = 1
    Call YAX3MOB_SHOWALERT(2, YALERT_TYPE, YALERT_MESSAGE) From YAX3MUTILS
  Else
    Raz FCY, SGHTYP, VCRNUM, TRSFAM, YLOCDEST
    For K = 0 To func YUTILS.COUNT(LOC) - 1
      Raz LOC(K), ITMREF(K), ITMDES1(K), PCU(K), PCUSTUCOE(K), STA(K), LOT(K), QTYPCU(K), SERNUM(K) #dettaglio
    Next
    Call YAX3MOB_SHOWALERT(1, YALERT_TYPE, YALERT_MESSAGE) From YAX3MUTILS
  Endif

  Gosub YAX3MOB_END_BUTTONACTION From YAX3MUTILS
  Call FERME_TRACE From LECFIC

End

######################################################
#**
#* Sub per compilazione testo csv per Modello di Import Cambio Stock: SCS
#*!

$YFILL_YSCSCSV

  #INIZIO creaz csv
  #Testata
  Call YAX3MOB_APPEND(YCSVTEXT, "E", 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS                   #vcrnum
  Call YAX3MOB_APPEND(YCSVTEXT, FCY, 0) From YAX3MUTILS                           #stofcy
  Call YAX3MOB_APPEND(YCSVTEXT, format$("D:YYYYMMDD",IPTDAT), 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, "Cambio Stock AX3M", 0) From YAX3MUTILS           #vcrdes
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS                   #pjt
  Call YAX3MOB_APPEND(YCSVTEXT, TRSFAM, 1) From YAX3MUTILS

  Local Integer I,J : I = 0 : J = 0
  For I=0 To func YUTILS.COUNT(LOC) - 1
    # Row L
    Call YAX3MOB_APPEND(YCSVTEXT, "L", 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS                #vcrlin
    Call YAX3MOB_APPEND(YCSVTEXT, ITMREF(I), 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, PCU(I), 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, num$(PCUSTUCOE(I)), 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, STA(I), 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, func YAX3MSTOCKLIB.YGET_LOCTYP(FCY,LOC(I)), 0) From YAX3MUTILS     #loctyp orig
    Call YAX3MOB_APPEND(YCSVTEXT, LOC(I), 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, LOT(I), 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS                #slo
    Call YAX3MOB_APPEND(YCSVTEXT, SERNUM(I), 0) From YAX3MUTILS                  #sernum
    Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS                #palnum
    Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS                #ctrnum
    Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS                #qlyctldem
    Call YAX3MOB_APPEND(YCSVTEXT, FCY, 1) From YAX3MUTILS                        #owner = stofcy

    # Row S
    Call YAX3MOB_APPEND(YCSVTEXT, "S", 0)  From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, PCU(I), 0)  From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, num$(QTYPCU(I)), 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, num$(QTYPCU(I)*PCUSTUCOE(I)), 0) From YAX3MUTILS     #qtystu (calcolato) = qtypcu * pcustucoe
    Call YAX3MOB_APPEND(YCSVTEXT, YLOCDEST, 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, STA(I), 1) From YAX3MUTILS                     #sta (finale)

  Next
  #FINE creaz csv
Return

###########################################################################################
#                                             Utilità
###########################################################################################

#**
#* Funzione di Pulitura Riquadro YCSTK
#*
#* @param LOC
#* @param ITMREF
#* @param ITMDES1
#* @param PCU
#* @param PCUSTUCOE
#* @param STA
#* @param LOT
#* @param QTYPCU
#* @param SERNUM
#*!

Subprog YCLEANRIQ_YCSTK(LOC,ITMREF,ITMDES1,PCU,PCUSTUCOE,STA,LOT,QTYPCU,SERNUM)

  Variable Char LOC()()
  Variable Char ITMREF()()
  Variable Char ITMDES1()()
  Variable Char PCU()()
  Variable Decimal PCUSTUCOE()
  Variable Char STA()()
  Variable Char LOT()()
  Variable Decimal QTYPCU()
  Variable Char SERNUM()()

  Local Integer YI

  For YI=0 To dim(LOC,1)-1
    Raz LOC(YI), ITMREF(YI),ITMDES1(YI),PCU(YI),PCUSTUCOE(YI),STA(YI),LOT(YI),QTYPCU(YI),SERNUM(YI)
  Next
End

#######################################################################################################

Subprog YAFFZORIQ_YCSTK(YMSKALIAS,LOC,ITMREF,ITMDES1,PCU,PCUSTUCOE,STA,LOT,QTYPCU,SERNUM)

  Value Char YMSKALIAS
  Variable Char LOC()()
  Variable Char ITMREF()()
  Variable Char ITMDES1()()
  Variable Char PCU()()
  Variable Decimal PCUSTUCOE()
  Variable Char STA()()
  Variable Char LOT()()
  Variable Decimal QTYPCU()
  Variable Char SERNUM()()

  Local Integer YI,YNBLIG
  YNBLIG = func YUTILS.COUNT(LOC) #TODO: Modifica estraendo valore NBLIG

  For YI=0 To YNBLIG-1

    Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"LOC",YI) From YAX3MUTILS
    Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"ITMREF",YI) From YAX3MUTILS
    Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"ITMDES1",YI) From YAX3MUTILS
    Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"PCU",YI) From YAX3MUTILS
    Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"PCUSTUCOE",YI) From YAX3MUTILS
    Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"STA",YI) From YAX3MUTILS
    Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"LOT",YI) From YAX3MUTILS
    Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"QTYPCU",YI) From YAX3MUTILS
    Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"SERNUM",YI) From YAX3MUTILS
  Next
End

########################################################################################################

Funprog YISRIQVALUED_YCSTK(LOC,ITMREF,ITMDES1,PCU,PCUSTUCOE,STA,LOT,QTYPCU,SERNUM)

  Variable Char LOC()()
  Variable Char ITMREF()()
  Variable Char ITMDES1()()
  Variable Char PCU()()
  Variable Decimal PCUSTUCOE()
  Variable Char STA()()
  Variable Char LOT()()
  Variable Decimal QTYPCU()
  Variable Char SERNUM()()

  Local Integer YHASVALUES
  YHASVALUES = func YUTILS.COUNT(LOC)+func YUTILS.COUNT(ITMREF) + func YUTILS.COUNT(ITMDES1)+ func YUTILS.COUNT(SERNUM)

End YHASVALUES
#########################################################################################################
#**
#* Funzione che controlla se la riga è pulita da ITMREF(compreso) in poi
#*
#* @param ITMREF
#* @param ITMDES1
#* @param PCU
#* @param PCUSTUCOE
#* @param STA
#* @param LOT
#* @param QTYPCU
#* @param SERNUM
#* @param CURRENTROW
#*!

Funprog YISCLEAN_POSTLOC(ITMREF,ITMDES1,PCU,PCUSTUCOE,STA,LOT,QTYPCU,SERNUM,CURRENTROW)

  Variable Char ITMREF()()
  Variable Char ITMDES1()()
  Variable Char PCU()()
  Variable Decimal PCUSTUCOE()
  Variable Char STA()()
  Variable Char LOT()()
  Variable Decimal QTYPCU()
  Variable Char SERNUM()()
  Value Integer CURRENTROW
  Local Integer YISCLEAN

  If(vireblc(ITMREF(CURRENTROW),2)<> AVOID.ACHAR | vireblc(ITMDES1(CURRENTROW),2)<> AVOID.ACHAR |
&    vireblc(PCU(CURRENTROW),2)<> AVOID.ACHAR | PCUSTUCOE(CURRENTROW)> 0 | vireblc(STA(CURRENTROW),2)<> AVOID.ACHAR |
&    vireblc(LOT(CURRENTROW),2)<> AVOID.ACHAR | QTYPCU(CURRENTROW)> 0 | vireblc(SERNUM(CURRENTROW),2)<> AVOID.ACHAR)

    YISCLEAN = 1
  Endif

End YISCLEAN

#############################################################################################################
#**
#* Funzione che controlla se la riga è pulita da ITMDES1(compreso) in poi
#*
#* @param ITMREF
#* @param ITMDES1
#* @param PCU
#* @param PCUSTUCOE
#* @param STA
#* @param LOT
#* @param QTYPCU
#* @param SERNUM
#* @param CURRENTROW
#*!

Funprog YISCLEAN_POSTITM(ITMDES1,PCU,PCUSTUCOE,STA,LOT,QTYPCU,SERNUM,CURRENTROW)

  Variable Char ITMDES1()()
  Variable Char PCU()()
  Variable Decimal PCUSTUCOE()
  Variable Char STA()()
  Variable Char LOT()()
  Variable Decimal QTYPCU()
  Variable Char SERNUM()()
  Value Integer CURRENTROW
  Local Integer YISCLEAN

  If(vireblc(ITMDES1(CURRENTROW),2)<> AVOID.ACHAR | vireblc(PCU(CURRENTROW),2)<> AVOID.ACHAR | PCUSTUCOE(CURRENTROW)> 0 |
&    vireblc(STA(CURRENTROW),2)<> AVOID.ACHAR |vireblc(LOT(CURRENTROW),2)<> AVOID.ACHAR | QTYPCU(CURRENTROW)> 0 |
&    vireblc(SERNUM(CURRENTROW),2)<> AVOID.ACHAR)

    YISCLEAN = 1
  Endif

End YISCLEAN

##############################################################################################################

Funprog YISCLEAN_POSTLOT(QTYPCU,SERNUM,CURRENTROW)

  Variable Decimal QTYPCU()
  Variable Char SERNUM()()
  Value Integer CURRENTROW
  Local Integer YISCLEAN

  If(QTYPCU(CURRENTROW)> 0 | vireblc(SERNUM(CURRENTROW),2)<> AVOID.ACHAR)
    YISCLEAN = 1
  Endif
End YISCLEAN

##############################################################################################################
$AFFZO_YCSTK_ROW

  Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"LOC",CURRENTROW) From YAX3MUTILS
  Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"ITMREF",CURRENTROW) From YAX3MUTILS
  Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"ITMDES1",CURRENTROW) From YAX3MUTILS
  Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"PCU",CURRENTROW) From YAX3MUTILS
  Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"PCUSTUCOE",CURRENTROW) From YAX3MUTILS
  Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"STA",CURRENTROW) From YAX3MUTILS
  Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"LOT",CURRENTROW) From YAX3MUTILS
  Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"QTYPCU",CURRENTROW) From YAX3MUTILS
  Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"SERNUM",CURRENTROW) From YAX3MUTILS

Return
**********
7,"TRT","YCSTK",""
2,"TRT","YGIAC",""
#<AdxTL>@(#)0.0.0.0 $Revision$
#MC 11/01/2024: Test calcolo Giacenza

$ACTION

  #If GUSER='ADMIN' : Infbox(ACTION) : Endif

  Case ACTION

    When "DEBUT"         : Gosub DEBUT
    When "BOUTON"        : Gosub BOUTON
    When "FIN"           : Gosub FIN
    When "APRES_MODIF"   : Gosub APRES_MODIF
    When Default
  Endcase

Return

$APRES_MODIF


#Infbox "TEST"
If COUZON = "LOC"
  zonsui = "[M:YGIAC1]ITMREF"
Endif

Return

###############################################

$DEBUT

  Call OUVRE_TRACE ("YAX3M - Log Gestione Calcolo giacenza Test - " - num$(date$)) From LECFIC
  Call ECR_TRACE("# -- Gestione Calcolo giacenza Test --- ",0) From GESECRAN
  Raz [M:YGIAC1]VALDCB
  Affzo [M:YGIAC1]

Return

###############################################
$BOUTON

  Call ECR_TRACE("# -- SubRoutine BOUTON --- ",0) From GESECRAN
  Call ECR_TRACE("# -- Impostazione parametri : ",0) From GESECRAN

  #Inizio impostazione eventuali parametri delle subprog utilizzate nei buttons
  Local Char YITMREF(250)
  Local Char YSTOFCY(250)
  Local Char YLOC(250)

  Local Decimal YGIACENZA
  Local Clbfile YRESPONSE
  #Local Char YMESSAGE(250)

  YITMREF = [M:YGIAC1]ITMREF
  YSTOFCY = [M:YGIAC1]STOFCY
  YLOC = [M:YGIAC1]LOC
  Raz [M:YGIAC1]VALDCB

  Call ECR_TRACE("# -- YITMREF = " - [M:YGIAC1]ITMREF,0) From GESECRAN
  Call ECR_TRACE("# -- YSTOFCY = " - [M:YGIAC1]STOFCY,0) From GESECRAN
  Call ECR_TRACE("# -- YLOC = " - [M:YGIAC1]STOFCY,0) From GESECRAN

  #Fine impostazione parametri

  Case BOUT
    When "G"   #Calcolo Giacenza

      Call ECR_TRACE("# -- Bouton = G : Calcolo Giacenza --- ",0) From GESECRAN

      #GYDECIMAL: var globale per gestire decimali
      Call YTCALCGIAC(YITMREF,YSTOFCY,YLOC,YRESPONSE)
      #Call YCALCGIAC(YITMREF,YSTOFCY,YLOC,GYDECIMAL,YRESPONSE)
      #[M:YGIAC1]VALDCB = GYDECIMAL

      Call ECR_TRACE("# -- Giacenza =" - num$(YGIACENZA),0) From GESECRAN
      Affzo [M:YGIAC1]VALDCB

    When Default
  Endcase

Return

###########################################################
$FIN

  Effzo [M:YGIAC1]
  Call FERME_TRACE From LECFIC
  Call LEC_TRACE From LECFIC

Return


#####################################################################################################
######################################## Subprog/FunProg ############################################
#####################################################################################################

# Calcolo Giacenza
Subprog YTCALCGIAC(ITMREF,STOFCY,LOC,YRESPONSE)
#Subprog YCALCGIAC(ITMREF,STOFCY,LOC,VALDCB,YRESPONSE)

    #parametri passati per valore
    Value Char ITMREF
    Value Char STOFCY
    Value Char LOC

    #parametri passati per riferimento
    Variable Clbfile YRESPONSE

    #variabili locali
    Local Char YALERT_WS(50)(1..3,1..3)
    Local Char YFIELDS(250)(4,8)
    Local Char YHEADER(0)(1,1)
    Local Char YDATA(0)(1,1)
    Local Char YMESSAGE(250):YMESSAGE=AVOID.ACHAR
    Local Integer YSUCCESS: [L]YSUCCESS=0
    Local Char YITMREF(20): YITMREF = ITMREF
    Local Char YSTOFCY(5): YSTOFCY = STOFCY
    Local Char YLOC(3): YLOC = LOC
    Local Decimal YVALDCB:YVALDCB=0

    Local File STOCK [F:YSTO]
    Local File STOLOC [F:YSTC]

    Link [F:YSTO] With [F:YSTC]STC0=[F:YSTO]STOFCY;[F:YSTO]LOC
&                 As [YLNK]
    Filter [YLNK] Where ([F:YSTO]STOFCY = YSTOFCY & [F:YSTO]ITMREF = YITMREF & [F:YSTC]LOC = YLOC)

    #Controllo che record set non vuoto
    If rowcount([YLNK])= 0
      YSUCCESS=1
      YMESSAGE = "Nessun record trovato con Codice Articolo = "-YITMREF - ",Sito = "-YSTOFCY-", Ubicazione = "-YLOC

      If ![V]GWEBSERV
        Call ERREURT(YMESSAGE,1) From GESECRAN
        Call ECR_TRACE(YMESSAGE,0) From GESECRAN
      Endif
    Endif

    #Se record set non vuoto, ha senso calcolo della giacenza
    If(YSUCCESS=0)

       Columns [YLNK]([F:YSTO]QTYSTU,[F:YSTO]CUMALLQTA,[F:YSTO]CUMWIPQTY)

       For [YLNK]
          YVALDCB += [F:YSTO]QTYSTU - [F:YSTO]CUMALLQTA -[F:YSTO]CUMWIPQTY
       Next

       If ![V]GWEBSERV
          Call ECR_TRACE("# -- YCALCGIAC ; VALDCB = "- num$(YVALDCB) ,0) From GESECRAN
       Endif
    Endif

    Filter [YLNK]

    If ![V]GWEBSERV
       [M:YGIAC1]VALDCB= YVALDCB
    Endif

    #Valorizzo YRESPONSE
    Call SET_FIELDS(YFIELDS,"STOFCY","Char",STOFCY,"0",AVOID.ACHAR,"0","0","0",0) From YAX3MJSONGEN
    Call SET_FIELDS(YFIELDS,"LOC","Char",LOC,"0",AVOID.ACHAR,"1","0","0",1) From YAX3MJSONGEN
    Call SET_FIELDS(YFIELDS,"ITMREF","Char",ITMREF,"0",AVOID.ACHAR,"1","0","0",2) From YAX3MJSONGEN
    Call SET_FIELDS(YFIELDS,"VALDCB","Decimal",num$(YVALDCB),"0",AVOID.ACHAR,"1","0","0",3) From YAX3MJSONGEN

    If(YSUCCESS=0)
      YRESPONSE =func YAX3MJSONGEN.GENERATE_JSON(YSUCCESS,"toast","Giacenza corretta",YALERT_WS,YFIELDS,YHEADER,YDATA)
    Else
      YRESPONSE =func YAX3MJSONGEN.GENERATE_JSON(YSUCCESS,"error",YMESSAGE,YALERT_WS,YFIELDS,YHEADER,YDATA)
    Endif

End

######################################################################################
######################################################################################

# Controllo che la stringa sia regolare (no caratteri speciali al suo interno)
# Se non trovati restituisce : 0
# Altrimenti : 1

Funprog YREGSTRINGCHECK(YSTRINGTOCHECK)

  Value Char YSTRINGTOCHECK

  # intero usato anche per condizione per ciclo while
  Local Integer YRES: YRES = 0
  Local Char YCHARSVIETATI(50): [L]YCHARSVIETATI = "!£$%&/()=?^[]+:;,#@§*\|<>'_°"
  Local Integer YSTRINGLEN: [L]YSTRINGLEN = len(YCHARSVIETATI)
  Local Integer YINDEX : YINDEX =1
  Local Char YSELCHAR(1)

  If(YSTRINGTOCHECK <>"")
    While (YRES=0 & YINDEX <= YSTRINGLEN)

      YSELCHAR = xgetchar(YCHARSVIETATI,YINDEX)
      If (instr(0,YSTRINGTOCHECK,YSELCHAR) <> 0)
        YRES=1
      Endif

      YINDEX +=1
    Wend
  Endif

End YRES

###################################### AZIONI - CAMPO ###################################################

#####################################[ C - CONTROLLO ]###################################################

# Azione-Campo : Controllo obbligatorietà e REGEX :STOFCY

Subprog C_STOFCY(STOFCY,YRESPONSE)

  Value Char STOFCY
  Variable Clbfile YRESPONSE
#
#  Local Char YALERT_WS(50)(1..3,1..3)
#  Local Char YFIELDS(250)(4,8)
#  Local Char YHEADER(0)(1,1)
#  Local Char YDATA(0)(1,1)
#  Local Char YMESSAGE(250):YMESSAGE= AVOID.ACHAR
#  Local Integer YSUCCESS
#
#  If vireblc(STOFCY, 2) = AVOID.ACHAR
#    YSUCCESS = 1
#    YMESSAGE = "Codice Sito obbligatorio!"
#    Call ECR_TRACE(YMESSAGE, 0) From GESECRAN
#    If ![V]GWEBSERV
#      Call ERREURT(YMESSAGE, 1) From GESECRAN
#      mkstat=2
#    Endif
#  Elsif func YREGSTRINGCHECK(STOFCY) > 0
#    YSUCCESS = 1
#    YMESSAGE = "Attenzione! Codice Sito con caratteri non ammessi!"
#    If ![V]GWEBSERV
#      Call ERREURT(YMESSAGE, 1) From GESECRAN
#      mkstat=2
#    Endif
#  Else
#    YSUCCESS = 0
#  Endif
#
#  #Valorizzo YRESPONSE
#  If(YSUCCESS=0)
#    Call SET_FIELDS(YFIELDS,"STOFCY","Char",STOFCY,"0",YMESSAGE,"1","0","0",0) From YAX3MJSONGEN
#    Call SET_FIELDS(YFIELDS,"LOC","Char",AVOID.ACHAR,"0",AVOID.ACHAR,"0","0","0",1) From YAX3MJSONGEN
#    Call SET_FIELDS(YFIELDS,"ITMREF","Char",AVOID.ACHAR,"0",AVOID.ACHAR,"1","0","1",2) From YAX3MJSONGEN
#    Call SET_FIELDS(YFIELDS,"VALDCB","Decimal",AVOID.ACHAR,"0",AVOID.ACHAR,"1","0","1",3) From YAX3MJSONGEN
#  Else
#    Call SET_FIELDS(YFIELDS,"STOFCY","Char",AVOID.ACHAR,"1",YMESSAGE,"0","0","0",0) From YAX3MJSONGEN
#    Call SET_FIELDS(YFIELDS,"LOC","Char",AVOID.ACHAR,"0",AVOID.ACHAR,"1","0","1",1) From YAX3MJSONGEN
#    Call SET_FIELDS(YFIELDS,"ITMREF","Char",AVOID.ACHAR,"0",AVOID.ACHAR,"1","0","1",2) From YAX3MJSONGEN
#    Call SET_FIELDS(YFIELDS,"VALDCB","Decimal",AVOID.ACHAR,"0",AVOID.ACHAR,"1","0","1",3) From YAX3MJSONGEN
#  Endif
#
#  YRESPONSE =func YAX3MJSONGEN.GENERATE_JSON(YSUCCESS,AVOID.ACHAR,AVOID.ACHAR,YALERT_WS,YFIELDS,YHEADER,YDATA)

End

# Azione-Campo : Controllo obbligatorietà e REGEX :LOC--------------------------------------------------------------

Subprog C_LOC(LOC,YRESPONSE)

  Value Char LOC
  Variable Clbfile YRESPONSE

  Local Char YALERT_WS(50)(1..3,1..3)
  Local Char YFIELDS(250)(3,8)
  Local Char YHEADER(0)(1,1)
  Local Char YDATA(0)(1,1)
  Local Char YMESSAGE(250):YMESSAGE=AVOID.ACHAR
  Local Integer YSUCCESS

  If vireblc(LOC, 2) = AVOID.ACHAR
    YSUCCESS = 1
    YMESSAGE = "Codice Ubicazione obbligatorio!"
    Call ECR_TRACE(YMESSAGE, 0) From GESECRAN
    If ![V]GWEBSERV
      Call ERREURT(YMESSAGE, 1) From GESECRAN
      mkstat=2
    Endif
  Elsif func YREGSTRINGCHECK(LOC) > 0
    YSUCCESS = 1
    YMESSAGE = "Attenzione! Codice Ubicazione con caratteri non ammessi!"
    If ![V]GWEBSERV
      Call ERREURT(YMESSAGE, 1) From GESECRAN
      mkstat=2
    Endif
  Else
    YSUCCESS = 0
  Endif

  #Valorizzo YRESPONSE
  If(YSUCCESS=0)
    Call SET_FIELDS(YFIELDS,"LOC","Char",LOC,"0",YMESSAGE,"1","0","0",0) From YAX3MJSONGEN
    Call SET_FIELDS(YFIELDS,"ITMREF","Char",AVOID.ACHAR,"0",AVOID.ACHAR,"1","0","1",1) From YAX3MJSONGEN
    Call SET_FIELDS(YFIELDS,"VALDCB","Decimal",AVOID.ACHAR,"0",AVOID.ACHAR,"1","0","1",2) From YAX3MJSONGEN
  Else
    Call SET_FIELDS(YFIELDS,"LOC","Char",AVOID.ACHAR,"1",YMESSAGE,"0","0","0",0) From YAX3MJSONGEN
    Call SET_FIELDS(YFIELDS,"ITMREF","Char",AVOID.ACHAR,"0",AVOID.ACHAR,"1","0","1",1) From YAX3MJSONGEN
    Call SET_FIELDS(YFIELDS,"VALDCB","Decimal",AVOID.ACHAR,"0",AVOID.ACHAR,"1","0","1",2) From YAX3MJSONGEN
  Endif

  YRESPONSE =func YAX3MJSONGEN.GENERATE_JSON(YSUCCESS,AVOID.ACHAR,AVOID.ACHAR,YALERT_WS,YFIELDS,YHEADER,YDATA)

End

# Azione-Campo : Controllo obbligatorietà e REGEX :ITMREF-------------------------------------------------------------------

Subprog C_ITMREF(ITMREF, YRESPONSE)

  Value Char ITMREF
  Variable Clbfile YRESPONSE

  Local Char YALERT_WS(50)(1..3,1..3)
  Local Char YFIELDS(250)(2,8)
  Local Char YHEADER(0)(1,1)
  Local Char YDATA(0)(1,1)
  Local Char YMESSAGE(250):YMESSAGE = AVOID.ACHAR
  Local Integer YSUCCESS

  If vireblc(ITMREF, 2) = AVOID.ACHAR
    YSUCCESS = 1
    YMESSAGE = "Codice articolo obbligatorio!"
    Call ECR_TRACE(YMESSAGE, 0) From GESECRAN
    If ![V]GWEBSERV
      Call ERREURT(YMESSAGE, 1) From GESECRAN
      mkstat=2
    Endif
  Elsif func YREGSTRINGCHECK(ITMREF) > 0
    YSUCCESS = 1
    YMESSAGE = "Attenzione! Codice articolo con caratteri non ammessi!"
    If ![V]GWEBSERV
      Call ERREURT(YMESSAGE, 1) From GESECRAN
      mkstat=2
    Endif
  Else
    YSUCCESS = 0
  Endif

  #Valorizzo YRESPONSE
  If(YSUCCESS=0)
    Call SET_FIELDS(YFIELDS,"ITMREF","Char",ITMREF,"0",YMESSAGE,"0","0","0",0) From YAX3MJSONGEN
    Call SET_FIELDS(YFIELDS,"VALDCB","Decimal",AVOID.ACHAR,"0",AVOID.ACHAR,"1","0","1",1) From YAX3MJSONGEN
  Else
    Call SET_FIELDS(YFIELDS,"ITMREF","Char",AVOID.ACHAR,"1",YMESSAGE,"0","0","0",0) From YAX3MJSONGEN
    Call SET_FIELDS(YFIELDS,"VALDCB","Decimal",AVOID.ACHAR,"0",AVOID.ACHAR,"1","0","1",1) From YAX3MJSONGEN
  Endif

  YRESPONSE =func YAX3MJSONGEN.GENERATE_JSON(YSUCCESS,AVOID.ACHAR,AVOID.ACHAR,YALERT_WS,YFIELDS,YHEADER,YDATA)

End

#####################################[ AM - POST MODIFICA ]###################################################

# AZIONE-CAMPO: AM-Post Modifica Sito esistente in DB --------------------------------------------------------

Subprog AM_STOFCY(STOFCY,YRESPONSE)

  Value Char STOFCY
  Variable Clbfile YRESPONSE

  Local File STOCK [F:YSTO]

  Local Char YALERT_WS(50)(1..3,1..3)
  Local Char YFIELDS(250)(5,8)
  Local Char YHEADER(0)(1,1)
  Local Char YDATA(0)(1,1)
  Local Char YMESSAGE(250):YMESSAGE=AVOID.ACHAR
  Local Integer YSUCCESS: [L]YSUCCESS=0
  Local Char YSTOFCY(250) : YSTOFCY= STOFCY
  Local Char YIPTDAT(20): YIPTDAT = format$("D:YYYY[-]MM[-]DD[T]hh[:]mm[:]ss[Z]", datetime$)

  # Controllo che Sito esista
  Filter [F:YSTO] Where [F:YSTO]STOFCY = YSTOFCY

  #Controllo che record set non vuoto
  If rowcount([F:YSTO])= 0
    YSUCCESS=1
    YMESSAGE = "Nessun record trovato con Sito = "- YSTOFCY
    Call ECR_TRACE(YMESSAGE,0) From GESECRAN

    If ![V]GWEBSERV
      Call ERREURT(YMESSAGE,1) From GESECRAN
      mkstat =2
      # Disabilito successivi campi di maschera
      Diszo [M:YGIAC1]LOC
      Diszo [M:YGIAC1]ITMREF
    Endif
  Else
    If ![V]GWEBSERV
      # Abilito successivi campi di maschera
      Actzo [M:YGIAC1]LOC
      Actzo [M:YGIAC1]ITMREF
    Endif
  Endif

  Filter [F:YSTO]

  #Valorizzo YRESPONSE
  If(YSUCCESS=0)
    Call SET_FIELDS(YFIELDS,"STOFCY","Char",YSTOFCY,"0",YMESSAGE,"1","0","0",0) From YAX3MJSONGEN
    Call SET_FIELDS(YFIELDS,"LOC","Char",AVOID.ACHAR,"0",AVOID.ACHAR,"0","0","0",1) From YAX3MJSONGEN
    Call SET_FIELDS(YFIELDS,"ITMREF","Char",AVOID.ACHAR,"0",AVOID.ACHAR,"1","0","1",2) From YAX3MJSONGEN
    Call SET_FIELDS(YFIELDS,"VALDCB","Decimal",AVOID.ACHAR,"0",AVOID.ACHAR,"1","0","1",3) From YAX3MJSONGEN
    Call SET_FIELDS(YFIELDS,"IPTDAT","Date",YIPTDAT,"0",AVOID.ACHAR,"1","0","1",4) From YAX3MJSONGEN
  Else
    Call SET_FIELDS(YFIELDS,"STOFCY","Char",AVOID.ACHAR,"1",YMESSAGE,"0","0","0",0) From YAX3MJSONGEN
    Call SET_FIELDS(YFIELDS,"LOC","Char",AVOID.ACHAR,"0",AVOID.ACHAR,"1","0","1",1) From YAX3MJSONGEN
    Call SET_FIELDS(YFIELDS,"ITMREF","Char",AVOID.ACHAR,"0",AVOID.ACHAR,"1","0","1",2) From YAX3MJSONGEN
    Call SET_FIELDS(YFIELDS,"VALDCB","Decimal",AVOID.ACHAR,"0",AVOID.ACHAR,"1","0","1",3) From YAX3MJSONGEN
    Call SET_FIELDS(YFIELDS,"IPTDAT","Date",AVOID.ACHAR,"0",AVOID.ACHAR,"1","0","1",4) From YAX3MJSONGEN
  Endif

  YRESPONSE =func YAX3MJSONGEN.GENERATE_JSON(YSUCCESS,AVOID.ACHAR,AVOID.ACHAR,YALERT_WS,YFIELDS,YHEADER,YDATA)

End

# AZIONE-CAMPO: AM-Post Modifica LOC esistente in DB-------------------------------------------

Subprog AM_LOC(LOC, YRESPONSE)

  Value Char LOC
  Variable Clbfile YRESPONSE

  Local Char YALERT_WS(50)(1..3,1..3)
  Local Char YFIELDS(250)(3,8)
  Local Char YHEADER(0)(1,1)
  Local Char YDATA(0)(1,1)
  Local File STOLOC [F:YSTC]
  Local Char YLOC(10): YLOC = LOC
  Local Char YMESSAGE(250):YMESSAGE = AVOID.ACHAR
  Local Shortint YSUCCESS : YSUCCESS = 0

  Filter [F:YSTC] Where [F:YSTC]LOC = YLOC
  #Controllo che il recordset non sia vuoto
  If rowcount([F:YSTC])= 0
    YSUCCESS = 1
    YMESSAGE = "Nessun record trovato con Ubicazione = " + YLOC
    Call ECR_TRACE(YMESSAGE,0) From GESECRAN
    If ![V]GWEBSERV
      Call ERREURT(YMESSAGE,1) From GESECRAN
      mkstat=2
    Endif
  Endif
  Filter [F:YSTC]
  #zonsui = "[M:YGIAC1]ITMREF"
  #Valorizzo YRESPONSE
  If [V]GWEBSERV
    If(YSUCCESS=0)
      Call SET_FIELDS(YFIELDS,"LOC","Char",YLOC,"0",YMESSAGE,"1","0","0",0) From YAX3MJSONGEN
      Call SET_FIELDS(YFIELDS,"ITMREF","Char",AVOID.ACHAR,"0",AVOID.ACHAR,"1","0","1",1) From YAX3MJSONGEN
      Call SET_FIELDS(YFIELDS,"VALDCB","Decimal",AVOID.ACHAR,"0",AVOID.ACHAR,"1","0","1",2) From YAX3MJSONGEN
    Else
      Call SET_FIELDS(YFIELDS,"LOC","Char",AVOID.ACHAR,"1",YMESSAGE,"0","0","0",0) From YAX3MJSONGEN
      Call SET_FIELDS(YFIELDS,"ITMREF","Char",AVOID.ACHAR,"0",AVOID.ACHAR,"1","0","1",1) From YAX3MJSONGEN
      Call SET_FIELDS(YFIELDS,"VALDCB","Decimal",AVOID.ACHAR,"0",AVOID.ACHAR,"1","0","1",2) From YAX3MJSONGEN
    Endif

    YRESPONSE =func YAX3MJSONGEN.GENERATE_JSON(YSUCCESS,AVOID.ACHAR,AVOID.ACHAR,YALERT_WS,YFIELDS,YHEADER,YDATA)
  Endif

End

# AZIONE-CAMPO: AM-Post Modifica itmref esistente in DB---------------------------------

Subprog AM_ITMREF(ITMREF,YRESPONSE)

  Value Char ITMREF
  Variable Clbfile YRESPONSE

  Local File STOCK [F:YSTO]

  Local Char YALERT_WS(50)(1..3,1..3)
  Local Char YFIELDS(250)(2,8)
  Local Char YHEADER(0)(1,1)
  Local Char YDATA(0)(1,1)
  Local Char YMESSAGE(250):YMESSAGE =AVOID.ACHAR
  Local Integer YSUCCESS: [L]YSUCCESS=0
  Local Char YITMREF(20): YITMREF = ITMREF

  # Controllo che Cod.Articolo esista
  Filter [F:YSTO] Where [F:YSTO]ITMREF = YITMREF

  #Controllo che record set non vuoto
  If rowcount([F:YSTO])= 0
    YSUCCESS=1
    YMESSAGE = "Nessun record trovato con Cod.Articolo = "- YITMREF
    Call ECR_TRACE(YMESSAGE,0) From GESECRAN

    If ![V]GWEBSERV
      mkstat =2
      Call ERREURT(YMESSAGE,1) From GESECRAN
    Endif
  Endif

  Filter [F:YSTO]

  #Valorizzo YRESPONSE
  If(YSUCCESS=0)
    Call SET_FIELDS(YFIELDS,"ITMREF","Char",YITMREF,"0",YMESSAGE,"0","0","0",0) From YAX3MJSONGEN
    Call SET_FIELDS(YFIELDS,"VALDCB","Decimal",AVOID.ACHAR,"0",AVOID.ACHAR,"1","0","1",1) From YAX3MJSONGEN
  Else
    Call SET_FIELDS(YFIELDS,"ITMREF","Char",AVOID.ACHAR,"1",YMESSAGE,"0","0","0",0) From YAX3MJSONGEN
    Call SET_FIELDS(YFIELDS,"VALDCB","Decimal",AVOID.ACHAR,"0",AVOID.ACHAR,"1","0","1",1) From YAX3MJSONGEN
  Endif

  YRESPONSE =func YAX3MJSONGEN.GENERATE_JSON(YSUCCESS,AVOID.ACHAR,AVOID.ACHAR,YALERT_WS,YFIELDS,YHEADER,YDATA)
End

# AZIONE-CAMPO: AS-Pre Inserimento : AS_ITMREF: controllo Loc ESISTENTE in DB ---------------------------------------------------------------------

Subprog AS_ITMREF(YITMREF,YRES,YMESS)
  Value Char YITMREF
  Variable Integer YRES
  Variable Char YMESS

  #Local Char YLOC(3):YLOC = YSTOFCYGET

  Local File STOCK [F:YSTO]
  Local File STOLOC [F:YSTC]

  Local Char YVAL (20)

  If ![V]GWEBSERV
      YVAL =[M:YGIAC1]LOC
  Else
      YVAL =YITMREF
  Endif

  YRES=0
  YMESS=""

  # Controllo che Loc esista
  #Filter [F:YSTC] Where [F:YSTC]LOC = [M:YGIAC1]LOC
  Filter [F:YSTC] Where [F:YSTC]LOC = YVAL

  #Controllo che record set non vuoto
  If rowcount([F:YSTC])= 0

    YMESS = "Nessun record trovato con LOC = "- YVAL
    #YMESS = "Nessun record trovato con lOC = "- YITMREF
    Call ECR_TRACE(YMESS,0) From GESECRAN

    If ![V]GWEBSERV
      Call ERREURT(YMESS,1) From GESECRAN
    Endif

    mkstat =2
    YRES= mkstat


  Endif
  Filter [F:YSTC]


End

##################################################
Subprog AS_LOC(STOFCY,LOC,YRESPONSE)
Value    Char    STOFCY
Value    Char    LOC
Variable Clbfile YRESPONSE
End

######################################################################################
## Etichetta aggiunta dal supervisore (videata YGIAC1) 12/03/2025 17:44:39 (ADMIN)
######################################################################################
Subprog B2_LOC(VALEUR)
Variable Char    VALEUR()
End


######################################################################################

######################################################################################
## Etichetta aggiunta dal supervisore (videata YGIAC1) 04/04/2025 12:27:02 (ADMIN)
######################################################################################
Subprog C_CANC2(VALEUR)
Variable Integer VALEUR
End


######################################################################################

######################################################################################
## Etichetta aggiunta dal supervisore (videata YGIAC1) 04/04/2025 12:30:26 (ADMIN)
######################################################################################
Subprog C_CANC3(VALEUR)
Variable Integer VALEUR
End


######################################################################################

**********
7,"TRT","YGIAC",""
2,"TRT","YSMO",""
#<AdxTL>@(#)0.0.0.0 $Revision$

#############################################################################################################################
#
#MC - Gestione USCITE DIVERSE App ArgoX3 Mobile - 05/04/2024
#
#############################################################################################################################

$ACTION

#If GUSER='ADMIN' : Infbox(ACTION) : Endif

  Case ACTION
    When "OUVRE"         : Gosub OUVRE
    When "DEBUT"         : Gosub DEBUT
    When "FIN"           : Gosub FIN
    When Default
  Endcase

Return

###########################################################

$OUVRE
  #Qui metto le tabelle che utilizzo nello script
Return

###########################################################

$DEBUT

  Call OUVRE_TRACE ("YAX3M - YSMO - Gestione USCITE AX3M- " - num$(date$)) From LECFIC
  Call ECR_TRACE("# -- Gestione USCITE AX3M--- ",0) From GESECRAN

#  nolign =1
#  [M:YSMO1]FCY = PARAM(1)
#  [M:YSMO1]IPTDAT = date$
#  [M:YSMO1]NBLIG = nolign
#  [M:YSMO1]ITMREF(nolign-1)= PARAM(3)
  Raz [M:YSMO1]
#  Affzo [M:YSMO1]

Return

$FIN
  Call FERME_TRACE From LECFIC
  #Call LEC_TRACE From LECFIC
Return

#######################################################################################################################
#**
#* Inizializzazione - NOTA: Se la finestra è composta da più  maschere, aggiungere YCURRMSK1, YCURRMSKALIAS1,...
#*!

$INIT_FILE

  Local Char YWINNAME(20): YWINNAME = "YSMO"
  Local Char YCURRMSK(20): YCURRMSK = "YSMO1"           #NOTA: Se la finestra è composta da più  maschere: Local Char YCURRMSK1(20): YCURRMSK1 = "<Nome>"
  Local Char YCURRMSKALIAS(20): YCURRMSKALIAS= "YSMO1"  #NOTA: Se la finestra è composta da più  maschere: Local Char YCURRMSKALIAS1(20): YCURRMSKALIAS1 = "<NomeAlias>"
  Local Char YACTION(20)
  Local Char YCURRFIELD(20)

Return

########################################################################################################################
################################################ SUBPROG /FUNPROG ######################################################
########################################################################################################################

#=============================================== AZIONI-CAMPO ==========================================================
#Controllo su SITO(FCY) su Anagrafica

Subprog C_STOUSC(FCY, IPTDAT, TRSFAM, YAX3MRESP, YRESPONSE, ITMREF, STU, QTYSTU, LOC, STA, LOT, SERNUM)

  Variable Char FCY
  Variable Date IPTDAT
  Variable Char TRSFAM

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char STU()
  Variable Decimal QTYSTU()
  Variable Char LOC()
  Variable Char STA()
  Variable Char LOT()
  Variable Char SERNUM()

  Local File FACILITY [F:YFCY]

  Call OUVRE_TRACE("C_STOUSC") From LECFIC
  Gosub INIT_FILE
  YACTION = "YCSTOUSC"
  YCURRFIELD = "FCY"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  IPTDAT = date$
  Call YAX3MOB_AFFZO(YCURRMSKALIAS,"IPTDAT") From YAX3MUTILS

  Read [F:YFCY]FCY0 = FCY
  If fstat
    mkstat = 2
    YMESSAGE = "ATTENZIONE! Sito inesistente!"
    Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
  Else
    mkstat = 0
    #YMESSAGE = [F:YFCY]FCYNAM    #In YMESSAGE metto Descrizione Sito inserito (valido)
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

#######################################################################################################################
#**
#* Gestore Formattazione Data
#*
#* @param YDATE Data
#*!
Funprog YDATEFORMATTER(YDATE)
  Value Char YDATE
  YDATE = ctrans(YDATE,chr$(22),"")  #tolgo doppiacoppia di apici e ne metto uno
  YDATE = mid$(YDATE,1,10)
End YDATE

####################################################################################################################
# AM -- Controllo su Cod Articolo(ITMREF)su Anagrafica & valorizzazione ITMDES1, STA, STU + controllo se Gestionea Lotto e/o Matricola

Subprog AM_ITRUSC(FCY, IPTDAT, TRSFAM, YAX3MRESP, YRESPONSE, ITMREF, STU, QTYSTU, LOC, STA, LOT, SERNUM)

  Variable Char FCY
  Variable Date IPTDAT
  Variable Char TRSFAM

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char STU()
  Variable Decimal QTYSTU()
  Variable Char LOC()
  Variable Char STA()
  Variable Char LOT()
  Variable Char SERNUM()

  Local File STOLOC [F:YSTC]
  Local File ITMMASTER [F:YITM]
  Local File ITMFACILIT [F:YITF]
  Local Char YLOC(10), YLOCTYP(5), YSTA(2), YLOT(20), YITMREF(20)

  Call OUVRE_TRACE("AM_ITRUSC") From LECFIC
  Gosub INIT_FILE
  YACTION = "YAMITRUSC"
  YCURRFIELD = "ITMREF"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #Start BL : Controllo ITMREF in anagrafica, poi cerco STA, STU
  Call YSTRVALEUR(ITMREF,YITMREF,CURRENTROW) From YAX3MUTILS
  Columns [F:YITF](ITMREF)
  Read [F:YITF]ITF0 = [L]YITMREF;FCY

  If(fstat=0)
    Columns [F:YITM](ITMDES1,STU,LOTMGTCOD,SERMGTCOD)
    Read [F:YITM]ITM0 = YITMREF
    #YMESSAGE = [F:YITM]ITMDES1
    STU(CURRENTROW) = [F:YITM]STU
    STA(CURRENTROW) = "A"
    Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"STU",CURRENTROW) From YAX3MUTILS
    Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"STA",CURRENTROW) From YAX3MUTILS

    If([F:YITM]LOTMGTCOD < 3)   #Gestione non a Lotto (A LOTTO: >=3)
      Call YAX3MOB_DISZO_RIQUADRO(YFIELDS,YCURRMSKALIAS,"LOT",CURRENTROW) From YAX3MUTILS
    Endif

    If([F:YITM]SERMGTCOD >= 2) #Gestione a Matricola
      QTYSTU(CURRENTROW) = 1
      Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"QTYSTU",CURRENTROW) From YAX3MUTILS
      Call YAX3MOB_DISZO_RIQUADRO(YFIELDS,YCURRMSKALIAS,"QTYSTU",CURRENTROW) From YAX3MUTILS
    Else
      Call YAX3MOB_DISZO_RIQUADRO(YFIELDS,YCURRMSKALIAS,"SERNUM",CURRENTROW) From YAX3MUTILS
    Endif
  Else
    mkstat = 2
    YMESSAGE = "ATTENZIONE! Cod.Articolo non in anagrafica!"
    Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC

End

###################################################################################################################
# Azione-Campo CONTROLLO campo QTYSTU : Controllo qta NON = 0 , se gestione NON a Matricola

Subprog C_QTSTUSC(FCY, IPTDAT, TRSFAM, YAX3MRESP, YRESPONSE, ITMREF, STU, QTYSTU, LOC, STA, LOT, SERNUM)

  Variable Char FCY
  Variable Date IPTDAT
  Variable Char TRSFAM

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char STU()
  Variable Decimal QTYSTU()
  Variable Char LOC()
  Variable Char STA()
  Variable Char LOT()
  Variable Char SERNUM()

  Call OUVRE_TRACE("C_QTSTUSC") From LECFIC
  Gosub INIT_FILE
  YACTION = "YCQTSTUSC"
  YCURRFIELD = "QTYSTU"
  Local Decimal YQTYSTU,YSTODIS

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  Call YDECVALEUR(QTYSTU,YQTYSTU,CURRENTROW) From YAX3MUTILS
  If(YQTYSTU<>0)
#    Call YGETSTODISPO(FCY,ITMREF(CURRENTROW),LOC,YSTODIS)
#    If(YQTYSTU > YSTODIS)
#      mkstat=2
#      YMESSAGE = "ATTENZIONE! Quantità prelevata superiore alla disponibilità!"
#      Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE,CURRENTROW) From YAX3MUTILS
#    Else
      mkstat=0
#    Endif
  Else
    mkstat = 2
    YMESSAGE = "Attenzione! Quantità inserita nulla!"
    Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE,CURRENTROW) From YAX3MUTILS
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

################################################################################################################
# C -- Controllo su Ubicazione(LOC) su Anagrafica

Subprog C_LOCUSC(FCY, IPTDAT, TRSFAM, YAX3MRESP, YRESPONSE, ITMREF, STU, QTYSTU, LOC, STA, LOT, SERNUM)

  Variable Char FCY
  Variable Date IPTDAT
  Variable Char TRSFAM

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char STU()
  Variable Decimal QTYSTU()
  Variable Char LOC()
  Variable Char STA()
  Variable Char LOT()
  Variable Char SERNUM()

  Local File STOLOC [F:YSTC]
  Local Char YLOC(10)

  Call OUVRE_TRACE("C_LOCUSC") From LECFIC
  Gosub INIT_FILE
  YACTION = "YCLOCUSC"
  YCURRFIELD = "LOC"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic:Controllo LOC in anagrafica
  Call YSTRVALEUR(LOC,YLOC,CURRENTROW) From YAX3MUTILS
  Columns [F:YSTC](LOC)
  Read [F:YSTC]STC0 = FCY;YLOC

  If(fstat > 0)
   mkstat = 2
   YMESSAGE = "ATTENZIONE! Ubicazione non in anagrafica!"
   Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE,CURRENTROW) From YAX3MUTILS
  Else
    mkstat = 0
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

################################################################################################################
# C -- Controllo su Lotto(LOT) su Anagrafica & non vuoto, nel caso ITMREF gestito a Lotto

Subprog C_LOTUSC(FCY, IPTDAT, TRSFAM, YAX3MRESP, YRESPONSE, ITMREF, STU, QTYSTU, LOC, STA, LOT, SERNUM)

  Variable Char FCY
  Variable Date IPTDAT
  Variable Char TRSFAM

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char STU()
  Variable Decimal QTYSTU()
  Variable Char LOC()
  Variable Char STA()
  Variable Char LOT()
  Variable Char SERNUM()

  Local File STOCK [F:YSTO]
  Local File STOLOC [F:YSTC]
  Local Char YLOT(15)
  Call OUVRE_TRACE("C_LOTUSC") From LECFIC

  #init
  Gosub INIT_FILE
  YACTION = "YCLOTUSC"
  YCURRFIELD = "LOT"
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  Call YSTRVALEUR(LOT,YLOT,CURRENTROW) From YAX3MUTILS
  If (vireblc(YLOT,2) = AVOID.ACHAR)
    mkstat = 2
    YMESSAGE = "ATTENZIONE! Lotto obbligatorio!"
    Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
  Else
    #controllo Lotto in anagrafica
    Filter [F:YSTO]
    Columns [F:YSTO](LOT)
    Filter [F:YSTO] Where ([F:YSTO]STOFCY = FCY & [F:YSTO]ITMREF = ITMREF(CURRENTROW) & [F:YSTO]LOT = YLOT)
    #Filter [F:YSTO] Where ([F:YSTO]STOFCY = FCY & [F:YSTO]ITMREF = ITMREF(CURRENTROW) )

Call ECR_TRACE("Sito =" -FCY-"-"-"itmref =" -ITMREF(CURRENTROW)-"lotto =" -YLOT - "rwcount =" -num$(rowcount([F:YSTO])),0) From GESECRAN
Infbox "Sito =" -FCY-"-"-"itmref =" -ITMREF(CURRENTROW)-"lotto =" -YLOT - "rwcount =" -num$(rowcount([F:YSTO]))

#    If (rowcount([F:YSTO])=0)
#     mkstat =2
#     YMESSAGE = "ATTENZIONE! Lotto " + YLOT + " non in anagrafica!"
#     Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE, CURRENTROW) From YAX3MUTILS
#    Endif
  Endif
  Filter [F:YSTO]

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

####################################################################################################################
#C-- Controllo Matricola (se prevista la sua gestione)(SERNUM) in anagrafica

Subprog C_SERNUSC(FCY, IPTDAT, TRSFAM, YAX3MRESP, YRESPONSE, ITMREF, STU, QTYSTU, LOC, STA, LOT, SERNUM)

  Variable Char FCY
  Variable Date IPTDAT
  Variable Char TRSFAM

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char STU()
  Variable Decimal QTYSTU()
  Variable Char LOC()
  Variable Char STA()
  Variable Char LOT()
  Variable Char SERNUM()

  Local File STOSER [F:YSTS]
  Local Char YSERNUM(20)

  Call OUVRE_TRACE("C_SERNUSC") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCSERNUSC"
  YCURRFIELD = "SERNUM"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  Call YSTRVALEUR(SERNUM,YSERNUM,CURRENTROW) From YAX3MUTILS
  If(vireblc(SERNUM,2) = AVOID.ACHAR)
    mkstat =2
    YMESSAGE = "ATTENZIONE! Matricola obbligatoria per questo articolo!"
    Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE,CURRENTROW) From YAX3MUTILS
  Else
    Columns [F:YSTS](SERNUM)
    Read [F:YSTS]STS0 = ITMREF(CURRENTROW);SERNUM
    If(fstat >0)
      mkstat =2
      YMESSAGE = "ATTENZIONE! Matricola non esistente!"
      Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE,CURRENTROW) From YAX3MUTILS
    Else
      mkstat =0
    Endif
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

####################################################################################################################
#                                                 Utilità
####################################################################################################################
#**
#* Calcolo Giacenza
#* @param FCY Sito
#* @param ITMREF Cod Articolo
#* @param LOC Ubicazione
#* @param LOT Lotto
#*!

Funprog YCALCGIAC(FCY,ITMREF,LOC,LOT)

  Value Char FCY
  Value Char ITMREF
  Value Char LOC
  Value Char LOT

  Local File STOCK [F:YSTO]
  Local File STOLOC [F:YSTC]
  Local Decimal YGIAC: YGIAC=0

  Link [F:YSTO] With [F:YSTC]STC0=[F:YSTO]STOFCY;[F:YSTO]LOC
&               As [YLNK]
&               Where ([F:YSTO]ITMREF =[L]ITMREF & [F:YSTO]LOT =[L]LOT & [F:YSTO]STOFCY =[L]FCY & [F:YSTO]LOC =[L]LOC & [F:YSTO]STA ="A")
#& Where ([F:YSTO]ITMREF =[L]ITMREF & [F:YSTO]STOFCY =[L]FCY)

  Columns [YLNK]([F:YSTO]QTYSTU,[F:YSTO]CUMALLQTA,[F:YSTO]CUMWIPQTY)

  For [YLNK]
    YGIAC += [F:YSTO]QTYSTU - [F:YSTO]CUMALLQTA -[F:YSTO]CUMWIPQTY
  Next
End YGIAC

#######################################################################################################################

#**
#* Controllo della disponibilità in Stock di un Articolo in un Sito & ubicazione
#*
#* @param FCY Sito dove controllare qtà disponibile
#* @param ITMREF Cod articolo di cui controllare la qtà disponibile
#* @param LOC Ubicazione dove contrllare qtà disponibile
#* @param YSTODIS Qtà Stodispo
#*!

Subprog YGETSTODISPO(FCY,ITMREF,LOC,YSTODIS)

  Value Char FCY
  Value Char ITMREF
  Value Char LOC
  Variable Decimal YSTODIS

  Local File ITMMVT [F:YITV]
  Local File ITMMASTER [F:YITM]
  Local File ITMCATEG [F:ITG]
  Local Integer YSTA

  Read [F:YITM]ITM0 = ITMREF
  Columns [F:YITM](TCLCOD)
  Read [F:ITG]ITG0 = "";[F:YITM]TCLCOD
  Columns [F:ITG](GLOAAAFLG,GLOQQQFLG,GLORRRFLG)
  Read [F:YITV]ITV0=ITMREF;FCY

  If [F:ITG]GLOAAAFLG = 2 YSTA += 1 Endif
  If [F:ITG]GLOQQQFLG = 2 YSTA += 2 Endif
  If [F:ITG]GLORRRFLG = 2 YSTA += 4 Endif

  # Call STODISPO("",[F:ITF]STOFCY,[F:ITF]ITMREF,"*","*",1,WSTA,"","","","",WDISPO) From STKLIB
  Call STODISPO("[F:YITV]",FCY,ITMREF,"*",LOC,1,YSTA,"","","","",YSTODIS) From STKLIB
End

########################################################################################################################
#                                               BOTTONE FINESTRA
########################################################################################################################

Subprog YCREA_USC(FCY, IPTDAT, TRSFAM, YAX3MRESP, YRESPONSE, ITMREF, STU, QTYSTU, LOC, STA, LOT, SERNUM)

  Variable Char FCY
  Variable Date IPTDAT
  Variable Char TRSFAM

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char STU()
  Variable Decimal QTYSTU()
  Variable Char LOC()
  Variable Char STA()
  Variable Char LOT()
  Variable Char SERNUM()

  Local Integer K, YSUCCESS : YSUCCESS = 0

  #apertura traccia
  Call OUVRE_TRACE("YCREA_USC") From LECFIC
  Gosub INIT_FILE
  YACTION = "YCREAUSC"
  YCURRFIELD = ""

  #init
  Gosub YAX3MOB_INIT_BUTTONACTION From YAX3MUTILS
  #parametrizzazioni iniziali (contestuali)
  YFUNC_NAME = "YSMO" : YFUNC_TYPE = "DOC" : YIMP_CODE= "YSMO" : YMEX_DOCTYPE = "Uscita Diversa"

  #Business logic
  Gosub YFILL_YSMOCSV
  Call YPRINT_CLB(YCSVTEXT,YFUNC_NAME, "csv") From YUTILS  #stampa csv (opzionale)
  #Check correttezza codice Modello import impostato?

  If dim(GYVCRENT)<0
    Global Char GYVCRENT(20)
  Endif
  Raz GYVCRENT

  Call YAX3MOB_IMPORTSIL(YIMP_CODE, YCSVTEXT, YSUCCESS, YMESSAGE) From YAX3MUTILS
  If (vireblc(GYVCRENT,2)= AVOID.ACHAR)
    YMESSAGE = func YUTILS.IIF(YMESSAGE = AVOID.ACHAR, "Movimento di uscita fallito! Impossibile proseguire!", YMESSAGE)
    YSUCCESS=1
  Else
    YMESSAGE = "Uscita diversa ("-GYVCRENT-")avvenuta con successo!"
  Endif

  If dim(GYVCRENT)>0
   Kill GYVCRENT
  Endif
  YALERT_MESSAGE -= YMESSAGE

  If YSUCCESS = 1
    Call YAX3MOB_SHOWALERT(2, YALERT_TYPE, YALERT_MESSAGE) From YAX3MUTILS
  Else
    Raz FCY, IPTDAT
    For K = 0 To func YUTILS.COUNT(ITMREF) - 1
      Raz ITMREF(K),STU(K),QTYSTU(K),LOC(K),STA(K),LOT(K),SERNUM(K) #dettaglio
    Next
    Call YAX3MOB_SHOWALERT(1, YALERT_TYPE, YALERT_MESSAGE) From YAX3MUTILS
  Endif

  Gosub YAX3MOB_END_BUTTONACTION From YAX3MUTILS
  Call FERME_TRACE From LECFIC

End

#######################################################################################################################
#**
#* Sub per creazione testo csv per YSMO
#*!

$YFILL_YSMOCSV

  #INIZIO creaz csv
  #Testata
  Call YAX3MOB_APPEND(YCSVTEXT, "E", 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, FCY, 0) From YAX3MUTILS  #STOFCY
  Call YAX3MOB_APPEND(YCSVTEXT, format$("D:YYYYMMDD",IPTDAT), 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, "Uscita AX3M", 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, TRSFAM, 1) From YAX3MUTILS

  Local Integer I,J : I = 0 : J = 0
  For I=0 To func YUTILS.COUNT(ITMREF) - 1
    # Row L
    Call YAX3MOB_APPEND(YCSVTEXT, "L", 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, ITMREF(I), 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, STU(I), 0) From YAX3MUTILS           #CI METTO SU PCU IL VALORE DI STU
    Call YAX3MOB_APPEND(YCSVTEXT, num$(QTYSTU(I)), 0) From YAX3MUTILS  #CI METTO SU QTYPCU IL VALORE DI QTYSTU
    Call YAX3MOB_APPEND(YCSVTEXT, STU(I), 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, num$(QTYSTU(I)), 0) From YAX3MUTILS  #CI METTO SU QTYPCU IL VALORE DI QTYSTU

    # Row S
    Call YAX3MOB_APPEND(YCSVTEXT, "S", 0)  From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, STU(I), 0)  From YAX3MUTILS          #CI METTO SU PCU IL VALORE DI STU
    Call YAX3MOB_APPEND(YCSVTEXT, num$(QTYSTU(I)), 0) From YAX3MUTILS  #CI METTO SU QTYPCU IL VALORE DI QTYSTU
    Call YAX3MOB_APPEND(YCSVTEXT, LOT(I), 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, LOC(I), 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, STA(I), 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, TRSFAM, 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, SERNUM(I), 1) From YAX3MUTILS
  Next
  #FINE creaz csv
Return

##################################################
Subprog C_IPTDUSC(IPTDAT,YRESPONSE)
Value    Date    IPTDAT
Variable Clbfile YRESPONSE
End

**********
7,"TRT","YSMO",""
2,"TRT","YSMR_ENT",""
#<AdxTL>@(#)0.0.0.0 $Revision$
#MC  Gestione Entrate DiversE App

$ACTION

#If GUSER='ADMIN' : Infbox(ACTION) : Endif

  Case ACTION
    When "OUVRE"         : Gosub OUVRE
    When "DEBUT"         : Gosub DEBUT
    When "FIN"           : Gosub FIN
    When Default
  Endcase

Return

###########################################################

$OUVRE

Return

###########################################################

$DEBUT

  Call OUVRE_TRACE ("YAX3M - YSMR - Gestione Entrate Diverse - " - num$(date$)) From LECFIC
  Call ECR_TRACE("# -- Gestione Entrate Diverse --- ",0) From GESECRAN
  Raz [M:YSMR1]
Return

###########################################################

$FIN
  Call FERME_TRACE From LECFIC
Return

#######################################################################################################################
#**
#* Inizializzazione - NOTA: Se la finestra è composta da più  maschere, aggiungere YCURRMSK1, YCURRMSKALIAS1,...
#*!

$INIT_FILE

  Local Char YWINNAME(20): YWINNAME = "YSMR"
  Local Char YCURRMSK(20): YCURRMSK = "YSMR1"
  #NOTA: Se la finestra è composta da più  maschere: Local Char YCURRMSK1(20): YCURRMSK1 = "<Nome1>",... ecc
  Local Char YCURRMSKALIAS(20): YCURRMSKALIAS= "YSMR1"
  #NOTA: Se la finestra è composta da più  maschere: Local Char YCURRMSKALIAS1(20): YCURRMSKALIAS1 = "<NomeAlias1>",...ecc
  Local Char YACTION(20)
  Local Char YCURRFIELD(20)

Return

########################################################################################################################
################################################ SUBPROG /FUNPROG ######################################################
########################################################################################################################

#=============================================== AZIONI-CAMPO ==========================================================
#Controllo su SITO(FCY) su Anagrafica & non vuoto

Subprog C_STOENT(FCY, IPTDAT, TRSFAM, YAX3MRESP, YRESPONSE, ITMREF, STU, QTYSTU, LOC, LOCTYP, STA, LOT, SERNUM)

  Variable Char FCY
  Variable Date IPTDAT
  Variable Char TRSFAM

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char STU()
  Variable Decimal QTYSTU()
  Variable Char LOC()
  Variable Char LOCTYP()
  Variable Char STA()
  Variable Char LOT()
  Variable Char SERNUM()

  Call OUVRE_TRACE("C_STOENT") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCSTOENT"
  YCURRFIELD = "FCY"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS   #print clb: "yax3mresp", "postJson", "init"

  #business logic
  IPTDAT = date$
  Call YAX3MOB_AFFZO(YCURRMSKALIAS,"IPTDAT") From YAX3MUTILS

  Local File FACILITY [F:YFCY]
  Read [F:YFCY]FCY0 = FCY
  If fstat
    mkstat = 2
    YMESSAGE = "ATTENZIONE! Sito inesistente!"
    Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
    Call YAX3MOB_ECRTRACE(mkstat,YCURRFIELD-"mex :"-YMESSAGE) From YAX3MLOG     #log
  Else
    mkstat = 0
    Call YAX3MOB_ECRTRACE(mkstat,"Sito in anagrafica") From YAX3MLOG     #log
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS   #print clb: "yresponse", "end"
  Call FERME_TRACE From LECFIC
End

###############################################################################################################################

Subprog AM_ITRENT(FCY, IPTDAT, TRSFAM, YAX3MRESP, YRESPONSE, ITMREF, STU, QTYSTU, LOC, LOCTYP, STA, LOT, SERNUM)

  Variable Char FCY
  Variable Date IPTDAT
  Variable Char TRSFAM

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char STU()
  Variable Decimal QTYSTU()
  Variable Char LOC()
  Variable Char LOCTYP()
  Variable Char STA()
  Variable Char LOT()
  Variable Char SERNUM()

  Local File STOLOC [F:YSTC]
  Local File ITMMASTER [F:YITM]
  Local File ITMFACILIT [F:YITF]
  Local Char YITMREF(20)

  Call OUVRE_TRACE("AM_ITRENT") From LECFIC
  Gosub INIT_FILE
  YACTION = "YAMITRENT"
  YCURRFIELD = "ITMREF"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  Call YSTRVALEUR(ITMREF,YITMREF,CURRENTROW) From YAX3MUTILS
  Columns [F:YITF](DEFLOC)
  Read [F:YITF]ITF0 = YITMREF;FCY
  #Read [F:YITF]ITF0 = ITMREF(CURRENTROW);FCY

  If fstat
    mkstat=2
    YMESSAGE="ATTENZIONE! Cod. Articolo non associato al sito o inesistente!"
    Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE,CURRENTROW) From YAX3MUTILS
    Call YAX3MOB_ECRTRACE(mkstat,YCURRFIELD-"(row"-num$(CURRENTROW+1)-")-"-"mex :"-YMESSAGE) From YAX3MLOG    #log
  Else
    Columns [F:YSTC](LOCTYP)
    Read [F:YSTC]STC0=FCY;[F:YITF]DEFLOC
    #se l'articolo ha un ubicazione di default settiamo in automatico lo stato A, altrimenti lo fa l'azione campo sull'ubicazione
    If fstat=0
      LOC(CURRENTROW) = [F:YITF]DEFLOC
      Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"LOC",CURRENTROW) From YAX3MUTILS
      LOCTYP(CURRENTROW) = [F:YSTC]LOCTYP
      Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"LOCTYP",CURRENTROW) From YAX3MUTILS
      STA(CURRENTROW) = "A" #stato articolo settato così per semplicità
      Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"STA",CURRENTROW) From YAX3MUTILS
    Endif

    Columns [F:YITM](ITMDES1,SERMGTCOD,LOTMGTCOD,STU)
    Read [F:YITM]ITM0 = YITMREF

    If fstat
      mkstat=2
      YMESSAGE="ATTENZIONE! Cod. Articolo inesistente!"
      Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE,CURRENTROW) From YAX3MUTILS
      Call YAX3MOB_ECRTRACE(mkstat,YCURRFIELD-"(row"-num$(CURRENTROW+1)-")-"-"mex :"-YMESSAGE) From YAX3MLOG     #log
    Else
      mkstat =0

      STU(CURRENTROW) = [F:YITM]STU
      Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"STU",CURRENTROW) From YAX3MUTILS
      #Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, [F:YITM]ITMDES1,CURRENTROW) From YAX3MUTILS

      #Gestione a matricola, qta forzata a 1
      If([F:YITM]SERMGTCOD=3)
        QTYSTU(CURRENTROW)=1
        Call YAX3MOB_DISZO_RIQUADRO(YFIELDS,YCURRMSKALIAS,"QTYSTU",CURRENTROW) From YAX3MUTILS
        Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"QTYSTU",CURRENTROW) From YAX3MUTILS
      Else
        Call YAX3MOB_DISZO_RIQUADRO(YFIELDS,YCURRMSKALIAS,"SERNUM",CURRENTROW) From YAX3MUTILS
      Endif

      #Gestione NON a lotto, disabilito il campo lotto
      If([F:YITM]LOTMGTCOD < 2)
        Call YAX3MOB_DISZO_RIQUADRO(YFIELDS,YCURRMSKALIAS,"LOT",CURRENTROW) From YAX3MUTILS
      Endif
      Call YAX3MOB_SETLABEL(YFIELDS,YCURRFIELD,0,[F:YITM]ITMDES1,CURRENTROW) From YAX3MUTILS
      Call YAX3MOB_ECRTRACE(mkstat,"Articolo in anagrafica") From YAX3MLOG     #log

    Endif
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

########################################################################################################################
Subprog C_QTSTENT(FCY, IPTDAT, TRSFAM, YAX3MRESP, YRESPONSE, ITMREF, STU, QTYSTU, LOC, LOCTYP, STA, LOT, SERNUM)

  Variable Char FCY
  Variable Date IPTDAT
  Variable Char TRSFAM

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char STU()
  Variable Decimal QTYSTU()
  Variable Char LOC()
  Variable Char LOCTYP()
  Variable Char STA()
  Variable Char LOT()
  Variable Char SERNUM()

  Call OUVRE_TRACE("C_QTSTENT") From LECFIC
  Local Decimal YQTYSTU

  Gosub INIT_FILE
  YACTION = "YCQTSTENT"
  YCURRFIELD = "QTYSTU"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  Call YDECVALEUR(QTYSTU,YQTYSTU,CURRENTROW) From YAX3MUTILS
  If(YQTYSTU = 0)
    mkstat =2
    YMESSAGE = "ATTENZIONE! Quantità inserita nulla!"
    Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE,CURRENTROW) From YAX3MUTILS
    Call YAX3MOB_ECRTRACE(mkstat,YCURRFIELD-"(row"-num$(CURRENTROW+1)-")-"-"mex :"-YMESSAGE) From YAX3MLOG     #log
  Else
    Call YAX3MOB_ECRTRACE(mkstat,"Quantità imputata > 0") From YAX3MLOG     #log
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC

End

#############################################################################################################################
# C -- Controllo su Ubicazione(LOC) su Anagrafica & valorizzazione campi: LOCTYP, STA

Subprog C_LOCENT(FCY, IPTDAT, TRSFAM, YAX3MRESP, YRESPONSE, ITMREF, STU, QTYSTU, LOC, LOCTYP, STA, LOT, SERNUM)

  Variable Char FCY
  Variable Date IPTDAT
  Variable Char TRSFAM

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char STU()
  Variable Decimal QTYSTU()
  Variable Char LOC()
  Variable Char LOCTYP()
  Variable Char STA()
  Variable Char LOT()
  Variable Char SERNUM()

  Local File ITMFACILIT [F:YITF]
  Local File STOLOC [F:YSTC]
  Local File ITMMASTER [F:YITM]
  Local Char YLOC(10)

  Call OUVRE_TRACE("C_LOCENT") From LECFIC
  Gosub INIT_FILE
  YACTION = "YCLOCENT"
  YCURRFIELD = "LOC"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  Call YSTRVALEUR(LOC,YLOC,CURRENTROW) From YAX3MUTILS
  Columns [F:YSTC](LOCTYP)
  Read [F:YSTC]STC0 = FCY;YLOC

  If(fstat = 0)
    #loctyp,sta
    LOCTYP(CURRENTROW)= [F:YSTC]LOCTYP
    STA(CURRENTROW) = "A"
    #LOT,SERNUM (dipendono da ITMREF: già imputato)
    Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"LOCTYP",CURRENTROW) From YAX3MUTILS
    Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"STA",CURRENTROW) From YAX3MUTILS
    Call YAX3MOB_ECRTRACE(mkstat,"Ubicazione in anagrafica") From YAX3MLOG     #log
  Else
    mkstat =2
    YMESSAGE = "ATTENZIONE! Ubicazione non trovata!"
    Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE, CURRENTROW) From YAX3MUTILS
    Call YAX3MOB_ECRTRACE(mkstat,YCURRFIELD-"(row"-num$(CURRENTROW+1)-")-"-"mex :"-YMESSAGE) From YAX3MLOG    #log
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

#############################################################################################################################
#C- Controllo: se gestione a Lotto, campo non vuoto

Subprog C_LOTENT(FCY, IPTDAT, TRSFAM, YAX3MRESP, YRESPONSE, ITMREF, STU, QTYSTU, LOC, LOCTYP, STA, LOT, SERNUM)

  Variable Char FCY
  Variable Date IPTDAT
  Variable Char TRSFAM

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char STU()
  Variable Decimal QTYSTU()
  Variable Char LOC()
  Variable Char LOCTYP()
  Variable Char STA()
  Variable Char LOT()
  Variable Char SERNUM()

  Call OUVRE_TRACE("C_LOTENT") From LECFIC
  Local Char YLOT(15)
  Gosub INIT_FILE
  YACTION = "YCLOTENT"
  YCURRFIELD = "LOT"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  Call YSTRVALEUR(LOT,YLOT,CURRENTROW) From YAX3MUTILS
  If(vireblc(YLOT,2) = AVOID.ACHAR)
   mkstat =2
   YMESSAGE = "Attenzione! Lotto obbligatorio."
   Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE,CURRENTROW) From YAX3MUTILS
   Call YAX3MOB_ECRTRACE(mkstat,YCURRFIELD-"(row"-num$(CURRENTROW+1)-")-"-"mex :"-YMESSAGE) From YAX3MLOG     #log
  Else
    mkstat=0
    Call YAX3MOB_ECRTRACE(mkstat,"Lotto inserito") From YAX3MLOG     #log
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC

End

##############################################################################################################################
#C-- Controllo Matricola (se prevista la sua gestione)(SERNUM): NO Inserimento Matricola già esistente in anagrafica

Subprog C_SERNENT(FCY, IPTDAT, TRSFAM, YAX3MRESP, YRESPONSE, ITMREF, STU, QTYSTU, LOC, LOCTYP, STA, LOT, SERNUM)

  Variable Char FCY
  Variable Date IPTDAT
  Variable Char TRSFAM

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char STU()
  Variable Decimal QTYSTU()
  Variable Char LOC()
  Variable Char LOCTYP()
  Variable Char STA()
  Variable Char LOT()
  Variable Char SERNUM()

  Local File STOSER [F:YSTS]
  Local Char YSERNUM(20)

  Call OUVRE_TRACE("C_SERNENT") From LECFIC
  Gosub INIT_FILE
  YACTION = "YCSERNENT"
  YCURRFIELD = "SERNUM"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic:Controllo se già presente la matricola in Anagrafica
  Call YSTRVALEUR(SERNUM,YSERNUM,CURRENTROW) From YAX3MUTILS
  If(vireblc(YSERNUM,2) = AVOID.ACHAR)
    mkstat=2
    YMESSAGE = "ATTENZIONE! Matricola obbligatoria per l'art. "-ITMREF(CURRENTROW)-"!"
    Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE,CURRENTROW) From YAX3MUTILS
    Call YAX3MOB_ECRTRACE(mkstat,YCURRFIELD-"(row"-num$(CURRENTROW+1)-")-"-"mex :"-YMESSAGE) From YAX3MLOG     #log
  Else
    Columns [F:YSTS](SERNUM)
    Read [F:YSTS]STS0 = [L]ITMREF(CURRENTROW);YSERNUM

    If(fstat =0)
      mkstat=2
      YMESSAGE = "ATTENZIONE! Matricola già esistente, inserirne una nuova!"
      Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE,CURRENTROW) From YAX3MUTILS
      Call YAX3MOB_ECRTRACE(mkstat,YCURRFIELD-"(row"-num$(CURRENTROW+1)-")-"-"mex :"-YMESSAGE) From YAX3MLOG     #log
    Else
      mkstat=0
      Call YAX3MOB_ECRTRACE(mkstat,"Matricola inserità e non già in anagrafica") From YAX3MLOG    #log
    Endif
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

#####################################################################################################################
#**
#* Controllo Validità LOC - Gestione "*" nel campo LOC, ritorna booleano
#* @param YFCY Sito
#* @param YLOC Ubicazione
#*!
Funprog YVALIDATELOC(YFCY,YLOC)

  Value Char YFCY
  Value Char YLOC
  Local File STOLOC [F:YSTC]

  Columns [F:YSTC](LOC)
  Read [F:YSTC]STC0 = YFCY;YLOC
End fstat

#========================================================================================================================
#============================================ AZIONI-BOTTONE ============================================================

Subprog YCREA_ENT(FCY, IPTDAT, TRSFAM, YAX3MRESP, YRESPONSE, ITMREF, STU, QTYSTU, LOC, LOCTYP, STA, LOT, SERNUM)

  Variable Char FCY
  Variable Date IPTDAT
  Variable Char TRSFAM

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char STU()
  Variable Decimal QTYSTU()
  Variable Char LOC()
  Variable Char LOCTYP()
  Variable Char STA()
  Variable Char LOT()
  Variable Char SERNUM()

  Local Integer K, YSUCCESS : YSUCCESS = 0

  #apertura traccia
  Call OUVRE_TRACE("YCREA_ENT") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCREAENT"
  YCURRFIELD = ""

  #init
  Gosub YAX3MOB_INIT_BUTTONACTION From YAX3MUTILS
  #parametrizzazioni iniziali :
  YFUNC_NAME = "YSMR" : YFUNC_TYPE = "DOC" : YIMP_CODE="YSMRU" : YMEX_DOCTYPE = "Entrata Diversa"

  #business logic
  If(YIMP_CODE="YSMR")
    Gosub YFILL_YSMRCSV
  Endif
  If(YIMP_CODE="YSMRU")
    Gosub YFILL_YSMRUCSV
  Endif

  #Call YPRINT_CLB(YCSVTEXT,YFUNC_NAME, "csv") From YUTILS  #stampo csv(opzionale)
  Call YPRINT_DIR_CLB(YLOGDIRNAME, YCSVTEXT, YFUNC_NAME, "csv") From YUTILS
  #Check correttezza codice Modello import impostato?

  If dim(GYVCRENT)<0
    Global Char GYVCRENT(20)
  Endif
  Raz GYVCRENT

  Call YAX3MOB_IMPORTSIL(YIMP_CODE, YCSVTEXT, YSUCCESS, YMESSAGE) From YAX3MUTILS

  If (vireblc(GYVCRENT,2)= AVOID.ACHAR)
    YMESSAGE = func YUTILS.IIF(YMESSAGE = AVOID.ACHAR, "Movimento di entrata fallito! Impossibile proseguire!", YMESSAGE)
    Call YAX3MOB_ECRTRACE(2,YMESSAGE) From  YAX3MLOG           #log
    YSUCCESS=1
  Else
    YMESSAGE = "Entrata diversa ("-GYVCRENT-")avvenuta con successo!"
    Call YAX3MOB_ECRTRACE(0,YMESSAGE) From YAX3MLOG
  Endif
  YALERT_MESSAGE -= YMESSAGE

  If YSUCCESS = 1
    Call YAX3MOB_SHOWALERT(2, YALERT_TYPE, YALERT_MESSAGE) From YAX3MUTILS
  Else
    Raz FCY, IPTDAT
    For K = 0 To func YUTILS.COUNT(ITMREF) - 1
      Raz ITMREF(K),STU(K),QTYSTU(K),LOC(K),LOCTYP(K),STA(K),LOT(K),SERNUM(K) #dettaglio
    Next

    Call YAX3MOB_SHOWALERT(1, YALERT_TYPE, YALERT_MESSAGE) From YAX3MUTILS
  Endif

  #end
  Gosub YAX3MOB_END_BUTTONACTION From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

#############################################################################################################
#**
#* Sub per riempimento testo csv per modello di Import YSMR
#*!

$YFILL_YSMRCSV

  #INIZIO creaz csv
  Call YAX3MOB_APPEND(YCSVTEXT, "E", 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, FCY, 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, format$("D:YYYYMMDD",IPTDAT), 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, "Entrata ArgoX3M", 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, TRSFAM, 1) From YAX3MUTILS

#  Call YAX3MOB_APPEND(YCSVTEXT, "mc", 0) From YAX3MUTILS  #creusr
#  Call YAX3MOB_APPEND(YCSVTEXT, "mc", 1) From YAX3MUTILS  #updusr

  Local Integer I,J : I = 0 : J = 0

  For I=0 To func YUTILS.COUNT(ITMREF) - 1
    # Row L
    Call YAX3MOB_APPEND(YCSVTEXT, "L", 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, ITMREF(I), 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, STU(I), 0) From YAX3MUTILS           #CI METTO SU PCU IL VALORE DI STU
    Call YAX3MOB_APPEND(YCSVTEXT, num$(QTYSTU(I)), 0) From YAX3MUTILS  #CI METTO SU QTYPCU IL VALORE DI QTYSTU
    Call YAX3MOB_APPEND(YCSVTEXT, STU(I), 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, num$(QTYSTU(I)), 0) From YAX3MUTILS  #CI METTO SU QTYPCU IL VALORE DI QTYSTU
    Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 1) From YAX3MUTILS

#    Call YAX3MOB_APPEND(YCSVTEXT, "mc", 0) From YAX3MUTILS  #creusr
#    Call YAX3MOB_APPEND(YCSVTEXT, "mc", 1) From YAX3MUTILS  #updusr

    # Row S
    Call YAX3MOB_APPEND(YCSVTEXT, "S", 0)  From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, STU(I), 0)  From YAX3MUTILS          #CI METTO SU PCU IL VALORE DI STU
    Call YAX3MOB_APPEND(YCSVTEXT, num$(QTYSTU(I)), 0) From YAX3MUTILS  #CI METTO SU QTYPCU IL VALORE DI QTYSTU
    Call YAX3MOB_APPEND(YCSVTEXT, LOC(I), 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, LOT(I), 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, STA(I), 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, TRSFAM, 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, SERNUM(I), 1) From YAX3MUTILS

#    Call YAX3MOB_APPEND(YCSVTEXT, "mc", 0) From YAX3MUTILS  #creusr
#    Call YAX3MOB_APPEND(YCSVTEXT, "mc", 1) From YAX3MUTILS  #updusr
  Next
  #FINE creaz csv
Return

############################################################################

$YFILL_YSMRUCSV

  #INIZIO creaz csv
  Call YAX3MOB_APPEND(YCSVTEXT, "E", 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, FCY, 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, format$("D:YYYYMMDD",IPTDAT), 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, "Entrata ArgoX3M", 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, TRSFAM, 0) From YAX3MUTILS

  Call YAX3MOB_APPEND(YCSVTEXT, "mc", 0) From YAX3MUTILS  #creusr
  Call YAX3MOB_APPEND(YCSVTEXT, "mc", 1) From YAX3MUTILS  #updusr

  Local Integer I,J : I = 0 : J = 0

  For I=0 To func YUTILS.COUNT(ITMREF) - 1
    # Row L
    Call YAX3MOB_APPEND(YCSVTEXT, "L", 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, ITMREF(I), 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, STU(I), 0) From YAX3MUTILS           #CI METTO SU PCU IL VALORE DI STU
    Call YAX3MOB_APPEND(YCSVTEXT, num$(QTYSTU(I)), 0) From YAX3MUTILS  #CI METTO SU QTYPCU IL VALORE DI QTYSTU
    Call YAX3MOB_APPEND(YCSVTEXT, STU(I), 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, num$(QTYSTU(I)), 0) From YAX3MUTILS  #CI METTO SU QTYPCU IL VALORE DI QTYSTU
    Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS

    Call YAX3MOB_APPEND(YCSVTEXT, "mc", 0) From YAX3MUTILS  #creusr
    Call YAX3MOB_APPEND(YCSVTEXT, "mc", 1) From YAX3MUTILS  #updusr

    # Row S
    Call YAX3MOB_APPEND(YCSVTEXT, "S", 0)  From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, STU(I), 0)  From YAX3MUTILS          #CI METTO SU PCU IL VALORE DI STU
    Call YAX3MOB_APPEND(YCSVTEXT, num$(QTYSTU(I)), 0) From YAX3MUTILS  #CI METTO SU QTYPCU IL VALORE DI QTYSTU
    Call YAX3MOB_APPEND(YCSVTEXT, LOC(I), 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, LOT(I), 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, STA(I), 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, TRSFAM, 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, SERNUM(I), 0) From YAX3MUTILS

    Call YAX3MOB_APPEND(YCSVTEXT, "mc", 0) From YAX3MUTILS  #creusr
    Call YAX3MOB_APPEND(YCSVTEXT, "mc", 1) From YAX3MUTILS  #updusr
  Next
  #FINE creaz csv
Return
######################################################################################
## Etichetta aggiunta dal supervisore (videata YSMR1) 02/07/2025 18:18:05 (ARG01)
######################################################################################
Subprog IB_ITMREF
End


######################################################################################

##################################################
Subprog AM_LOTENT(FCY,IPTDAT,TRSFAM,YAX3MRESP,YRESPONSE,ITMREF,STU,QTYSTU,LOC,LOCTYP,STA,LOT,SERNUM)
Variable Char    FCY()
Variable Date    IPTDAT
Variable Char    TRSFAM()
Value    Clbfile YAX3MRESP
Variable Clbfile YRESPONSE
Variable Char    ITMREF()
Variable Char    STU()
Variable Decimal QTYSTU
Variable Char    LOC()
Variable Char    LOCTYP()
Variable Char    STA()
Variable Char    LOT()
Variable Char    SERNUM()
End


##################################################
Subprog AM_QTSTENT(FCY,IPTDAT,TRSFAM,YAX3MRESP,YRESPONSE,ITMREF,STU,QTYSTU,LOC,LOCTYP,STA,LOT,SERNUM)
Variable Char    FCY()
Variable Date    IPTDAT
Variable Char    TRSFAM()
Value    Clbfile YAX3MRESP
Variable Clbfile YRESPONSE
Variable Char    ITMREF()
Variable Char    STU()
Variable Decimal QTYSTU
Variable Char    LOC()
Variable Char    LOCTYP()
Variable Char    STA()
Variable Char    LOT()
Variable Char    SERNUM()
End


##################################################
Subprog AM_SERNENT(FCY,IPTDAT,TRSFAM,YAX3MRESP,YRESPONSE,ITMREF,STU,QTYSTU,LOC,LOCTYP,STA,LOT,SERNUM)
Variable Char    FCY()
Variable Date    IPTDAT
Variable Char    TRSFAM()
Value    Clbfile YAX3MRESP
Variable Clbfile YRESPONSE
Variable Char    ITMREF()
Variable Char    STU()
Variable Decimal QTYSTU
Variable Char    LOC()
Variable Char    LOCTYP()
Variable Char    STA()
Variable Char    LOT()
Variable Char    SERNUM()
End
**********
7,"TRT","YSMR_ENT",""
2,"TRT","YSOH",""
#<AdxTL>@(#)0.0.0.0 $Revision$
#############################################################################################################################
#
#MC - Gestione ORDINI DI VENDITA App ArgoX3 Mobile - 24/04/2024
#
#############################################################################################################################

$ACTION

#If GUSER='ADMIN' : Infbox(ACTION) : Endif

  Case ACTION
    When "OUVRE"         : Gosub OUVRE
    When "DEBUT"         : Gosub DEBUT
    When "FIN"           : Gosub FIN
    When Default
  Endcase

Return

###########################################################

$OUVRE
  #Qui metto le tabelle che utilizzo nello script
Return

###########################################################

$DEBUT

  Call OUVRE_TRACE ("YAX3M - YSOH - Gestione ORDINI DI VENDITA AX3M- " - num$(date$)) From LECFIC
  Call ECR_TRACE("# -- Gestione ORDINI DI VENDITA AX3M--- ",0) From GESECRAN
  Raz [M:YSOH1]

Return

##########################################################

$FIN
  Call FERME_TRACE From LECFIC
Return

########################################################################################################################
################################################ SUBPROG /FUNPROG ######################################################
########################################################################################################################

$INIT_FILE
  Local Char YWINNAME(20): YWINNAME = "YSOH"
  Local Char YCURRMSK(20): YCURRMSK = "YSOH1"
  Local Char YCURRMSKALIAS(20): YCURRMSKALIAS= "YSOH1"
  Local Char YACTION(20)
  Local Char YCURRFIELD(20)
Return

#=============================================== AZIONI-CAMPO ==========================================================
# AZIONE-CAMPO : Controllo su SITO VENDITA(SALFCY) su Anagrafica

Subprog AS_SOHSOH(SOHNUM,FCY,SOHTYP,ORDDAT,BPRNUM,BPRNAM,BPAADDLIG,CUR,DEMDLVDAT,YAX3MRESP,YRESPONSE,ITMREF,SAU,QTY,GROPRI,DISCRGVAL1,DISCRGVAL2,NETPRI,YTOTALE)

  Variable Char SOHNUM
  Variable Char FCY
  Variable Char SOHTYP
  Variable Date ORDDAT
  Variable Char BPRNUM
  Variable Char BPRNAM
  Variable Char BPAADDLIG
  Variable Char CUR
  Variable Date DEMDLVDAT

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char SAU()
  Variable Decimal QTY()
  Variable Decimal GROPRI()
  Variable Decimal DISCRGVAL1()
  Variable Decimal DISCRGVAL2()
  Variable Decimal NETPRI()
  Variable Decimal YTOTALE()

  Call OUVRE_TRACE("AS_SOHSOH") From LECFIC
  Gosub INIT_FILE
  YACTION = "YASSOHSOH"
  YCURRFIELD = "SOHNUM"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS
  #business logic start


  #business logic end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC

End

###############################################################################################################################################################

Subprog C_SOHSOH(SOHNUM,FCY,SOHTYP,ORDDAT,BPRNUM,BPRNAM,BPAADDLIG,CUR,DEMDLVDAT,YAX3MRESP,YRESPONSE,ITMREF,SAU,QTY,GROPRI,DISCRGVAL1,DISCRGVAL2,NETPRI,YTOTALE)

  Variable Char SOHNUM
  Variable Char FCY
  Variable Char SOHTYP
  Variable Date ORDDAT
  Variable Char BPRNUM
  Variable Char BPRNAM
  Variable Char BPAADDLIG
  Variable Char CUR
  Variable Date DEMDLVDAT

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char SAU()
  Variable Decimal QTY()
  Variable Decimal GROPRI()
  Variable Decimal DISCRGVAL1()
  Variable Decimal DISCRGVAL2()
  Variable Decimal NETPRI()
  Variable Decimal YTOTALE()

  Call OUVRE_TRACE("C_SOHSOH") From LECFIC
  Gosub INIT_FILE
  YACTION = "YCSOHSOH"
  YCURRFIELD = "SOHNUM"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS
  #business logic start

  Local File SORDER [YSOH], SORDERP [YSOP], SORDERQ [YSOQ]
  Local Char CRITERE(100)

  Columns [F:YSOH](SOHNUM)
  Read [F:YSOH]SOH0 = SOHNUM
  If fstat > 0
    mkstat = 2
    YMESSAGE = "ATTENZIONE! Ordine di vendita non esistente!"
    Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
  Else
    #
    Local Integer K
    Raz FCY,SOHTYP,ORDDAT,BPRNUM,BPRNAM,BPAADDLIG,CUR,DEMDLVDAT
    For K = 0 To func YUTILS.COUNT(ITMREF) - 1
      Raz ITMREF(K),SAU(K),QTY(K),GROPRI(K),DISCRGVAL1(K),DISCRGVAL2(K),NETPRI(K),YTOTALE(K) #dettaglio
    Next
    #

    CRITERE = "[YSOH]SOHNUM = '" + SOHNUM + "'"
    Link [YSOQ] With [YSOH]SOH0~=[YSOQ]SOHNUM,
&                    [YSOP]SOP0~=[YSOQ]SOHNUM;[YSOQ]SOPLIN;[YSOQ]SOQSEQ
&               As [YLSOH]
&               Where evalue(CRITERE)
&               Order By Key KEYSOH = [YSOH]SOHNUM;[YSOQ]SOPLIN

    Local Integer I : I = 0
    Columns [YLSOH] ([YSOH]STOFCY, [YSOH]SOHTYP, [YSOH]ORDDAT, [YSOH]BPCORD, [YSOH]BPCNAM, [YSOH]BPCADDLIG, [YSOH]CUR, [YSOH]DEMDLVDAT,
&                    [YSOQ]ITMREF, [YSOQ]QTY, [YSOP]SAU, [YSOP]GROPRI, [YSOP]DISCRGVAL1, [YSOP]DISCRGVAL2, [YSOP]NETPRI )
    For [YLSOH]KEYSOH(1)
      FCY = [YSOH]STOFCY    : SOHTYP = [YSOH]SOHTYP    : ORDDAT = [YSOH]ORDDAT
      BPRNUM = [YSOH]BPCORD : BPRNAM = [YSOH]BPCNAM    : BPAADDLIG = [YSOH]BPCADDLIG
      CUR    = [YSOH]CUR    : DEMDLVDAT = [YSOH]DEMDLVDAT
      For [YLSOH]KEYSOH(2)
        ITMREF(I) = [YSOQ]ITMREF : SAU(I)        = [YSOP]SAU        : QTY(I)        = [YSOQ]QTY
        GROPRI(I) = [YSOP]GROPRI : DISCRGVAL1(I) = [YSOP]DISCRGVAL1 : DISCRGVAL2(I) = [YSOP]DISCRGVAL2
        NETPRI(I) = [YSOP]NETPRI : Call YCALC_NETTOT(QTY(I), GROPRI(I), DISCRGVAL1(I), DISCRGVAL2(I), NETPRI(I), YTOTALE(I))
        I += 1
      Next
    Next
    #DOCUMENTARE QUESTE VARIABILI NELLA MODALITA' MODIFICA!!!!!!!!!!!!!!!!!!!!!!!
    YMODIF = 1
    YMODIF_RIQUADRO_COUNT = I
    mkstat = 0
  Endif

  #business logic end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC

End

###############################################################################################################################################################

Subprog C_FCYSOH(SOHNUM,FCY,SOHTYP,ORDDAT,BPRNUM,BPRNAM,BPAADDLIG,CUR,DEMDLVDAT,YAX3MRESP,YRESPONSE,ITMREF,SAU,QTY,GROPRI,DISCRGVAL1,DISCRGVAL2,NETPRI,YTOTALE)

  Variable Char SOHNUM
  Variable Char FCY
  Variable Char SOHTYP
  Variable Date ORDDAT
  Variable Char BPRNUM
  Variable Char BPRNAM
  Variable Char BPAADDLIG
  Variable Char CUR
  Variable Date DEMDLVDAT

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char SAU()
  Variable Decimal QTY()
  Variable Decimal GROPRI()
  Variable Decimal DISCRGVAL1()
  Variable Decimal DISCRGVAL2()
  Variable Decimal NETPRI()
  Variable Decimal YTOTALE()

  Call OUVRE_TRACE("C_FCYSOH") From LECFIC
  Gosub INIT_FILE
  YACTION = "YCFCYSOH"
  YCURRFIELD = "FCY"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  ORDDAT = date$
  Call YAX3MOB_AFFZO(YCURRMSKALIAS,"ORDDAT") From YAX3MUTILS

  Local File FACILITY [F:YFCY]
  Read [F:YFCY]FCY0 = FCY

  If fstat
    mkstat = 2
    YMESSAGE = "ATTENZIONE! Sito inesistente!"
    Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
  Else
    mkstat = 0
    #YMESSAGE = [F:YFCY]FCYNAM    #In YMESSAGE metto Descrizione Sito inserito (valido)
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC

End

#######################################################################################################################################
# AZIONE-CAMPO : Controllo TIPO ORDINE(SOHTYP) su Anagrafica

Subprog C_SOHTSOH(SOHNUM,FCY,SOHTYP,ORDDAT,BPRNUM,BPRNAM,BPAADDLIG,CUR,DEMDLVDAT,YAX3MRESP,YRESPONSE,ITMREF,SAU,QTY,GROPRI,DISCRGVAL1,DISCRGVAL2,NETPRI,YTOTALE)

  Variable Char SOHNUM
  Variable Char FCY
  Variable Char SOHTYP
  Variable Date ORDDAT
  Variable Char BPRNUM
  Variable Char BPRNAM
  Variable Char BPAADDLIG
  Variable Char CUR
  Variable Date DEMDLVDAT

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char SAU()
  Variable Decimal QTY()
  Variable Decimal GROPRI()
  Variable Decimal DISCRGVAL1()
  Variable Decimal DISCRGVAL2()
  Variable Decimal NETPRI()
  Variable Decimal YTOTALE()

  Local File TABSOHTYP [F:YTSO]

  Call OUVRE_TRACE("C_SOHTSOH") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCSOHTSOH"
  YCURRFIELD = "SOHTYP"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #Business logic:Controllo anagrafica
  Columns [F:YTSO](SOHTYP)
  Read [F:YTSO]TSO0 = SOHTYP
  If fstat > 0
    mkstat = 2
    YMESSAGE = "ATTENZIONE! Tipo Ordine non in anagrafica!"
    Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
  Else
    mkstat = 0
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD_NOFOCUS From YAX3MUTILS
  Call FERME_TRACE From LECFIC

End

#############################################################################################

# AZIONE-CAMPO : Controllo su (AM_)-CLIENTE ORDINE(BPRNUM) su Anagrafica & valorizzazione BPRNAM,BPAADDLIG,CUR

Subprog AM_BPRSOH(SOHNUM,FCY,SOHTYP,ORDDAT,BPRNUM,BPRNAM,BPAADDLIG,CUR,DEMDLVDAT,YAX3MRESP,YRESPONSE,ITMREF,SAU,QTY,GROPRI,DISCRGVAL1,DISCRGVAL2,NETPRI,YTOTALE)

  Variable Char SOHNUM
  Variable Char FCY
  Variable Char SOHTYP
  Variable Date ORDDAT
  Variable Char BPRNUM
  Variable Char BPRNAM
  Variable Char BPAADDLIG
  Variable Char CUR
  Variable Date DEMDLVDAT

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char SAU()
  Variable Decimal QTY()
  Variable Decimal GROPRI()
  Variable Decimal DISCRGVAL1()
  Variable Decimal DISCRGVAL2()
  Variable Decimal NETPRI()
  Variable Decimal YTOTALE()

  Local Integer YBPATYP: YBPATYP =1   #impostato ad 1 (Terzi)
  Local File BPARTNER [F:YBPR]
  Local File BPADDRESS [F:YBPA]

  Call OUVRE_TRACE("AM_BPRSOH") From LECFIC

  Gosub INIT_FILE
  YACTION = "YAMBPRSOH"
  YCURRFIELD = "BPRNUM"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic: Controllo Anagrafica
  DEMDLVDAT = date$
  Call YAX3MOB_AFFZO(YCURRMSKALIAS,"DEMDLVDAT") From YAX3MUTILS

  Columns [F:YBPR](BPRNUM,BPRNAM,BPAADD,CUR)
  Read [F:YBPR]BPR0 = BPRNUM

  If (fstat>0)
    mkstat=2
    YMESSAGE = "ATTENZIONE! Cliente Ordine non in anagrafica!"
    Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
  Else
    mkstat=0
    #Valorizzo BPRNAM,BPAADDLIG,CUR
    BPRNAM = [F:YBPR]BPRNAM
    CUR = [F:YBPR]CUR

    Columns [F:YBPA](BPANUM,BPAADDLIG,BPATYP)
    Read [F:YBPA]BPA0 = YBPATYP;BPRNUM;[F:YBPR]BPAADD
    BPAADDLIG = [F:YBPA]BPAADDLIG

    Call YAX3MOB_AFFZO(YCURRMSKALIAS,"BPRNAM") From YAX3MUTILS
    Call YAX3MOB_AFFZO(YCURRMSKALIAS,"BPAADDLIG") From YAX3MUTILS
    Call YAX3MOB_AFFZO(YCURRMSKALIAS,"CUR") From YAX3MUTILS
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD_NOFOCUS From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

#################################################################################################
# AZIONE-CAMPO : Controllo su ARTICOLO(ITMREF) su Anagrafica & valorizzazione ITMDES,SAU
Subprog AM_ITRSOH(SOHNUM,FCY,SOHTYP,ORDDAT,BPRNUM,BPRNAM,BPAADDLIG,CUR,DEMDLVDAT,YAX3MRESP,YRESPONSE,ITMREF,SAU,QTY,GROPRI,DISCRGVAL1,DISCRGVAL2,NETPRI,YTOTALE)

  Variable Char SOHNUM
  Variable Char FCY
  Variable Char SOHTYP
  Variable Date ORDDAT
  Variable Char BPRNUM
  Variable Char BPRNAM
  Variable Char BPAADDLIG
  Variable Char CUR
  Variable Date DEMDLVDAT

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()()
  Variable Char SAU()()
  Variable Decimal QTY()
  Variable Decimal GROPRI()
  Variable Decimal DISCRGVAL1()
  Variable Decimal DISCRGVAL2()
  Variable Decimal NETPRI()
  Variable Decimal YTOTALE()

  Local File ITMFACILIT [F:YITF]
  Local File ITMMASTER [F:YITM]
  Local Char YITMREF(20)

  Call OUVRE_TRACE("AM_ITRSOH") From LECFIC

  Gosub INIT_FILE
  YACTION = "YAMITRSOH"
  YCURRFIELD = "ITMREF"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #Business logic: Controllo in anagrafica, poi cerco ITMDES1, SAU
  Call YSTRVALEUR(ITMREF,YITMREF,CURRENTROW) From YAX3MUTILS
  Read [F:YITF]ITF0 = YITMREF;FCY
  Columns [F:YITF](ITMREF)

  If(fstat=0)
    mkstat=0
    Columns [F:YITM](ITMDES1,SAU)
    Read [F:YITM]ITM0 = YITMREF
    #YITMDES1 = [F:YITM]ITMDES1
    SAU(CURRENTROW) = [F:YITM]SAU
    Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"SAU",CURRENTROW) From YAX3MUTILS
  Else
    mkstat=2
    YMESSAGE = "ATTENZIONE! Cod.Articolo non in anagrafica!"
    Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE,CURRENTROW) From YAX3MUTILS
  Endif

  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

#################################################################################################
# AZIONE-CAMPO : Controllo QTY ( diverso da 0), imposto a 0 : GROPRI, DISCRGVAL1 (Sconto1), DISCRGVAL2 (Sconto2), calcolo NETPRI , calcolo YTOTALE

Subprog C_QTYSOH(SOHNUM,FCY,SOHTYP,ORDDAT,BPRNUM,BPRNAM,BPAADDLIG,CUR,DEMDLVDAT,YAX3MRESP,YRESPONSE,ITMREF,SAU,QTY,GROPRI,DISCRGVAL1,DISCRGVAL2,NETPRI,YTOTALE)

  Variable Char SOHNUM
  Variable Char FCY
  Variable Char SOHTYP
  Variable Date ORDDAT
  Variable Char BPRNUM
  Variable Char BPRNAM
  Variable Char BPAADDLIG
  Variable Char CUR
  Variable Date DEMDLVDAT

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char SAU()
  Variable Decimal QTY()
  Variable Decimal GROPRI()
  Variable Decimal DISCRGVAL1()
  Variable Decimal DISCRGVAL2()
  Variable Decimal NETPRI()
  Variable Decimal YTOTALE()

  Local Decimal YQTY
  Call OUVRE_TRACE("C_QTYSOH") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCQTYSOH"
  YCURRFIELD = "QTY"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  Call YDECVALEUR(QTY,YQTY,CURRENTROW) From YAX3MUTILS
  If(YQTY = 0)
    mkstat=2
    YMESSAGE = "ATTENZIONE! Quantità inserita nulla!"
    Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE,CURRENTROW) From YAX3MUTILS
  Else
    mkstat =0
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

#################################################################################################
# AZIONE - CAMPO : Controllo GROPRI (diverso da 0), imposto a 0 : DISCRGVAL1 (Sconto1), DISCRGVAL2 (Sconto2), calcolo NETPRI , calcolo YTOTALE

Subprog C_GROPSOH(SOHNUM,FCY,SOHTYP,ORDDAT,BPRNUM,BPRNAM,BPAADDLIG,CUR,DEMDLVDAT,YAX3MRESP,YRESPONSE,ITMREF,SAU,QTY,GROPRI,DISCRGVAL1,DISCRGVAL2,NETPRI,YTOTALE)

  Variable Char SOHNUM
  Variable Char FCY
  Variable Char SOHTYP
  Variable Date ORDDAT
  Variable Char BPRNUM
  Variable Char BPRNAM
  Variable Char BPAADDLIG
  Variable Char CUR
  Variable Date DEMDLVDAT

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char SAU()
  Variable Decimal QTY()
  Variable Decimal GROPRI()
  Variable Decimal DISCRGVAL1()
  Variable Decimal DISCRGVAL2()
  Variable Decimal NETPRI()
  Variable Decimal YTOTALE()

  Local Decimal YGROPRI
  Call OUVRE_TRACE("C_GROPSOH") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCGROPSOH"
  YCURRFIELD = "GROPRI"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #Business logic
  Call YDECVALEUR(GROPRI,YGROPRI,CURRENTROW) From YAX3MUTILS
  NETPRI(CURRENTROW)=0
  YTOTALE(CURRENTROW)=0

  If(YGROPRI = 0)
    mkstat=2
    YMESSAGE = "ATTENZIONE! Prezzo Lordo nullo!"
    Call YAX3MOB_SHOWMESS_RIQUADRO(YFIELDS, YCURRFIELD, mkstat, YMESSAGE,CURRENTROW) From YAX3MUTILS
  Else
    mkstat=0
    Call YCALC_NETTOT(QTY(CURRENTROW),YGROPRI,DISCRGVAL1(CURRENTROW),DISCRGVAL2(CURRENTROW),NETPRI(CURRENTROW),YTOTALE(CURRENTROW))
  Endif

  Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"DISCRGVAL1",CURRENTROW) From YAX3MUTILS
  Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"DISCRGVAL2",CURRENTROW) From YAX3MUTILS
  Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"NETPRI",CURRENTROW) From YAX3MUTILS
  Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"YTOTALE",CURRENTROW) From YAX3MUTILS

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC

End

###############################################################################################
# AZIONE - CAMPO :  Azione Post SCONTO1, calcolo NETPRI , calcolo YTOTALE

Subprog AM_REM1SOH(SOHNUM,FCY,SOHTYP,ORDDAT,BPRNUM,BPRNAM,BPAADDLIG,CUR,DEMDLVDAT,YAX3MRESP,YRESPONSE,ITMREF,SAU,QTY,GROPRI,DISCRGVAL1,DISCRGVAL2,NETPRI,YTOTALE)

  Variable Char SOHNUM
  Variable Char FCY
  Variable Char SOHTYP
  Variable Date ORDDAT
  Variable Char BPRNUM
  Variable Char BPRNAM
  Variable Char BPAADDLIG
  Variable Char CUR
  Variable Date DEMDLVDAT

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char SAU()
  Variable Decimal QTY()
  Variable Decimal GROPRI()
  Variable Decimal DISCRGVAL1()
  Variable Decimal DISCRGVAL2()
  Variable Decimal NETPRI()
  Variable Decimal YTOTALE()

  Local Decimal YDISCRGVAL1
  Call OUVRE_TRACE("AM_REM1SOH1") From LECFIC

  Gosub INIT_FILE
  YACTION = "YAMREM1SOH"
  YCURRFIELD = "DISCRGVAL1"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  Call YDECVALEUR(DISCRGVAL1,YDISCRGVAL1,CURRENTROW) From YAX3MUTILS
  Call YCALC_NETTOT(QTY(CURRENTROW),GROPRI(CURRENTROW),YDISCRGVAL1,DISCRGVAL2(CURRENTROW),NETPRI(CURRENTROW),YTOTALE(CURRENTROW))
  Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"DISCRGVAL1",CURRENTROW) From YAX3MUTILS
  Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"DISCRGVAL2",CURRENTROW) From YAX3MUTILS
  Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"NETPRI",CURRENTROW) From YAX3MUTILS
  Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"YTOTALE",CURRENTROW) From YAX3MUTILS

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC

End

##############################################################################################################################
# AZIONE - CAMPO :  Azione Post SCONTO2, calcolo NETPRI , calcolo YTOTALE

Subprog AM_REM2SOH(SOHNUM,FCY,SOHTYP,ORDDAT,BPRNUM,BPRNAM,BPAADDLIG,CUR,DEMDLVDAT,YAX3MRESP,YRESPONSE,ITMREF,SAU,QTY,GROPRI,DISCRGVAL1,DISCRGVAL2,NETPRI,YTOTALE)

  Variable Char SOHNUM
  Variable Char FCY
  Variable Char SOHTYP
  Variable Date ORDDAT
  Variable Char BPRNUM
  Variable Char BPRNAM
  Variable Char BPAADDLIG
  Variable Char CUR
  Variable Date DEMDLVDAT

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()
  Variable Char SAU()
  Variable Decimal QTY()
  Variable Decimal GROPRI()
  Variable Decimal DISCRGVAL1()
  Variable Decimal DISCRGVAL2()
  Variable Decimal NETPRI()
  Variable Decimal YTOTALE()

  Local Decimal YDISCRGVAL2
  Call OUVRE_TRACE("AM_REM2SOH") From LECFIC

  Gosub INIT_FILE
  YACTION = "YAMREM2SOH"
  YCURRFIELD = "DISCRGVAL2"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS
  #business logic
  Call YDECVALEUR(DISCRGVAL2,YDISCRGVAL2,CURRENTROW) From YAX3MUTILS
  Call YCALC_NETTOT(QTY(CURRENTROW),GROPRI(CURRENTROW),DISCRGVAL1(CURRENTROW),YDISCRGVAL2,NETPRI(CURRENTROW),YTOTALE(CURRENTROW))
  Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"NETPRI",CURRENTROW) From YAX3MUTILS
  Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"YTOTALE",CURRENTROW) From YAX3MUTILS

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

##################################################################################################################
#                                                         Utilità
###################################################################################################################
#qui usare subroutine come  in TRTPRICE
#TODO: GUARDA Calcolo Prezzo netto da Ordini di Vendita standard X3

###############################################################################

Subprog YCALC_NETTOT(YQTY, YGROPRI, YDISCOUNT1, YDISCOUNT2, YNETPRI, YTOTALE)

  Value Decimal YQTY
  Value Decimal YGROPRI
  Value Decimal YDISCOUNT1
  Value Decimal YDISCOUNT2
  Variable Decimal YNETPRI
  Variable Decimal YTOTALE

  YNETPRI = YGROPRI - (YGROPRI * YDISCOUNT1) / 100 - (YGROPRI * YDISCOUNT2) / 100
  YTOTALE = YQTY*YNETPRI
End

####################################################################################################################
#                                           BOTTONE FINESTRA
####################################################################################################################

Subprog YCREA_SOH(SOHNUM,FCY,SOHTYP,ORDDAT,BPRNUM,BPRNAM,BPAADDLIG,CUR,DEMDLVDAT,YAX3MRESP,YRESPONSE,ITMREF,SAU,QTY,GROPRI,DISCRGVAL1,DISCRGVAL2,NETPRI,YTOTALE)

  Variable Char SOHNUM
  Variable Char FCY
  Variable Char SOHTYP
  Variable Date ORDDAT
  Variable Char BPRNUM
  Variable Char BPRNAM
  Variable Char BPAADDLIG
  Variable Char CUR
  Variable Date DEMDLVDAT

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char ITMREF()()
  Variable Char SAU()()
  Variable Decimal QTY()
  Variable Decimal GROPRI()
  Variable Decimal DISCRGVAL1()
  Variable Decimal DISCRGVAL2()
  Variable Decimal NETPRI()
  Variable Decimal YTOTALE()

  Local Integer K, YSUCCESS : YSUCCESS = 0

  Call OUVRE_TRACE("YCREA_SOH") From LECFIC
  Gosub INIT_FILE
  YACTION = "YCREASOH"
  YCURRFIELD = ""

  #init
  Gosub YAX3MOB_INIT_BUTTONACTION From YAX3MUTILS
  #YFUNC_NAME = "YSOH" : YFUNC_TYPE = "DOC" : YIMP_CODE="YSOHAX3M" : YMEX_DOCTYPE = "Ordine di Vendita"
  YFUNC_NAME = "YSOH" : YFUNC_TYPE = "DOC" : YIMP_CODE="YSOHAX3M1" : YMEX_DOCTYPE = "Ordine di Vendita1"

  #business logic
  #Gosub YFILL_YSOHCSV

  Gosub YGET_MISSINGFLDS
  Gosub YFILL_YSOHCSV1

  Call YPRINT_CLB(YCSVTEXT,YFUNC_NAME, "csv") From YUTILS  #stampo csv(opzionale)
  #Check correttezza codice Modello import impostato?

  #Inizio CREAZ DOCUMENTO
  If dim(GYVCRSOH)<0
    Global Char GYVCRSOH(20)
  Endif
  Raz GYVCRSOH

  Call YAX3MOB_IMPORTSIL(YIMP_CODE, YCSVTEXT, YSUCCESS, YMESSAGE) From YAX3MUTILS  #lancio modello di import

  If SOHNUM <> AVOID.ACHAR
     If vireblc(YMESSAGE, 2) = AVOID.ACHAR #significa che la get trace non ha rilevato errori
      YMESSAGE = "Ordine" - GYVCRSOH - "aggiornato correttamente!"
     Else
      YSUCCESS = 1
     Endif
  Else
    If(vireblc(GYVCRSOH,2) = AVOID.ACHAR)
      YMESSAGE = func YUTILS.IIF(YMESSAGE = AVOID.ACHAR, "Creazione/modifica ordine di vendita fallita! Impossibile proseguire!", YMESSAGE)
      YSUCCESS = 1
    Else
      YMESSAGE = "Ordine" - GYVCRSOH - "creato correttamente!"
    Endif
  Endif
  YALERT_MESSAGE -= YMESSAGE

  If dim(GYVCRSOH)>0
   Kill GYVCRSOH
  Endif

   If YSUCCESS = 1
    Call YAX3MOB_SHOWALERT(2, YALERT_TYPE, YALERT_MESSAGE) From YAX3MUTILS
  Else
    Raz FCY,SOHTYP,ORDDAT,BPRNUM,BPRNAM,BPAADDLIG,CUR,DEMDLVDAT
    For K = 0 To func YUTILS.COUNT(ITMREF) - 1
      Raz ITMREF(K),SAU(K),QTY(K),GROPRI(K),DISCRGVAL1(K),DISCRGVAL2(K),NETPRI(K),YTOTALE(K) #dettaglio
    Next

    Call YAX3MOB_SHOWALERT(1, YALERT_TYPE, YALERT_MESSAGE) From YAX3MUTILS
  Endif

  #end
  Gosub YAX3MOB_END_BUTTONACTION From YAX3MUTILS
  Call FERME_TRACE From LECFIC

End

#####################################################################################

$YGET_MISSINGFLDS

  Local Char YBPCINV(15),YBPCPYR(15),YPTE(15),YBPAADD(5),YVACITM(5)
  Local File BPCUSTOMER [F:YBPC]
  Local File ITMMASTER [F:YITM]

  Read [F:YBPC]BPC0 = BPRNUM
  If! fstat
    YBPCINV = [F:YBPC]BPCINV
    YPTE = [F:YBPC]PTE
    YBPCPYR = [F:YBPC]BPCPYR
    YBPAADD = [F:YBPC]BPAADD
  Endif

Call ECR_TRACE("bpcinv-pte:" -YBPCINV-"-"-YPTE,0) From GESECRAN

Return

#####################################################################################
#**
#* Riempimento contenuto file csv per Modllo Import ODV- Modello Import: YSOHAX3M
#*!

$YFILL_YSOHCSV

  #Creazione csv (QUI creo un documento)
  Call YAX3MOB_APPEND(YCSVTEXT, "E", 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, FCY, 0) From YAX3MUTILS                             #salfcy =fcy
  Call YAX3MOB_APPEND(YCSVTEXT, SOHTYP, 0) From YAX3MUTILS                          #sohtyp
  Call YAX3MOB_APPEND(YCSVTEXT, SOHNUM, 0) From YAX3MUTILS                          #sohnum
  Call YAX3MOB_APPEND(YCSVTEXT, BPRNUM, 0) From YAX3MUTILS                          #bpcord
  Call YAX3MOB_APPEND(YCSVTEXT, format$("D:YYYYMMDD",ORDDAT), 0) From YAX3MUTILS    #orddat
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS                     #cusordref
  Call YAX3MOB_APPEND(YCSVTEXT, FCY, 0) From YAX3MUTILS                             #stofcy = fcy
  Call YAX3MOB_APPEND(YCSVTEXT, CUR, 0) From YAX3MUTILS                             #cur
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 1) From YAX3MUTILS                     #pjt

  Local Integer I,J : I = 0 : J = 0
  For I=0 To func YUTILS.COUNT(ITMREF) - 1

    Call YAX3MOB_APPEND(YCSVTEXT, "L", 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, ITMREF(I), 0) From YAX3MUTILS                     #itmref
    Call YAX3MOB_APPEND(YCSVTEXT, func AFNC.TEXTRA('ITMMASTER','DES1AXX',ITMREF(I),''), 0) From YAX3MUTILS  #ITMDES1
    Call YAX3MOB_APPEND(YCSVTEXT, SAU(I), 0) From YAX3MUTILS                        #sau
    Call YAX3MOB_APPEND(YCSVTEXT, num$(QTY(I)), 0) From YAX3MUTILS                  #qty
    Call YAX3MOB_APPEND(YCSVTEXT, num$(GROPRI(I)), 0) From YAX3MUTILS               #gropri
    Call YAX3MOB_APPEND(YCSVTEXT, num$(DISCRGVAL1(I)), 0) From YAX3MUTILS           #discrgval1
    Call YAX3MOB_APPEND(YCSVTEXT, num$(DISCRGVAL2(I)), 1) From YAX3MUTILS           #discrgval2
  Next

Return

###################################################################################
#RIEMPIMENTO CONTENUTO File CSV PER MODLLO IMPORT ODV- MODELLO IMPORT: YSOHAX3M1
$YFILL_YSOHCSV1

  #Creazione csv (QUI creo un documento)
  Call YAX3MOB_APPEND(YCSVTEXT, "E", 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, FCY, 0) From YAX3MUTILS                             #salfcy =fcy
  Call YAX3MOB_APPEND(YCSVTEXT, SOHTYP, 0) From YAX3MUTILS                          #sohtyp
  Call YAX3MOB_APPEND(YCSVTEXT, SOHNUM, 0) From YAX3MUTILS                          #sohnum
  Call YAX3MOB_APPEND(YCSVTEXT, BPRNUM, 0) From YAX3MUTILS                          #bpcord
  Call YAX3MOB_APPEND(YCSVTEXT, format$("D:YYYYMMDD",ORDDAT), 0) From YAX3MUTILS    #orddat
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS                     #cusordref
  Call YAX3MOB_APPEND(YCSVTEXT, FCY, 0) From YAX3MUTILS                             #stofcy = fcy
  Call YAX3MOB_APPEND(YCSVTEXT, CUR, 0) From YAX3MUTILS                             #cur
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS                     #pjt

  Call YAX3MOB_APPEND(YCSVTEXT, YBPCINV, 0) From YAX3MUTILS                         #bpcinv
  Call YAX3MOB_APPEND(YCSVTEXT, format$("D:YYYYMMDD",DEMDLVDAT), 0) From YAX3MUTILS #demdlvdat
  Call YAX3MOB_APPEND(YCSVTEXT, YPTE, 0) From YAX3MUTILS                            #pte
  Call YAX3MOB_APPEND(YCSVTEXT, YBPCPYR, 0) From YAX3MUTILS                         #bpcpyr
  Call YAX3MOB_APPEND(YCSVTEXT, YBPAADD, 1) From YAX3MUTILS                         #bpaadd

  Local Integer I,J : I = 0 : J = 0
  For I=0 To func YUTILS.COUNT(ITMREF) - 1

    Columns [F:YITM](ITMREF,VACITM)
    Read [F:YITM]ITM0 = ITMREF(I)
    YVACITM=[F:YITM]VACITM

    Call YAX3MOB_APPEND(YCSVTEXT, "L", 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, ITMREF(I), 0) From YAX3MUTILS                     #itmref
    Call YAX3MOB_APPEND(YCSVTEXT, func AFNC.TEXTRA('ITMMASTER','DES1AXX',ITMREF(I),''), 0) From YAX3MUTILS  #ITMDES1
    Call YAX3MOB_APPEND(YCSVTEXT, SAU(I), 0) From YAX3MUTILS                        #sau
    Call YAX3MOB_APPEND(YCSVTEXT, num$(QTY(I)), 0) From YAX3MUTILS                  #qty
    Call YAX3MOB_APPEND(YCSVTEXT, num$(GROPRI(I)), 0) From YAX3MUTILS               #gropri
    Call YAX3MOB_APPEND(YCSVTEXT, num$(DISCRGVAL1(I)), 0) From YAX3MUTILS           #discrgval1
    Call YAX3MOB_APPEND(YCSVTEXT, num$(DISCRGVAL2(I)), 0) From YAX3MUTILS           #discrgval2

    Call YAX3MOB_APPEND(YCSVTEXT, YVACITM, 1) From YAX3MUTILS                       #vacitm
  Next

Return

####################################################################################

$YIMPSOH_CSV

  Local Char YBPCINV(15),YPTE(15),YCUSORDREF(20),YPJT(20)

  #Creazione csv (QUI creo un documento)
  Call YAX3MOB_APPEND(YCSVTEXT, "E", 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, FCY, 0) From YAX3MUTILS  #salfcy =fcy
  Call YAX3MOB_APPEND(YCSVTEXT, SOHTYP, 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, AVOID.ACHAR, 0) From YAX3MUTILS
  Call YAX3MOB_APPEND(YCSVTEXT, BPRNUM, 0) From YAX3MUTILS #bpcord

  Call YAX3MOB_APPEND(YCSVTEXT, YBPCINV, 0) From YAX3MUTILS    #bpcinv
  Call YAX3MOB_APPEND(YCSVTEXT, format$("D:YYYYMMDD",ORDDAT), 0) From YAX3MUTILS   #demdlvdat

  Call YAX3MOB_APPEND(YCSVTEXT, YPTE, 0) From YAX3MUTILS    #pte

  Call YAX3MOB_APPEND(YCSVTEXT, YCUSORDRREF, 0) From YAX3MUTILS  #cusordref
  Call YAX3MOB_APPEND(YCSVTEXT, FCY, 0) From YAX3MUTILS    #stofcy = fcy
  Call YAX3MOB_APPEND(YCSVTEXT, CUR, 0) From YAX3MUTILS    #cur
  Call YAX3MOB_APPEND(YCSVTEXT, YPJT, 1) From YAX3MUTILS #pjt

  Local Integer I,J : I = 0 : J = 0

  For I=0 To func YUTILS.COUNT(ITMREF) - 1
    Call YAX3MOB_APPEND(YCSVTEXT, "L", 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, ITMREF(I), 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, func AFNC.TEXTRA('ITMMASTER','DES1AXX',ITMREF(I),''), 0) From YAX3MUTILS  #ITMDES1
    Call YAX3MOB_APPEND(YCSVTEXT, SAU(I), 0) From YAX3MUTILS
    Call YAX3MOB_APPEND(YCSVTEXT, num$(QTY(I)), 0) From YAX3MUTILS
  Next

Return
**********
7,"TRT","YSOH",""
2,"TRT","YVBPC",""
#<AdxTL>@(#)0.0.0.0 $Revision$

$ACTION

#If GUSER='ADMIN' : Infbox(ACTION) : Endif

  Case ACTION
    When "OUVRE"         : Gosub OUVRE
    When "DEBUT"         : Gosub DEBUT
    When "FIN"           : Gosub FIN
    When Default
  Endcase
Return

###########################################################

$OUVRE

Return

###########################################################

$DEBUT
  Call OUVRE_TRACE ("YAX3M - YVBPC - Cerca Cliente - " - num$(date$)) From LECFIC
  Call ECR_TRACE("# -- Cerca Cliente --- ",0) From GESECRAN
Return

###########################################################

$FIN
  Call FERME_TRACE From LECFIC
Return

#######################################################################################################################
#**
#* Inizializzazione - NOTA: Se la finestra è composta da più  maschere, aggiungere YCURRMSK1, YCURRMSKALIAS1,...
#*!

$INIT_FILE

  Local Char YWINNAME(20): YWINNAME = "YVBPC"
  Local Char YCURRMSK(20): YCURRMSK = "YVBPC"           #NOTA: Se la finestra è composta da più  maschere: Local Char YCURRMSK1(20): YCURRMSK1 = "<Nome>"
  Local Char YCURRMSKALIAS(20): YCURRMSKALIAS= "YVBPC"  #NOTA: Se la finestra è composta da più  maschere: Local Char YCURRMSKALIAS1(20): YCURRMSKALIAS1 = "<NomeAlias>"
  Local Char YACTION(20)
  Local Char YCURRFIELD(20)
Return

########################################################################################################################
################################################ SUBPROG /FUNPROG ######################################################
########################################################################################################################

#=============================================== AZIONI-CAMPO ==========================================================
#BPCNUM: C,AM, SEL_OBJ (BPR)

Subprog AS_BPNVBPC(BPCNUM,BPRNAM,EECNUM,BPAADD,YAX3MRESP,YRESPONSE,YBPCNUM,YBPRNAM,BPAADDLIG,CRY,POSCOD,CTY,TEL,WEB,FCYWEB)

  Variable Char BPCNUM
  Variable Char BPRNAM
  Variable Char EECNUM
  Variable Char BPAADD

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char YBPCNUM()
  Variable Char YBPRNAM()
  Variable Char BPAADDLIG()
  Variable Char CRY()
  Variable Char POSCOD()
  Variable Char CTY()
  Variable Char TEL()
  Variable Char WEB()
  Variable Char FCYWEB()

  Call OUVRE_TRACE("AS_BPNVBPC") From LECFIC

  Gosub INIT_FILE
  YACTION = "YASBPNVBPC"
  YCURRFIELD = "BPRNAM"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #end
  Gosub YAX3MOB_END_ACTIONFIELD_NOFOCUS From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

Subprog C_BPCVBPC(BPCNUM, BPRNAM,EECNUM,BPAADD,YAX3MRESP,YRESPONSE,YBPCNUM,YBPRNAM,BPAADDLIG,CRY,POSCOD,CTY,TEL,WEB,FCYWEB)

  Variable Char BPCNUM
  Variable Char BPRNAM
  Variable Char EECNUM
  Variable Char BPAADD

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char YBPCNUM()
  Variable Char YBPRNAM()
  Variable Char BPAADDLIG()
  Variable Char CRY()
  Variable Char POSCOD()
  Variable Char CTY()
  Variable Char TEL()
  Variable Char WEB()
  Variable Char FCYWEB()

  Call OUVRE_TRACE("C_BPCVBPC") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCBPCVBPC"
  YCURRFIELD = "BPCNUM"
  Local File BPCUSTOMER [F:YBPC]

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic: Controllo Anagrafica
  If(vireblc(BPCNUM,2)<> AVOID.ACHAR)

    Columns [F:YBPC](BPCNUM,BPCNAM)
    Read [F:YBPC]BPC0 = toupper(BPCNUM)

    If(fstat>0)
      mkstat=2
      YMESSAGE = "ATTENZIONE! Cliente non in anagrafica!"
      Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
    Else
      mkstat=0
      BPRNAM = [F:YBPC]BPCNAM
      Call YAX3MOB_AFFZO(YCURRMSKALIAS,"BPRNAM") From YAX3MUTILS
    Endif
  Else
    mkstat=0
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

######################################################################################
#BPAADD: C, SEL_custom

Subprog C_BPDDVBPC(BPCNUM, BPRNAM,EECNUM,BPAADD,YAX3MRESP,YRESPONSE,YBPCNUM,YBPRNAM,BPAADDLIG,CRY,POSCOD,CTY,TEL,WEB,FCYWEB)

  Variable Char BPCNUM
  Variable Char BPRNAM
  Variable Char EECNUM
  Variable Char BPAADD

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char YBPCNUM()
  Variable Char YBPRNAM()
  Variable Char BPAADDLIG()
  Variable Char CRY()
  Variable Char POSCOD()
  Variable Char CTY()
  Variable Char TEL()
  Variable Char WEB()
  Variable Char FCYWEB()

  Call OUVRE_TRACE("C_BPDDVBPC") From LECFIC

  Gosub INIT_FILE
  YACTION = "YCBPDDVBPC"
  YCURRFIELD = "BPAADD"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic: query su tabella diversa
  Local File ATEXTRA [LNK]
  #prendo lo stesso dataset della SEL
  Gosub SET_LINK_YBPC From YAX3MSELBPAADDLNK
  Filter [LNK] Where [LNK]IDENT2 = toupper(BPAADD)

  If(rowcount([LNK])=0)
    mkstat = 2
    YMESSAGE = "ATTENZIONE! Tipologia Indirizzo inesistente!"
    Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
  Else
    mkstat = 0
    #YMESSAGE = [F:YBCG]BCGDES    #In YMESSAGE metto Descrizione Categoria inserito (valido)?
  Endif
  Filter [LNK]

  #end
  Gosub YAX3MOB_END_ACTIONFIELD_NOFOCUS From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

#############################################################################################
#BOTTONE DI FINESTRA
#############################################################################################

Subprog YCRC_VBPC(YLAYOUT,BPCNUM,BPRNAM,EECNUM,BPAADD,YAX3MRESP,YRESPONSE,YBPCNUM,YBPRNAM,BPAADDLIG,CRY,POSCOD,CTY,TEL,WEB,FCYWEB)

  Value Integer YLAYOUT
  Variable Char BPCNUM
  Variable Char BPRNAM
  Variable Char EECNUM
  Variable Char BPAADD

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char YBPCNUM()
  Variable Char YBPRNAM()
  Variable Char BPAADDLIG()
  Variable Char CRY()
  Variable Char POSCOD()
  Variable Char CTY()
  Variable Char TEL()
  Variable Char WEB()
  Variable Char FCYWEB()

  Local Integer K,YI,YSUCCESS : YSUCCESS = 0 : YI = 0

  #Gestione Multimedia
  Local Integer YMMEDIANUM: YMMMEDIANUM = 4 # N° azioni multimediali previste per ogni record
  Local Char YMMACTIONS(250)(YMMMEDIANUM,2)
  #Local Clbfile YMEDIA(1)(0..)
  Local Char YMEDIA(250)(0..)      # array payload per ogni item

  #apertura traccia
  Call OUVRE_TRACE("YCRC_VBPC") From LECFIC
  Gosub INIT_FILE
  YACTION = "YCRCVBPC"
  YCURRFIELD = ""

  #init: #parametrizzazioni iniziali :
  Gosub YAX3MOB_INIT_BUTTONACTION From YAX3MUTILS
  YFUNC_NAME = "YVBPC" : YFUNC_TYPE = "CONS": YMSKALIAS = "YVBPC" : NUM_COLS=9 #num campi riquadro (per AX3M) (Gestione automatica?)

  #business logic
  #Tables + Critere + Link[LNK]
  Gosub OPEN_FILES
  Gosub SET_CRITERE
  Gosub SET_LINK

  #Filter LINK + rowcount
  Filter [LNK] Where evalue(CRITERE) Order By [F:YBPC]BPCNUM;[F:YBPC]BPCNAM
  COUNT_VALUES = rowcount([LNK])   #n° record trovati ( = N° righe riquadro)
  #Popolamento
  #Call YAX3MOB_UPDATE_NBLIG(YCURRMSKALIAS,"NBLIG",COUNT_VALUES) From YAX3MUTILS

#Infbox num$(COUNT_VALUES)

  If(COUNT_VALUES = 0)
    YSUCCESS = 1
    mkstat = 2
  Else
    YSUCCESS = 0

    For [LNK]
      YBPCNUM(YI)= [F:YBPC]BPCNUM
#Infbox "1"-num$(YI)-YBPCNUM(YI)
      YBPRNAM(YI)= [F:YBPC]BPCNAM
      BPAADDLIG(YI)= [F:YBPA]BPAADDLIG
      CRY(YI) = [F:YBPA]CRY
      POSCOD(YI) = [F:YBPA]POSCOD
      CTY(YI) = [F:YBPA]CTY
      TEL(YI)=[F:YBPA]TEL
      #old [F:YBPA]WEB
      WEB(YI)= [F:YBPA]WEB
      FCYWEB(YI)= [F:YBPA]FCYWEB

#Infbox [F:YBPC]BPCNUM - [F:YBPC]BPCNAM
      YMEDIA(YI) = func YGETMEDIA(YMMACTIONS,BPAADDLIG(YI),CTY(YI),CRY(YI),TEL(YI),WEB(YI), func YUTILS.STR_IIF(vireblc(FCYWEB(YI),2)= AVOID.ACHAR, AVOID.ACHAR, func YUTILS.FIXURL(FCYWEB(YI))))

      Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"YBPCNUM",YI) From YAX3MUTILS
      Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"YBPRNAM",YI) From YAX3MUTILS
      Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"BPAADDLIG",YI) From YAX3MUTILS
      Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"CRY",YI) From YAX3MUTILS
      Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"POSCOD",YI) From YAX3MUTILS
      Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"CTY",YI) From YAX3MUTILS
      Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"TEL",YI) From YAX3MUTILS
      Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"WEB",YI) From YAX3MUTILS
      Call YAX3MOB_AFFZO_RIQUADRO(YMSKALIAS,"FCYWEB",YI) From YAX3MUTILS

      YI+=1
    Next
  Endif

#Infbox YBPCNUM(1) - YBPRNAM(1)- BPAADDLIG(1)- CRY(1)
  #POPOLAMENTO
  Call YAX3MOB_UPDATE_NBLIG(YCURRMSKALIAS,"NBLIG",COUNT_VALUES) From YAX3MUTILS
  NUM_COLS +=1
  Gosub YAX3MOB_END_BUTTONACTION From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

###################################################################################################

Subprog YCLEARVBPC(BPCNUM,BPRNAM,EECNUM,BPAADD,YAX3MRESP,YRESPONSE,YBPCNUM,YBPRNAM,BPAADDLIG,CRY,POSCOD,CTY,TEL,WEB,FCYWEB)

  Variable Char BPCNUM
  Variable Char BPRNAM
  Variable Char EECNUM
  Variable Char BPAADD

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char YBPCNUM()
  Variable Char YBPRNAM()
  Variable Char BPAADDLIG()
  Variable Char CRY()
  Variable Char POSCOD()
  Variable Char CTY()
  Variable Char TEL()
  Variable Char WEB()
  Variable Char FCYWEB()

  Call OUVRE_TRACE("YCLEARVBPC") From LECFIC
  Gosub INIT_FILE
  YACTION = "YCLEARVBPC"
  YCURRFIELD = ""

  #init
  Gosub YAX3MOB_INIT_BUTTONACTION From YAX3MUTILS

  #business logic
  Raz BPCNUM,BPRNAM,EECNUM,BPAADD
  For K = 0 To func YUTILS.COUNT(YBPCNUM) - 1
    Raz YBPCNUM(K),YBPRNAM(K),BPAADDLIG(K),CRY(K),POSCOD(K),CTY(K),TEL(K),WEB(K) #dettaglio
  Next

  #end
  Gosub YAX3MOB_END_BUTTONACTION From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

#################################################################################################
#################################################################################################
#**
#* Apertura TABELLE PER link (contestuale)
#*!

$OPEN_FILES

  Local File BPCUSTOMER [F:YBPC]
  Local File BPARTNER [F:YBPR]
  Local File BPADDRESS [F:YBPA]
Return

#################################################################################################
#**
#* LINK per consultazione (contestuale)
#*!

$SET_LINK

  Link [YBPA] With [YBPC]BPC0~=[YBPA]BPANUM,
&                  [YBPR]BPR0~=[YBPC]BPCNUM
&             As [LNK]
   Columns [LNK] ([F:YBPC]BPCNUM,[F:YBPC]BPCNAM,[F:YBPR]EECNUM,[F:YBPA]BPAADD,[F:YBPA]BPAADDLIG,[F:YBPA]CRY,[F:YBPA]POSCOD,
&                 [F:YBPA]CTY,[F:YBPA]TEL,[F:YBPA]WEB,[F:YBPA]FCYWEB)

Return

############################################################################################
#**
#* CRITERE per consultazione (contestuale)
#*!

$SET_CRITERE

  Local Char YTRIVCOND(10): YTRIVCOND = "1=1"
  CRITERE(0) = YTRIVCOND                # "1=1"
  CRITERE(1) = chr$(32)+"&"+YTRIVCOND   #" & 1=1"

  If(vireblc(func YAX3MOB_SWFLDVAL(YFIELDS,BPCNUM,"BPCNUM"),2) <> AVOID.ACHAR)
    #CRITERE(0)-="& instr(1, tolower([F:YBPC]BPCNUM), tolower('" + func YAX3MOB_SWFLDVAL(YFIELDS,BPCNUM,"BPCNUM") + "'))<>0"
    CRITERE(0)-="& instr(1, tolower([F:YBPC]BPCNUM), tolower('" + BPCNUM + "'))<>0"
  Endif

  If(vireblc(func YAX3MOB_SWFLDVAL(YFIELDS,BPRNAM,"BPRNAM"),2) <> AVOID.ACHAR)
    #CRITERE(0)-="& instr(1, tolower([F:YBPC]BPCNAM), tolower('" + func YAX3MOB_SWFLDVAL(YFIELDS,BPRNAM,"BPRNAM") + "'))<>0"
    CRITERE(0)-="& instr(1, tolower([F:YBPC]BPCNAM), tolower('" + BPRNAM + "'))<>0"
  Endif

  If(vireblc(func YAX3MOB_SWFLDVAL(YFIELDS,EECNUM,"EECNUM"),2) <> AVOID.ACHAR)
    #CRITERE(1)-="& instr(1, tolower([F:YBPR]EECNUM), tolower('" + func YAX3MOB_SWFLDVAL(YFIELDS,EECNUM,"EECNUM") + "'))<>0"
    CRITERE(1)-="& instr(1, tolower([F:YBPR]EECNUM), tolower('" + EECNUM + "'))<>0"
  Endif

  If(vireblc(func YAX3MOB_SWFLDVAL(YFIELDS,BPAADD,"BPAADD"),2) <> AVOID.ACHAR)
    #CRITERE(1)-="& [F:YBPA]BPAADD = '" + toupper(func YAX3MOB_SWFLDVAL(YFIELDS,BPAADD,"BPAADD")) + "'"
    CRITERE(1)-="& [F:YBPA]BPAADD = '" + BPAADD + "'"
  Endif

Return

##############################################################

Funprog YAX3MOB_SWFLDVAL(YFIELDS,YPARAM,YFIELDCODE)

  Variable Char YFIELDS()(,)
  Value Char YPARAM
  Value Char YFIELDCODE
  Local Char YVALUE(250)
  Const Integer YCOL_VALUE : YCOL_VALUE = 2

  If(![V]GWEBSERV)
    YVALUE = YPARAM
  Else
    Local Integer YI : YI = func YUTILS.FIND_ITEM(YFIELDS,YFIELDCODE)
    YVALUE = YFIELDS(YI,YCOL_VALUE)
  Endif

End YVALUE

##################################################################################################################
#                         SOLO AX3M
##################################################################################################################

#$SET_AX3M_TIT_COL
#
#  Call TEXTFIC("BPCUSTOMER","BPCNUM",2,TIT(NBCOL)) From OBJDIV
#  COL(NBCOL) = "[F:YBPC]BPCNUM"
#  NBCOL += 1 : Call TEXTFIC("BPCUSTOMER","BPCNAM",2,TIT(NBCOL)) From OBJDIV
#  COL(NBCOL) = "[F:YBPC]BPCNAM"
#  NBCOL += 1 : Call TEXTFIC("BPADDRESS","BPAADDLIG",2,TIT(NBCOL)) From OBJDIV
#  COL(NBCOL) = "[F:YBPA]BPAADDLIG"
#  NBCOL += 1 : Call TEXTFIC("BPADDRESS","CRY",2,TIT(NBCOL)) From OBJDIV
#  COL(NBCOL) = "[F:YBPA]CRY"
#  NBCOL += 1 : Call TEXTFIC("BPADDRESS","POSCOD",2,TIT(NBCOL)) From OBJDIV
#  COL(NBCOL) = "[F:YBPA]POSCOD"
#  NBCOL += 1 : Call TEXTFIC("BPADDRESS","CTY",2,TIT(NBCOL)) From OBJDIV
#  COL(NBCOL) = "[F:YBPA]CTY"
#  NBCOL += 1 : Call TEXTFIC("BPADDRESS","TEL",2,TIT(NBCOL)) From OBJDIV
#  COL(NBCOL) = "[F:YBPA]TEL"
#  NBCOL += 1 : Call TEXTFIC("AUTILIS","ADDEML",2,TIT(NBCOL)) From OBJDIV
#  COL(NBCOL) = "[F:YBPA]WEB"
#  NBCOL += 1 : Call TEXTFIC("BPADDRESS","FCYWEB",2,TIT(NBCOL)) From OBJDIV
#  COL(NBCOL) = "[F:YBPA]FCYWEB"
#
#Return

#-------------------------------------------------------------------------------------------------------

$SET_AX3M_TIT_COL

  Call TEXTFIC("BPCUSTOMER","BPCNUM",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YBPC]BPCNUM"
  NBCOL += 1 : Call TEXTFIC("BPCUSTOMER","BPCNAM",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YBPC]BPCNAM"
  NBCOL += 1 : Call TEXTFIC("BPADDRESS","BPAADDLIG",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YBPA]BPAADDLIG"
  NBCOL += 1 : Call TEXTFIC("BPADDRESS","CRY",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YBPA]CRY"
  NBCOL += 1 : Call TEXTFIC("BPADDRESS","POSCOD",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YBPA]POSCOD"
  NBCOL += 1 : Call TEXTFIC("BPADDRESS","CTY",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YBPA]CTY"
  NBCOL += 1 : Call TEXTFIC("BPADDRESS","TEL",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YBPA]TEL"
  NBCOL += 1 : Call TEXTFIC("AUTILIS","ADDEML",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YBPA]WEB"
  NBCOL += 1 : Call TEXTFIC("BPADDRESS","FCYWEB",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YBPA]FCYWEB"

  NBCOL += 1 : TIT(NBCOL)= "Azioni Multimediali"
  COL(NBCOL) = AVOID.ACHAR

Return

###################################################################################################################

#$SET_AX3M_FIELDS
#
#  FIELDS(0) = "YBPCNUM" : FIELDS(1) = "YBPRNAM" : FIELDS(2) = "BPAADDLIG"
#  FIELDS(3) = "CRY" : FIELDS(4) = "POSCOD" : FIELDS(5) = "CTY"
#  FIELDS(6) = "TEL" : FIELDS(7) = "WEB" : FIELDS(8) = "FCYWEB"
#
#Return

#---------------------------------------------------------------------------------------------------------------------

$SET_AX3M_FIELDS

  FIELDS(0) = "YBPCNUM" : FIELDS(1) = "YBPRNAM" : FIELDS(2) = "BPAADDLIG"
  FIELDS(3) = "CRY" : FIELDS(4) = "POSCOD" : FIELDS(5) = "CTY"
  FIELDS(6) = "TEL" : FIELDS(7) = "WEB" : FIELDS(8) = "FCYWEB"
  FIELDS(9) = "actions"

Return

####################################################################################################################
####################################################################################################################
#**
#* GESTIONE MULTIMEDIA (per Ricerca Clienti)(YVBPC): ritorna payload per azioni multimediali
#*
#* @param YMMACTIONS Matrice con Enum Tipi azioni Multimediali (col=0), valori (col=1)
#* @param YBPAADDLIG Indirizzo
#* @param YCTY Città
#* @param YCRY Stato
#* @param YTEL N°Tel
#* @param YWEB Mail
#* @param YLINK Sito Web
#*!

Funprog YGETMEDIA(YMMACTIONS,YBPAADDLIG,YCTY,YCRY,YTEL,YWEB,YLINK)

  Variable Char YMMACTIONS()(,)
  Value Char YBPAADDLIG
  Value Char YCTY
  Value Char YCRY
  Value Char YTEL
  Value Char YWEB
  Value Char YLINK

  #Local Clbfile YJSONRESULT
  Local Char YRESULT(250)
  Gosub YMEDIACONST From YAX3MUTILS

  If([V]GWEBSERV)
    YMMACTIONS(0,0)= num$(CONST_EMAIL)
    YMMACTIONS(1,0)= num$(CONST_PHONE)
    YMMACTIONS(2,0)= num$(CONST_POSITION)
    YMMACTIONS(3,0)= num$(CONST_LINK)

    YMMACTIONS(0,1)= YWEB
    YMMACTIONS(1,1)= YTEL
    YMMACTIONS(2,1)= YBPAADDLIG + "," - YCTY + "," - YCRY
    YMMACTIONS(3,1)= YLINK

    YRESULT = func YAX3MUTILS.YGETMULTIMEDIA(YMMACTIONS)
  Endif

End YRESULT
**********
7,"TRT","YVBPC",""
2,"TRT","YVCSOH",""
#<AdxTL>@(#)0.0.0.0 $Revision$
$ACTION

#If GUSER='ADMIN' : Infbox(ACTION) : Endif

  Case ACTION
    When "OUVRE"         : Gosub OUVRE
    When "DEBUT"         : Gosub DEBUT
    When "FIN"           : Gosub FIN
    When Default
  Endcase

Return

###########################################################

$OUVRE
Return

###########################################################

$DEBUT
  Call OUVRE_TRACE ("YAX3M - YVCSOH - Ricerca ODV (Consultazione classica) - " - num$(date$)) From LECFIC
  Call ECR_TRACE("# --- Ricerca ODV (Consultazione classica) --- ",0) From GESECRAN
Return

###########################################################

$FIN
  Call FERME_TRACE From LECFIC
Return

#######################################################################################################################
#**
#* Inizializzazione - NOTA: Se la finestra è composta da più  maschere, aggiungere YCURRMSK1, YCURRMSKALIAS1,...
#*!

$INIT_FILE

  Local Char YWINNAME(20): YWINNAME = "YVCSOH"
  Local Char YCURRMSK(20): YCURRMSK = "YVCSOH"           #NOTA: Se la finestra è composta da più  maschere: Local Char YCURRMSK1(20): YCURRMSK1 = "<Nome>"
  Local Char YCURRMSKALIAS(20): YCURRMSKALIAS= "YVCSOH"  #NOTA: Se la finestra è composta da più  maschere: Local Char YCURRMSKALIAS1(20): YCURRMSKALIAS1 = "<NomeAlias>"
  Local Char YACTION(20)
  Local Char YCURRFIELD(20)

Return

########################################################################################################################
################################################ SUBPROG /FUNPROG ######################################################
########################################################################################################################

#SOHNUM: C, SELOBJ
Subprog C_SOHVCSOH(SOHNUM,BPCNAM,EECNUM,FCY,ITMREF,YAX3MRESP,YRESPONSE,YSOHNUM,BPCNUM,YBPCNAM,YEECNUM,YITMREF,ITMDES1,
&                  QTY,GROPRI,DISCRGVAL1,DISCRGVAL2,NETPRI,YTOTALE)

  Variable Char SOHNUM
  Variable Char BPCNAM
  Variable Char EECNUM
  Variable Char FCY
  Variable Char ITMREF

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char YSOHNUM()
  Variable Char BPCNUM()
  Variable Char YBPCNAM()
  Variable Char YEECNUM()
  Variable Char YITMREF()
  Variable Char ITMDES1()
  Variable Decimal QTY()
  Variable Decimal GROPRI()
  Variable Decimal DISCRGVAL1()
  Variable Decimal DISCRGVAL2()
  Variable Decimal NETPRI()
  Variable Decimal YTOTALE()

  Call OUVRE_TRACE("C_SOHVCSOH") From LECFIC
  Gosub INIT_FILE
  YACTION = "YCSOHVCSOH"
  YCURRFIELD = "SOHNUM"

  Local File SORDER [F:YSOH]

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  If(vireblc(SOHNUM,2)<> AVOID.ACHAR)
    Read[F:YSOH]SOH0 = SOHNUM
    If(fstat)
      mkstat = 2
      YMESSAGE = "Attenzione! Nr.Ordine non in anagrafica."
      Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
    Else
      mkstat = 0
    Endif
  Else
    mkstat = 0
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

###########################################################################################################################################
#BPCNAM:

###########################################################################################################################################à
#EECNUM: C, SEL(?)

Subprog C_EECVCSOH(SOHNUM,BPCNAM,EECNUM,FCY,ITMREF,YAX3MRESP,YRESPONSE,YSOHNUM,BPCNUM,YBPCNAM,YEECNUM,YITMREF,ITMDES1,
&                  QTY,GROPRI,DISCRGVAL1,DISCRGVAL2,NETPRI,YTOTALE)

  Variable Char SOHNUM
  Variable Char BPCNAM
  Variable Char EECNUM
  Variable Char FCY
  Variable Char ITMREF

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char YSOHNUM()
  Variable Char BPCNUM()
  Variable Char YBPCNAM()
  Variable Char YEECNUM()
  Variable Char YITMREF()
  Variable Char ITMDES1()
  Variable Decimal QTY()
  Variable Decimal GROPRI()
  Variable Decimal DISCRGVAL1()
  Variable Decimal DISCRGVAL2()
  Variable Decimal NETPRI()
  Variable Decimal YTOTALE()

  Local File SORDER [F:YSOH]

  Call OUVRE_TRACE("C_EECVCSOH") From LECFIC
  Gosub INIT_FILE
  YACTION = "YCEECVCSOH"
  YCURRFIELD = "EECNUM"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  If(vireblc(EECNUM,2)<> AVOID.ACHAR)

    Filter [F:YSOH] Where [F:YSOH]BPIEECNUM = EECNUM
    If(rowcount([F:YSOH])= 0)
      mkstat = 2
      YMESSAGE = "Attenzione! P.Iva non in anagrafica"
      Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
    Else
      mkstat = 0
    Endif

#    If(func YCHK_EECFMT(EECNUM)>0)
#      mkstat = 2
#      YMESSAGE = "Attenzione! Il formato del valore non corrisponde ad una P.IVA."
#    Else
#      mkstat = 0
#    Endif
  Else
    mkstat = 0
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

############################################################################################
#FCY: C, SEL

Subprog C_FCYVCSOH(SOHNUM,BPCNAM,EECNUM,FCY,ITMREF,YAX3MRESP,YRESPONSE,YSOHNUM,BPCNUM,YBPCNAM,YEECNUM,YITMREF,ITMDES1,
&                  QTY,GROPRI,DISCRGVAL1,DISCRGVAL2,NETPRI,YTOTALE)

  Variable Char SOHNUM
  Variable Char BPCNAM
  Variable Char EECNUM
  Variable Char FCY
  Variable Char ITMREF

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char YSOHNUM()
  Variable Char BPCNUM()
  Variable Char YBPCNAM()
  Variable Char YEECNUM()
  Variable Char YITMREF()
  Variable Char ITMDES1()
  Variable Decimal QTY()
  Variable Decimal GROPRI()
  Variable Decimal DISCRGVAL1()
  Variable Decimal DISCRGVAL2()
  Variable Decimal NETPRI()
  Variable Decimal YTOTALE()

  Local File FACILITY [F:YFCY]

  Call OUVRE_TRACE("C_FCYVCSOH") From LECFIC
  Gosub INIT_FILE
  YACTION = "YCFCYVCSOH"
  YCURRFIELD = "FCY"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  If(vireblc(FCY,2) <> AVOID.ACHAR)
    Read [F:YFCY]FCY0 = FCY
    If fstat
      mkstat = 2
      YMESSAGE = "ATTENZIONE! Sito inesistente!"
      Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
    Else
      mkstat = 0
      Call YAX3MOB_SETLABEL(YFIELDS,YCURRFIELD,0,[F:YFCY]FCYNAM,CURRENTROW) From YAX3MUTILS #LABEL: Descr Sito
    Endif
  Else
    mkstat = 0
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

############################################################################################

#ITMREF: C,SEL

Subprog C_ITRVCSOH(SOHNUM,BPCNAM,EECNUM,FCY,ITMREF,YAX3MRESP,YRESPONSE,YSOHNUM,BPCNUM,YBPCNAM,YEECNUM,YITMREF,ITMDES1,
&                  QTY,GROPRI,DISCRGVAL1,DISCRGVAL2,NETPRI,YTOTALE)

  Variable Char SOHNUM
  Variable Char BPCNAM
  Variable Char EECNUM
  Variable Char FCY
  Variable Char ITMREF

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char YSOHNUM()
  Variable Char BPCNUM()
  Variable Char YBPCNAM()
  Variable Char YEECNUM()
  Variable Char YITMREF()
  Variable Char ITMDES1()
  Variable Decimal QTY()
  Variable Decimal GROPRI()
  Variable Decimal DISCRGVAL1()
  Variable Decimal DISCRGVAL2()
  Variable Decimal NETPRI()
  Variable Decimal YTOTALE()

  Local File FACILITY [F:YFCY]
  Local File ITMMASTER [F:YITM]

  Call OUVRE_TRACE("C_ITRVCSOH") From LECFIC
  Gosub INIT_FILE
  YACTION = "YCITRVCSOH"
  YCURRFIELD = "ITMREF"

  #init
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  If(vireblc(ITMREF,2) <> AVOID.ACHAR)
    Read [F:YITM]ITM0 = ITMREF
    If fstat
      mkstat = 2
      YMESSAGE = "ATTENZIONE! Articolo inesistente!"
      Call YAX3MOB_SHOWMESS(YFIELDS, YCURRFIELD, mkstat, YMESSAGE) From YAX3MUTILS
    Else
      mkstat = 0
      Call YAX3MOB_SETLABEL(YFIELDS,YCURRFIELD,0,[F:YITM]ITMDES1,CURRENTROW) From YAX3MUTILS #LABEL: descr Articolo
    Endif
  Else
    mkstat = 0
  Endif

  #end
  Gosub YAX3MOB_END_ACTIONFIELD From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

#############################################################################################
#BOTTONI DI FINESTRA
#############################################################################################

Subprog YCRC_VCSOH(YLAYOUT,SOHNUM,BPCNAM,EECNUM,FCY,ITMREF,YAX3MRESP,YRESPONSE,YSOHNUM,BPCNUM,YBPCNAM,
&                  YEECNUM,YITMREF,ITMDES1,QTY,GROPRI,DISCRGVAL1,DISCRGVAL2,NETPRI,YTOTALE)

  Value Integer YLAYOUT
  Variable Char SOHNUM
  Variable Char BPCNAM
  Variable Char EECNUM
  Variable Char FCY
  Variable Char ITMREF

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char YSOHNUM()
  Variable Char BPCNUM()
  Variable Char YBPCNAM()
  Variable Char YEECNUM()
  Variable Char YITMREF()
  Variable Char ITMDES1()
  Variable Decimal QTY()
  Variable Decimal GROPRI()
  Variable Decimal DISCRGVAL1()
  Variable Decimal DISCRGVAL2()
  Variable Decimal NETPRI()
  Variable Decimal YTOTALE()

  Local Integer K,YI,YIDX,YSUCCESS : YSUCCESS = 0
  Local Decimal YYTOTALE

  #apertura traccia
  Call OUVRE_TRACE("YCRC_VCSOH") From LECFIC
  Gosub INIT_FILE
  YACTION = "YCRCVCSOH"
  YCURRFIELD = ""

  #init: #parametrizzazioni iniziali :
  Gosub YAX3MOB_INIT_BUTTONACTION From YAX3MUTILS
  YFUNC_NAME = "YVCSOH" : YFUNC_TYPE = "CONS": YMSKALIAS = "YVCSOH" : NUM_COLS = 12 #num campi riquadro (per AX3M) (Gestione automatica?)

  #business logic
  #Tables + Critere + Link[LNK]
  Gosub OPEN_FILES
  Gosub SET_CRITERE
  Gosub SET_LINK

  #Filter LINK + rowcount
  Filter [LNK] Where evalue(CRITERE) Order By [F:YSOH]SOHNUM
  COUNT_VALUES = rowcount([LNK])   #n° record trovati ( = N° righe riquadro)

  If(COUNT_VALUES = 0)
    YSUCCESS = 1
    mkstat = 2
  Else
    YSUCCESS = 0

    For [LNK]
      YSOHNUM(YI)    = [F:YSOH]SOHNUM
      BPCNUM(YI)     = [F:YSOH]BPCORD
      YBPCNAM(YI)    = [F:YSOH]BPCNAM
      YEECNUM(YI)    = [F:YSOH]BPIEECNUM
      YITMREF(YI)    = [F:YSOQ]ITMREF
      ITMDES1(YI)    = [F:YITM]ITMDES1
      QTY(YI)        = [F:YSOQ]QTY
      GROPRI(YI)     = [F:YSOP]GROPRI
      DISCRGVAL1(YI) = [F:YSOP]DISCRGVAL1
      DISCRGVAL2(YI) = [F:YSOP]DISCRGVAL2
      NETPRI(YI)     = [F:YSOP]NETPRI

      Call YCALC_NETTOT(QTY(YI), GROPRI(YI), DISCRGVAL1(YI), DISCRGVAL2(YI), NETPRI(YI), YYTOTALE)
      YTOTALE(YI)    = YYTOTALE

      YIDX = YI
      Gosub YAFFZO_YVCSOH_RIQ
      YI+=1
    Next
  Endif

  #Popolamento
  Call YAX3MOB_UPDATE_NBLIG(YCURRMSKALIAS,"NBLIG",COUNT_VALUES) From YAX3MUTILS

  #end
  Gosub YAX3MOB_END_BUTTONACTION From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

###################################################################################################

Subprog YCLRVCSOH(SOHNUM,BPCNAM,EECNUM,FCY,ITMREF,YAX3MRESP,YRESPONSE,YSOHNUM,BPCNUM,YBPCNAM,YEECNUM,YITMREF,ITMDES1,
&                 QTY,GROPRI,DISCRGVAL1,DISCRGVAL2,NETPRI,YTOTALE)

  Variable Char SOHNUM
  Variable Char BPCNAM
  Variable Char EECNUM
  Variable Char FCY
  Variable Char ITMREF

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Variable Char YSOHNUM()
  Variable Char BPCNUM()
  Variable Char YBPCNAM()
  Variable Char YEECNUM()
  Variable Char YITMREF()
  Variable Char ITMDES1()
  Variable Decimal QTY()
  Variable Decimal GROPRI()
  Variable Decimal DISCRGVAL1()
  Variable Decimal DISCRGVAL2()
  Variable Decimal NETPRI()
  Variable Decimal YTOTALE()


  Call OUVRE_TRACE("YCLRVCSOH") From LECFIC
  Gosub INIT_FILE
  YACTION = "YCLRVCSOH"
  YCURRFIELD = ""

  #init
  Gosub YAX3MOB_INIT_BUTTONACTION From YAX3MUTILS

  #business logic
  Local Integer K,YIDX
  Raz SOHNUM,BPCNAM,EECNUM,FCY,ITMREF
  Gosub YAFFZO_FILTERS

  #Pulizia labels (CAMPI FILTRO)
  Call YAX3MOB_RAZLABEL(YFIELDS,"SOHNUM",CURRENTROW) From YAX3MUTILS
  Call YAX3MOB_RAZLABEL(YFIELDS,"FCY",CURRENTROW) From YAX3MUTILS
  Call YAX3MOB_RAZLABEL(YFIELDS,"ITMREF",CURRENTROW) From YAX3MUTILS

  For K = 0 To func YUTILS.COUNT(YSOHNUM) - 1
    Raz YSOHNUM(K),BPCNUM(K),YBPCNAM(K),YEECNUM(K),YITMREF(K),
&       ITMDES1(K),QTY(K),GROPRI(K),DISCRGVAL1(K),DISCRGVAL2(K),NETPRI(K),YTOTALE(K) #dettaglio

    YIDX = K
    Gosub YAFFZO_YVCSOH_RIQ
  Next

  #end
  Gosub YAX3MOB_END_BUTTONACTION From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

#################################################################################################
#################################################################################################
#**
#* Apertura TABELLE per Link (contestuale alla funzione)
#*!

$OPEN_FILES

  Local File SORDER [F:YSOH]
  Local File SORDERP [F:YSOP]
  Local File SORDERQ [F:YSOQ]
  Local File ITMMASTER [F:YITM]

Return

#################################################################################################
#**
#* LINK per consultazione (contestuale alla funzione)
#*!

$SET_LINK

    Link [YSOQ] With [YSOH]SOH0~=[YSOQ]SOHNUM,
&                    [YSOP]SOP0~=[YSOQ]SOHNUM;[YSOQ]SOPLIN;[YSOQ]SOQSEQ,
&                    [YITM]ITM0~=[YSOQ]ITMREF
&               As [LNK]
&               Order By Key KEYSOH = [YSOH]SOHNUM;[YSOQ]SOPLIN

   Columns [LNK] ([F:YSOH]SOHNUM,[F:YSOH]BPCORD,[F:YSOH]BPCNAM,[F:YSOH]BPIEECNUM,[F:YSOQ]ITMREF,[F:YITM]ITMDES1,[F:YSOQ]QTY,
&                 [F:YSOP]GROPRI,[F:YSOP]DISCRGVAL1,[F:YSOP]DISCRGVAL2,[F:YSOP]NETPRI)

Return

############################################################################################
#**
#* CRITERE per consultazione (contestuale alla funzione)
#*!

$SET_CRITERE

  Local Char YTRIVCOND(10): YTRIVCOND = "1=1"
  CRITERE(0) = YTRIVCOND                # "1=1"
  CRITERE(1) = chr$(32)+"&"+YTRIVCOND   #" & 1=1"

  SOHNUM = vireblc(SOHNUM,2)
  BPCNAM = vireblc(BPCNAM,2)
  EECNUM = vireblc(EECNUM,2)
  FCY    = vireblc(FCY,2)
  ITMREF = vireblc(ITMREF,2)

  If(SOHNUM <> AVOID.ACHAR)
    CRITERE(0)-="& instr(1, tolower([F:YSOH]SOHNUM), tolower('" + SOHNUM + "'))<>0"
  Endif

  If(BPCNAM <> AVOID.ACHAR)
    CRITERE(0)-="& instr(1, tolower([F:YSOH]BPCNAM), tolower('" + BPCNAM + "'))<>0"
  Endif

  If(EECNUM <> AVOID.ACHAR)
    CRITERE(0)-="& instr(1, tolower([F:YSOH]BPIEECNUM), tolower('" + EECNUM + "'))<>0"
  Endif

  If(FCY <> AVOID.ACHAR)
    CRITERE(0)-="& [F:YSOH]STOFCY = '" + FCY + "'"
  Endif

  If(ITMREF <> AVOID.ACHAR)
  #in like:
    #CRITERE(0)-="& instr(1, tolower([F:YSOQ]ITMREF), tolower('" + ITMREF + "'))<>0"
    CRITERE(0)-="& [F:YSOQ]ITMREF = '" + ITMREF + "'"
  Endif

Return

##################################################################################################################
#                         SOLO AX3M
##################################################################################################################

$SET_AX3M_TIT_COL

  Call TEXTFIC("SORDER","SOHNUM",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YSOH]SOHNUM"
  NBCOL += 1 : Call TEXTFIC("SORDER","BPCORD",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YSOH]BPCNAM"
  NBCOL += 1 : Call TEXTFIC("SORDER","BPCNAM",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YSOH]BPCNAM"
  NBCOL += 1 : Call TEXTFIC("SORDER","BPIEECNUM",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YSOH]BPIEECNUM"
  NBCOL += 1 : Call TEXTFIC("SORDERQ","ITMREF",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YSOQ]ITMREF"
  NBCOL += 1 : Call TEXTFIC("ITMMASTER","ITMDES1",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YITM]ITMDES1"
  NBCOL += 1 : Call TEXTFIC("SORDERQ","QTY",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YSOQ]QTY"
  NBCOL += 1 : Call TEXTFIC("SORDERP","GROPRI",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YSOP]GROPRI"
  NBCOL += 1 : Call TEXTFIC("SORDERP","DISCRGVAL1",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YSOP]DISCRGVAL1"
  NBCOL += 1 : Call TEXTFIC("SORDERP","DISCRGVAL2",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YSOP]DISCRGVAL2"
  NBCOL += 1 : Call TEXTFIC("SORDERP","NETPRI",2,TIT(NBCOL)) From OBJDIV
  COL(NBCOL) = "[F:YSOP]NETPRI"
  NBCOL += 1 : TIT(NBCOL) = "Totale"
  COL(NBCOL) = "num$([F:YSOQ]QTY*([F:YSOP]GROPRI-([F:YSOP]GROPRI*[F:YSOP]DISCRGVAL1)/100-([F:YSOP]GROPRI*[F:YSOP]DISCRGVAL2)/100))"

Return

 #YNETPRI = YGROPRI - (YGROPRI * YDISCOUNT1) / 100 - (YGROPRI * YDISCOUNT2) / 100
 #YTOTALE = YQTY*YNETPRI

###################################################################################################################
#**
#* Setting Array con elenco cod. Campi per la griglia di Selezione [Lato AX3M]
#*!

$SET_AX3M_FIELDS

  FIELDS(0) = "YSOHNUM" : FIELDS(1) = "BPCNUM" : FIELDS(2) = "YBPCNAM"
  FIELDS(3) = "YEECNUM" : FIELDS(4) = "YITMREF" : FIELDS(5) = "ITMDES1"
  FIELDS(6) = "QTY" : FIELDS(7) = "GROPRI" : FIELDS(8) = "DISCRGVAL1"
  FIELDS(9) = "DISCRGVAL2" : FIELDS(10) = "NETPRI" : FIELDS(11) = "YTOTALE"

Return

####################################################################################################################
#                                                 UTILITà
####################################################################################################################
#controllo formato P.IVA

Funprog YCHK_EECFMT(YEECNUM)

  Value Char YEECNUM
  Local Integer YSUCCESS,YI,YJ
  Local Char YNUMS(1)(10)

  If(len(YEECNUM)<2)
    YSUCCESS = 2
  Else
    For YI = 0 To 9
      YNUMS(YI) = num$(YI)
    Next

    #CONTROLLO :formato partita IVA
    If(find(YEECNUM(1),YNUMS)>0 | find(YEECNUM(2),YNUMS)>0)
      YSUCCESS = 2
    Endif
  Endif

End YSUCCESS

######################################################################

Subprog YCALC_NETTOT(YQTY, YGROPRI, YDISCOUNT1, YDISCOUNT2, YNETPRI, YTOTALE)

  Value Decimal YQTY
  Value Decimal YGROPRI
  Value Decimal YDISCOUNT1
  Value Decimal YDISCOUNT2
  Variable Decimal YNETPRI
  Variable Decimal YTOTALE

  YNETPRI = YGROPRI - (YGROPRI * YDISCOUNT1) / 100 - (YGROPRI * YDISCOUNT2) / 100
  YTOTALE = YQTY*YNETPRI
End

####################################################################################
#**
#* Sub per Affzo Campi Filtro(Testata) YVCSOH
#*!

$YAFFZO_FILTERS

  Call YAX3MOB_AFFZO(YCURRMSKALIAS,"SOHNUM") From YAX3MUTILS
  Call YAX3MOB_AFFZO(YCURRMSKALIAS,"BPCNAM") From YAX3MUTILS
  Call YAX3MOB_AFFZO(YCURRMSKALIAS,"EECNUM") From YAX3MUTILS
  Call YAX3MOB_AFFZO(YCURRMSKALIAS,"FCY") From YAX3MUTILS
  Call YAX3MOB_AFFZO(YCURRMSKALIAS,"ITMREF") From YAX3MUTILS
Return

###################################################################################
#**
#* Sub per Affzo Campi Riquadro YVCSOH
#*!

$YAFFZO_YVCSOH_RIQ

  Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"YSOHNUM",YIDX) From YAX3MUTILS
  Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"BPCNUM",YIDX) From YAX3MUTILS
  Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"YBPCNAM",YIDX) From YAX3MUTILS
  Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"YEECNUM",YIDX) From YAX3MUTILS
  Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"YITMREF",YIDX) From YAX3MUTILS
  Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"ITMDES1",YIDX) From YAX3MUTILS
  Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"QTY",YIDX) From YAX3MUTILS
  Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"GROPRI",YIDX) From YAX3MUTILS
  Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"DISCRGVAL1",YIDX) From YAX3MUTILS
  Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"DISCRGVAL2",YIDX) From YAX3MUTILS
  Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"NETPRI",YIDX) From YAX3MUTILS
  Call YAX3MOB_AFFZO_RIQUADRO(YCURRMSKALIAS,"YTOTALE",YIDX) From YAX3MUTILS

Return
**********
7,"TRT","YVCSOH",""
2,"TRT","YVSOH",""
#<AdxTL>@(#)0.0.0.0 $Revision$
#############################################################################################################################
#
#LD - Consultazione ordini di vendita (ArgoX3 Mobile)
#
#############################################################################################################################

$ACTION

  Case ACTION
    When "DEBUT"         : Gosub DEBUT
    When "FIN"           : Gosub FIN
    When Default
  Endcase

Return


###########################################################

$DEBUT

  Call OUVRE_TRACE ("YVSOH (ArgoX3 Mobile) - Consultazione ordini di vendita" - num$(date$)) From LECFIC
  Raz [M:YVSOH]
  Raz [M:YVSOH2]
  Affzo [M:YVSOH]
  Affzo [M:YVSOH2]

Return

##########################################################

$FIN

  Call FERME_TRACE From LECFIC

Return

$INIT_FILE

  Local Char YWINNAME(20) : YWINNAME = "YVSOH"
  Local Char YCURRMSKNUM(10) : YCURRMSKNUM = func YUTILS.IIF(SCREEN_NUMBER = 1, "YVSOH", "YVSOH" + num$(SCREEN_NUMBER))
  Local Char YCURRMSK(20) : YCURRMSK =  YCURRMSKNUM
  Local Char YCURRMSKALIAS(20) : YCURRMSKALIAS = YCURRMSKNUM
  Local Char YACTION(20)
  Local Char YCURRFIELD(20)

Return

#####################################################################################################################

Subprog AS_BPCVSOH(ID,BPCNAM,EECNUM,CTY,CRY,WEB,SOHNUM,SOPLIN,ITMREF,ITMDES1,QTY,GROPRI,YNEXTPREV,YAX3MRESP,YRESPONSE)

  Value Integer ID
  Variable Char BPCNAM
  Variable Char EECNUM
  Variable Char CTY
  Variable Char CRY
  Variable Char WEB
  Variable Char SOHNUM
  Value Integer SOPLIN
  Variable Char ITMREF
  Variable Char ITMDES1
  Variable Decimal QTY
  Variable Decimal GROPRI
  Value Integer YNEXTPREV

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Call OUVRE_TRACE("AS_BPCVSOH") From LECFIC

  Local Integer SCREEN_NUMBER : SCREEN_NUMBER = 1
  Gosub INIT_FILE
  YACTION = "YASBPCVSOH"
  YCURRFIELD = "BPCNAM"

  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  Gosub YAX3MOB_END_ACTIONFIELD_NOFOCUS From YAX3MUTILS
  Call FERME_TRACE From LECFIC

End

########################################################################################################################

Subprog AM_BPCVSOH(ID,BPCNAM,EECNUM,CTY,CRY,WEB,SOHNUM,SOPLIN,ITMREF,ITMDES1,QTY,GROPRI,YNEXTPREV,YAX3MRESP,YRESPONSE)

  Value Integer ID
  Variable Char BPCNAM
  Variable Char EECNUM
  Variable Char CTY
  Variable Char CRY
  Variable Char WEB
  Variable Char SOHNUM
  Value Integer SOPLIN
  Variable Char ITMREF
  Variable Char ITMDES1
  Variable Decimal QTY
  Variable Decimal GROPRI
  Value Integer YNEXTPREV

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Call OUVRE_TRACE("AM_BPCVSOH") From LECFIC

  Local Integer SCREEN_NUMBER : SCREEN_NUMBER = 1
  Gosub INIT_FILE
  YACTION = "YAMBPCVSOH"
  YCURRFIELD = "BPCNAM"

  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  #Gosub YFILTER_SOH
  Local File YRICORDSESS [F:YROS]
  Delete [F:YROS] Where 1=1

  Local Integer YRESULT
  YRESULT = func YFILTER_ORDERS(ID, BPCNAM, EECNUM, CTY, CRY, WEB, SOHNUM, SOPLIN, ITMREF, ITMDES1, QTY, GROPRI, YNEXTPREV)
  If YRESULT = 0
    Gosub YEMPTY_SCREENDATA
  Elsif YRESULT = 1
    Gosub YSET_SCREENDATA
  Endif

  Gosub YFIX_DATA
  #Call YAX3MOB_FOCUS(YFIELDS,"SOHNUM",0) From YAX3MUTILS
  #business logic end

  Gosub YAX3MOB_END_ACTIONFIELD_NOFOCUS From YAX3MUTILS
  Call FERME_TRACE From LECFIC

End

########################################################################################################################

Subprog AM_SOHVSOH(ID,BPCNAM,EECNUM,CTY,CRY,WEB,SOHNUM,SOPLIN,ITMREF,ITMDES1,QTY,GROPRI,YNEXTPREV,YAX3MRESP,YRESPONSE)

  Value Integer ID
  Variable Char BPCNAM
  Variable Char EECNUM
  Variable Char CTY
  Variable Char CRY
  Variable Char WEB
  Variable Char SOHNUM
  Value Integer SOPLIN
  Variable Char ITMREF
  Variable Char ITMDES1
  Variable Decimal QTY
  Variable Decimal GROPRI
  Value Integer YNEXTPREV

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE


  Call OUVRE_TRACE("AM_SOHVSOH") From LECFIC

#Infbox num$(ID)-BPCNAM-EECNUM-CTY-CRY-WEB-SOHNUM-ITMREF
  Local Integer SCREEN_NUMBER : SCREEN_NUMBER = 2
  Gosub INIT_FILE
  YACTION = "YAMSOHVSOH"
  YCURRFIELD = "SOHNUM"

  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  Local File YRICORDSESS [F:YROS]
  Delete [F:YROS] Where 1=1

  Local Integer YRESULT
  YRESULT = func YFILTER_ORDERS(ID, BPCNAM, EECNUM, CTY, CRY, WEB, SOHNUM, SOPLIN, ITMREF, ITMDES1, QTY, GROPRI, YNEXTPREV)
  If YRESULT = 0
    Gosub YEMPTY_SCREENDATA
  Elsif YRESULT = 1
    Gosub YSET_SCREENDATA
  Endif
  Gosub YFIX_DATA
  #Call YAX3MOB_FOCUS(YFIELDS,"SOPLIN",0) From YAX3MUTILS
  #business logic end

  Gosub YAX3MOB_END_ACTIONFIELD_NOFOCUS From YAX3MUTILS
  Call FERME_TRACE From LECFIC

End

########################################################################################################################

Subprog AM_EECVSOH(ID,BPCNAM,EECNUM,CTY,CRY,WEB,SOHNUM,SOPLIN,ITMREF,ITMDES1,QTY,GROPRI,YNEXTPREV,YAX3MRESP,YRESPONSE)

  Value Integer ID
  Variable Char BPCNAM
  Variable Char EECNUM
  Variable Char CTY
  Variable Char CRY
  Variable Char WEB
  Variable Char SOHNUM
  Value Integer SOPLIN
  Variable Char ITMREF
  Variable Char ITMDES1
  Variable Decimal QTY
  Variable Decimal GROPRI
  Value Integer YNEXTPREV

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE


  Call OUVRE_TRACE("AM_EECVSOH") From LECFIC

  Local Integer SCREEN_NUMBER : SCREEN_NUMBER = 2
  Gosub INIT_FILE
  YACTION = "YAMEECVSOH"
  YCURRFIELD = "EECNUM"

  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic
  Local File YRICORDSESS [F:YROS]
  Delete [F:YROS] Where 1=1

  Local Integer YRESULT
  YRESULT = func YFILTER_ORDERS(ID, BPCNAM, EECNUM, CTY, CRY, WEB, SOHNUM, SOPLIN, ITMREF, ITMDES1, QTY, GROPRI, YNEXTPREV)
  If YRESULT = 0
    Gosub YEMPTY_SCREENDATA
  Elsif YRESULT = 1
    Gosub YSET_SCREENDATA
  Endif

  Gosub YFIX_DATA
  #Call YAX3MOB_FOCUS(YFIELDS,"SOHNUM",0) From YAX3MUTILS #NON FUNZIONA!!
  #business logic end

  Gosub YAX3MOB_END_ACTIONFIELD_NOFOCUS From YAX3MUTILS
  Call FERME_TRACE From LECFIC

End

#####################################################################################################################

Subprog AM_NEXTPRE(ID,BPCNAM,EECNUM,CTY,CRY,WEB,SOHNUM,SOPLIN,ITMREF,ITMDES1,QTY,GROPRI,YNEXTPREV,YAX3MRESP,YRESPONSE)

  Value Integer ID
  Variable Char BPCNAM
  Variable Char EECNUM
  Variable Char CTY
  Variable Char CRY
  Variable Char WEB
  Variable Char SOHNUM
  Value Integer SOPLIN
  Variable Char ITMREF
  Variable Char ITMDES1
  Variable Decimal QTY
  Variable Decimal GROPRI
  Value Integer YNEXTPREV

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Call OUVRE_TRACE("AM_NEXTPREV") From LECFIC

  Local Integer SCREEN_NUMBER : SCREEN_NUMBER = 1
  Gosub INIT_FILE
  YACTION = "YAMANEXTPR"
  YCURRFIELD = "YNEXTPREV"
  Gosub YAX3MOB_INIT_ACTIONFIELD From YAX3MUTILS

  #business logic start
  If YNEXTPREV = 1
    Gosub YNEXT_SOH
  Elsif YNEXTPREV = 2
    Gosub YPREV_SOH
  Endif
  #business logic end

  Gosub YAX3MOB_END_ACTIONFIELD_NOFOCUS From YAX3MUTILS
  Call FERME_TRACE From LECFIC
End

#####################################################################################################################

Subprog YPREVVSOH(ID,BPCNAM,EECNUM,CTY,CRY,WEB,SOHNUM,SOPLIN,ITMREF,ITMDES1,QTY,GROPRI,YNEXTPREV,YAX3MRESP,YRESPONSE)

  Value Integer ID
  Variable Char BPCNAM
  Variable Char EECNUM
  Variable Char CTY
  Variable Char CRY
  Variable Char WEB
  Variable Char SOHNUM
  Value Integer SOPLIN
  Variable Char ITMREF
  Variable Char ITMDES1
  Variable Decimal QTY
  Variable Decimal GROPRI
  Value Integer YNEXTPREV

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Call OUVRE_TRACE("AM_NEXTPREV") From LECFIC

  Local Integer SCREEN_NUMBER : SCREEN_NUMBER = 1
  Gosub INIT_FILE
  YACTION = "YPREVVSOH"
  YCURRFIELD = ""
  Gosub YAX3MOB_INIT_BUTTONACTION From YAX3MUTILSLDTEST

  #business logic start
  Gosub YPREV_SOH
  #business logic end

  Gosub YAX3MOB_END_BUTTONACTION From YAX3MUTILSLDTEST
  Call FERME_TRACE From LECFIC
End

#####################################################################################################################

Subprog YNEXTVSOH(ID,BPCNAM,EECNUM,CTY,CRY,WEB,SOHNUM,SOPLIN,ITMREF,ITMDES1,QTY,GROPRI,YNEXTPREV,YAX3MRESP,YRESPONSE)

  Value Integer ID
  Variable Char BPCNAM
  Variable Char EECNUM
  Variable Char CTY
  Variable Char CRY
  Variable Char WEB
  Variable Char SOHNUM
  Value Integer SOPLIN
  Variable Char ITMREF
  Variable Char ITMDES1
  Variable Decimal QTY
  Variable Decimal GROPRI
  Value Integer YNEXTPREV

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Call OUVRE_TRACE("AM_NEXTPREV") From LECFIC

  Local Integer SCREEN_NUMBER : SCREEN_NUMBER = 1
  Gosub INIT_FILE
  YACTION = "YNEXTVSOH"
  YCURRFIELD = ""
  Gosub YAX3MOB_INIT_BUTTONACTION From YAX3MUTILSLDTEST

  #business logic start
  Gosub YNEXT_SOH
  #business logic end

  Gosub YAX3MOB_END_BUTTONACTION From YAX3MUTILSLDTEST
  Call FERME_TRACE From LECFIC
End

#####################################################################################################################

Subprog YCLEARVSOH(ID,BPCNAM,EECNUM,CTY,CRY,WEB,SOHNUM,SOPLIN,ITMREF,ITMDES1,QTY,GROPRI,YNEXTPREV,YAX3MRESP,YRESPONSE)

  Value Integer ID
  Variable Char BPCNAM
  Variable Char EECNUM
  Variable Char CTY
  Variable Char CRY
  Variable Char WEB
  Variable Char SOHNUM
  Value Integer SOPLIN
  Variable Char ITMREF
  Variable Char ITMDES1
  Variable Decimal QTY
  Variable Decimal GROPRI
  Value Integer YNEXTPREV

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Call OUVRE_TRACE("YCLEARVSOH") From LECFIC

  Local Integer SCREEN_NUMBER : SCREEN_NUMBER = 1
  Gosub INIT_FILE
  YACTION = "YCLEARVSOH"
  YCURRFIELD = ""

  Gosub YAX3MOB_INIT_BUTTONACTION From YAX3MUTILSLDTEST

  #business logic start
  Gosub YEMPTY_SCREENDATA
  Local File YRICORDSESS [F:YROS]
  Delete [F:YROS] Where 1=1

  Gosub YAX3MOB_END_BUTTONACTION From YAX3MUTILSLDTEST
  Call FERME_TRACE From LECFIC

End

#####################################################################################################################

Subprog YTEMPVSOH(YLAYOUT,ID,BPCNAM,EECNUM,CTY,CRY,WEB,SOHNUM,SOPLIN,ITMREF,ITMDES1,QTY,GROPRI,YNEXTPREV,YAX3MRESP,YRESPONSE)

  Value Integer YLAYOUT
  Value Integer ID
  Variable Char BPCNAM
  Variable Char EECNUM
  Variable Char CTY
  Variable Char CRY
  Variable Char WEB
  Variable Char SOHNUM
  Value Integer SOPLIN
  Variable Char ITMREF
  Variable Char ITMDES1
  Variable Decimal QTY
  Variable Decimal GROPRI
  Value Integer YNEXTPREV

  Value Clbfile YAX3MRESP
  Variable Clbfile YRESPONSE

  Call OUVRE_TRACE("YTEMPVSOH") From LECFIC

  Local Integer SCREEN_NUMBER : SCREEN_NUMBER = 1
  Gosub INIT_FILE
  YACTION = "YTEMPVSOH"
  YCURRFIELD = ""

  Gosub YAX3MOB_INIT_BUTTONACTION From YAX3MUTILSLDTEST

  #business logic start
  YOPENFUNCTION(0) = "YSOH" #open
  YOPENFUNCTION(1) = "Ordine di vendita" - SOHNUM #title
  YOPENFUNCTION(2) = "OrdineDiVendita" #controller
  YOPENFUNCTION(3) = "1" #modal navigation
  #business logic end

  Gosub YAX3MOB_END_BUTTONACTION From YAX3MUTILSLDTEST
  Call FERME_TRACE From LECFIC

End


#####################################Funzioni generali################################################################

$YNEXT_SOH

  If !clalev([F:YROS]) : Local File YRICORDSESS   [F:YROS] : Endif

  If vireblc(SOHNUM, 2) <> AVOID.ACHAR
    Filter [F:YROS] Where ID = ID_VIS + 1
    Read [F:YROS] First
    If fstat = 0
      Gosub YSET_SCREENDATA
      Gosub YFIX_DATA
      Filter [F:YROS]
      Update [F:YROS] Where 1=1 With [F:YROS]ID_VIS = ID_VIS + 1
    Endif
  Endif

Return

$YPREV_SOH

  If !clalev([F:YROS]) : Local File YRICORDSESS   [F:YROS] : Endif

  If vireblc(SOHNUM, 2) <> AVOID.ACHAR
    Filter [F:YROS] Where ID = ID_VIS - 1
    Read [F:YROS] First
    If fstat = 0
      Gosub YSET_SCREENDATA
      Gosub YFIX_DATA
      Filter [F:YROS]
      Update [F:YROS] Where 1=1 With [F:YROS]ID_VIS = ID_VIS - 1
    Endif
  Endif

Return

$YEMPTY_SCREENDATA

  BPCNAM = AVOID.ACHAR
  EECNUM = AVOID.ACHAR
  CTY = AVOID.ACHAR
  CRY = AVOID.ACHAR
  WEB = AVOID.ACHAR
  SOHNUM = AVOID.ACHAR
  SOPLIN = 0
  ITMREF = AVOID.ACHAR
  ITMDES1 = AVOID.ACHAR
  QTY = 0
  GROPRI = 0

Return

$YSET_SCREENDATA

  If !clalev([F:YROS]) : Local File YRICORDSESS [F:YROS] : Endif
  Read [YROS]YROS0 = func YUTILS.IIF(ID = 0, ID + 1, ID)
  BPCNAM = [YROS]BPCNAM
  EECNUM = [YROS]EECNUM
  CTY = [YROS]CTY
  CRY = [YROS]CRY
  WEB = [YROS]WEB(0)
  SOHNUM = [YROS]SOHNUM
  SOPLIN = [YROS]SOPLIN
  ITMREF = [YROS]ITMREF
  ITMDES1 = [YROS]ITMDES1
  QTY = [YROS]QTY
  GROPRI = [YROS]GROPRI

Return

$YFIX_DATA

  If !GWEBSERV
      #non funziona il passaggio per riferimento degli interi
    [M:YVSOH2]SOPLIN = func YUTILS.IIF([YROS]SOPLIN > 0, [YROS]SOPLIN, 0)
    Affzo [M:YVSOH]BPCNAM
    Affzo [M:YVSOH]EECNUM
    Affzo [M:YVSOH]CTY
    Affzo [M:YVSOH]CRY
    Affzo [M:YVSOH]WEB
    Affzo [M:YVSOH2]SOHNUM
    Affzo [M:YVSOH2]SOPLIN
    Affzo [M:YVSOH2]ITMREF
    Affzo [M:YVSOH2]ITMDES1
    Affzo [M:YVSOH2]QTY
    Affzo [M:YVSOH2]GROPRI
  Endif

Return

######################################################################################################

Funprog YFILTER_ORDERS(ID,BPCNAM,EECNUM,CTY,CRY,WEB,SOHNUM,SOPLIN,ITMREF,ITMDES1,QTY,GROPRI,YNEXTPREV)

  Value Integer ID
  Variable Char BPCNAM
  Variable Char EECNUM
  Variable Char CTY
  Variable Char CRY
  Variable Char WEB
  Variable Char SOHNUM
  Value Integer SOPLIN
  Variable Char ITMREF
  Variable Char ITMDES1
  Variable Decimal QTY
  Variable Decimal GROPRI
  Value Integer YNEXTPREV

  Local Char YFILTER(250)(2)
  Local Integer TRANS_OPEN

  Call OUVRE_TRACE("YFILTER_ORDERS") From LECFIC

  If SOPLIN = 0
    SOPLIN = 1000
  Endif

  YFILTER = "1=1"
  If vireblc(SOHNUM, 2) <> AVOID.ACHAR
    YFILTER(0) -= "& [YSOH]SOHNUM='" + SOHNUM + "'"
  Endif
  If vireblc(BPCNAM, 2) <> AVOID.ACHAR
    YFILTER(0) -= "& instr(1, tolower([YBPC]BPCNAM), tolower('" + BPCNAM + "'))<>0"
  Endif
  If vireblc(EECNUM, 2) <> AVOID.ACHAR
    YFILTER(0) -= "& instr(1, tolower([YBPR]EECNUM), tolower('" + EECNUM + "'))<>0"
  Endif
  If vireblc(CTY, 2) <> AVOID.ACHAR
    YFILTER(1) -= "& instr(1, tolower([YBPA]CTY), tolower('" + CTY + "'))<>0"
  Endif
  If vireblc(CRY, 2) <> AVOID.ACHAR
    YFILTER(1) -= "& instr(1, tolower([YBPA]CRY), tolower('" + CRY + "'))<>0"
  Endif

  Local File BPCUSTOMER [F:YBPC]
  Local File BPARTNER   [F:YBPR]
  Local File BPADDRESS  [F:YBPA]
  Local File SORDER     [F:YSOH]
  Local File SORDERP    [F:YSOP]
  Local File SORDERQ    [F:YSOQ]

  Link  [YSOP] With
&       [YSOQ]SOQ0 ~= [YSOP]SOHNUM;[YSOP]SOPLIN;[YSOP]SOPSEQ,
&       [YSOH]SOH0 ~= [YSOQ]SOHNUM,
&       [YBPC]BPC0 ~= [YSOH]BPCORD,
&       [YBPR]BPR0 ~= [YBPC]BPCNUM,
&       [YBPA]BPA0 ~= 1;[YBPR]BPRNUM;[YSOP]BPAADD
& As    [YLNK]
& Where evalue(YFILTER)

  Columns [YLNK] ([YBPC]BPCNAM, [YBPR]EECNUM, [YBPA]CTY, [YBPA]CRY, [YBPA]WEB,
&                 [YSOH]SOHNUM, [YSOP]SOPLIN, [YSOP]ITMREF, [YSOP]ITMDES1, [YSOQ]QTY, [YSOP]GROPRI)

  #Delete [YROS] Where 1=1

#  If adxlog=0
#    TRANS_OPEN = 0
#    Trbegin [YROS]
#  Endif
  If adxlog = 1
    Rollback
  Endif

  Local File YRICORDSESS [F:YROS]

  If rowcount([YLNK]) > 0
    Trbegin [YROS]

    Local Integer YID : YID = 1

    For [YLNK]
      [F:YROS]ID = YID
      Call ECR_TRACE("ID:" - num$([F:YROS]ID), 0) From GESECRAN
      [F:YROS]ID_VIS = func YUTILS.IIF(ID = 0, ID + 1, ID)
      Call ECR_TRACE("ID_VIS:" - num$([F:YROS]ID_VIS), 0) From GESECRAN
      [F:YROS]BPCNAM = [YBPC]BPCNAM
      Call ECR_TRACE("BPCNAM:" - [F:YROS]BPCNAM, 0) From GESECRAN
      [F:YROS]EECNUM = [YBPR]EECNUM
      Call ECR_TRACE("EECNUM:" - [F:YROS]EECNUM, 0) From GESECRAN
      [F:YROS]CTY = [YBPA]CTY
      Call ECR_TRACE("CTY:" - [F:YROS]CTY, 0) From GESECRAN
      [F:YROS]CRY = [YBPA]CRY
      Call ECR_TRACE("CRY:" - [F:YROS]CRY, 0) From GESECRAN
      [F:YROS]WEB = [YBPA]WEB(0)
      Call ECR_TRACE("WEB:" - [F:YROS]WEB(0), 0) From GESECRAN
      [F:YROS]SOHNUM = [YSOH]SOHNUM
      Call ECR_TRACE("SOHNUM:" - [F:YROS]SOHNUM, 0) From GESECRAN
      [F:YROS]SOPLIN = [YSOP]SOPLIN
      Call ECR_TRACE("SOPLIN:" - num$([F:YROS]SOPLIN), 0) From GESECRAN
      [F:YROS]ITMREF = [YSOP]ITMREF
      Call ECR_TRACE("ITMREF:" - [F:YROS]ITMREF, 0) From GESECRAN
      [F:YROS]ITMDES1 = [YSOP]ITMDES1
      Call ECR_TRACE("ITMDES1:" - [F:YROS]ITMDES1, 0) From GESECRAN
      [F:YROS]QTY = [YSOQ]QTY
      Call ECR_TRACE("QTY:" - num$([F:YROS]QTY), 0) From GESECRAN
      [F:YROS]GROPRI = [YSOP]GROPRI
      Call ECR_TRACE("GROPRI:" - num$([F:YROS]GROPRI), 0) From GESECRAN
      Write  [F:YROS]
      If !fstat
        YID = YID + 1
      Else
        Rollback
      Endif
    Next

    If !fstat #& TRANS_OPEN = 0
      Commit
      End 1
    Else #IF TRANS_OPEN = 0
      Rollback
      End 2
    Endif
  Else
    End 0
  Endif

End -1

##################################################
Subprog YSOH_NEXT(ID,BPCNAM,EECNUM,CTY,CRY,WEB,SOHNUM,SOPLIN,ITMREF,ITMDES1,QTY,GROPRI,YAX3MRESP,YRESPONSE)
Value    Integer ID
Variable Char    BPCNAM()
Variable Char    EECNUM()
Variable Char    CTY()
Variable Char    CRY()
Variable Char    WEB()
Variable Char    SOHNUM()
Value    Integer SOPLIN
Variable Char    ITMREF()
Variable Char    ITMDES1()
Variable Decimal QTY
Variable Decimal GROPRI
Value    Clbfile YAX3MRESP
Variable Clbfile YRESPONSE
End


##################################################
Subprog YSOH_PREV(ID,BPCNAM,EECNUM,CTY,CRY,WEB,SOHNUM,SOPLIN,ITMREF,ITMDES1,QTY,GROPRI,YAX3MRESP,YRESPONSE)
Value    Integer ID
Variable Char    BPCNAM()
Variable Char    EECNUM()
Variable Char    CTY()
Variable Char    CRY()
Variable Char    WEB()
Variable Char    SOHNUM()
Value    Integer SOPLIN
Variable Char    ITMREF()
Variable Char    ITMDES1()
Variable Decimal QTY
Variable Decimal GROPRI
Value    Clbfile YAX3MRESP
Variable Clbfile YRESPONSE
End

**********
7,"TRT","YVSOH",""
8,"Patch TRT  AX3M - AppCore"
